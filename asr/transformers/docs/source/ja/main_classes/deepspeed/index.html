
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../../../../../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Deepspeed - Ohayou</title>
      
    
    
      <link rel="stylesheet" href="../../../../../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../../../assets/extra.css">
    
    <script>__md_scope=new URL("../../../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#deepspeed-integration" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../../../.." title="Ohayou" class="md-header__button md-logo" aria-label="Ohayou" data-md-component="logo">
      
  <img src="../../../../../../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ohayou
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Deepspeed
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../../ohayou/" class="md-tabs__link">
        
  
  
    
  
  Ohayou

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../../../vllm/open_ai_vllm_example_a_v_t/" class="md-tabs__link">
          
  
  
    
  
  vLLM

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../../../llm/speculative_decoding/" class="md-tabs__link">
          
  
  
    
  
  LLM

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../../../vlm/qwen3_vl_4B_object_detection/" class="md-tabs__link">
          
  
  
    
  
  VLM

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../../md_format_helpers/" class="md-tabs__link">
        
  
  
    
  
  MD format helpers

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../../docker/" class="md-tabs__link">
        
  
  
    
  
  Docker

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../../linux/" class="md-tabs__link">
        
  
  
    
  
  Linux

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../../moe/" class="md-tabs__link">
        
  
  
    
  
  Mixture of Experts

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../../slurm/" class="md-tabs__link">
        
  
  
    
  
  Slurm

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../../../japanese-phrases/" class="md-tabs__link">
          
  
  
    
  
  Japanese Phrases

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../../hackathon/index.md" class="md-tabs__link">
        
  
  
    
  
  Hack

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../../../.." title="Ohayou" class="md-nav__button md-logo" aria-label="Ohayou" data-md-component="logo">
      
  <img src="../../../../../../../assets/logo.png" alt="logo">

    </a>
    Ohayou
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../../ohayou/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ohayou
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    vLLM
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            vLLM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../../vllm/open_ai_vllm_example_a_v_t/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Single Request
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../../vllm/bash_vllm_serve/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bash online serve
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../../vllm/benchmarks/performance_eval/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Benchmarks
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    LLM
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            LLM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../../llm/speculative_decoding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Speculative Decoding
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    VLM
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            VLM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../../vlm/qwen3_vl_4B_object_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Qwen3VL_adema_grounding
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../../vlm/qwen3_vla_4B_audio_training_aspandiyar/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Qwen3VLA_aspandiyar_thinking
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../../md_format_helpers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MD format helpers
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../../docker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Docker
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../../linux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Linux
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../../moe/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mixture of Experts
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../../slurm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Slurm
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../../../../japanese-phrases/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Japanese Phrases
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_11" id="__nav_11_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Japanese Phrases
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../../../../japanese-phrases/daily-life/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Daily Life
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_11_2" id="__nav_11_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_11_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11_2">
            <span class="md-nav__icon md-icon"></span>
            Daily Life
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../../japanese-phrases/daily-life/shopping/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shopping
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../../../../japanese-phrases/greetings/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Greetings
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_11_3" id="__nav_11_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_11_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11_3">
            <span class="md-nav__icon md-icon"></span>
            Greetings
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../../japanese-phrases/greetings/casual/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Casual
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../../japanese-phrases/emotions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Emotions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../../japanese-phrases/anime-manga/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Anime/Manga
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../../hackathon/index.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hack
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#trainer-deepspeed-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Trainer Deepspeed Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trainer Deepspeed Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    <span class="md-ellipsis">
      Installation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment-with-multiple-gpus" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment with multiple GPUs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment-with-one-gpu" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment with one GPU
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      è¤‡æ•°ã®ãƒãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ãŸãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="è¤‡æ•°ã®ãƒãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ãŸãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-torchdistributedrun-launcher" class="md-nav__link">
    <span class="md-ellipsis">
      The torch.distributed.run launcher
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¹ãƒ”ãƒ¼ãƒ‰ ãƒ©ãƒ³ãƒãƒ£ãƒ¼
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#launching-in-a-slurm-environment" class="md-nav__link">
    <span class="md-ellipsis">
      Launching in a SLURM environment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-of-non-shared-filesystem" class="md-nav__link">
    <span class="md-ellipsis">
      Use of Non-shared filesystem
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment-in-notebooks" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment in Notebooks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#passing-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Passing Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shared-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Shared Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zero" class="md-nav__link">
    <span class="md-ellipsis">
      ZeRO
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ZeRO">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zero-2-config" class="md-nav__link">
    <span class="md-ellipsis">
      ZeRO-2 Config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zero-3-config" class="md-nav__link">
    <span class="md-ellipsis">
      ZeRO-3 Config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zero-0-config" class="md-nav__link">
    <span class="md-ellipsis">
      ZeRO-0 Config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zero-1-config" class="md-nav__link">
    <span class="md-ellipsis">
      ZeRO-1 Config
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nvme-support" class="md-nav__link">
    <span class="md-ellipsis">
      NVMe Support
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NVMe Support">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zero-2-vs-zero-3-performance" class="md-nav__link">
    <span class="md-ellipsis">
      ZeRO-2 vs ZeRO-3 Performance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zero-2-example" class="md-nav__link">
    <span class="md-ellipsis">
      ZeRO-2 Example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zero-3-example" class="md-nav__link">
    <span class="md-ellipsis">
      ZeRO-3 Example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-choose-which-zero-stage-and-offloads-to-use-for-best-performance" class="md-nav__link">
    <span class="md-ellipsis">
      How to Choose Which ZeRO Stage and Offloads To Use For Best Performance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activation-checkpointing-or-gradient-checkpointing" class="md-nav__link">
    <span class="md-ellipsis">
      Activation Checkpointing or Gradient Checkpointing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimizer-and-scheduler" class="md-nav__link">
    <span class="md-ellipsis">
      Optimizer and Scheduler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Optimizer and Scheduler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optimizer" class="md-nav__link">
    <span class="md-ellipsis">
      Optimizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scheduler" class="md-nav__link">
    <span class="md-ellipsis">
      Scheduler
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fp32-precision" class="md-nav__link">
    <span class="md-ellipsis">
      fp32 Precision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automatic-mixed-precision" class="md-nav__link">
    <span class="md-ellipsis">
      Automatic Mixed Precision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fp16" class="md-nav__link">
    <span class="md-ellipsis">
      fp16
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bf16" class="md-nav__link">
    <span class="md-ellipsis">
      BF16
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nccl-collectives" class="md-nav__link">
    <span class="md-ellipsis">
      NCCL Collectives
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batch-size" class="md-nav__link">
    <span class="md-ellipsis">
      Batch Size
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gradient-accumulation" class="md-nav__link">
    <span class="md-ellipsis">
      Gradient Accumulation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gradient-clipping" class="md-nav__link">
    <span class="md-ellipsis">
      Gradient Clipping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-the-model-weights-out" class="md-nav__link">
    <span class="md-ellipsis">
      Getting The Model Weights Out
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zero-3-infinity-nuances" class="md-nav__link">
    <span class="md-ellipsis">
      ZeRO-3 ã¨ Infinity Nuances
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ZeRO-3 ã¨ Infinity Nuances">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constructing-massive-models" class="md-nav__link">
    <span class="md-ellipsis">
      Constructing Massive Models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gathering-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Gathering Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zero-inference" class="md-nav__link">
    <span class="md-ellipsis">
      ZeRO Inference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Memory Requirements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filing-issues" class="md-nav__link">
    <span class="md-ellipsis">
      Filing Issues
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-deepspeed-process-gets-killed-at-startup-without-a-traceback" class="md-nav__link">
    <span class="md-ellipsis">
      the deepspeed process gets killed at startup without a traceback
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#training-andor-evalpredict-loss-is-nan" class="md-nav__link">
    <span class="md-ellipsis">
      training and/or eval/predict loss is NaN
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#non-trainer-deepspeed-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Non-Trainer Deepspeed Integration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hfdeepspeedconfig" class="md-nav__link">
    <span class="md-ellipsis">
      HfDeepSpeedConfig
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HfDeepSpeedConfig">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#custom-deepspeed-zero-inference" class="md-nav__link">
    <span class="md-ellipsis">
      Custom DeepSpeed ZeRO Inference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-nuances" class="md-nav__link">
    <span class="md-ellipsis">
      generate nuances
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deepspeed" class="md-nav__link">
    <span class="md-ellipsis">
      Deepspeed çµ±åˆã®ãƒ†ã‚¹ãƒˆ
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main-deepspeed-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Main DeepSpeed Resources
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<!--Copyright 2020 The HuggingFace Team. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with
the License. You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.

âš ï¸ Note that this file is in Markdown but contain specific syntax for our doc-builder (similar to MDX) that may not be
rendered properly in your Markdown viewer.

-->

<h1 id="deepspeed-integration">DeepSpeed Integration</h1>
<p><a href="https://github.com/deepspeedai/DeepSpeed">DeepSpeed</a> ã¯ã€<a href="https://huggingface.co/papers/1910.02054">ZeRO è«–æ–‡</a> ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ç¾åœ¨ã€æ¬¡ã®ã‚‚ã®ã‚’å®Œå…¨ã«ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚</p>
<ol>
<li>ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã®çŠ¶æ…‹åˆ†å‰² (ZeRO ã‚¹ãƒ†ãƒ¼ã‚¸ 1)</li>
<li>å‹¾é…åˆ†å‰² (ZeRO ã‚¹ãƒ†ãƒ¼ã‚¸ 2)</li>
<li>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®åˆ†å‰² (ZeRO ã‚¹ãƒ†ãƒ¼ã‚¸ 3)</li>
<li>ã‚«ã‚¹ã‚¿ãƒ æ··åˆç²¾åº¦ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å‡¦ç†</li>
<li>ä¸€é€£ã®é«˜é€Ÿ CUDA æ‹¡å¼µãƒ™ãƒ¼ã‚¹ã®ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼</li>
<li>CPU ãŠã‚ˆã³ NVMe ã¸ã® ZeRO ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰</li>
</ol>
<p>ZeRO-Offload ã«ã¯ç‹¬è‡ªã®å°‚ç”¨ãƒšãƒ¼ãƒ‘ãƒ¼ãŒã‚ã‚Šã¾ã™: <a href="https://huggingface.co/papers/2101.06840">ZeRO-Offload: Democratizing Billion-Scale Model Training</a>ã€‚ NVMe ã‚µãƒãƒ¼ãƒˆã«ã¤ã„ã¦ã¯ã€è«–æ–‡ <a href="https://huggingface.co/papers/2104.07857">ZeRO-Infinity: Breaking the GPU Memory Wall for Extreme Scale Deep Learning</a>ã€‚</p>
<p>DeepSpeed ZeRO-2 ã¯ã€ãã®æ©Ÿèƒ½ãŒæ¨è«–ã«ã¯å½¹ã«ç«‹ãŸãªã„ãŸã‚ã€ä¸»ã«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®ã¿ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</p>
<p>DeepSpeed ZeRO-3 ã¯ã€å·¨å¤§ãªãƒ¢ãƒ‡ãƒ«ã‚’è¤‡æ•°ã® GPU ã«ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ãŸã‚ã€æ¨è«–ã«ã‚‚ä½¿ç”¨ã§ãã¾ã™ã€‚
å˜ä¸€ã® GPU ã§ã¯ä¸å¯èƒ½ã§ã™ã€‚</p>
<p>ğŸ¤— Transformers ã¯ã€2 ã¤ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»‹ã—ã¦ <a href="https://github.com/deepspeedai/DeepSpeed">DeepSpeed</a> ã‚’çµ±åˆã—ã¾ã™ã€‚</p>
<ol>
<li>[<code>Trainer</code>] ã«ã‚ˆã‚‹ã‚³ã‚¢ DeepSpeed æ©Ÿèƒ½ã®çµ±åˆã€‚ä½•ã§ã‚‚ã‚„ã£ã¦ãã‚Œã‚‹ã‚¿ã‚¤ãƒ—ã§ã™
   çµ±åˆã®å ´åˆ - ã‚«ã‚¹ã‚¿ãƒ æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã™ã‚‹ã‹ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã ã‘ã§ã€ä»–ã«ä½•ã‚‚ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãŸã„ã¦ã„ã®
   ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã“ã®æ©Ÿèƒ½ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚</li>
<li>[<code>Trainer</code>] ã‚’ä½¿ç”¨ã›ãšã€DeepSpeed ã‚’çµ±åˆã—ãŸç‹¬è‡ªã®ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã‚’ä½¿ç”¨ã—ãŸã„å ´åˆ
   <code>from_pretrained</code> ã‚„ <code>from_config</code> ãªã©ã®ã‚³ã‚¢æ©Ÿèƒ½ã«ã¯ã€é‡è¦ãªæ©Ÿèƒ½ã®çµ±åˆãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
   ZeRO ã‚¹ãƒ†ãƒ¼ã‚¸ 3 ä»¥é™ã® <code>zero.Init</code>ãªã©ã® DeepSpeed ã®éƒ¨åˆ†ã€‚ã“ã®æ©Ÿèƒ½ã‚’æ´»ç”¨ã™ã‚‹ã«ã¯ã€æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãŠèª­ã¿ãã ã•ã„ã€‚
   <a href="#nontrainer-deepspeed-integration">éãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ DeepSpeed çµ±åˆ</a>ã€‚</li>
</ol>
<p>çµ±åˆã•ã‚Œã¦ã„ã‚‹ã‚‚ã®:</p>
<p>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼š</p>
<ol>
<li>DeepSpeed ZeRO ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¯ã€ZeRO-Infinity (CPU ãŠã‚ˆã³ NVME ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰) ã‚’ä½¿ç”¨ã—ã¦å®Œå…¨ãª ZeRO ã‚¹ãƒ†ãƒ¼ã‚¸ 1ã€2ã€ãŠã‚ˆã³ 3 ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚</li>
</ol>
<p>æ¨è«–ï¼š</p>
<ol>
<li>DeepSpeed ZeRO Inference ã¯ã€ZeRO-Infinity ã«ã‚ˆã‚‹ ZeRO ã‚¹ãƒ†ãƒ¼ã‚¸ 3 ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨åŒã˜ ZeRO ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ãŒã€
   ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã¨ lr ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã¯ä½¿ç”¨ã›ãšã€ã‚¹ãƒ†ãƒ¼ã‚¸ 3 ã®ã¿ãŒé–¢é€£ã—ã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
   <a href="#zero-inference">ã‚¼ãƒ­æ¨è«–</a>ã€‚</li>
</ol>
<p>DeepSpeed Inference ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€Tensor Parallelism ã®ä»£ã‚ã‚Šã« Tensor Parallelism ã‚’ä½¿ç”¨ã™ã‚‹ã¾ã£ãŸãç•°ãªã‚‹ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã§ã™ã€‚
ZeRO (è¿‘æ—¥å…¬é–‹)ã€‚</p>
<p><a id='deepspeed-trainer-integration'></a></p>
<h2 id="trainer-deepspeed-integration">Trainer Deepspeed Integration</h2>
<p><a id='deepspeed-installation'></a></p>
<h3 id="installation">Installation</h3>
<p>pypi çµŒç”±ã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>pip<span class="w"> </span>install<span class="w"> </span>deepspeed
</span></code></pre></div></p>
<p>ã¾ãŸã¯<code>tansformers</code>, <code>extras</code>çµŒç”±:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>pip<span class="w"> </span>install<span class="w"> </span>transformers<span class="o">[</span>deepspeed<span class="o">]</span>
</span></code></pre></div>
<p>ã¾ãŸã¯ã€<a href="https://github.com/deepspeedai/DeepSpeed#installation">DeepSpeed ã® GitHub ãƒšãƒ¼ã‚¸</a> ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
<a href="https://www.deepspeed.ai/tutorials/advanced-install/">é«˜åº¦ãªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</a>ã€‚</p>
<p>ãã‚Œã§ã‚‚ãƒ“ãƒ«ãƒ‰ã«è‹¦åŠ´ã™ã‚‹å ´åˆã¯ã€ã¾ãš <a href="trainer#cuda-extension-installation-notes">CUDA æ‹¡å¼µæ©Ÿèƒ½ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ãƒãƒ¼ãƒˆ</a> ã‚’å¿…ãšèª­ã‚“ã§ãã ã•ã„ã€‚</p>
<p>æ‹¡å¼µæ©Ÿèƒ½ã‚’äº‹å‰ãƒ“ãƒ«ãƒ‰ã›ãšã€å®Ÿè¡Œæ™‚ã«æ‹¡å¼µæ©Ÿèƒ½ãŒãƒ“ãƒ«ãƒ‰ã•ã‚Œã‚‹ã“ã¨ã«ä¾å­˜ã—ã¦ãŠã‚Šã€ä¸Šè¨˜ã®è§£æ±ºç­–ã‚’ã™ã¹ã¦è©¦ã—ãŸå ´åˆ
ãã‚ŒãŒå½¹ã«ç«‹ãŸãªã‹ã£ãŸå ´åˆã€æ¬¡ã«è©¦ã™ã¹ãã“ã¨ã¯ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å‰ã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’äº‹å‰ã«ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã“ã¨ã§ã™ã€‚</p>
<p>DeepSpeed ã®ãƒ­ãƒ¼ã‚«ãƒ« ãƒ“ãƒ«ãƒ‰ã‚’ä½œæˆã™ã‚‹ã«ã¯:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/deepspeedai/DeepSpeed/
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="nb">cd</span><span class="w"> </span>DeepSpeed
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>rm<span class="w"> </span>-rf<span class="w"> </span>build
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="nv">TORCH_CUDA_ARCH_LIST</span><span class="o">=</span><span class="s2">&quot;8.6&quot;</span><span class="w"> </span><span class="nv">DS_BUILD_CPU_ADAM</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">DS_BUILD_UTILS</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>.<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>--global-option<span class="o">=</span><span class="s2">&quot;build_ext&quot;</span><span class="w"> </span>--global-option<span class="o">=</span><span class="s2">&quot;-j8&quot;</span><span class="w"> </span>--no-cache<span class="w"> </span>-v<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>--disable-pip-version-check<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>build.log
</span></code></pre></div>
<p>NVMe ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ä¸Šè¨˜ã®æ‰‹é †ã«<code>DS_BUILD_AIO=1</code>ã‚’å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ (ã¾ãŸã€
<em>libaio-dev</em> ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™)ã€‚</p>
<p><code>TORCH_CUDA_ARCH_LIST</code> ã‚’ç·¨é›†ã—ã¦ã€ä½¿ç”¨ã™ã‚‹ GPU ã‚«ãƒ¼ãƒ‰ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã—ã¾ã™ã€‚ã™ã¹ã¦ã‚’ä»®å®šã™ã‚‹ã¨
ã‚ãªãŸã®ã‚«ãƒ¼ãƒ‰ã¯åŒã˜ã§ã€æ¬¡ã®æ–¹æ³•ã§ã‚¢ãƒ¼ãƒã‚’å–å¾—ã§ãã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import torch; print(torch.cuda.get_device_capability())&quot;</span>
</span></code></pre></div>
<p>ã—ãŸãŒã£ã¦ã€<code>8, 6</code>ã‚’å–å¾—ã—ãŸå ´åˆã¯ã€<code>TORCH_CUDA_ARCH_LIST="8.6"</code>ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚è¤‡æ•°ã®ç•°ãªã‚‹ã‚«ãƒ¼ãƒ‰ã‚’ãŠæŒã¡ã®å ´åˆã¯ã€ã™ã¹ã¦ã‚’ãƒªã‚¹ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™
ãã‚Œã‚‰ã®ã†ã¡ã€<code>TORCH_CUDA_ARCH_LIST="6.1;8.6"</code>ãŒå¥½ãã§ã™</p>
<p>è¤‡æ•°ã®ãƒã‚·ãƒ³ã§åŒã˜ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€ãƒã‚¤ãƒŠãƒª ãƒ›ã‚¤ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/deepspeedai/DeepSpeed/
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="nb">cd</span><span class="w"> </span>DeepSpeed
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>rm<span class="w"> </span>-rf<span class="w"> </span>build
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="nv">TORCH_CUDA_ARCH_LIST</span><span class="o">=</span><span class="s2">&quot;8.6&quot;</span><span class="w"> </span><span class="nv">DS_BUILD_CPU_ADAM</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">DS_BUILD_UTILS</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>python<span class="w"> </span>setup.py<span class="w"> </span>build_ext<span class="w"> </span>-j8<span class="w"> </span>bdist_wheel
</span></code></pre></div>
<p><code>dist/deepspeed-0.3.13+8cd046f-cp38-cp38-linux_x86_64.whl</code>ã®ã‚ˆã†ãªã‚‚ã®ãŒç”Ÿæˆã•ã‚Œã‚‹ã®ã§ã€ã“ã‚Œã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™
<code>pip install deepspeed-0.3.13+8cd046f-cp38-cp38-linux_x86_64.whl</code>ã¨ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã¾ãŸã¯ä»–ã®ãƒã‚·ãƒ³ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚</p>
<p>ç¹°ã‚Šè¿”ã—ã¾ã™ãŒã€<code>TORCH_CUDA_ARCH_LIST</code>ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«åˆã‚ã›ã¦èª¿æ•´ã™ã‚‹ã“ã¨ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ã€‚</p>
<p>NVIDIA GPU ã®å®Œå…¨ãªãƒªã‚¹ãƒˆã¨ã€ãã‚Œã«å¯¾å¿œã™ã‚‹ <strong>ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ©Ÿèƒ½</strong> (ã“ã®è¨˜äº‹ã® Arch ã¨åŒã˜) ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ) <a href="https://developer.nvidia.com/cuda-gpus">ã“ã“</a>ã€‚</p>
<p>ä»¥ä¸‹ã‚’ä½¿ç”¨ã—ã¦ã€pytorch ãŒæ§‹ç¯‰ã•ã‚ŒãŸã‚¢ãƒ¼ãƒã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import torch; print(torch.cuda.get_arch_list())&quot;</span>
</span></code></pre></div>
<p>ã“ã“ã§ã¯ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ GPU ã® 1 ã¤ã®ã‚¢ãƒ¼ãƒã‚’è¦‹ã¤ã‘ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚ãŸã¨ãˆã°ã€GPU 0 ã®å ´åˆ:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import torch; \</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="s2">print(torch.cuda.get_device_properties(torch.device(&#39;cuda&#39;)))&quot;</span>
</span></code></pre></div>
<p>å‡ºåŠ›ãŒæ¬¡ã®å ´åˆ:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>_CudaDeviceProperties<span class="o">(</span><span class="nv">name</span><span class="o">=</span><span class="s1">&#39;GeForce RTX 3090&#39;</span>,<span class="w"> </span><span class="nv">major</span><span class="o">=</span><span class="m">8</span>,<span class="w"> </span><span class="nv">minor</span><span class="o">=</span><span class="m">6</span>,<span class="w"> </span><span class="nv">total_memory</span><span class="o">=</span>24268MB,<span class="w"> </span><span class="nv">multi_processor_count</span><span class="o">=</span><span class="m">82</span><span class="o">)</span>
</span></code></pre></div>
<p>ãã†ã™ã‚Œã°ã€ã“ã®ã‚«ãƒ¼ãƒ‰ã®ã‚¢ãƒ¼ãƒãŒ<code>8.6</code>ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚</p>
<p><code>TORCH_CUDA_ARCH_LIST</code> ã‚’å®Œå…¨ã«çœç•¥ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ãã†ã™ã‚Œã°ã€ãƒ“ãƒ«ãƒ‰ ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒè‡ªå‹•çš„ã«ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
ãƒ“ãƒ«ãƒ‰ãŒè¡Œã‚ã‚Œã‚‹ GPU ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€‚ã“ã‚Œã¯ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ ãƒã‚·ãƒ³ã® GPU ã¨ä¸€è‡´ã™ã‚‹å ´åˆã‚‚ã‚ã‚Œã°ã€ä¸€è‡´ã—ãªã„å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚
ç›®çš„ã®ã‚¢ãƒ¼ãƒã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚</p>
<p>ææ¡ˆã•ã‚ŒãŸã“ã¨ã‚’ã™ã¹ã¦è©¦ã—ã¦ã‚‚ã¾ã ãƒ“ãƒ«ãƒ‰ã®å•é¡ŒãŒç™ºç”Ÿã™ã‚‹å ´åˆã¯ã€GitHub ã®å•é¡Œã«é€²ã‚“ã§ãã ã•ã„ã€‚
<a href="https://github.com/deepspeedai/DeepSpeed/issues">ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¹ãƒ”ãƒ¼ãƒ‰</a>ã€</p>
<p><a id='deepspeed-multi-gpu'></a></p>
<h3 id="deployment-with-multiple-gpus">Deployment with multiple GPUs</h3>
<p>DeepSpeed çµ±åˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã«ã¯ã€[<code>Trainer</code>] ã‚³ãƒãƒ³ãƒ‰ ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’èª¿æ•´ã—ã¦æ–°ã—ã„å¼•æ•° <code>--deepspeed ds_config.json</code> ã‚’å«ã‚ã¾ã™ã€‚ã“ã“ã§ã€<code>ds_config.json</code> ã¯ DeepSpeed æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚
   <a href="https://www.deepspeed.ai/docs/config-json/">ã“ã¡ã‚‰</a>ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã‚ãªãŸæ¬¡ç¬¬ã§ã™ã€‚
   DeepSpeed ã®<code>add_config_arguments</code>ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½¿ç”¨ã—ã¦ã€å¿…è¦ãªã‚³ãƒãƒ³ãƒ‰ ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’ã‚³ãƒ¼ãƒ‰ã«è¿½åŠ ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
   è©³ç´°ã«ã¤ã„ã¦ã¯ã€<a href="https://deepspeed.readthedocs.io/en/latest/initialize.html#argument-parsing">DeepSpeed ã®å¼•æ•°è§£æ</a> ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
<p>ã“ã“ã§é¸æŠã—ãŸãƒ©ãƒ³ãƒãƒ£ãƒ¼ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚ pytorch ãƒ©ãƒ³ãƒãƒ£ãƒ¼ã‚’å¼•ãç¶šãä½¿ç”¨ã§ãã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>torch.distributed.run<span class="w"> </span>--nproc_per_node<span class="o">=</span><span class="m">2</span><span class="w"> </span>your_program.py<span class="w"> </span>&lt;normal<span class="w"> </span>cl<span class="w"> </span>args&gt;<span class="w"> </span>--deepspeed<span class="w"> </span>ds_config.json
</span></code></pre></div>
<p>ã¾ãŸã¯ã€<code>deepspeed</code>ã«ã‚ˆã£ã¦æä¾›ã•ã‚Œã‚‹ãƒ©ãƒ³ãƒãƒ£ãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>deepspeed<span class="w"> </span>--num_gpus<span class="o">=</span><span class="m">2</span><span class="w"> </span>your_program.py<span class="w"> </span>&lt;normal<span class="w"> </span>cl<span class="w"> </span>args&gt;<span class="w"> </span>--deepspeed<span class="w"> </span>ds_config.json
</span></code></pre></div>
<p>ã”è¦§ã®ã¨ãŠã‚Šã€å¼•æ•°ã¯åŒã˜ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã»ã¨ã‚“ã©ã®ãƒ‹ãƒ¼ã‚ºã§ã¯ã©ã¡ã‚‰ã§ã‚‚æ©Ÿèƒ½ã—ã¾ã™ã€‚ã®
ã•ã¾ã–ã¾ãªãƒãƒ¼ãƒ‰ã¨ GPU ã‚’æ§‹æˆã™ã‚‹æ–¹æ³•ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€<a href="https://www.deepspeed.ai/getting-started/#resource-configuration-multi-node">ã“ã¡ã‚‰</a> ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
<p><code>deepspeed</code>ãƒ©ãƒ³ãƒãƒ£ãƒ¼ã‚’ä½¿ç”¨ã—ã€åˆ©ç”¨å¯èƒ½ãªã™ã¹ã¦ã® GPU ã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã¯ã€<code>--num_gpus</code>ãƒ•ãƒ©ã‚°ã‚’çœç•¥ã™ã‚‹ã ã‘ã§ã™ã€‚</p>
<p>ä»¥ä¸‹ã¯ã€åˆ©ç”¨å¯èƒ½ãªã™ã¹ã¦ã® GPU ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ DeepSpeed ã§<code>run_translation.py</code>ã‚’å®Ÿè¡Œã™ã‚‹ä¾‹ã§ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>deepspeed<span class="w"> </span>examples/pytorch/translation/run_translation.py<span class="w"> </span><span class="se">\</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>--deepspeed<span class="w"> </span>tests/deepspeed/ds_config_zero3.json<span class="w"> </span><span class="se">\</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>--model_name_or_path<span class="w"> </span>google-t5/t5-small<span class="w"> </span>--per_device_train_batch_size<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>--output_dir<span class="w"> </span>output_dir<span class="w"> </span>--fp16<span class="w"> </span><span class="se">\</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>--do_train<span class="w"> </span>--max_train_samples<span class="w"> </span><span class="m">500</span><span class="w"> </span>--num_train_epochs<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>--dataset_name<span class="w"> </span>wmt16<span class="w"> </span>--dataset_config<span class="w"> </span><span class="s2">&quot;ro-en&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>--source_lang<span class="w"> </span>en<span class="w"> </span>--target_lang<span class="w"> </span>ro
</span></code></pre></div>
<p>DeepSpeed ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ã€<code>--deepspeed --deepspeed_config ds_config.json</code>ãŒè¡¨ç¤ºã•ã‚Œã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
DeepSpeed é–¢é€£ã®å¼•æ•°ãŒ 2 ã¤ã‚ã‚Šã¾ã™ãŒã€ç°¡å˜ã«ã™ã‚‹ãŸã‚ã§ã‚ã‚Šã€å‡¦ç†ã™ã¹ãå¼•æ•°ãŒã™ã§ã«éå¸¸ã«å¤šã„ãŸã‚ã§ã™ã€‚
ã“ã® 2 ã¤ã‚’ 1 ã¤ã®å¼•æ•°ã«çµåˆã—ã¾ã—ãŸã€‚</p>
<p>å®Ÿéš›ã®ä½¿ç”¨ä¾‹ã«ã¤ã„ã¦ã¯ã€ã“ã® <a href="https://github.com/huggingface/transformers/issues/8771#issuecomment-759248400">æŠ•ç¨¿</a> ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
<p><a id='deepspeed-one-gpu'></a></p>
<h3 id="deployment-with-one-gpu">Deployment with one GPU</h3>
<p>1 ã¤ã® GPU ã§ DeepSpeed ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã«ã¯ã€[<code>Trainer</code>] ã‚³ãƒãƒ³ãƒ‰ ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’æ¬¡ã®ã‚ˆã†ã«èª¿æ•´ã—ã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>deepspeed<span class="w"> </span>--num_gpus<span class="o">=</span><span class="m">1</span><span class="w"> </span>examples/pytorch/translation/run_translation.py<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>--deepspeed<span class="w"> </span>tests/deepspeed/ds_config_zero2.json<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>--model_name_or_path<span class="w"> </span>google-t5/t5-small<span class="w"> </span>--per_device_train_batch_size<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>--output_dir<span class="w"> </span>output_dir<span class="w"> </span>--fp16<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>--do_train<span class="w"> </span>--max_train_samples<span class="w"> </span><span class="m">500</span><span class="w"> </span>--num_train_epochs<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>--dataset_name<span class="w"> </span>wmt16<span class="w"> </span>--dataset_config<span class="w"> </span><span class="s2">&quot;ro-en&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>--source_lang<span class="w"> </span>en<span class="w"> </span>--target_lang<span class="w"> </span>ro
</span></code></pre></div>
<p>ã“ã‚Œã¯è¤‡æ•°ã® GPU ã®å ´åˆã¨ã»ã¼åŒã˜ã§ã™ãŒã€ã“ã“ã§ã¯ã€DeepSpeed ã« 1 ã¤ã® GPU ã ã‘ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«æ˜ç¤ºçš„ã«æŒ‡ç¤ºã—ã¾ã™ã€‚
<code>--num_gpus=1</code>ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€DeepSpeed ã¯æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ãƒ‰ä¸Šã§èªè­˜ã§ãã‚‹ã™ã¹ã¦ã® GPU ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚èµ·å‹•ã™ã‚‹ GPU ãŒ 1 ã¤ã ã‘ã®å ´åˆ
ã®å ´åˆã€ã“ã®å¼•æ•°ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚æ¬¡ã® <a href="https://www.deepspeed.ai/getting-started/#resource-configuration-multi-node">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a> ã§ã¯ã€ãƒ©ãƒ³ãƒãƒ£ãƒ¼ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚</p>
<p>1 ã¤ã® GPU ã ã‘ã§ DeepSpeed ã‚’ä½¿ç”¨ã—ãŸã„ã®ã¯ãªãœã§ã™ã‹?</p>
<ol>
<li>ä¸€éƒ¨ã®è¨ˆç®—ã¨ãƒ¡ãƒ¢ãƒªã‚’ãƒ›ã‚¹ãƒˆã® CPU ã¨ RAM ã«å§”ä»»ã§ãã‚‹ ZeRO ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’å‚™ãˆã¦ã„ã‚‹ãŸã‚ã€
   ãƒ¢ãƒ‡ãƒ«ã®ãƒ‹ãƒ¼ã‚ºã«åˆã‚ã›ã¦ã‚ˆã‚Šå¤šãã® GPU ãƒªã‚½ãƒ¼ã‚¹ã‚’æ®‹ã—ã¦ãŠãã¾ã™ã€‚ã‚ˆã‚Šå¤§ããªãƒãƒƒãƒ ã‚µã‚¤ã‚ºã€ã¾ãŸã¯éå¸¸ã«å¤§ããªãƒ¢ãƒ‡ãƒ«ã®ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚’å¯èƒ½ã«ã™ã‚‹
   æ™®é€šã¯åˆã‚ãªã„ã§ã—ã‚‡ã†ã€‚</li>
<li>ã‚¹ãƒãƒ¼ãƒˆãª GPU ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’æä¾›ã—ã€ãƒ¡ãƒ¢ãƒªã®æ–­ç‰‡åŒ–ã‚’æœ€å°é™ã«æŠ‘ãˆã¾ã™ã€‚
   ã‚ˆã‚Šå¤§ããªãƒ¢ãƒ‡ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ ãƒãƒƒãƒã€‚</li>
</ol>
<p>æ¬¡ã«æ§‹æˆã«ã¤ã„ã¦è©³ã—ãèª¬æ˜ã—ã¾ã™ãŒã€å˜ä¸€ã® GPU ã§å¤§å¹…ãªæ”¹å–„ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®éµã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚
DeepSpeed ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã«å°‘ãªãã¨ã‚‚æ¬¡ã®æ§‹æˆãŒå¿…è¦ã§ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="p">{</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">  </span><span class="nt">&quot;zero_optimization&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">     </span><span class="nt">&quot;stage&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">     </span><span class="nt">&quot;offload_optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">         </span><span class="nt">&quot;device&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">         </span><span class="nt">&quot;pin_memory&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">     </span><span class="p">},</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">     </span><span class="nt">&quot;allgather_partitions&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">     </span><span class="nt">&quot;allgather_bucket_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">2e8</span><span class="p">,</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">     </span><span class="nt">&quot;reduce_scatter&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">     </span><span class="nt">&quot;reduce_bucket_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">2e8</span><span class="p">,</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">     </span><span class="nt">&quot;overlap_comm&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">     </span><span class="nt">&quot;contiguous_gradients&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="p">}</span>
</span></code></pre></div>
<p>ã“ã‚Œã«ã‚ˆã‚Šã€ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã®ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã‚„ãã®ä»–ã®é‡è¦ãªæ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚ãƒãƒƒãƒ•ã‚¡ ã‚µã‚¤ã‚ºã‚’è©¦ã—ã¦ã¿ã‚‹ã¨ã‚ˆã„ã§ã—ã‚‡ã†ã€‚
è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
<p>ã“ã®ã‚¿ã‚¤ãƒ—ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®å®Ÿéš›çš„ãªä½¿ç”¨ä¾‹ã«ã¤ã„ã¦ã¯ã€ã“ã® <a href="https://github.com/huggingface/transformers/issues/8771#issuecomment-759176685">æŠ•ç¨¿</a> ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
<p>ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§è©³ã—ãèª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€CPU ãŠã‚ˆã³ NVMe ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã‚’å‚™ãˆãŸ ZeRO-3 ã‚’è©¦ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
<p>ãƒãƒ¼ãƒˆï¼š</p>
<ul>
<li>GPU 0 ã¨ã¯ç•°ãªã‚‹ç‰¹å®šã® GPU ã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã€<code>CUDA_VISIBLE_DEVICES</code> ã‚’ä½¿ç”¨ã—ã¦åˆ¶é™ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
  åˆ©ç”¨å¯èƒ½ãª GPU ã®è¡¨ç¤ºç¯„å›²ã€‚ä»£ã‚ã‚Šã«ã€æ¬¡ã®æ§‹æ–‡ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>deepspeed<span class="w"> </span>--include<span class="w"> </span>localhost:1<span class="w"> </span>examples/pytorch/translation/run_translation.py<span class="w"> </span>...
</span></code></pre></div>
<p>ã“ã®ä¾‹ã§ã¯ã€DeepSpeed ã« GPU 1 (2 ç•ªç›®ã® GPU) ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«æŒ‡ç¤ºã—ã¾ã™ã€‚</p>
<p><a id='deepspeed-multi-node'></a></p>
<h3 id="_1">è¤‡æ•°ã®ãƒãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ãŸãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ</h3>
<p>ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æƒ…å ±ã¯ DeepSpeed çµ±åˆã«å›ºæœ‰ã®ã‚‚ã®ã§ã¯ãªãã€ã‚ã‚‰ã‚†ã‚‹ãƒãƒ«ãƒãƒãƒ¼ãƒ‰ ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«é©ç”¨ã§ãã¾ã™ã€‚ãŸã ã—ã€DeepSpeed ã¯ã€SLURM ç’°å¢ƒã§ãªã„é™ã‚Šã€ä»–ã®ãƒ©ãƒ³ãƒãƒ£ãƒ¼ã‚ˆã‚Šã‚‚ä½¿ã„ã‚„ã™ã„<code>deepspeed</code>ãƒ©ãƒ³ãƒãƒ£ãƒ¼ã‚’æä¾›ã—ã¾ã™ã€‚</p>
<p>ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ãã‚Œãã‚Œ 8 GPU ã‚’å‚™ãˆãŸ 2 ã¤ã®ãƒãƒ¼ãƒ‰ãŒã‚ã‚‹ã¨ä»®å®šã—ã¾ã™ã€‚ã¾ãŸã€æœ€åˆã®ãƒãƒ¼ãƒ‰ã«ã¯ <code>ssh hostname1</code> ã‚’ä½¿ç”¨ã—ã¦ã€2 ç•ªç›®ã®ãƒãƒ¼ãƒ‰ã«ã¯ <code>ssh hostname2</code> ã‚’ä½¿ç”¨ã—ã¦æ¥ç¶šã§ãã¾ã™ã€‚ä¸¡æ–¹ã¨ã‚‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—ã§ãƒ­ãƒ¼ã‚«ãƒ«ã® ssh çµŒç”±ã§ç›¸äº’ã«æ¥ç¶šã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚‚ã¡ã‚ã‚“ã€ã“ã‚Œã‚‰ã®ãƒ›ã‚¹ãƒˆ (ãƒãƒ¼ãƒ‰) åã‚’ã€ä½œæ¥­ã—ã¦ã„ã‚‹å®Ÿéš›ã®ãƒ›ã‚¹ãƒˆåã«å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<h4 id="the-torchdistributedrun-launcher">The torch.distributed.run launcher</h4>
<p>ãŸã¨ãˆã°ã€<code>torch.distributed.run</code> ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>python<span class="w"> </span>-m<span class="w"> </span>torch.distributed.run<span class="w"> </span>--nproc_per_node<span class="o">=</span><span class="m">8</span><span class="w"> </span>--nnode<span class="o">=</span><span class="m">2</span><span class="w"> </span>--node_rank<span class="o">=</span><span class="m">0</span><span class="w"> </span>--master_addr<span class="o">=</span>hostname1<span class="w"> </span><span class="se">\</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>--master_port<span class="o">=</span><span class="m">9901</span><span class="w"> </span>your_program.py<span class="w"> </span>&lt;normal<span class="w"> </span>cl<span class="w"> </span>args&gt;<span class="w"> </span>--deepspeed<span class="w"> </span>ds_config.json
</span></code></pre></div>
<p>å„ãƒãƒ¼ãƒ‰ã« SSH ã§æ¥ç¶šã—ã€ãã‚Œãã‚Œã®ãƒãƒ¼ãƒ‰ã§åŒã˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æ€¥ãå¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ©ãƒ³ãƒãƒ£ãƒ¼ã¯ä¸¡æ–¹ã®ãƒãƒ¼ãƒ‰ãŒåŒæœŸã™ã‚‹ã¾ã§å¾…æ©Ÿã—ã¾ã™ã€‚</p>
<p>è©³ç´°ã«ã¤ã„ã¦ã¯ã€<a href="https://pytorch.org/docs/stable/elastic/run.html">torchrun</a> ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ã¡ãªã¿ã«ã€ã“ã‚Œã¯ pytorch ã®æ•°ãƒãƒ¼ã‚¸ãƒ§ãƒ³å‰ã®<code>torch.distributed.launch</code>ã‚’ç½®ãæ›ãˆãŸãƒ©ãƒ³ãƒãƒ£ãƒ¼ã§ã‚‚ã‚ã‚Šã¾ã™ã€‚</p>
<h4 id="_2">ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¹ãƒ”ãƒ¼ãƒ‰ ãƒ©ãƒ³ãƒãƒ£ãƒ¼</h4>
<p>ä»£ã‚ã‚Šã«<code>deepspeed</code>ãƒ©ãƒ³ãƒãƒ£ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ã¾ãš<code>hostfile</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>hostname1<span class="w"> </span><span class="nv">slots</span><span class="o">=</span><span class="m">8</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>hostname2<span class="w"> </span><span class="nv">slots</span><span class="o">=</span><span class="m">8</span>
</span></code></pre></div>
<p>ãã—ã¦ã€æ¬¡ã®ã‚ˆã†ã«èµ·å‹•ã§ãã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>deepspeed<span class="w"> </span>--num_gpus<span class="w"> </span><span class="m">8</span><span class="w"> </span>--num_nodes<span class="w"> </span><span class="m">2</span><span class="w"> </span>--hostfile<span class="w"> </span>hostfile<span class="w"> </span>--master_addr<span class="w"> </span>hostname1<span class="w"> </span>--master_port<span class="o">=</span><span class="m">9901</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>your_program.py<span class="w"> </span>&lt;normal<span class="w"> </span>cl<span class="w"> </span>args&gt;<span class="w"> </span>--deepspeed<span class="w"> </span>ds_config.json
</span></code></pre></div>
<p><code>torch.distributed.run</code>ãƒ©ãƒ³ãƒãƒ£ãƒ¼ã¨ã¯ç•°ãªã‚Šã€<code>deepspeed</code>ã¯ä¸¡æ–¹ã®ãƒãƒ¼ãƒ‰ã§ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’è‡ªå‹•çš„ã«èµ·å‹•ã—ã¾ã™ã€‚</p>
<p>è©³ç´°ã«ã¤ã„ã¦ã¯ã€<a href="https://www.deepspeed.ai/getting-started/#resource-configuration-multi-node">ãƒªã‚½ãƒ¼ã‚¹æ§‹æˆ (ãƒãƒ«ãƒãƒãƒ¼ãƒ‰)</a> ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
<h4 id="launching-in-a-slurm-environment">Launching in a SLURM environment</h4>
<p>SLURM ç’°å¢ƒã§ã¯ã€æ¬¡ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚ä»¥ä¸‹ã¯ã€ç‰¹å®šã® SLURM ç’°å¢ƒã«é©åˆã•ã›ã‚‹ãŸã‚ã«å¿…è¦ãª slurm ã‚¹ã‚¯ãƒªãƒ—ãƒˆ <code>launch.slurm</code> ã§ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1">#SBATCH --job-name=test-nodes        # name</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="c1">#SBATCH --nodes=2                    # nodes</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="c1">#SBATCH --ntasks-per-node=1          # crucial - only 1 task per dist per node!</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="c1">#SBATCH --cpus-per-task=10           # number of cores per tasks</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="c1">#SBATCH --gres=gpu:8                 # number of gpus</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="c1">#SBATCH --time 20:00:00              # maximum execution time (HH:MM:SS)</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="c1">#SBATCH --output=%x-%j.out           # output file name</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="nb">export</span><span class="w"> </span><span class="nv">GPUS_PER_NODE</span><span class="o">=</span><span class="m">8</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="nb">export</span><span class="w"> </span><span class="nv">MASTER_ADDR</span><span class="o">=</span><span class="k">$(</span>scontrol<span class="w"> </span>show<span class="w"> </span>hostnames<span class="w"> </span><span class="nv">$SLURM_JOB_NODELIST</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="k">)</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="nb">export</span><span class="w"> </span><span class="nv">MASTER_PORT</span><span class="o">=</span><span class="m">9901</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>srun<span class="w"> </span>--jobid<span class="w"> </span><span class="nv">$SLURM_JOBID</span><span class="w"> </span>bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;python -m torch.distributed.run \</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="s1"> --nproc_per_node $GPUS_PER_NODE --nnodes $SLURM_NNODES --node_rank $SLURM_PROCID \</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="s1"> --master_addr $MASTER_ADDR --master_port $MASTER_PORT \</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="s1">your_program.py &lt;normal cl args&gt; --deepspeed ds_config.json&#39;</span>
</span></code></pre></div>
<p>ã‚ã¨ã¯å®Ÿè¡Œã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã™ã‚‹ã ã‘ã§ã™ã€‚
<div class="language-bash highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>sbatch<span class="w"> </span>launch.slurm
</span></code></pre></div></p>
<h4 id="use-of-non-shared-filesystem">Use of Non-shared filesystem</h4>
<p>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€DeepSpeed ã¯ãƒãƒ«ãƒãƒãƒ¼ãƒ‰ç’°å¢ƒãŒå…±æœ‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚ã“ã‚ŒãŒå½“ã¦ã¯ã¾ã‚‰ãšã€å„ãƒãƒ¼ãƒ‰ãŒãƒ­ãƒ¼ã‚«ãƒ« ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã—ã‹å‚ç…§ã§ããªã„å ´åˆã¯ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª¿æ•´ã—ã¦ <a href="https://www.deepspeed.ai/docs/config-json/#"><code>checkpoint</code>_section</a> ã‚’å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ ã‚ªãƒ—ã‚·ãƒ§ãƒ³) ã‚’æ¬¡ã®è¨­å®šã§æŒ‡å®šã—ã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="p">{</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">  </span><span class="nt">&quot;checkpoint&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">    </span><span class="nt">&quot;use_node_local_storage&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>ã‚ã‚‹ã„ã¯ã€[<code>Trainer</code>] ã® <code>--save_on_each_node</code> å¼•æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã€ä¸Šè¨˜ã®è¨­å®šã¯è‡ªå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚</p>
<p><a id='deepspeed-notebook'></a></p>
<h3 id="deployment-in-notebooks">Deployment in Notebooks</h3>
<p>ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ã‚»ãƒ«ã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã—ã¦å®Ÿè¡Œã™ã‚‹å ´åˆã®å•é¡Œã¯ã€ä¾å­˜ã™ã‚‹é€šå¸¸ã®<code>deepspeed</code>ãƒ©ãƒ³ãƒãƒ£ãƒ¼ãŒãªã„ã“ã¨ã§ã™ã€‚
ç‰¹å®šã®è¨­å®šã§ã¯ã€ãã‚Œã‚’ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>GPU ã‚’ 1 ã¤ã ã‘ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€DeepSpeed ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° ã‚³ãƒ¼ãƒ‰ã‚’èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚‹æ–¹æ³•ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># DeepSpeed requires a distributed environment even when only one process is used.</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="c1"># This emulates a launcher in the notebook</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MASTER_ADDR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MASTER_PORT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;9994&quot;</span>  <span class="c1"># modify if RuntimeError: Address already in use</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;RANK&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LOCAL_RANK&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;WORLD_SIZE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="c1"># Now proceed as normal, plus pass the deepspeed config file</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">deepspeed</span><span class="o">=</span><span class="s2">&quot;ds_config_zero3.json&quot;</span><span class="p">)</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span></code></pre></div>
<p>æ³¨: <code>...</code> ã¯ã€é–¢æ•°ã«æ¸¡ã™é€šå¸¸ã®å¼•æ•°ã‚’è¡¨ã—ã¾ã™ã€‚</p>
<p>è¤‡æ•°ã® GPU ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€DeepSpeed ãŒå‹•ä½œã™ã‚‹ã«ã¯ãƒãƒ«ãƒãƒ—ãƒ­ã‚»ã‚¹ç’°å¢ƒã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¤ã¾ã‚Šã€ã‚ãªãŸã¯æŒã£ã¦ã„ã¾ã™
ãã®ç›®çš„ã§ãƒ©ãƒ³ãƒãƒ£ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ãŒã€ã“ã‚Œã¯ã€æç¤ºã•ã‚ŒãŸåˆ†æ•£ç’°å¢ƒã‚’ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã¯å®Ÿç¾ã§ãã¾ã›ã‚“ã€‚
ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å†’é ­ã§ã€‚</p>
<p>ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«ãã®å ´ã§æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ãŸã„å ´åˆã¯ã€å°‚ç”¨ã®
ã‚»ãƒ«ã®å†…å®¹:</p>
<p>```python no-style
%%bash
cat &lt;&lt;'EOT' &gt; ds_config_zero3.json
{
    "fp16": {
        "enabled": "auto",
        "loss_scale": 0,
        "loss_scale_window": 1000,
        "initial_scale_power": 16,
        "hysteresis": 2,
        "min_loss_scale": 1
    },</p>
<div class="language-bash highlight"><pre><span></span><code><span class="s2">&quot;optimizer&quot;</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;type&quot;</span>:<span class="w"> </span><span class="s2">&quot;AdamW&quot;</span>,
<span class="w">    </span><span class="s2">&quot;params&quot;</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="s2">&quot;lr&quot;</span>:<span class="w"> </span><span class="s2">&quot;auto&quot;</span>,
<span class="w">        </span><span class="s2">&quot;betas&quot;</span>:<span class="w"> </span><span class="s2">&quot;auto&quot;</span>,
<span class="w">        </span><span class="s2">&quot;eps&quot;</span>:<span class="w"> </span><span class="s2">&quot;auto&quot;</span>,
<span class="w">        </span><span class="s2">&quot;weight_decay&quot;</span>:<span class="w"> </span><span class="s2">&quot;auto&quot;</span>
<span class="w">    </span><span class="o">}</span>
<span class="o">}</span>,

<span class="s2">&quot;scheduler&quot;</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;type&quot;</span>:<span class="w"> </span><span class="s2">&quot;WarmupLR&quot;</span>,
<span class="w">    </span><span class="s2">&quot;params&quot;</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="s2">&quot;warmup_min_lr&quot;</span>:<span class="w"> </span><span class="s2">&quot;auto&quot;</span>,
<span class="w">        </span><span class="s2">&quot;warmup_max_lr&quot;</span>:<span class="w"> </span><span class="s2">&quot;auto&quot;</span>,
<span class="w">        </span><span class="s2">&quot;warmup_num_steps&quot;</span>:<span class="w"> </span><span class="s2">&quot;auto&quot;</span>
<span class="w">    </span><span class="o">}</span>
<span class="o">}</span>,

<span class="s2">&quot;zero_optimization&quot;</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;stage&quot;</span>:<span class="w"> </span><span class="m">3</span>,
<span class="w">    </span><span class="s2">&quot;offload_optimizer&quot;</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="s2">&quot;device&quot;</span>:<span class="w"> </span><span class="s2">&quot;cpu&quot;</span>,
<span class="w">        </span><span class="s2">&quot;pin_memory&quot;</span>:<span class="w"> </span><span class="nb">true</span>
<span class="w">    </span><span class="o">}</span>,
<span class="w">    </span><span class="s2">&quot;offload_param&quot;</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="s2">&quot;device&quot;</span>:<span class="w"> </span><span class="s2">&quot;cpu&quot;</span>,
<span class="w">        </span><span class="s2">&quot;pin_memory&quot;</span>:<span class="w"> </span><span class="nb">true</span>
<span class="w">    </span><span class="o">}</span>,
<span class="w">    </span><span class="s2">&quot;overlap_comm&quot;</span>:<span class="w"> </span>true,
<span class="w">    </span><span class="s2">&quot;contiguous_gradients&quot;</span>:<span class="w"> </span>true,
<span class="w">    </span><span class="s2">&quot;sub_group_size&quot;</span>:<span class="w"> </span>1e9,
<span class="w">    </span><span class="s2">&quot;reduce_bucket_size&quot;</span>:<span class="w"> </span><span class="s2">&quot;auto&quot;</span>,
<span class="w">    </span><span class="s2">&quot;stage3_prefetch_bucket_size&quot;</span>:<span class="w"> </span><span class="s2">&quot;auto&quot;</span>,
<span class="w">    </span><span class="s2">&quot;stage3_param_persistence_threshold&quot;</span>:<span class="w"> </span><span class="s2">&quot;auto&quot;</span>,
<span class="w">    </span><span class="s2">&quot;stage3_max_live_parameters&quot;</span>:<span class="w"> </span>1e9,
<span class="w">    </span><span class="s2">&quot;stage3_max_reuse_distance&quot;</span>:<span class="w"> </span>1e9,
<span class="w">    </span><span class="s2">&quot;stage3_gather_16bit_weights_on_model_save&quot;</span>:<span class="w"> </span><span class="nb">true</span>
<span class="o">}</span>,

<span class="s2">&quot;gradient_accumulation_steps&quot;</span>:<span class="w"> </span><span class="s2">&quot;auto&quot;</span>,
<span class="s2">&quot;gradient_clipping&quot;</span>:<span class="w"> </span><span class="s2">&quot;auto&quot;</span>,
<span class="s2">&quot;steps_per_print&quot;</span>:<span class="w"> </span><span class="m">2000</span>,
<span class="s2">&quot;train_batch_size&quot;</span>:<span class="w"> </span><span class="s2">&quot;auto&quot;</span>,
<span class="s2">&quot;train_micro_batch_size_per_gpu&quot;</span>:<span class="w"> </span><span class="s2">&quot;auto&quot;</span>,
<span class="s2">&quot;wall_clock_breakdown&quot;</span>:<span class="w"> </span><span class="nb">false</span>
</code></pre></div>
<p>}
EOT
<code>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ã‚»ãƒ«ã§ã¯ãªãé€šå¸¸ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ã‚‹å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ã«ã—ã¦`deepspeed`ã‚’é€šå¸¸ã©ãŠã‚Šèµ·å‹•ã§ãã¾ã™ã€‚
ç´°èƒã‹ã‚‰ã®ã‚·ã‚§ãƒ«ã€‚ãŸã¨ãˆã°ã€`run_translation.py` ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚ˆã†ã«èµ·å‹•ã—ã¾ã™ã€‚</code>python no-style
!git clone https://github.com/huggingface/transformers
!cd transformers; deepspeed examples/pytorch/translation/run_translation.py ...
```</p>
<p>ã¾ãŸã¯ã€<code>%%bash</code> ãƒã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚·ã‚§ãƒ« ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®è¤‡æ•°è¡Œã®ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
<p>```python no-style
%%bash</p>
<p>git clone https://github.com/huggingface/transformers
cd transformers
deepspeed examples/pytorch/translation/run_translation.py ...
<div class="language-bash highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>ãã®ã‚ˆã†ãªå ´åˆã€ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æœ€åˆã«ç¤ºã—ãŸã‚³ãƒ¼ãƒ‰ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>æ³¨:<span class="w"> </span><span class="sb">`</span>%%bash<span class="sb">`</span><span class="w"> </span>ãƒã‚¸ãƒƒã‚¯ã¯å„ªã‚Œã¦ã„ã¾ã™ãŒã€ç¾æ™‚ç‚¹ã§ã¯å‡ºåŠ›ã‚’ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ã™ã‚‹ãŸã‚ã€ãƒ—ãƒ­ã‚»ã‚¹ãŒçµ‚äº†ã™ã‚‹ã¾ã§ãƒ­ã‚°ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>å®Œäº†ã—ã¾ã™ã€‚
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>&lt;a<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s1">&#39;deepspeed-config&#39;</span>&gt;&lt;/a&gt;
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="c1">### Configuration</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ä½¿ç”¨ã§ãã‚‹<span class="w"> </span>DeepSpeed<span class="w"> </span>è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å®Œå…¨ãªã‚¬ã‚¤ãƒ‰ã«ã¤ã„ã¦ã¯ã€æ¬¡ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="o">[</span>æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ<span class="o">](</span>https://www.deepspeed.ai/docs/config-json/<span class="o">)</span><span class="w"> </span>ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>ã•ã¾ã–ã¾ãªå®Ÿéš›ã®ãƒ‹ãƒ¼ã‚ºã«å¯¾å¿œã™ã‚‹æ•°åã®<span class="w"> </span>DeepSpeed<span class="w"> </span>æ§‹æˆä¾‹ã‚’<span class="w"> </span><span class="o">[</span>DeepSpeedExamples<span class="o">](</span>https://github.com/deepspeedai/DeepSpeedExamples<span class="o">)</span>ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>ãƒªãƒã‚¸ãƒˆãƒª:
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="sb">```</span>bash
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/deepspeedai/DeepSpeedExamples
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="nb">cd</span><span class="w"> </span>DeepSpeedExamples
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>find<span class="w"> </span>.<span class="w"> </span>-name<span class="w"> </span><span class="s1">&#39;*json&#39;</span>
</span></code></pre></div></p>
<p>ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’ç¶šã‘ã¦ã€Lamb ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã‚’æ§‹æˆã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã¨ã—ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€æ¬¡ã®ä¸­ã‹ã‚‰æ¤œç´¢ã§ãã¾ã™
<code>.json</code> ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¾‹:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>grep<span class="w"> </span>-i<span class="w"> </span>Lamb<span class="w"> </span><span class="k">$(</span>find<span class="w"> </span>.<span class="w"> </span>-name<span class="w"> </span><span class="s1">&#39;*json&#39;</span><span class="k">)</span>
</span></code></pre></div>
<p>ã•ã‚‰ã«ã„ãã¤ã‹ã®ä¾‹ãŒ <a href="https://github.com/deepspeedai/DeepSpeed">ãƒ¡ã‚¤ãƒ³ ãƒªãƒã‚¸ãƒˆãƒª</a> ã«ã‚‚ã‚ã‚Šã¾ã™ã€‚</p>
<p>DeepSpeed ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€å¸¸ã« DeepSpeed æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ä¸€éƒ¨ã®æ§‹æˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã¯
ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³çµŒç”±ã§è¨­å®šã—ã¾ã™ã€‚å¾®å¦™ãªé•ã„ã«ã¤ã„ã¦ã¯ã€ã“ã®ã‚¬ã‚¤ãƒ‰ã®æ®‹ã‚Šã®éƒ¨åˆ†ã§èª¬æ˜ã—ã¾ã™ã€‚</p>
<p>DeepSpeed æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ãŒã©ã®ã‚ˆã†ãªã‚‚ã®ã‹ã‚’ç†è§£ã™ã‚‹ãŸã‚ã«ã€ZeRO ã‚¹ãƒ†ãƒ¼ã‚¸ 2 æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¬¡ã«ç¤ºã—ã¾ã™ã€‚
ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼çŠ¶æ…‹ã® CPU ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã‚’å«ã¿ã€<code>AdamW</code>ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã¨<code>WarmupLR</code>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’ä½¿ç”¨ã—ã€æ··åˆã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚
<code>--fp16</code> ãŒæ¸¡ã•ã‚ŒãŸå ´åˆã®ç²¾åº¦ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°:</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="p">{</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">    </span><span class="nt">&quot;fp16&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">        </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">        </span><span class="nt">&quot;loss_scale&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">        </span><span class="nt">&quot;loss_scale_window&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">        </span><span class="nt">&quot;initial_scale_power&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="w">        </span><span class="nt">&quot;hysteresis&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="w">        </span><span class="nt">&quot;min_loss_scale&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="w">    </span><span class="nt">&quot;optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AdamW&quot;</span><span class="p">,</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="w">        </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="w">            </span><span class="nt">&quot;lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="w">            </span><span class="nt">&quot;betas&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="w">            </span><span class="nt">&quot;eps&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="w">            </span><span class="nt">&quot;weight_decay&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span>
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a>
</span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a><span class="w">    </span><span class="nt">&quot;scheduler&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-22"><a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;WarmupLR&quot;</span><span class="p">,</span>
</span><span id="__span-24-23"><a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a><span class="w">        </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-24"><a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a><span class="w">            </span><span class="nt">&quot;warmup_min_lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-24-25"><a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a><span class="w">            </span><span class="nt">&quot;warmup_max_lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-24-26"><a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a><span class="w">            </span><span class="nt">&quot;warmup_num_steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span>
</span><span id="__span-24-27"><a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-24-28"><a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-24-29"><a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a>
</span><span id="__span-24-30"><a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a><span class="w">    </span><span class="nt">&quot;zero_optimization&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-31"><a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a><span class="w">        </span><span class="nt">&quot;stage&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-24-32"><a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a><span class="w">        </span><span class="nt">&quot;offload_optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-33"><a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a><span class="w">            </span><span class="nt">&quot;device&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span id="__span-24-34"><a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a><span class="w">            </span><span class="nt">&quot;pin_memory&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-24-35"><a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-24-36"><a id="__codelineno-24-36" name="__codelineno-24-36" href="#__codelineno-24-36"></a><span class="w">        </span><span class="nt">&quot;allgather_partitions&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-24-37"><a id="__codelineno-24-37" name="__codelineno-24-37" href="#__codelineno-24-37"></a><span class="w">        </span><span class="nt">&quot;allgather_bucket_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">2e8</span><span class="p">,</span>
</span><span id="__span-24-38"><a id="__codelineno-24-38" name="__codelineno-24-38" href="#__codelineno-24-38"></a><span class="w">        </span><span class="nt">&quot;overlap_comm&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-24-39"><a id="__codelineno-24-39" name="__codelineno-24-39" href="#__codelineno-24-39"></a><span class="w">        </span><span class="nt">&quot;reduce_scatter&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-24-40"><a id="__codelineno-24-40" name="__codelineno-24-40" href="#__codelineno-24-40"></a><span class="w">        </span><span class="nt">&quot;reduce_bucket_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">2e8</span><span class="p">,</span>
</span><span id="__span-24-41"><a id="__codelineno-24-41" name="__codelineno-24-41" href="#__codelineno-24-41"></a><span class="w">        </span><span class="nt">&quot;contiguous_gradients&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-24-42"><a id="__codelineno-24-42" name="__codelineno-24-42" href="#__codelineno-24-42"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-24-43"><a id="__codelineno-24-43" name="__codelineno-24-43" href="#__codelineno-24-43"></a>
</span><span id="__span-24-44"><a id="__codelineno-24-44" name="__codelineno-24-44" href="#__codelineno-24-44"></a><span class="w">    </span><span class="nt">&quot;gradient_accumulation_steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-24-45"><a id="__codelineno-24-45" name="__codelineno-24-45" href="#__codelineno-24-45"></a><span class="w">    </span><span class="nt">&quot;gradient_clipping&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-24-46"><a id="__codelineno-24-46" name="__codelineno-24-46" href="#__codelineno-24-46"></a><span class="w">    </span><span class="nt">&quot;train_batch_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-24-47"><a id="__codelineno-24-47" name="__codelineno-24-47" href="#__codelineno-24-47"></a><span class="w">    </span><span class="nt">&quot;train_micro_batch_size_per_gpu&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-24-48"><a id="__codelineno-24-48" name="__codelineno-24-48" href="#__codelineno-24-48"></a><span class="p">}</span>
</span></code></pre></div>
<p>ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€DeepSpeed ã¯ [<code>Trainer</code>] ã‹ã‚‰å—ã‘å–ã£ãŸè¨­å®šã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã—ã¾ã™ã€‚
ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«æ¸¡ã•ã‚Œã‚‹ãŸã‚ã€æœ€çµ‚çš„ã«ã©ã®ã‚ˆã†ãªè¨­å®šãŒæ¸¡ã•ã‚ŒãŸã®ã‹ã‚’æ­£ç¢ºã«ç¢ºèªã§ãã¾ã™ã€‚</p>
<p><a id='deepspeed-config-passing'></a></p>
<h3 id="passing-configuration">Passing Configuration</h3>
<p>ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§èª¬æ˜ã—ãŸã‚ˆã†ã«ã€é€šå¸¸ã€DeepSpeed è¨­å®šã¯ json ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒ‘ã‚¹ã¨ã—ã¦æ¸¡ã•ã‚Œã¾ã™ãŒã€
ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®è¨­å®šã«ã‚³ãƒãƒ³ãƒ‰ ãƒ©ã‚¤ãƒ³ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’ä½¿ç”¨ã›ãšã€ä»£ã‚ã‚Šã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
[<code>Trainer</code>] via [<code>TrainingArguments</code>] ãã®å¾Œã€<code>deepspeed</code> å¼•æ•°ã«ã¤ã„ã¦ã¯æ¬¡ã®ã“ã¨ãŒã§ãã¾ã™
ãƒã‚¹ãƒˆã•ã‚ŒãŸ <code>dict</code> ã‚’æ¸¡ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãã®å ´ã§æ§‹æˆã‚’ä½œæˆã§ãã€ãã‚Œã‚’æ›¸ãè¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
[<code>TrainingArguments</code>] ã«æ¸¡ã™å‰ã«ãƒ•ã‚¡ã‚¤ãƒ« ã‚·ã‚¹ãƒ†ãƒ ã‚’å¤‰æ›´ã—ã¾ã™ã€‚</p>
<p>è¦ç´„ã™ã‚‹ã¨ã€æ¬¡ã®ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="n">TrainingArguments</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">deepspeed</span><span class="o">=</span><span class="s2">&quot;/path/to/ds_config.json&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>ã¾ãŸã¯ï¼š</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">ds_config_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler_params</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer_params</span><span class="p">)</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="n">TrainingArguments</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">deepspeed</span><span class="o">=</span><span class="n">ds_config_dict</span><span class="p">)</span>
</span></code></pre></div>
<p><a id='deepspeed-config-shared'></a></p>
<h3 id="shared-configuration">Shared Configuration</h3>
<p><Tip warning={true}></p>
<p>ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯å¿…èª­ã§ã™</p>
<p></Tip></p>
<p>[<code>Trainer</code>] ã¨ DeepSpeed ã®ä¸¡æ–¹ãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹ã«ã¯ã€ã„ãã¤ã‹ã®è¨­å®šå€¤ãŒå¿…è¦ã§ã™ã€‚
ã—ãŸãŒã£ã¦ã€æ¤œå‡ºãŒå›°é›£ãªã‚¨ãƒ©ãƒ¼ã«ã¤ãªãŒã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹å®šç¾©ã®ç«¶åˆã‚’é˜²ããŸã‚ã«ã€ãã‚Œã‚‰ã‚’æ§‹æˆã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚
[<code>Trainer</code>] ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°çµŒç”±ã€‚</p>
<p>ã•ã‚‰ã«ã€ä¸€éƒ¨ã®æ§‹æˆå€¤ã¯ãƒ¢ãƒ‡ãƒ«ã®æ§‹æˆã«åŸºã¥ã„ã¦è‡ªå‹•çš„ã«å°å‡ºã•ã‚Œã¾ã™ã€‚
è¤‡æ•°ã®å€¤ã‚’æ‰‹å‹•ã§èª¿æ•´ã™ã‚‹ã“ã¨ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ã€‚[<code>Trainer</code>] ã«å¤§éƒ¨åˆ†ã‚’ä»»ã›ã‚‹ã®ãŒæœ€å–„ã§ã™
ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚</p>
<p>ã—ãŸãŒã£ã¦ã€ã“ã®ã‚¬ã‚¤ãƒ‰ã®æ®‹ã‚Šã®éƒ¨åˆ†ã§ã¯ã€ç‰¹åˆ¥ãªè¨­å®šå€¤ <code>auto</code> ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚’è¨­å®šã™ã‚‹ã¨ã€
æ­£ã—ã„å€¤ã¾ãŸã¯æœ€ã‚‚åŠ¹ç‡çš„ãªå€¤ã«è‡ªå‹•çš„ã«ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚ã“ã‚Œã‚’ç„¡è¦–ã™ã‚‹ã“ã¨ã‚’è‡ªç”±ã«é¸æŠã—ã¦ãã ã•ã„
æ¨å¥¨äº‹é …ã‚’å‚ç…§ã—ã€å€¤ã‚’æ˜ç¤ºçš„ã«è¨­å®šã—ã¾ã™ã€‚ã“ã®å ´åˆã€æ¬¡ã®ç‚¹ã«ååˆ†æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
[<code>Trainer</code>] å¼•æ•°ã¨ DeepSpeed è¨­å®šã¯ä¸€è‡´ã—ã¾ã™ã€‚ãŸã¨ãˆã°ã€åŒã˜ã‚‚ã®ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã‹
å­¦ç¿’ç‡ã€ãƒãƒƒãƒã‚µã‚¤ã‚ºã€ã¾ãŸã¯å‹¾é…ç´¯ç©è¨­å®š?ã“ã‚Œã‚‰ãŒä¸€è‡´ã—ãªã„å ´åˆã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¯éå¸¸ã«å¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
æ–¹æ³•ã‚’æ¤œå‡ºã™ã‚‹ã®ãŒé›£ã—ã„ã€‚ã‚ãªãŸã¯è­¦å‘Šã‚’å—ã‘ã¾ã—ãŸã€‚</p>
<p>DeepSpeed ã®ã¿ã«å›ºæœ‰ã®å€¤ã‚„ã€ãã‚Œã«åˆã‚ã›ã¦æ‰‹å‹•ã§è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹å€¤ãŒä»–ã«ã‚‚è¤‡æ•°ã‚ã‚Šã¾ã™ã€‚
ã‚ãªãŸã®è¦æœ›ã€‚</p>
<p>ç‹¬è‡ªã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã€DeepSpeed æ§‹æˆã‚’ãƒã‚¹ã‚¿ãƒ¼ã¨ã—ã¦å¤‰æ›´ã—ãŸã„å ´åˆã¯ã€æ¬¡ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
ãã‚Œã«åŸºã¥ã„ã¦ [<code>TrainingArguments</code>] ã‚’è¨­å®šã—ã¾ã™ã€‚æ‰‹é †ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚</p>
<ol>
<li>ãƒã‚¹ã‚¿ãƒ¼æ§‹æˆã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ DeepSpeed æ§‹æˆã‚’ä½œæˆã¾ãŸã¯ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™</li>
<li>ã“ã‚Œã‚‰ã®å€¤ã«åŸºã¥ã„ã¦ [<code>TrainingArguments</code>] ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™</li>
</ol>
<p><code>scheduler.params.total_num_steps</code>ãªã©ã®ä¸€éƒ¨ã®å€¤ã¯æ¬¡ã®ã‚ˆã†ã«è¨ˆç®—ã•ã‚Œã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
<code>train</code> ä¸­ã« [<code>Trainer</code>] ã‚’å®Ÿè¡Œã—ã¾ã™ãŒã€ã‚‚ã¡ã‚ã‚“è‡ªåˆ†ã§è¨ˆç®—ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
<p><a id='deepspeed-zero'></a></p>
<h3 id="zero">ZeRO</h3>
<p><a href="https://www.deepspeed.ai/tutorials/zero/">Zero Redundancy Optimizer (ZeRO)</a> ã¯ã€DeepSpeed ã®ä¸»åŠ›è£½å“ã§ã™ã€‚ãã‚Œ
3 ã¤ã®ç•°ãªã‚‹ãƒ¬ãƒ™ãƒ« (æ®µéš) ã®æœ€é©åŒ–ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚æœ€åˆã®ã‚‚ã®ã¯ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã®è¦³ç‚¹ã‹ã‚‰ã¯ã‚ã¾ã‚Šèˆˆå‘³æ·±ã„ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ã—ãŸãŒã£ã¦ã€ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã‚¹ãƒ†ãƒ¼ã‚¸ 2 ã¨ 3 ã«ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™ã€‚ã‚¹ãƒ†ãƒ¼ã‚¸ 3 ã¯ã€æœ€æ–°ã® ZeRO-Infinity ã®è¿½åŠ ã«ã‚ˆã£ã¦ã•ã‚‰ã«æ”¹å–„ã•ã‚Œã¦ã„ã¾ã™ã€‚
è©³ç´°ã«ã¤ã„ã¦ã¯ã€DeepSpeed ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
<p>æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã® <code>zero_optimization</code> ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯æœ€ã‚‚é‡è¦ãªéƒ¨åˆ†ã§ã™ (<a href="https://www.deepspeed.ai/docs/config-json/#zero-optimizations-for-fp16-training">docs</a>)ã€‚ã“ã“ã§å®šç¾©ã—ã¾ã™
ã©ã® ZeRO ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‹ã€ãã—ã¦ãã‚Œã‚‰ã‚’ã©ã®ã‚ˆã†ã«æ§‹æˆã™ã‚‹ã‹ã€‚å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª¬æ˜ã¯ã€
DeepSpeed ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€‚</p>
<p>ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€DeepSpeed è¨­å®šã‚’ä»‹ã—ã¦ã®ã¿è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ - [<code>Trainer</code>] ãŒæä¾›ã—ã¾ã™
åŒç­‰ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
<p>æ³¨: ç¾åœ¨ã€DeepSpeed ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼åã‚’æ¤œè¨¼ã—ãªã„ãŸã‚ã€ã‚¹ãƒšãƒ«ã‚’é–“é•ãˆã‚‹ã¨ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
ã‚¹ãƒšãƒ«ãŒé–“é•ã£ã¦ã„ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚ DeepSpeed ã‚¨ãƒ³ã‚¸ãƒ³ã®èµ·å‹•ãƒ­ã‚° ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦‹ã¦ã€ãã®å€¤ã‚’ç¢ºèªã§ãã¾ã™ã€‚
ä½¿ç”¨ã™ã‚‹ã¤ã‚‚ã‚Šã§ã™ã€‚</p>
<p><a id='deepspeed-zero2-config'></a></p>
<h4 id="zero-2-config">ZeRO-2 Config</h4>
<p>ä»¥ä¸‹ã¯ã€ZeRO ã‚¹ãƒ†ãƒ¼ã‚¸ 2 ã®æ§‹æˆä¾‹ã§ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="p">{</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="w">    </span><span class="nt">&quot;zero_optimization&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="w">        </span><span class="nt">&quot;stage&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">        </span><span class="nt">&quot;offload_optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">            </span><span class="nt">&quot;device&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="w">            </span><span class="nt">&quot;pin_memory&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="w">        </span><span class="nt">&quot;allgather_partitions&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="w">        </span><span class="nt">&quot;allgather_bucket_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">5e8</span><span class="p">,</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="w">        </span><span class="nt">&quot;overlap_comm&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="w">        </span><span class="nt">&quot;reduce_scatter&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="w">        </span><span class="nt">&quot;reduce_bucket_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">5e8</span><span class="p">,</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="w">        </span><span class="nt">&quot;contiguous_gradients&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>æ€§èƒ½èª¿æ•´ï¼š</strong></p>
<ul>
<li><code>offload_optimizer</code> ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€GPU RAM ã®ä½¿ç”¨é‡ãŒå‰Šæ¸›ã•ã‚Œã¾ã™ (<code>"stage": 2</code> ãŒå¿…è¦ã§ã™)</li>
<li><code>"overlap_comm": true</code> ã¯ã€GPU RAM ä½¿ç”¨é‡ã®å¢—åŠ ã¨ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã—ã¦ã€é…å»¶ã‚’ã™ã¹ã¦å‰Šæ¸›ã—ã¾ã™ã€‚ <code>overlap_comm</code>ã¯ 4.5x ã‚’ä½¿ç”¨ã—ã¾ã™
  <code>allgather_bucket_size</code>ã¨<code>reduce_bucket_size</code>ã®å€¤ã€‚ã—ãŸãŒã£ã¦ã€5e8 ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€9GB ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
  ãƒ•ãƒƒãƒˆãƒ—ãƒªãƒ³ãƒˆ (<code>5e8 x 2Bytes x 2 x 4.5</code>)ã€‚ã—ãŸãŒã£ã¦ã€8GB ä»¥ä¸‹ã® RAM ã‚’æ­è¼‰ã—ãŸ GPU ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€
  OOM ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ã“ã‚Œã‚‰ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’<code>2e8</code>ç¨‹åº¦ã«æ¸›ã‚‰ã™å¿…è¦ãŒã‚ã‚Šã€ãã‚Œã«ã¯ 3.6GB ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚ã‚„ã‚ŠãŸããªã‚‹ã§ã—ã‚‡ã†
  OOM ã«é”ã—å§‹ã‚ã¦ã„ã‚‹å ´åˆã¯ã€ã‚ˆã‚Šå¤§å®¹é‡ã® GPU ã§ã‚‚åŒæ§˜ã§ã™ã€‚</li>
<li>ã“ã‚Œã‚‰ã®ãƒãƒƒãƒ•ã‚¡ã‚’æ¸›ã‚‰ã™ã¨ã€ã‚ˆã‚Šå¤šãã® GPU RAM ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«é€šä¿¡é€Ÿåº¦ã‚’çŠ ç‰²ã«ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚ºãŒå°ã•ã„ã»ã©ã€
  é€šä¿¡ãŒé…ããªã‚Šã€ä»–ã®ã‚¿ã‚¹ã‚¯ã§ä½¿ç”¨ã§ãã‚‹ GPU RAM ãŒå¢—ãˆã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ãƒãƒƒãƒã‚µã‚¤ã‚ºãŒå¤§ãã„å ´åˆã¯ã€
  é‡è¦ãªã®ã¯ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ™‚é–“ã‚’å°‘ã—é…ã‚‰ã›ã‚‹ã“ã¨ã¯è‰¯ã„ãƒˆãƒ¬ãƒ¼ãƒ‰ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</li>
</ul>
<p>ã•ã‚‰ã«ã€<code>deepspeed==0.4.4</code>ã«ã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§æœ‰åŠ¹ã«ã§ãã‚‹æ–°ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³<code>round_robin_gradients</code>ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="p">{</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">    </span><span class="nt">&quot;zero_optimization&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">        </span><span class="nt">&quot;round_robin_gradients&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>ã“ã‚Œã¯ã€ãã‚ç´°ã‹ã„å‹¾é…ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ã«ã‚ˆã£ã¦ãƒ©ãƒ³ã‚¯é–“ã® CPU ãƒ¡ãƒ¢ãƒªã¸ã®å‹¾é…ã‚³ãƒ”ãƒ¼ã‚’ä¸¦åˆ—åŒ–ã™ã‚‹ã€CPU ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã®ã‚¹ãƒ†ãƒ¼ã‚¸ 2 æœ€é©åŒ–ã§ã™ã€‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®åˆ©ç‚¹ã¯ã€å‹¾é…ç´¯ç©ã‚¹ãƒ†ãƒƒãƒ— (ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ ã‚¹ãƒ†ãƒƒãƒ—é–“ã®ã‚³ãƒ”ãƒ¼ã®å¢—åŠ ) ã¾ãŸã¯ GPU æ•° (ä¸¦åˆ—å‡¦ç†ã®å¢—åŠ ) ã«å¿œã˜ã¦å¢—åŠ ã—ã¾ã™ã€‚</p>
<p><a id='deepspeed-zero3-config'></a></p>
<h4 id="zero-3-config">ZeRO-3 Config</h4>
<p>ä»¥ä¸‹ã¯ã€ZeRO ã‚¹ãƒ†ãƒ¼ã‚¸ 3 ã®æ§‹æˆä¾‹ã§ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="p">{</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="w">    </span><span class="nt">&quot;zero_optimization&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="w">        </span><span class="nt">&quot;stage&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="w">        </span><span class="nt">&quot;offload_optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="w">            </span><span class="nt">&quot;device&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="w">            </span><span class="nt">&quot;pin_memory&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="w">        </span><span class="nt">&quot;offload_param&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="w">            </span><span class="nt">&quot;device&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="w">            </span><span class="nt">&quot;pin_memory&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="w">        </span><span class="nt">&quot;overlap_comm&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="w">        </span><span class="nt">&quot;contiguous_gradients&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="w">        </span><span class="nt">&quot;sub_group_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e9</span><span class="p">,</span>
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="w">        </span><span class="nt">&quot;reduce_bucket_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-29-16"><a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="w">        </span><span class="nt">&quot;stage3_prefetch_bucket_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-29-17"><a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a><span class="w">        </span><span class="nt">&quot;stage3_param_persistence_threshold&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-29-18"><a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a><span class="w">        </span><span class="nt">&quot;stage3_max_live_parameters&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e9</span><span class="p">,</span>
</span><span id="__span-29-19"><a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a><span class="w">        </span><span class="nt">&quot;stage3_max_reuse_distance&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e9</span><span class="p">,</span>
</span><span id="__span-29-20"><a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a><span class="w">        </span><span class="nt">&quot;stage3_gather_16bit_weights_on_model_save&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-29-21"><a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-29-22"><a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a><span class="p">}</span>
</span></code></pre></div>
<p>ãƒ¢ãƒ‡ãƒ«ã¾ãŸã¯ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒ GPU ãƒ¡ãƒ¢ãƒªã«é©åˆã›ãšã€CPU ãŒæœªä½¿ç”¨ã§ã‚ã‚‹ãŸã‚ã« OOM ãŒç™ºç”Ÿã—ã¦ã„ã‚‹å ´åˆ
<code>"device": "cpu"</code> ã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã®çŠ¶æ…‹ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ CPU ãƒ¡ãƒ¢ãƒªã«ãƒ¡ãƒ¢ãƒªã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ã“ã®åˆ¶é™ãŒè§£æ±ºã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
CPU ãƒ¡ãƒ¢ãƒªã«ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã—ãŸããªã„å ´åˆã¯ã€<code>device</code>ã‚¨ãƒ³ãƒˆãƒªã«<code>cpu</code>ã®ä»£ã‚ã‚Šã«<code>none</code>ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰å…ˆ
NVMe ã«ã¤ã„ã¦ã¯å¾Œã»ã©èª¬æ˜ã—ã¾ã™ã€‚</p>
<p>å›ºå®šãƒ¡ãƒ¢ãƒªã¯ã€<code>pin_memory</code>ã‚’<code>true</code>ã«è¨­å®šã™ã‚‹ã¨æœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚ã“ã®æ©Ÿèƒ½ã«ã‚ˆã‚Šã€æ¬¡ã®ã‚ˆã†ãªã‚³ã‚¹ãƒˆã‚’ã‹ã‘ã¦ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä»–ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒä½¿ç”¨ã§ãã‚‹ãƒ¡ãƒ¢ãƒªãŒå°‘ãªããªã‚Šã¾ã™ã€‚ãƒ”ãƒ³ç•™ã‚ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªã¯ã€ãã‚Œã‚’è¦æ±‚ã—ãŸç‰¹å®šã®ãƒ—ãƒ­ã‚»ã‚¹ã®ãŸã‚ã«ç¢ºä¿ã•ã‚Œã¾ã™ã€‚
é€šå¸¸ã€é€šå¸¸ã® CPU ãƒ¡ãƒ¢ãƒªã‚ˆã‚Šã‚‚ã¯ã‚‹ã‹ã«é«˜é€Ÿã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã¾ã™ã€‚</p>
<p><strong>æ€§èƒ½èª¿æ•´ï¼š</strong></p>
<ul>
<li><code>stage3_max_live_parameters</code>: <code>1e9</code></li>
<li><code>stage3_max_reuse_distance</code>: <code>1e9</code></li>
</ul>
<p>OOM ã«é”ã—ãŸå ´åˆã¯ã€ã€Œstage3_max_live_parametersã€ã¨ã€Œstage3_max_reuse_ distanceã€ã‚’æ¸›ã‚‰ã—ã¾ã™ã€‚å½±éŸ¿ã¯æœ€å°é™ã«æŠ‘ãˆã‚‰ã‚Œã‚‹ã¯ãšã§ã™
ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè¡Œã—ãªã„é™ã‚Šã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«å½±éŸ¿ã—ã¾ã™ã€‚ <code>1e9</code>ã¯ç´„ 2GB ã‚’æ¶ˆè²»ã—ã¾ã™ã€‚è¨˜æ†¶ã‚’å…±æœ‰ã—ã¦ã„ã‚‹ã®ã¯ã€
<code>stage3_max_live_parameters</code> ã¨ <code>stage3_max_reuse_distance</code> ãªã®ã§ã€åŠ ç®—ã•ã‚Œã‚‹ã‚‚ã®ã§ã¯ãªãã€åˆè¨ˆã§ 2GB ã«ãªã‚Šã¾ã™ã€‚</p>
<p><code>stage3_max_live_parameters</code> ã¯ã€ç‰¹å®šã®æ™‚ç‚¹ã§ GPU ä¸Šã«ä¿æŒã™ã‚‹å®Œå…¨ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ•°ã®ä¸Šé™ã§ã™ã€‚
æ™‚é–“ã€‚ ã€Œå†åˆ©ç”¨è·é›¢ã€ã¯ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå°†æ¥ã„ã¤å†ã³ä½¿ç”¨ã•ã‚Œã‚‹ã‹ã‚’åˆ¤æ–­ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹æŒ‡æ¨™ã§ã™ã€‚
<code>stage3_max_reuse_ distance</code>ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç ´æ£„ã™ã‚‹ã‹ä¿æŒã™ã‚‹ã‹ã‚’æ±ºå®šã—ã¾ã™ã€‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒ
è¿‘ã„å°†æ¥ã«å†ã³ä½¿ç”¨ã•ã‚Œã‚‹äºˆå®š (<code>stage3_max_reuse_distance</code>æœªæº€) ãªã®ã§ã€é€šä¿¡ã‚’æ¸›ã‚‰ã™ãŸã‚ã«ä¿æŒã—ã¾ã™ã€‚
ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã€‚ã“ã‚Œã¯ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’æœ‰åŠ¹ã«ã—ã¦ã„ã‚‹å ´åˆã«éå¸¸ã«å½¹ç«‹ã¡ã¾ã™ã€‚ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰å†è¨ˆç®—ãŒè¡Œã‚ã‚Œã€
backward ã¯å˜ä¸€ãƒ¬ã‚¤ãƒ¤ãƒ¼ç²’åº¦ã‚’æ¸¡ã—ã€å¾Œæ–¹å†è¨ˆç®—ã¾ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰æ–¹å†è¨ˆç®—ã«ä¿æŒã—ãŸã„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚</p>
<p>æ¬¡ã®æ§‹æˆå€¤ã¯ã€ãƒ¢ãƒ‡ãƒ«ã®éè¡¨ç¤ºã‚µã‚¤ã‚ºã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚</p>
<ul>
<li><code>reduce_bucket_size</code>: <code>hidden_size*hidden_size</code></li>
<li><code>stage3_prefetch_bucket_size</code>: <code>0.9 * hidden_size * hidden_size</code></li>
<li><code>stage3_param_persistence_threshold</code>: <code>10 * hidden_size</code></li>
</ul>
<p>ã—ãŸãŒã£ã¦ã€ã“ã‚Œã‚‰ã®å€¤ã‚’ <code>auto</code> ã«è¨­å®šã™ã‚‹ã¨ã€[<code>Trainer</code>] ãŒæ¨å¥¨ã•ã‚Œã‚‹å€¤ã‚’è‡ªå‹•çš„ã«å‰²ã‚Šå½“ã¦ã¾ã™ã€‚
ä¾¡å€¤è¦³ã€‚ãŸã ã—ã€ã‚‚ã¡ã‚ã‚“ã€ã“ã‚Œã‚‰ã‚’æ˜ç¤ºçš„ã«è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
<p><code>stage3_gather_16bit_weights_on_model_save</code> ã¯ã€ãƒ¢ãƒ‡ãƒ«ã®ä¿å­˜æ™‚ã«ãƒ¢ãƒ‡ãƒ« fp16 ã®é‡ã¿çµ±åˆã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚å¤§ãã„
ãƒ¢ãƒ‡ãƒ«ã¨è¤‡æ•°ã® GPU ã®å ´åˆã€ã“ã‚Œã¯ãƒ¡ãƒ¢ãƒªã¨é€Ÿåº¦ã®ä¸¡æ–¹ã®ç‚¹ã§é«˜ä¾¡ãªæ“ä½œã§ã™ã€‚ç¾åœ¨å¿…é ˆã¨ãªã£ã¦ã„ã‚‹ã®ã¯ã€
ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å†é–‹ã™ã‚‹äºˆå®šã§ã™ã€‚ã“ã®åˆ¶é™ã‚’å–ã‚Šé™¤ãã€ã‚ˆã‚Šä¾¿åˆ©ã«ã™ã‚‹ä»Šå¾Œã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«æ³¨ç›®ã—ã¦ãã ã•ã„ã€‚
ãƒ•ãƒ¬ã‚­ã‚·ãƒ–ãƒ«ã€‚</p>
<p>ZeRO-2 æ§‹æˆã‹ã‚‰ç§»è¡Œã—ã¦ã„ã‚‹å ´åˆã¯ã€<code>allgather_partitions</code>ã€<code>allgather_bucket_size</code>ã€ãŠã‚ˆã³
<code>reduce_scatter</code>è¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ ZeRO-3 ã§ã¯ä½¿ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚ã“ã‚Œã‚‰ã‚’è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ãŠãã¨ã€
ç„¡è¦–ã•ã‚Œã‚‹ã€‚</p>
<ul>
<li><code>sub_group_size</code>: <code>1e9</code></li>
</ul>
<p><code>sub_group_size</code> ã¯ã€ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã®ã‚¹ãƒ†ãƒƒãƒ—ä¸­ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒæ›´æ–°ã•ã‚Œã‚‹ç²’åº¦ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚
<code>sub_group_size</code> ã®ãƒã‚±ãƒƒãƒˆã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚Œã€å„ãƒã‚±ãƒƒãƒˆã¯ä¸€åº¦ã« 1 ã¤ãšã¤æ›´æ–°ã•ã‚Œã¾ã™ã€‚ NVMeã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã§ä½¿ç”¨ã™ã‚‹å ´åˆ
ã—ãŸãŒã£ã¦ã€ZeRO-Infinity ã® <code>sub_group_size</code>ã¯ã€ãƒ¢ãƒ‡ãƒ«ã®çŠ¶æ…‹ãŒ CPU ã«å‡ºå…¥ã‚Šã™ã‚‹ç²’åº¦ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚
ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã‚¹ãƒ†ãƒƒãƒ—ä¸­ã« NVMe ã‹ã‚‰ãƒ¡ãƒ¢ãƒªã‚’å–å¾—ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€éå¸¸ã«å¤§è¦æ¨¡ãªãƒ¢ãƒ‡ãƒ«ã® CPU ãƒ¡ãƒ¢ãƒªä¸è¶³ãŒé˜²æ­¢ã•ã‚Œã¾ã™ã€‚</p>
<p>NVMe ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ãªã„å ´åˆã¯ã€<code>sub_group_size</code>ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã® <em>1e9</em> ã®ã¾ã¾ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚å¤‰æ›´ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™
æ¬¡ã®å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤:</p>
<ol>
<li>ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ ã‚¹ãƒ†ãƒƒãƒ—ä¸­ã« OOM ãŒç™ºç”Ÿã™ã‚‹: <code>sub_group_size</code> ã‚’æ¸›ã‚‰ã—ã¦ã€ä¸€æ™‚ãƒãƒƒãƒ•ã‚¡ãƒ¼ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’å‰Šæ¸›ã—ã¾ã™ã€‚</li>
<li>ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ ã‚¹ãƒ†ãƒƒãƒ—ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚<code>sub_group_size</code>ã‚’å¢—ã‚„ã—ã¦ã€å¸¯åŸŸå¹…ã®ä½¿ç”¨ç‡ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚
   ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ•ã‚¡ã®å¢—åŠ ã€‚</li>
</ol>
<h4 id="zero-0-config">ZeRO-0 Config</h4>
<p>ã‚¹ãƒ†ãƒ¼ã‚¸ 0 ã¨ 1 ã¯ã‚ã£ãŸã«ä½¿ç”¨ã•ã‚Œãªã„ãŸã‚ã€æœ€å¾Œã«ãƒªã‚¹ãƒˆã—ã¦ã„ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚</p>
<p>ã‚¹ãƒ†ãƒ¼ã‚¸ 0 ã§ã¯ã€ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒ—ã®ã‚·ãƒ£ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç„¡åŠ¹ã«ã—ã€DDP ã¨ã—ã¦ DeepSpeed ã®ã¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚ªãƒ³ã«ã§ãã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="p">{</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">    </span><span class="nt">&quot;zero_optimization&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">        </span><span class="nt">&quot;stage&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>ã“ã‚Œã«ã‚ˆã‚Šã€ä»–ã«ä½•ã‚‚å¤‰æ›´ã™ã‚‹å¿…è¦ãŒãªãã€åŸºæœ¬çš„ã« ZeRO ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚</p>
<h4 id="zero-1-config">ZeRO-1 Config</h4>
<p>ã‚¹ãƒ†ãƒ¼ã‚¸ 1 ã¯ã€ã‚¹ãƒ†ãƒ¼ã‚¸ 2 ã‹ã‚‰ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ ã‚·ãƒ£ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’é™¤ã„ãŸã‚‚ã®ã§ã™ã€‚ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã®çŠ¶æ…‹ã‚’ã‚·ãƒ£ãƒ¼ãƒ‰åŒ–ã™ã‚‹ã ã‘ã§ã€å‡¦ç†ã‚’å°‘ã—é«˜é€ŸåŒ–ã™ã‚‹ãŸã‚ã«ã„ã¤ã§ã‚‚è©¦ã™ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="p">{</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="w">    </span><span class="nt">&quot;zero_optimization&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="w">        </span><span class="nt">&quot;stage&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="p">}</span>
</span></code></pre></div>
<p><a id='deepspeed-nvme'></a></p>
<h3 id="nvme-support">NVMe Support</h3>
<p>ZeRO-Infinity ã¯ã€GPU ã¨ CPU ãƒ¡ãƒ¢ãƒªã‚’ NVMe ãƒ¡ãƒ¢ãƒªã§æ‹¡å¼µã™ã‚‹ã“ã¨ã§ã€éå¸¸ã«å¤§è¦æ¨¡ãªãƒ¢ãƒ‡ãƒ«ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ãŠã‹ã’ã§
ã‚¹ãƒãƒ¼ãƒˆ ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ãŠã‚ˆã³ã‚¿ã‚¤ãƒªãƒ³ã‚° ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã¯ã€å„ GPU ãŒéå¸¸ã«å°‘é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’é€å—ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã«ã‚ˆã‚Šã€æœ€æ–°ã® NVMe ãŒãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«åˆ©ç”¨ã§ãã‚‹åˆè¨ˆãƒ¡ãƒ¢ãƒª ãƒ—ãƒ¼ãƒ«ã‚’ã•ã‚‰ã«å¤§ããã™ã‚‹ã®ã«é©ã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ¤æ˜ã—ã¾ã—ãŸã€‚
ãƒ—ãƒ­ã‚»ã‚¹ã€‚ ZeRO-Infinity ã«ã¯ã€ZeRO-3 ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>æ¬¡ã®è¨­å®šä¾‹ã§ã¯ã€NVMe ãŒã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã®çŠ¶æ…‹ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä¸¡æ–¹ã‚’ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="p">{</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="w">    </span><span class="nt">&quot;zero_optimization&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="w">        </span><span class="nt">&quot;stage&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="w">        </span><span class="nt">&quot;offload_optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="w">            </span><span class="nt">&quot;device&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nvme&quot;</span><span class="p">,</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="w">            </span><span class="nt">&quot;nvme_path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/local_nvme&quot;</span><span class="p">,</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="w">            </span><span class="nt">&quot;pin_memory&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="w">            </span><span class="nt">&quot;buffer_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="w">            </span><span class="nt">&quot;fast_init&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="w">        </span><span class="nt">&quot;offload_param&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="w">            </span><span class="nt">&quot;device&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nvme&quot;</span><span class="p">,</span>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="w">            </span><span class="nt">&quot;nvme_path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/local_nvme&quot;</span><span class="p">,</span>
</span><span id="__span-32-14"><a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a><span class="w">            </span><span class="nt">&quot;pin_memory&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-32-15"><a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a><span class="w">            </span><span class="nt">&quot;buffer_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
</span><span id="__span-32-16"><a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a><span class="w">            </span><span class="nt">&quot;buffer_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e8</span><span class="p">,</span>
</span><span id="__span-32-17"><a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a><span class="w">            </span><span class="nt">&quot;max_in_cpu&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e9</span>
</span><span id="__span-32-18"><a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-32-19"><a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a><span class="w">        </span><span class="nt">&quot;aio&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-20"><a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a><span class="w">            </span><span class="nt">&quot;block_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">262144</span><span class="p">,</span>
</span><span id="__span-32-21"><a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a><span class="w">            </span><span class="nt">&quot;queue_depth&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span>
</span><span id="__span-32-22"><a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a><span class="w">            </span><span class="nt">&quot;thread_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-32-23"><a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a><span class="w">            </span><span class="nt">&quot;single_submit&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-32-24"><a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a><span class="w">            </span><span class="nt">&quot;overlap_events&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-32-25"><a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-32-26"><a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a><span class="w">        </span><span class="nt">&quot;overlap_comm&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-32-27"><a id="__codelineno-32-27" name="__codelineno-32-27" href="#__codelineno-32-27"></a><span class="w">        </span><span class="nt">&quot;contiguous_gradients&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-32-28"><a id="__codelineno-32-28" name="__codelineno-32-28" href="#__codelineno-32-28"></a><span class="w">        </span><span class="nt">&quot;sub_group_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e9</span><span class="p">,</span>
</span><span id="__span-32-29"><a id="__codelineno-32-29" name="__codelineno-32-29" href="#__codelineno-32-29"></a><span class="w">        </span><span class="nt">&quot;reduce_bucket_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-32-30"><a id="__codelineno-32-30" name="__codelineno-32-30" href="#__codelineno-32-30"></a><span class="w">        </span><span class="nt">&quot;stage3_prefetch_bucket_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-32-31"><a id="__codelineno-32-31" name="__codelineno-32-31" href="#__codelineno-32-31"></a><span class="w">        </span><span class="nt">&quot;stage3_param_persistence_threshold&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-32-32"><a id="__codelineno-32-32" name="__codelineno-32-32" href="#__codelineno-32-32"></a><span class="w">        </span><span class="nt">&quot;stage3_max_live_parameters&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e9</span><span class="p">,</span>
</span><span id="__span-32-33"><a id="__codelineno-32-33" name="__codelineno-32-33" href="#__codelineno-32-33"></a><span class="w">        </span><span class="nt">&quot;stage3_max_reuse_distance&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e9</span><span class="p">,</span>
</span><span id="__span-32-34"><a id="__codelineno-32-34" name="__codelineno-32-34" href="#__codelineno-32-34"></a><span class="w">        </span><span class="nt">&quot;stage3_gather_16bit_weights_on_model_save&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-32-35"><a id="__codelineno-32-35" name="__codelineno-32-35" href="#__codelineno-32-35"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-32-36"><a id="__codelineno-32-36" name="__codelineno-32-36" href="#__codelineno-32-36"></a><span class="p">}</span>
</span></code></pre></div>
<p>ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã®çŠ¶æ…‹ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä¸¡æ–¹ã‚’ NVMe ã«ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã€ã©ã¡ã‚‰ã‹ 1 ã¤ã ã‘ã‚’ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã€ã¾ã£ãŸãã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã—ãªã„ã‹ã‚’é¸æŠã§ãã¾ã™ã€‚ãŸã¨ãˆã°ã€æ¬¡ã®å ´åˆ
åˆ©ç”¨å¯èƒ½ãª CPU ãƒ¡ãƒ¢ãƒªãŒå¤§é‡ã«ã‚ã‚‹å ´åˆã¯ã€é«˜é€Ÿã«ãªã‚‹ãŸã‚ã€å¿…ãš CPU ãƒ¡ãƒ¢ãƒªã®ã¿ã«ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ (ãƒ’ãƒ³ãƒˆ:
<em>"device": "CPU"</em>)ã€‚</p>
<p><a href="https://www.deepspeed.ai/docs/config-json/#optimizer-offloading">ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã®çŠ¶æ…‹</a> ã¨ <a href="https://www.deepspeed.ai/docs/config-json/#parameter-offloading">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼</a>ã€‚</p>
<p><code>nvme_path</code>ãŒå®Ÿéš›ã« NVMe ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚NVMe ã¯é€šå¸¸ã®ãƒãƒ¼ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ–ã¾ãŸã¯ SSD ã§å‹•ä½œã—ã¾ã™ãŒã€
ã¯ã‚‹ã‹ã«é…ããªã‚Šã¾ã™ã€‚é«˜é€Ÿã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¯ã€æœ€æ–°ã® NVMe è»¢é€é€Ÿåº¦ã‚’å¿µé ­ã«ç½®ã„ã¦è¨­è¨ˆã•ã‚Œã¾ã—ãŸ (ã“ã®æ™‚ç‚¹ã§ã¯
æ›¸ãè¾¼ã¿ã§ã¯ã€èª­ã¿å–ã‚Šæœ€å¤§ 3.5 GB/ç§’ã€æ›¸ãè¾¼ã¿æœ€å¤§ 3 GB/ç§’ã®ãƒ”ãƒ¼ã‚¯é€Ÿåº¦ãŒå¾—ã‚‰ã‚Œã¾ã™)ã€‚</p>
<p>æœ€é©ãª<code>aio</code>æ§‹æˆãƒ–ãƒ­ãƒƒã‚¯ã‚’è¦‹ã¤ã‘ã‚‹ã«ã¯ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¨­å®šã§ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
<a href="https://github.com/deepspeedai/DeepSpeed/issues/998">ã“ã“ã§èª¬æ˜</a>ã€‚</p>
<p><a id='deepspeed-zero2-zero3-performance'></a></p>
<h4 id="zero-2-vs-zero-3-performance">ZeRO-2 vs ZeRO-3 Performance</h4>
<p>ZeRO-3 ã¯ã€ä»–ã®ã™ã¹ã¦ãŒåŒã˜ã‚ˆã†ã«æ§‹æˆã•ã‚Œã¦ã„ã‚‹å ´åˆã€ZeRO-2 ã‚ˆã‚Šã‚‚é…ããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å‰è€…ã¯åé›†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã§ã™ã€‚
ZeRO-2 ã®æ©Ÿèƒ½ã«åŠ ãˆã¦ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ä»˜ã‘ã‚’è¡Œã„ã¾ã™ã€‚ ZeRO-2 ãŒãƒ‹ãƒ¼ã‚ºã‚’æº€ãŸã—ã€æ•°å€‹ã® GPU ã‚’è¶…ãˆã¦æ‹¡å¼µã™ã‚‹å¿…è¦ãŒãªã„å ´åˆ
ãã†ã™ã‚Œã°ã€ãã‚Œã«å›ºåŸ·ã™ã‚‹ã“ã¨ã‚’é¸æŠã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ ZeRO-3 ã«ã‚ˆã‚Šã€ã¯ã‚‹ã‹ã«é«˜ã„ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£å®¹é‡ãŒå¯èƒ½ã«ãªã‚‹ã“ã¨ã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™
ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’çŠ ç‰²ã«ã—ã¦ã€‚</p>
<p>ZeRO-3 ã®æ§‹æˆã‚’èª¿æ•´ã—ã¦ã€ZeRO-2 ã«è¿‘ã¥ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
<ul>
<li><code>stage3_param_persistence_threshold</code> ã‚’éå¸¸ã«å¤§ããªæ•°å€¤ã«è¨­å®šã—ã¾ã™ã€‚ãŸã¨ãˆã°ã€<code>6 * hidden_â€‹â€‹size * hidden_â€‹â€‹size</code> ã®ã‚ˆã†ã«ã€æœ€å¤§â€‹â€‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚ˆã‚Šã‚‚å¤§ãããªã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒ GPU ã«ä¿æŒã•ã‚Œã¾ã™ã€‚</li>
<li>ZeRO-2 ã«ã¯ãã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒãªã„ãŸã‚ã€<code>offload_params</code> ã‚’ã‚ªãƒ•ã«ã—ã¾ã™ã€‚</li>
</ul>
<p>å¤‰æ›´ã—ãªãã¦ã‚‚ã€<code>offload_params</code>ã‚’ã‚ªãƒ•ã«ã™ã‚‹ã ã‘ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒå¤§å¹…ã«å‘ä¸Šã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
<code>stage3_param_persistence_threshold</code>ã€‚ã‚‚ã¡ã‚ã‚“ã€ã“ã‚Œã‚‰ã®å¤‰æ›´ã¯ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§ãã‚‹ãƒ¢ãƒ‡ãƒ«ã®ã‚µã‚¤ã‚ºã«å½±éŸ¿ã—ã¾ã™ã€‚ãã‚Œã§
ã“ã‚Œã‚‰ã¯ã€ãƒ‹ãƒ¼ã‚ºã«å¿œã˜ã¦ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã¨å¼•ãæ›ãˆã«é€Ÿåº¦ã‚’å‘ä¸Šã•ã›ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚</p>
<p><a id='deepspeed-zero2-example'></a></p>
<h4 id="zero-2-example">ZeRO-2 Example</h4>
<p>ä»¥ä¸‹ã¯ã€å®Œå…¨ãª ZeRO-2 è‡ªå‹•æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ« <code>ds_config_zero2.json</code> ã§ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="p">{</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="w">    </span><span class="nt">&quot;fp16&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="w">        </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="w">        </span><span class="nt">&quot;loss_scale&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="w">        </span><span class="nt">&quot;loss_scale_window&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="w">        </span><span class="nt">&quot;initial_scale_power&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="w">        </span><span class="nt">&quot;hysteresis&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="w">        </span><span class="nt">&quot;min_loss_scale&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="w">    </span><span class="nt">&quot;optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a><span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AdamW&quot;</span><span class="p">,</span>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a><span class="w">        </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="w">            </span><span class="nt">&quot;lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="w">            </span><span class="nt">&quot;betas&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a><span class="w">            </span><span class="nt">&quot;eps&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="w">            </span><span class="nt">&quot;weight_decay&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span>
</span><span id="__span-33-18"><a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-33-19"><a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-33-20"><a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a>
</span><span id="__span-33-21"><a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a><span class="w">    </span><span class="nt">&quot;scheduler&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-22"><a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a><span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;WarmupLR&quot;</span><span class="p">,</span>
</span><span id="__span-33-23"><a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a><span class="w">        </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-24"><a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a><span class="w">            </span><span class="nt">&quot;warmup_min_lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-33-25"><a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a><span class="w">            </span><span class="nt">&quot;warmup_max_lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-33-26"><a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a><span class="w">            </span><span class="nt">&quot;warmup_num_steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span>
</span><span id="__span-33-27"><a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-33-28"><a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-33-29"><a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a>
</span><span id="__span-33-30"><a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a><span class="w">    </span><span class="nt">&quot;zero_optimization&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-31"><a id="__codelineno-33-31" name="__codelineno-33-31" href="#__codelineno-33-31"></a><span class="w">        </span><span class="nt">&quot;stage&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-33-32"><a id="__codelineno-33-32" name="__codelineno-33-32" href="#__codelineno-33-32"></a><span class="w">        </span><span class="nt">&quot;offload_optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-33"><a id="__codelineno-33-33" name="__codelineno-33-33" href="#__codelineno-33-33"></a><span class="w">            </span><span class="nt">&quot;device&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span id="__span-33-34"><a id="__codelineno-33-34" name="__codelineno-33-34" href="#__codelineno-33-34"></a><span class="w">            </span><span class="nt">&quot;pin_memory&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-33-35"><a id="__codelineno-33-35" name="__codelineno-33-35" href="#__codelineno-33-35"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-33-36"><a id="__codelineno-33-36" name="__codelineno-33-36" href="#__codelineno-33-36"></a><span class="w">        </span><span class="nt">&quot;allgather_partitions&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-33-37"><a id="__codelineno-33-37" name="__codelineno-33-37" href="#__codelineno-33-37"></a><span class="w">        </span><span class="nt">&quot;allgather_bucket_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">2e8</span><span class="p">,</span>
</span><span id="__span-33-38"><a id="__codelineno-33-38" name="__codelineno-33-38" href="#__codelineno-33-38"></a><span class="w">        </span><span class="nt">&quot;overlap_comm&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-33-39"><a id="__codelineno-33-39" name="__codelineno-33-39" href="#__codelineno-33-39"></a><span class="w">        </span><span class="nt">&quot;reduce_scatter&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-33-40"><a id="__codelineno-33-40" name="__codelineno-33-40" href="#__codelineno-33-40"></a><span class="w">        </span><span class="nt">&quot;reduce_bucket_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">2e8</span><span class="p">,</span>
</span><span id="__span-33-41"><a id="__codelineno-33-41" name="__codelineno-33-41" href="#__codelineno-33-41"></a><span class="w">        </span><span class="nt">&quot;contiguous_gradients&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-33-42"><a id="__codelineno-33-42" name="__codelineno-33-42" href="#__codelineno-33-42"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-33-43"><a id="__codelineno-33-43" name="__codelineno-33-43" href="#__codelineno-33-43"></a>
</span><span id="__span-33-44"><a id="__codelineno-33-44" name="__codelineno-33-44" href="#__codelineno-33-44"></a><span class="w">    </span><span class="nt">&quot;gradient_accumulation_steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-33-45"><a id="__codelineno-33-45" name="__codelineno-33-45" href="#__codelineno-33-45"></a><span class="w">    </span><span class="nt">&quot;gradient_clipping&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-33-46"><a id="__codelineno-33-46" name="__codelineno-33-46" href="#__codelineno-33-46"></a><span class="w">    </span><span class="nt">&quot;steps_per_print&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2000</span><span class="p">,</span>
</span><span id="__span-33-47"><a id="__codelineno-33-47" name="__codelineno-33-47" href="#__codelineno-33-47"></a><span class="w">    </span><span class="nt">&quot;train_batch_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-33-48"><a id="__codelineno-33-48" name="__codelineno-33-48" href="#__codelineno-33-48"></a><span class="w">    </span><span class="nt">&quot;train_micro_batch_size_per_gpu&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-33-49"><a id="__codelineno-33-49" name="__codelineno-33-49" href="#__codelineno-33-49"></a><span class="w">    </span><span class="nt">&quot;wall_clock_breakdown&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-33-50"><a id="__codelineno-33-50" name="__codelineno-33-50" href="#__codelineno-33-50"></a><span class="p">}</span>
</span></code></pre></div>
<p>ä»¥ä¸‹ã¯ã€æ‰‹å‹•ã§è¨­å®šã•ã‚ŒãŸå®Œå…¨ãª ZeRO-2 ã®ã™ã¹ã¦ãŒæœ‰åŠ¹ãªæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚ã“ã“ã§ã¯ä¸»ã«ã€å…¸å‹çš„ãªã‚‚ã®ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚
å€¤ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ãŒã€è¤‡æ•°ã®<code>auto</code>è¨­å®šãŒå«ã¾ã‚Œã‚‹å€¤ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’å¼·ããŠå‹§ã‚ã—ã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="p">{</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="w">    </span><span class="nt">&quot;fp16&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="w">        </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="w">        </span><span class="nt">&quot;loss_scale&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="w">        </span><span class="nt">&quot;loss_scale_window&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="w">        </span><span class="nt">&quot;initial_scale_power&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="w">        </span><span class="nt">&quot;hysteresis&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="w">        </span><span class="nt">&quot;min_loss_scale&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="w">    </span><span class="nt">&quot;optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a><span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AdamW&quot;</span><span class="p">,</span>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="w">        </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a><span class="w">            </span><span class="nt">&quot;lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">3e-5</span><span class="p">,</span>
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a><span class="w">            </span><span class="nt">&quot;betas&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">0.8</span><span class="p">,</span><span class="w"> </span><span class="mf">0.999</span><span class="p">],</span>
</span><span id="__span-34-16"><a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a><span class="w">            </span><span class="nt">&quot;eps&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e-8</span><span class="p">,</span>
</span><span id="__span-34-17"><a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a><span class="w">            </span><span class="nt">&quot;weight_decay&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">3e-7</span>
</span><span id="__span-34-18"><a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-34-19"><a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-34-20"><a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a>
</span><span id="__span-34-21"><a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a><span class="w">    </span><span class="nt">&quot;scheduler&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-22"><a id="__codelineno-34-22" name="__codelineno-34-22" href="#__codelineno-34-22"></a><span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;WarmupLR&quot;</span><span class="p">,</span>
</span><span id="__span-34-23"><a id="__codelineno-34-23" name="__codelineno-34-23" href="#__codelineno-34-23"></a><span class="w">        </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-24"><a id="__codelineno-34-24" name="__codelineno-34-24" href="#__codelineno-34-24"></a><span class="w">            </span><span class="nt">&quot;warmup_min_lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-34-25"><a id="__codelineno-34-25" name="__codelineno-34-25" href="#__codelineno-34-25"></a><span class="w">            </span><span class="nt">&quot;warmup_max_lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">3e-5</span><span class="p">,</span>
</span><span id="__span-34-26"><a id="__codelineno-34-26" name="__codelineno-34-26" href="#__codelineno-34-26"></a><span class="w">            </span><span class="nt">&quot;warmup_num_steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">500</span>
</span><span id="__span-34-27"><a id="__codelineno-34-27" name="__codelineno-34-27" href="#__codelineno-34-27"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-34-28"><a id="__codelineno-34-28" name="__codelineno-34-28" href="#__codelineno-34-28"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-34-29"><a id="__codelineno-34-29" name="__codelineno-34-29" href="#__codelineno-34-29"></a>
</span><span id="__span-34-30"><a id="__codelineno-34-30" name="__codelineno-34-30" href="#__codelineno-34-30"></a><span class="w">    </span><span class="nt">&quot;zero_optimization&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-31"><a id="__codelineno-34-31" name="__codelineno-34-31" href="#__codelineno-34-31"></a><span class="w">        </span><span class="nt">&quot;stage&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-34-32"><a id="__codelineno-34-32" name="__codelineno-34-32" href="#__codelineno-34-32"></a><span class="w">        </span><span class="nt">&quot;offload_optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-33"><a id="__codelineno-34-33" name="__codelineno-34-33" href="#__codelineno-34-33"></a><span class="w">            </span><span class="nt">&quot;device&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span id="__span-34-34"><a id="__codelineno-34-34" name="__codelineno-34-34" href="#__codelineno-34-34"></a><span class="w">            </span><span class="nt">&quot;pin_memory&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-34-35"><a id="__codelineno-34-35" name="__codelineno-34-35" href="#__codelineno-34-35"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-34-36"><a id="__codelineno-34-36" name="__codelineno-34-36" href="#__codelineno-34-36"></a><span class="w">        </span><span class="nt">&quot;allgather_partitions&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-34-37"><a id="__codelineno-34-37" name="__codelineno-34-37" href="#__codelineno-34-37"></a><span class="w">        </span><span class="nt">&quot;allgather_bucket_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">2e8</span><span class="p">,</span>
</span><span id="__span-34-38"><a id="__codelineno-34-38" name="__codelineno-34-38" href="#__codelineno-34-38"></a><span class="w">        </span><span class="nt">&quot;overlap_comm&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-34-39"><a id="__codelineno-34-39" name="__codelineno-34-39" href="#__codelineno-34-39"></a><span class="w">        </span><span class="nt">&quot;reduce_scatter&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-34-40"><a id="__codelineno-34-40" name="__codelineno-34-40" href="#__codelineno-34-40"></a><span class="w">        </span><span class="nt">&quot;reduce_bucket_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">2e8</span><span class="p">,</span>
</span><span id="__span-34-41"><a id="__codelineno-34-41" name="__codelineno-34-41" href="#__codelineno-34-41"></a><span class="w">        </span><span class="nt">&quot;contiguous_gradients&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-34-42"><a id="__codelineno-34-42" name="__codelineno-34-42" href="#__codelineno-34-42"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-34-43"><a id="__codelineno-34-43" name="__codelineno-34-43" href="#__codelineno-34-43"></a>
</span><span id="__span-34-44"><a id="__codelineno-34-44" name="__codelineno-34-44" href="#__codelineno-34-44"></a><span class="w">    </span><span class="nt">&quot;steps_per_print&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2000</span><span class="p">,</span>
</span><span id="__span-34-45"><a id="__codelineno-34-45" name="__codelineno-34-45" href="#__codelineno-34-45"></a><span class="w">    </span><span class="nt">&quot;wall_clock_breakdown&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-34-46"><a id="__codelineno-34-46" name="__codelineno-34-46" href="#__codelineno-34-46"></a><span class="p">}</span>
</span></code></pre></div>
<p><a id='deepspeed-zero3-example'></a></p>
<h4 id="zero-3-example">ZeRO-3 Example</h4>
<p>ä»¥ä¸‹ã¯ã€å®Œå…¨ãª ZeRO-3 è‡ªå‹•æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«<code>ds_config_zero3.json</code>ã§ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="p">{</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="w">    </span><span class="nt">&quot;fp16&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="w">        </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="w">        </span><span class="nt">&quot;loss_scale&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="w">        </span><span class="nt">&quot;loss_scale_window&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="w">        </span><span class="nt">&quot;initial_scale_power&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="w">        </span><span class="nt">&quot;hysteresis&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="w">        </span><span class="nt">&quot;min_loss_scale&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="w">    </span><span class="nt">&quot;optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AdamW&quot;</span><span class="p">,</span>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="w">        </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="w">            </span><span class="nt">&quot;lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-35-15"><a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="w">            </span><span class="nt">&quot;betas&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-35-16"><a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a><span class="w">            </span><span class="nt">&quot;eps&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-35-17"><a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a><span class="w">            </span><span class="nt">&quot;weight_decay&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span>
</span><span id="__span-35-18"><a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-35-19"><a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-35-20"><a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a>
</span><span id="__span-35-21"><a id="__codelineno-35-21" name="__codelineno-35-21" href="#__codelineno-35-21"></a><span class="w">    </span><span class="nt">&quot;scheduler&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-22"><a id="__codelineno-35-22" name="__codelineno-35-22" href="#__codelineno-35-22"></a><span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;WarmupLR&quot;</span><span class="p">,</span>
</span><span id="__span-35-23"><a id="__codelineno-35-23" name="__codelineno-35-23" href="#__codelineno-35-23"></a><span class="w">        </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-24"><a id="__codelineno-35-24" name="__codelineno-35-24" href="#__codelineno-35-24"></a><span class="w">            </span><span class="nt">&quot;warmup_min_lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-35-25"><a id="__codelineno-35-25" name="__codelineno-35-25" href="#__codelineno-35-25"></a><span class="w">            </span><span class="nt">&quot;warmup_max_lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-35-26"><a id="__codelineno-35-26" name="__codelineno-35-26" href="#__codelineno-35-26"></a><span class="w">            </span><span class="nt">&quot;warmup_num_steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span>
</span><span id="__span-35-27"><a id="__codelineno-35-27" name="__codelineno-35-27" href="#__codelineno-35-27"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-35-28"><a id="__codelineno-35-28" name="__codelineno-35-28" href="#__codelineno-35-28"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-35-29"><a id="__codelineno-35-29" name="__codelineno-35-29" href="#__codelineno-35-29"></a>
</span><span id="__span-35-30"><a id="__codelineno-35-30" name="__codelineno-35-30" href="#__codelineno-35-30"></a><span class="w">    </span><span class="nt">&quot;zero_optimization&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-31"><a id="__codelineno-35-31" name="__codelineno-35-31" href="#__codelineno-35-31"></a><span class="w">        </span><span class="nt">&quot;stage&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
</span><span id="__span-35-32"><a id="__codelineno-35-32" name="__codelineno-35-32" href="#__codelineno-35-32"></a><span class="w">        </span><span class="nt">&quot;offload_optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-33"><a id="__codelineno-35-33" name="__codelineno-35-33" href="#__codelineno-35-33"></a><span class="w">            </span><span class="nt">&quot;device&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span id="__span-35-34"><a id="__codelineno-35-34" name="__codelineno-35-34" href="#__codelineno-35-34"></a><span class="w">            </span><span class="nt">&quot;pin_memory&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-35-35"><a id="__codelineno-35-35" name="__codelineno-35-35" href="#__codelineno-35-35"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-35-36"><a id="__codelineno-35-36" name="__codelineno-35-36" href="#__codelineno-35-36"></a><span class="w">        </span><span class="nt">&quot;offload_param&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-37"><a id="__codelineno-35-37" name="__codelineno-35-37" href="#__codelineno-35-37"></a><span class="w">            </span><span class="nt">&quot;device&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span id="__span-35-38"><a id="__codelineno-35-38" name="__codelineno-35-38" href="#__codelineno-35-38"></a><span class="w">            </span><span class="nt">&quot;pin_memory&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-35-39"><a id="__codelineno-35-39" name="__codelineno-35-39" href="#__codelineno-35-39"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-35-40"><a id="__codelineno-35-40" name="__codelineno-35-40" href="#__codelineno-35-40"></a><span class="w">        </span><span class="nt">&quot;overlap_comm&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-35-41"><a id="__codelineno-35-41" name="__codelineno-35-41" href="#__codelineno-35-41"></a><span class="w">        </span><span class="nt">&quot;contiguous_gradients&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-35-42"><a id="__codelineno-35-42" name="__codelineno-35-42" href="#__codelineno-35-42"></a><span class="w">        </span><span class="nt">&quot;sub_group_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e9</span><span class="p">,</span>
</span><span id="__span-35-43"><a id="__codelineno-35-43" name="__codelineno-35-43" href="#__codelineno-35-43"></a><span class="w">        </span><span class="nt">&quot;reduce_bucket_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-35-44"><a id="__codelineno-35-44" name="__codelineno-35-44" href="#__codelineno-35-44"></a><span class="w">        </span><span class="nt">&quot;stage3_prefetch_bucket_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-35-45"><a id="__codelineno-35-45" name="__codelineno-35-45" href="#__codelineno-35-45"></a><span class="w">        </span><span class="nt">&quot;stage3_param_persistence_threshold&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-35-46"><a id="__codelineno-35-46" name="__codelineno-35-46" href="#__codelineno-35-46"></a><span class="w">        </span><span class="nt">&quot;stage3_max_live_parameters&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e9</span><span class="p">,</span>
</span><span id="__span-35-47"><a id="__codelineno-35-47" name="__codelineno-35-47" href="#__codelineno-35-47"></a><span class="w">        </span><span class="nt">&quot;stage3_max_reuse_distance&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e9</span><span class="p">,</span>
</span><span id="__span-35-48"><a id="__codelineno-35-48" name="__codelineno-35-48" href="#__codelineno-35-48"></a><span class="w">        </span><span class="nt">&quot;stage3_gather_16bit_weights_on_model_save&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-35-49"><a id="__codelineno-35-49" name="__codelineno-35-49" href="#__codelineno-35-49"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-35-50"><a id="__codelineno-35-50" name="__codelineno-35-50" href="#__codelineno-35-50"></a>
</span><span id="__span-35-51"><a id="__codelineno-35-51" name="__codelineno-35-51" href="#__codelineno-35-51"></a><span class="w">    </span><span class="nt">&quot;gradient_accumulation_steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-35-52"><a id="__codelineno-35-52" name="__codelineno-35-52" href="#__codelineno-35-52"></a><span class="w">    </span><span class="nt">&quot;gradient_clipping&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-35-53"><a id="__codelineno-35-53" name="__codelineno-35-53" href="#__codelineno-35-53"></a><span class="w">    </span><span class="nt">&quot;steps_per_print&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2000</span><span class="p">,</span>
</span><span id="__span-35-54"><a id="__codelineno-35-54" name="__codelineno-35-54" href="#__codelineno-35-54"></a><span class="w">    </span><span class="nt">&quot;train_batch_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-35-55"><a id="__codelineno-35-55" name="__codelineno-35-55" href="#__codelineno-35-55"></a><span class="w">    </span><span class="nt">&quot;train_micro_batch_size_per_gpu&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-35-56"><a id="__codelineno-35-56" name="__codelineno-35-56" href="#__codelineno-35-56"></a><span class="w">    </span><span class="nt">&quot;wall_clock_breakdown&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-35-57"><a id="__codelineno-35-57" name="__codelineno-35-57" href="#__codelineno-35-57"></a><span class="p">}</span>
</span></code></pre></div>
<p>ä»¥ä¸‹ã¯ã€æ‰‹å‹•ã§è¨­å®šã•ã‚ŒãŸå®Œå…¨ãª ZeRO-3 ã®ã™ã¹ã¦ãŒæœ‰åŠ¹ãªæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚ã“ã“ã§ã¯ä¸»ã«ã€å…¸å‹çš„ãªã‚‚ã®ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚
å€¤ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ãŒã€è¤‡æ•°ã®<code>auto</code>è¨­å®šãŒå«ã¾ã‚Œã‚‹å€¤ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’å¼·ããŠå‹§ã‚ã—ã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="p">{</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="w">    </span><span class="nt">&quot;fp16&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="w">        </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="w">        </span><span class="nt">&quot;loss_scale&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="w">        </span><span class="nt">&quot;loss_scale_window&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="w">        </span><span class="nt">&quot;initial_scale_power&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="w">        </span><span class="nt">&quot;hysteresis&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="w">        </span><span class="nt">&quot;min_loss_scale&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a><span class="w">    </span><span class="nt">&quot;optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a><span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AdamW&quot;</span><span class="p">,</span>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a><span class="w">        </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a><span class="w">            </span><span class="nt">&quot;lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">3e-5</span><span class="p">,</span>
</span><span id="__span-36-15"><a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a><span class="w">            </span><span class="nt">&quot;betas&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">0.8</span><span class="p">,</span><span class="w"> </span><span class="mf">0.999</span><span class="p">],</span>
</span><span id="__span-36-16"><a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a><span class="w">            </span><span class="nt">&quot;eps&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e-8</span><span class="p">,</span>
</span><span id="__span-36-17"><a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a><span class="w">            </span><span class="nt">&quot;weight_decay&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">3e-7</span>
</span><span id="__span-36-18"><a id="__codelineno-36-18" name="__codelineno-36-18" href="#__codelineno-36-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-36-19"><a id="__codelineno-36-19" name="__codelineno-36-19" href="#__codelineno-36-19"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-36-20"><a id="__codelineno-36-20" name="__codelineno-36-20" href="#__codelineno-36-20"></a>
</span><span id="__span-36-21"><a id="__codelineno-36-21" name="__codelineno-36-21" href="#__codelineno-36-21"></a><span class="w">    </span><span class="nt">&quot;scheduler&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-22"><a id="__codelineno-36-22" name="__codelineno-36-22" href="#__codelineno-36-22"></a><span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;WarmupLR&quot;</span><span class="p">,</span>
</span><span id="__span-36-23"><a id="__codelineno-36-23" name="__codelineno-36-23" href="#__codelineno-36-23"></a><span class="w">        </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-24"><a id="__codelineno-36-24" name="__codelineno-36-24" href="#__codelineno-36-24"></a><span class="w">            </span><span class="nt">&quot;warmup_min_lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-36-25"><a id="__codelineno-36-25" name="__codelineno-36-25" href="#__codelineno-36-25"></a><span class="w">            </span><span class="nt">&quot;warmup_max_lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">3e-5</span><span class="p">,</span>
</span><span id="__span-36-26"><a id="__codelineno-36-26" name="__codelineno-36-26" href="#__codelineno-36-26"></a><span class="w">            </span><span class="nt">&quot;warmup_num_steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">500</span>
</span><span id="__span-36-27"><a id="__codelineno-36-27" name="__codelineno-36-27" href="#__codelineno-36-27"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-36-28"><a id="__codelineno-36-28" name="__codelineno-36-28" href="#__codelineno-36-28"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-36-29"><a id="__codelineno-36-29" name="__codelineno-36-29" href="#__codelineno-36-29"></a>
</span><span id="__span-36-30"><a id="__codelineno-36-30" name="__codelineno-36-30" href="#__codelineno-36-30"></a><span class="w">    </span><span class="nt">&quot;zero_optimization&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-31"><a id="__codelineno-36-31" name="__codelineno-36-31" href="#__codelineno-36-31"></a><span class="w">        </span><span class="nt">&quot;stage&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
</span><span id="__span-36-32"><a id="__codelineno-36-32" name="__codelineno-36-32" href="#__codelineno-36-32"></a><span class="w">        </span><span class="nt">&quot;offload_optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-33"><a id="__codelineno-36-33" name="__codelineno-36-33" href="#__codelineno-36-33"></a><span class="w">            </span><span class="nt">&quot;device&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span id="__span-36-34"><a id="__codelineno-36-34" name="__codelineno-36-34" href="#__codelineno-36-34"></a><span class="w">            </span><span class="nt">&quot;pin_memory&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-36-35"><a id="__codelineno-36-35" name="__codelineno-36-35" href="#__codelineno-36-35"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-36-36"><a id="__codelineno-36-36" name="__codelineno-36-36" href="#__codelineno-36-36"></a><span class="w">        </span><span class="nt">&quot;offload_param&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-37"><a id="__codelineno-36-37" name="__codelineno-36-37" href="#__codelineno-36-37"></a><span class="w">            </span><span class="nt">&quot;device&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span id="__span-36-38"><a id="__codelineno-36-38" name="__codelineno-36-38" href="#__codelineno-36-38"></a><span class="w">            </span><span class="nt">&quot;pin_memory&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-36-39"><a id="__codelineno-36-39" name="__codelineno-36-39" href="#__codelineno-36-39"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-36-40"><a id="__codelineno-36-40" name="__codelineno-36-40" href="#__codelineno-36-40"></a><span class="w">        </span><span class="nt">&quot;overlap_comm&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-36-41"><a id="__codelineno-36-41" name="__codelineno-36-41" href="#__codelineno-36-41"></a><span class="w">        </span><span class="nt">&quot;contiguous_gradients&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-36-42"><a id="__codelineno-36-42" name="__codelineno-36-42" href="#__codelineno-36-42"></a><span class="w">        </span><span class="nt">&quot;sub_group_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e9</span><span class="p">,</span>
</span><span id="__span-36-43"><a id="__codelineno-36-43" name="__codelineno-36-43" href="#__codelineno-36-43"></a><span class="w">        </span><span class="nt">&quot;reduce_bucket_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e6</span><span class="p">,</span>
</span><span id="__span-36-44"><a id="__codelineno-36-44" name="__codelineno-36-44" href="#__codelineno-36-44"></a><span class="w">        </span><span class="nt">&quot;stage3_prefetch_bucket_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.94e6</span><span class="p">,</span>
</span><span id="__span-36-45"><a id="__codelineno-36-45" name="__codelineno-36-45" href="#__codelineno-36-45"></a><span class="w">        </span><span class="nt">&quot;stage3_param_persistence_threshold&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e4</span><span class="p">,</span>
</span><span id="__span-36-46"><a id="__codelineno-36-46" name="__codelineno-36-46" href="#__codelineno-36-46"></a><span class="w">        </span><span class="nt">&quot;stage3_max_live_parameters&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e9</span><span class="p">,</span>
</span><span id="__span-36-47"><a id="__codelineno-36-47" name="__codelineno-36-47" href="#__codelineno-36-47"></a><span class="w">        </span><span class="nt">&quot;stage3_max_reuse_distance&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e9</span><span class="p">,</span>
</span><span id="__span-36-48"><a id="__codelineno-36-48" name="__codelineno-36-48" href="#__codelineno-36-48"></a><span class="w">        </span><span class="nt">&quot;stage3_gather_16bit_weights_on_model_save&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-36-49"><a id="__codelineno-36-49" name="__codelineno-36-49" href="#__codelineno-36-49"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-36-50"><a id="__codelineno-36-50" name="__codelineno-36-50" href="#__codelineno-36-50"></a>
</span><span id="__span-36-51"><a id="__codelineno-36-51" name="__codelineno-36-51" href="#__codelineno-36-51"></a><span class="w">    </span><span class="nt">&quot;steps_per_print&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2000</span><span class="p">,</span>
</span><span id="__span-36-52"><a id="__codelineno-36-52" name="__codelineno-36-52" href="#__codelineno-36-52"></a><span class="w">    </span><span class="nt">&quot;wall_clock_breakdown&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-36-53"><a id="__codelineno-36-53" name="__codelineno-36-53" href="#__codelineno-36-53"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="how-to-choose-which-zero-stage-and-offloads-to-use-for-best-performance">How to Choose Which ZeRO Stage and Offloads To Use For Best Performance</h4>
<p>ã“ã‚Œã§ã€ã•ã¾ã–ã¾ãªæ®µéšãŒã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚ã©ã¡ã‚‰ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã‚’ã©ã®ã‚ˆã†ã«æ±ºå®šã™ã‚Œã°ã‚ˆã„ã§ã—ã‚‡ã†ã‹?ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ã“ã®è³ªå•ã«ç­”ãˆã¦ã„ãã¾ã™ã€‚</p>
<p>ä¸€èˆ¬ã«ã€æ¬¡ã®ã“ã¨ãŒå½“ã¦ã¯ã¾ã‚Šã¾ã™ã€‚</p>
<ul>
<li>é€Ÿåº¦ã®ç‚¹ï¼ˆå·¦ã®æ–¹ãŒå³ã‚ˆã‚Šé€Ÿã„ï¼‰</li>
</ul>
<p>ã‚¹ãƒ†ãƒ¼ã‚¸ 0 (DDP) &gt; ã‚¹ãƒ†ãƒ¼ã‚¸ 1 &gt; ã‚¹ãƒ†ãƒ¼ã‚¸ 2 &gt; ã‚¹ãƒ†ãƒ¼ã‚¸ 2 + ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ &gt; ã‚¹ãƒ†ãƒ¼ã‚¸ 3 &gt; ã‚¹ãƒ†ãƒ¼ã‚¸ 3 + ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰</p>
<ul>
<li>GPU ãƒ¡ãƒ¢ãƒªã®ä½¿ç”¨çŠ¶æ³ (å³ã¯å·¦ã‚ˆã‚Šã‚‚ GPU ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ãŒé«˜ã„)</li>
</ul>
<p>ã‚¹ãƒ†ãƒ¼ã‚¸ 0 (DDP) &lt; ã‚¹ãƒ†ãƒ¼ã‚¸ 1 &lt; ã‚¹ãƒ†ãƒ¼ã‚¸ 2 &lt; ã‚¹ãƒ†ãƒ¼ã‚¸ 2 + ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ &lt; ã‚¹ãƒ†ãƒ¼ã‚¸ 3 &lt; ã‚¹ãƒ†ãƒ¼ã‚¸ 3 + ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰</p>
<p>ã—ãŸãŒã£ã¦ã€æœ€å°é™ã®æ•°ã® GPU ã«åã¾ã‚ŠãªãŒã‚‰æœ€é€Ÿã®å®Ÿè¡Œã‚’å®Ÿç¾ã—ãŸã„å ´åˆã¯ã€æ¬¡ã®ãƒ—ãƒ­ã‚»ã‚¹ã«å¾“ã†ã“ã¨ãŒã§ãã¾ã™ã€‚æœ€ã‚‚é€Ÿã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‹ã‚‰é–‹å§‹ã—ã€GPU OOM ã«é™¥ã£ãŸå ´åˆã¯ã€æ¬¡ã«é…ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«é€²ã¿ã¾ã™ãŒã€ã“ã‚Œã«ã‚ˆã‚Šä½¿ç”¨ã•ã‚Œã‚‹ GPU ãƒ¡ãƒ¢ãƒªãŒå°‘ãªããªã‚Šã¾ã™ã€‚ãªã©ãªã©ã€‚</p>
<p>ã¾ãšã€ãƒãƒƒãƒ ã‚µã‚¤ã‚ºã‚’ 1 ã«è¨­å®šã—ã¾ã™ (å¿…è¦ãªæœ‰åŠ¹ãƒãƒƒãƒ ã‚µã‚¤ã‚ºã«å¯¾ã—ã¦ã€ã„ã¤ã§ã‚‚å‹¾é…ç´¯ç©ã‚’ä½¿ç”¨ã§ãã¾ã™)ã€‚</p>
<ol>
<li><code>--gradient_checkpointing 1</code> (HF Trainer) ã¾ãŸã¯ç›´æ¥ <code>model.gradient_checkpointing_enable()</code> ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ - OOM ã®å ´åˆ</li>
<li>æœ€åˆã« ZeRO ã‚¹ãƒ†ãƒ¼ã‚¸ 2 ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚ OOMã®å ´åˆ</li>
<li>ZeRO ã‚¹ãƒ†ãƒ¼ã‚¸ 2 + <code>offload_optimizer</code> ã‚’è©¦ã—ã¾ã™ - OOM ã®å ´åˆ</li>
<li>ZeRO ã‚¹ãƒ†ãƒ¼ã‚¸ 3 ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ - OOM ã®å ´åˆ</li>
<li><code>cpu</code> ã«å¯¾ã—ã¦ <code>offload_param</code> ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ - OOM ã®å ´åˆ</li>
<li>
<p>OOM ã®å ´åˆã¯ã€<code>cpu</code>ã«å¯¾ã—ã¦<code>offload_optimizer</code>ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚</p>
</li>
<li>
<p>ãã‚Œã§ã‚‚ãƒãƒƒãƒ ã‚µã‚¤ã‚º 1 ã«é©åˆã—ãªã„å ´åˆã¯ã€ã¾ãšã•ã¾ã–ã¾ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ç¢ºèªã—ã€å¯èƒ½ã§ã‚ã‚Œã°å€¤ã‚’ä¸‹ã’ã¾ã™ã€‚ãŸã¨ãˆã°ã€<code>generate</code>ã‚’ä½¿ç”¨ã—ã€åºƒã„æ¤œç´¢ãƒ“ãƒ¼ãƒ ã‚’ä½¿ç”¨ã—ãªã„å ´åˆã¯ã€å¤§é‡ã®ãƒ¡ãƒ¢ãƒªã‚’æ¶ˆè²»ã™ã‚‹ãŸã‚ã€æ¤œç´¢ãƒ“ãƒ¼ãƒ ã‚’ç‹­ãã—ã¾ã™ã€‚</p>
</li>
<li>
<p>fp32 ã§ã¯å¿…ãšæ··åˆåŠç²¾åº¦ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã¤ã¾ã‚Šã€Ampere ä»¥ä¸Šã® GPU ã§ã¯ bf16ã€å¤ã„ GPU ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯ fp16 ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</p>
</li>
<li>
<p>ãã‚Œã§ã‚‚ OOM ã‚’è¡Œã†å ´åˆã¯ã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚’è¿½åŠ ã™ã‚‹ã‹ã€ZeRO-Infinity ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¤ã¾ã‚Šã€ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ <code>offload_param</code> ã¨ <code>offload_optimizer</code> ã‚’ <code>nvme</code> ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚éå¸¸ã«é«˜é€Ÿãª nvme ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚é€¸è©±ã¨ã—ã¦ã€ZeRO-Infinity ã‚’ä½¿ç”¨ã—ã¦å°ã•ãª GPU ã§ BLOOM-176B ã‚’æ¨è«–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸãŒã€éå¸¸ã«é…ã‹ã£ãŸã§ã™ã€‚ã§ã‚‚ã€ã†ã¾ãã„ãã¾ã—ãŸï¼</p>
</li>
</ol>
<p>ã‚‚ã¡ã‚ã‚“ã€æœ€ã‚‚ GPU ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã®é«˜ã„æ§‹æˆã‹ã‚‰å§‹ã‚ã¦ã€å¾Œã‹ã‚‰é€†ã«é€²ã‚€ã“ã¨ã§ã€ã“ã‚Œã‚‰ã®æ‰‹é †ã‚’é€†ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ã‚ã‚‹ã„ã¯äºŒç­‰åˆ†ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</p>
<p>OOM ã‚’å¼•ãèµ·ã“ã•ãªã„ãƒãƒƒãƒ ã‚µã‚¤ã‚º 1 ã‚’å–å¾—ã—ãŸã‚‰ã€å®ŸåŠ¹ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã‚’æ¸¬å®šã—ã¾ã™ã€‚</p>
<p>æ¬¡ã«ã€ãƒãƒƒãƒ ã‚µã‚¤ã‚ºã‚’ã§ãã‚‹ã ã‘å¤§ããã—ã¦ã¿ã¾ã™ã€‚ãƒãƒƒãƒ ã‚µã‚¤ã‚ºãŒå¤§ãã„ã»ã©ã€ä¹—ç®—ã™ã‚‹è¡Œåˆ—ãŒå·¨å¤§ãªå ´åˆã« GPU ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæœ€é«˜ã«ãªã‚‹ãŸã‚ã€GPU ã®åŠ¹ç‡ãŒå‘ä¸Šã—ã¾ã™ã€‚</p>
<p>ã“ã“ã§ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã‚²ãƒ¼ãƒ ãŒå§‹ã¾ã‚Šã¾ã™ã€‚ä¸€éƒ¨ã®ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’ã‚ªãƒ•ã«ã™ã‚‹ã‹ã€ZeRO æ®µéšã§ã‚¹ãƒ†ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã—ã¦ãƒãƒƒãƒ ã‚µã‚¤ã‚ºã‚’å¢—æ¸›ã—ã¦ã€å®ŸåŠ¹ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã‚’å†åº¦æ¸¬å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æº€è¶³ã™ã‚‹ã¾ã§æ´—ã„æµã—ã€ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚</p>
<p>æ°¸é ã«ã“ã‚Œã«è²»ã‚„ã™å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€3 ã‹æœˆã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’é–‹å§‹ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã«é–¢ã—ã¦æœ€ã‚‚åŠ¹æœçš„ãªè¨­å®šã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã«æ•°æ—¥ã‹ã‘ã¦ãã ã•ã„ã€‚ãã®ãŸã‚ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®ã‚³ã‚¹ãƒˆãŒæœ€å°é™ã«ãªã‚Šã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ã‚ˆã‚Šæ—©ãå®Œäº†ã§ãã¾ã™ã€‚ç¾åœ¨ã®ç›®ã¾ãã‚‹ã—ãå¤‰åŒ–ã™ã‚‹ ML ã®ä¸–ç•Œã§ã¯ã€ä½•ã‹ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹ã®ã«ã•ã‚‰ã« 1 ã‹æœˆã‹ã‹ã‚‹å ´åˆã€çµ¶å¥½ã®æ©Ÿä¼šã‚’é€ƒã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚‚ã¡ã‚ã‚“ã€ã“ã‚Œã¯ç§ãŒæ„è¦‹ã‚’å…±æœ‰ã—ã¦ã„ã‚‹ã ã‘ã§ã‚ã‚Šã€æ±ºã—ã¦ã‚ãªãŸã‚’æ€¥ã‹ãã†ã¨ã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ BLOOM-176B ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’é–‹å§‹ã™ã‚‹å‰ã«ã€ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã« 2 æ—¥é–“è²»ã‚„ã—ã€ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã‚’ 90 TFLOP ã‹ã‚‰ 150 TFLOP ã«å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ã“ã®å–ã‚Šçµ„ã¿ã«ã‚ˆã‚Šã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ™‚é–“ã‚’ 1 ã‹æœˆä»¥ä¸Šç¯€ç´„ã§ãã¾ã—ãŸã€‚</p>
<p>ã“ã‚Œã‚‰ã®ãƒ¡ãƒ¢ã¯ä¸»ã«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° ãƒ¢ãƒ¼ãƒ‰ç”¨ã«æ›¸ã‹ã‚ŒãŸã‚‚ã®ã§ã™ãŒã€ã»ã¨ã‚“ã©ã®å ´åˆã¯æ¨è«–ã«ã‚‚é©ç”¨ã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚ãŸã¨ãˆã°ã€å‹¾é…ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã¯ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ä¸­ã«ã®ã¿å½¹ç«‹ã¤ãŸã‚ã€æ¨è«–ä¸­ã¯ä½•ã‚‚è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚ã•ã‚‰ã«ã€ãƒãƒ«ãƒ GPU æ¨è«–ã‚’å®Ÿè¡Œã—ã¦ã„ã¦ã€<a href="https://www.deepspeed.ai/tutorials/inference-tutorial/">DeepSpeed-Inference</a>ã€<a href="https://ãƒã‚°ãƒ•ã‚§ã‚¤ã‚¹.co/blog/bloom-inference-pytorch-scripts">Accelerate</a> ã¯å„ªã‚ŒãŸãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æä¾›ã™ã‚‹ã¯ãšã§ã™ã€‚</p>
<p>ãã®ä»–ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é–¢é€£ã®ç°¡å˜ãªãƒ¡ãƒ¢:
- ä½•ã‹ã‚’æœ€åˆã‹ã‚‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã—ã¦ã„ã‚‹å ´åˆã¯ã€å¸¸ã« 16 ã§å‰²ã‚Šåˆ‡ã‚Œã‚‹å½¢çŠ¶ã®ãƒ†ãƒ³ã‚½ãƒ« (éš ã‚ŒãŸã‚µã‚¤ã‚ºãªã©) ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚ãƒãƒƒãƒ ã‚µã‚¤ã‚ºã«ã¤ã„ã¦ã¯ã€å°‘ãªãã¨ã‚‚ 2 ã§å‰²ã‚Šåˆ‡ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚ GPU ã‹ã‚‰ã•ã‚‰ã«é«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å¼•ãå‡ºã—ãŸã„å ´åˆã¯ã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢å›ºæœ‰ã® <a href="https://developer.nvidia.com/blog/optimizing-gpu-performance-tensor-cores/">æ³¢ã¨ã‚¿ã‚¤ãƒ«ã®é‡å­åŒ–</a> ã®å¯åˆ†æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
<h3 id="activation-checkpointing-or-gradient-checkpointing">Activation Checkpointing or Gradient Checkpointing</h3>
<p>ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã¨å‹¾é…ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã¯ã€åŒã˜æ–¹æ³•è«–ã‚’æŒ‡ã™ 2 ã¤ã®ç•°ãªã‚‹ç”¨èªã§ã™ã€‚ã¨ã¦ã‚‚ã‚„ã‚„ã“ã—ã„ã§ã™ãŒã€ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚</p>
<p>å‹¾é…ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€é€Ÿåº¦ã‚’ GPU ãƒ¡ãƒ¢ãƒªã¨å¼•ãæ›ãˆã«ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€GPU OOM ã‚’å…‹æœã—ãŸã‚Šã€ãƒãƒƒãƒ ã‚µã‚¤ã‚ºã‚’å¢—ã‚„ã™ã“ã¨ãŒã§ãã€å¤šãã®å ´åˆã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å‘ä¸Šã«ã¤ãªãŒã‚Šã¾ã™ã€‚</p>
<p>HF Transformers ãƒ¢ãƒ‡ãƒ«ã¯ã€DeepSpeed ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã«ã¤ã„ã¦ä½•ã‚‚çŸ¥ã‚‰ãªã„ãŸã‚ã€DeepSpeed æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã§ãã®æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã—ã‚ˆã†ã¨ã—ã¦ã‚‚ã€ä½•ã‚‚èµ·ã“ã‚Šã¾ã›ã‚“ã€‚</p>
<p>ã—ãŸãŒã£ã¦ã€ã“ã®éå¸¸ã«æœ‰ç›Šãªæ©Ÿèƒ½ã‚’æ´»ç”¨ã™ã‚‹ã«ã¯ 2 ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚</p>
<ol>
<li>HF Transformers ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã¯ã€<code>model.gradient_checkpointing_enable()</code> ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã€HF ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã§ <code>--gradient_checkpointing</code> ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã“ã‚ŒãŒè‡ªå‹•çš„ã«æœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚ãã“ã§ä½¿ã‚ã‚Œã‚‹ã®ãŒ <code>torch.utils.checkpoint</code> ã§ã™ã€‚</li>
<li>ç‹¬è‡ªã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã—ã€DeepSpeed ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã¯ã€<a href="https://deepspeed.readthedocs.io/en/latest/activation-checkpointing.html">ãã“ã§è¦å®šã•ã‚Œã¦ã„ã‚‹ API</a> ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚ HF Transformers ãƒ¢ãƒ‡ãƒªãƒ³ã‚° ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€<code>torch.utils.checkpoint</code> ã‚’ DeepSpeed ã® API ã«ç½®ãæ›ãˆã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚å¾Œè€…ã¯ã€é †æ–¹å‘ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†è¨ˆç®—ã™ã‚‹ä»£ã‚ã‚Šã« CPU ãƒ¡ãƒ¢ãƒªã«ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ãŸã‚ã€ã‚ˆã‚ŠæŸ”è»Ÿã§ã™ã€‚</li>
</ol>
<h3 id="optimizer-and-scheduler">Optimizer and Scheduler</h3>
<p><code>offload_optimizer</code>ã‚’æœ‰åŠ¹ã«ã—ãªã„é™ã‚Šã€DeepSpeed ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã¨ HuggingFace ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨â€‹â€‹ã§ãã¾ã™ã€‚
ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ (HuggingFace ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã¨ DeepSpeed ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã®çµ„ã¿åˆã‚ã›ã‚’é™¤ã):</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Combos</th>
<th style="text-align: left;">HF Scheduler</th>
<th style="text-align: left;">DS Scheduler</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">HF Optimizer</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">Yes</td>
</tr>
<tr>
<td style="text-align: left;">DS Optimizer</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">Yes</td>
</tr>
</tbody>
</table>
<p><code>offload_optimizer</code>ãŒæœ‰åŠ¹ãªå ´åˆã€CPU ã¨
GPU å®Ÿè£… (LAMB ã‚’é™¤ã)ã€‚</p>
<p><a id='deepspeed-optimizer'></a></p>
<h4 id="optimizer">Optimizer</h4>
<p>DeepSpeed ã®ä¸»ãªã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã¯ã€Adamã€AdamWã€OneBitAdamã€Lamb ã§ã™ã€‚ã“ã‚Œã‚‰ã¯ ZeRO ã§å¾¹åº•çš„ã«ãƒ†ã‚¹ãƒˆã•ã‚Œã¦ãŠã‚Šã€
ã—ãŸãŒã£ã¦ã€ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚ãŸã ã—ã€ä»–ã®ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã‚’ã€Œtorchã€ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨ã¯ã§ãã¾ã™ã€‚å®Œå…¨ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ <a href="https://www.deepspeed.ai/docs/config-json/#optimizer-parameters">ã“ã¡ã‚‰</a> ã«ã‚ã‚Šã¾ã™ã€‚</p>
<p>è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ <code>optimizer</code> ã‚¨ãƒ³ãƒˆãƒªã‚’è¨­å®šã—ãªã„å ´åˆã€[<code>Trainer</code>] ã¯
è‡ªå‹•çš„ã«<code>AdamW</code>ã«è¨­å®šã•ã‚Œã€æŒ‡å®šã•ã‚ŒãŸå€¤ã¾ãŸã¯æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
å¼•æ•°: <code>--learning_rate</code>ã€<code>--adam_beta1</code>ã€<code>--adam_beta2</code>ã€<code>--adam_epsilon</code>ã€ãŠã‚ˆã³ <code>--weight_decay</code>ã€‚</p>
<p>ä»¥ä¸‹ã¯ã€<code>AdamW</code>ã®è‡ªå‹•æ§‹æˆã•ã‚ŒãŸ<code>optimizer</code>ã‚¨ãƒ³ãƒˆãƒªã®ä¾‹ã§ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="p">{</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="w">   </span><span class="nt">&quot;optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="w">       </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AdamW&quot;</span><span class="p">,</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="w">       </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="w">         </span><span class="nt">&quot;lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="w">         </span><span class="nt">&quot;betas&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="w">         </span><span class="nt">&quot;eps&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="w">         </span><span class="nt">&quot;weight_decay&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="w">       </span><span class="p">}</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="p">}</span>
</span></code></pre></div>
<p>ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã«ã‚ˆã£ã¦æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«å†…ã®å€¤ãŒè¨­å®šã•ã‚Œã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯ 1 ã¤ã‚ã‚‹ãŸã‚ã§ã™
å€¤ã®æ±ºå®šçš„ãªã‚½ãƒ¼ã‚¹ã‚’æä¾›ã—ã€ãŸã¨ãˆã°å­¦ç¿’ç‡ãŒæ¬¡ã®ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã€è¦‹ã¤ã‘ã«ãã„ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã—ã¾ã™ã€‚
ã•ã¾ã–ã¾ãªå ´æ‰€ã§ã•ã¾ã–ã¾ãªä¾¡å€¤è¦³ã€‚ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã®ãƒ«ãƒ¼ãƒ«ã€‚ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã•ã‚Œã‚‹å€¤ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚</p>
<ul>
<li><code>lr</code> ã¨ <code>--learning_rate</code> ã®å€¤</li>
<li><code>betas</code> ã¨ <code>--adam_beta1 --adam_beta2</code> ã®å€¤</li>
<li><code>eps</code> ã¨ <code>--adam_epsilon</code> ã®å€¤</li>
<li><code>weight_decay</code> ã¨ <code>--weight_decay</code> ã®å€¤</li>
</ul>
<p>ã—ãŸãŒã£ã¦ã€ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã§å…±æœ‰ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´ã™ã‚‹ã“ã¨ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ã€‚</p>
<p>å€¤ã‚’æ˜ç¤ºçš„ã«è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="p">{</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="w">   </span><span class="nt">&quot;optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="w">       </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AdamW&quot;</span><span class="p">,</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="w">       </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="w">         </span><span class="nt">&quot;lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.001</span><span class="p">,</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="w">         </span><span class="nt">&quot;betas&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">0.8</span><span class="p">,</span><span class="w"> </span><span class="mf">0.999</span><span class="p">],</span>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="w">         </span><span class="nt">&quot;eps&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e-8</span><span class="p">,</span>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="w">         </span><span class="nt">&quot;weight_decay&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">3e-7</span>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a><span class="w">       </span><span class="p">}</span>
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="p">}</span>
</span></code></pre></div>
<p>ãŸã ã—ã€[<code>Trainer</code>] ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã¨ DeepSpeed ã‚’è‡ªåˆ†ã§åŒæœŸã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
æ§‹æˆã€‚</p>
<p>ä¸Šè¨˜ã«ãƒªã‚¹ãƒˆã•ã‚Œã¦ã„ãªã„åˆ¥ã®ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®æ§‹æˆã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="p">{</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="w">   </span><span class="nt">&quot;zero_allow_untested_optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>AdamW</code>ã¨åŒæ§˜ã«ã€å…¬å¼ã«ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ä»–ã®ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã‚’æ§‹æˆã§ãã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ç•°ãªã‚‹è¨­å®šå€¤ã‚’æŒã¤å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ä¾‹ãˆã°Adam ã®å ´åˆã¯ã€<code>weight_decay</code>ã‚’<code>0.01</code>ä»˜è¿‘ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>ã•ã‚‰ã«ã€ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã¯ã€Deepspeed ã® CPU Adam ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã¨ä½µç”¨ã™ã‚‹ã¨æœ€ã‚‚åŠ¹æœçš„ã«æ©Ÿèƒ½ã—ã¾ã™ã€‚ <code>deepspeed==0.8.3</code> ãªã®ã§ã€ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã§åˆ¥ã®ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã‚‚è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="p">{</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="w">   </span><span class="nt">&quot;zero_force_ds_cpu_optimizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>æœ€ä¸Šä½ã®æ§‹æˆã«ç§»è¡Œã—ã¾ã™ã€‚</p>
<p><a id='deepspeed-scheduler'></a></p>
<h4 id="scheduler">Scheduler</h4>
<p>DeepSpeed ã¯ã€<code>LRRangeTest</code>ã€<code>OneCycle</code>ã€<code>WarmupLR</code>ã€ãŠã‚ˆã³<code>WarmupDecayLR</code>å­¦ç¿’ç‡ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚å®Œå…¨ãª
ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯<a href="https://www.deepspeed.ai/docs/config-json/#scheduler-parameters">ã“ã“</a>ã§ã™ã€‚</p>
<p>ã“ã“ã§ã¯ã€ğŸ¤— Transformers ã¨ DeepSpeed ã®é–“ã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ãŒé‡è¤‡ã™ã‚‹å ´æ‰€ã‚’ç¤ºã—ã¾ã™ã€‚</p>
<ul>
<li><code>--lr_scheduler_type constant_with_warmup</code> çµŒç”±ã® <code>WarmupLR</code></li>
<li><code>--lr_scheduler_type Linear</code> ã‚’ä»‹ã—ãŸ <code>WarmupDecayLR</code>ã€‚ã“ã‚Œã¯ <code>--lr_scheduler_type</code> ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§ã‚‚ã‚ã‚Šã¾ã™ã€‚
  ã—ãŸãŒã£ã¦ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚’è¨­å®šã—ãªã„å ´åˆã€ã“ã‚ŒãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨­å®šã•ã‚Œã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã«ãªã‚Šã¾ã™ã€‚</li>
</ul>
<p>è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ <code>scheduler</code> ã‚¨ãƒ³ãƒˆãƒªã‚’è¨­å®šã—ãªã„å ´åˆã€[<code>Trainer</code>] ã¯
<code>--lr_scheduler_type</code>ã€<code>--learning_rate</code>ã€ãŠã‚ˆã³ <code>--warmup_steps</code> ã®å€¤ã‚’è¨­å®šã—ã¾ã™ã€‚
ğŸ¤— ãã‚Œã®ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‚</p>
<p>ä»¥ä¸‹ã¯ã€<code>WarmupLR</code>ã®è‡ªå‹•æ§‹æˆã•ã‚ŒãŸ<code>scheduler</code>ã‚¨ãƒ³ãƒˆãƒªã®ä¾‹ã§ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="p">{</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="w">   </span><span class="nt">&quot;scheduler&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="w">         </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;WarmupLR&quot;</span><span class="p">,</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="w">         </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="w">             </span><span class="nt">&quot;warmup_min_lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">             </span><span class="nt">&quot;warmup_max_lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="w">             </span><span class="nt">&quot;warmup_num_steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="w">         </span><span class="p">}</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="w">     </span><span class="p">}</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="p">}</span>
</span></code></pre></div>
<p><em>"auto"</em> ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€[<code>Trainer</code>] å¼•æ•°ã¯è¨­å®šã«æ­£ã—ã„å€¤ã‚’è¨­å®šã—ã¾ã™ã€‚
ãƒ•ã‚¡ã‚¤ãƒ«ã€‚ã“ã‚Œã¯ã€å€¤ã®æ±ºå®šçš„ãªã‚½ãƒ¼ã‚¹ãŒ 1 ã¤ã‚ã‚‹ã“ã¨ã¨ã€ãŸã¨ãˆã°æ¬¡ã®ã‚ˆã†ãªå ´åˆã«è¦‹ã¤ã‘ã«ãã„ã‚¨ãƒ©ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã§ã™ã€‚
å­¦ç¿’ç‡ã¯ã€å ´æ‰€ã”ã¨ã«ç•°ãªã‚‹å€¤ã«è¨­å®šã•ã‚Œã¾ã™ã€‚ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã®ãƒ«ãƒ¼ãƒ«ã€‚è¨­å®šã•ã‚Œã‚‹å€¤ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚</p>
<ul>
<li><code>warmup_min_lr</code> ã®å€¤ã¯ <code>0</code> ã§ã™ã€‚</li>
<li><code>warmup_max_lr</code> ã¨ <code>--learning_rate</code> ã®å€¤ã€‚</li>
<li><code>warmup_num_steps</code> ã¨ <code>--warmup_steps</code> ã®å€¤ (æŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ)</li>
<li><code>total_num_steps</code> ã«ã¯ <code>--max_steps</code> ã®å€¤ã‚’æŒ‡å®šã™ã‚‹ã‹ã€æŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯å®Ÿè¡Œæ™‚ã«è‡ªå‹•çš„ã«å°å‡ºã•ã‚Œã¾ã™ã€‚
  ç’°å¢ƒã€ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ã‚µã‚¤ã‚ºã€ãŠã‚ˆã³ãã®ä»–ã®ã‚³ãƒãƒ³ãƒ‰ ãƒ©ã‚¤ãƒ³å¼•æ•° (
  <code>WarmupDecayLR</code>)ã€‚</li>
</ul>
<p>ã‚‚ã¡ã‚ã‚“ã€æ§‹æˆå€¤ã®ä¸€éƒ¨ã¾ãŸã¯ã™ã¹ã¦ã‚’å¼•ãç¶™ã„ã§ã€è‡ªåˆ†ã§è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="p">{</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="w">   </span><span class="nt">&quot;scheduler&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="w">         </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;WarmupLR&quot;</span><span class="p">,</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="w">         </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="w">             </span><span class="nt">&quot;warmup_min_lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="w">             </span><span class="nt">&quot;warmup_max_lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.001</span><span class="p">,</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="w">             </span><span class="nt">&quot;warmup_num_steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="w">         </span><span class="p">}</span>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="w">     </span><span class="p">}</span>
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>ãŸã ã—ã€[<code>Trainer</code>] ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã¨ DeepSpeed ã‚’è‡ªåˆ†ã§åŒæœŸã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
æ§‹æˆã€‚</p>
<p>ãŸã¨ãˆã°ã€<code>WarmupDecayLR</code>ã®å ´åˆã¯ã€æ¬¡ã®ã‚¨ãƒ³ãƒˆãƒªã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="p">{</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="w">   </span><span class="nt">&quot;scheduler&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="w">         </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;WarmupDecayLR&quot;</span><span class="p">,</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">         </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="w">             </span><span class="nt">&quot;last_batch_iteration&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">             </span><span class="nt">&quot;total_num_steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="w">             </span><span class="nt">&quot;warmup_min_lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="w">             </span><span class="nt">&quot;warmup_max_lr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="w">             </span><span class="nt">&quot;warmup_num_steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="w">         </span><span class="p">}</span>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="w">     </span><span class="p">}</span>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>total_num_steps</code>ã€<code>warmup_max_lr</code>ã€<code>warmup_num_steps</code>ã€ãŠã‚ˆã³ <code>total_num_steps</code> ã¯ãƒ­ãƒ¼ãƒ‰æ™‚ã«è¨­å®šã•ã‚Œã¾ã™ã€‚</p>
<p><a id='deepspeed-fp32'></a></p>
<h3 id="fp32-precision">fp32 Precision</h3>
<p>Deepspeed ã¯ã€å®Œå…¨ãª fp32 ã¨ fp16 ã®æ··åˆç²¾åº¦ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚</p>
<p>fp16 æ··åˆç²¾åº¦ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€å¿…è¦ãªãƒ¡ãƒ¢ãƒªãŒå¤§å¹…ã«å‰Šæ¸›ã•ã‚Œã€é€Ÿåº¦ãŒå‘ä¸Šã™ã‚‹ãŸã‚ã€
ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ«ãŒã“ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° ãƒ¢ãƒ¼ãƒ‰ã§é©åˆ‡ã«å‹•ä½œã—ãªã„å ´åˆã¯ã€ä½¿ç”¨ã—ãªã„æ–¹ãŒã‚ˆã„ã§ã—ã‚‡ã†ã€‚é€šå¸¸ã“ã‚Œ
ãƒ¢ãƒ‡ãƒ«ãŒ fp16 æ··åˆç²¾åº¦ã§äº‹å‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚Œã¦ã„ãªã„å ´åˆã«ç™ºç”Ÿã—ã¾ã™ (ãŸã¨ãˆã°ã€ã“ã‚Œã¯ bf16 ã§äº‹å‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸå ´åˆã«ã‚ˆãç™ºç”Ÿã—ã¾ã™)
ãƒ¢ãƒ‡ãƒ«ï¼‰ã€‚ã“ã®ã‚ˆã†ãªãƒ¢ãƒ‡ãƒ«ã§ã¯ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã¾ãŸã¯ã‚¢ãƒ³ãƒ€ãƒ¼ãƒ•ãƒ­ãƒ¼ãŒç™ºç”Ÿã—ã€<code>NaN</code>æå¤±ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚ŒãŒã‚ãªãŸã®å ´åˆã¯ã€ä½¿ç”¨ã—ãŸã„ã¨æ€ã†ã§ã—ã‚‡ã†
å®Œå…¨ãª fp32 ãƒ¢ãƒ¼ãƒ‰ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® fp16 æ··åˆç²¾åº¦ãƒ¢ãƒ¼ãƒ‰ã‚’æ¬¡ã®ã‚ˆã†ã«æ˜ç¤ºçš„ã«ç„¡åŠ¹ã«ã—ã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="p">{</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="w">    </span><span class="nt">&quot;fp16&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="w">        </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>Ampere ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ ãƒ™ãƒ¼ã‚¹ã® GPU ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€pytorch ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 1.7 ä»¥é™ã¯è‡ªå‹•çš„ã« ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚
ä¸€éƒ¨ã®æ“ä½œã§ã¯ã¯ã‚‹ã‹ã«åŠ¹ç‡çš„ãª tf32 å½¢å¼ã‚’ä½¿ç”¨ã—ã¾ã™ãŒã€çµæœã¯ä¾ç„¶ã¨ã—ã¦ fp32 ã«ãªã‚Šã¾ã™ã€‚è©³ç´°ã¨
ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã«ã¤ã„ã¦ã¯ã€<a href="https://pytorch.org/docs/stable/notes/cuda.html#tensorfloat-32-tf32-on-ampere-devices">Ampere ãƒ‡ãƒã‚¤ã‚¹ä¸Šã® TensorFloat-32(TF32)</a> ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚æ–‡æ›¸ã«ã¯ä»¥ä¸‹ãŒå«ã¾ã‚Œã¾ã™
ä½•ã‚‰ã‹ã®ç†ç”±ã§ã“ã®è‡ªå‹•å¤‰æ›ã‚’ä½¿ç”¨ã—ãŸããªã„å ´åˆã¯ã€ã“ã®è‡ªå‹•å¤‰æ›ã‚’ç„¡åŠ¹ã«ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚</p>
<p>ğŸ¤— ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã§ã¯ã€<code>--tf32</code> ã‚’ä½¿ç”¨ã—ã¦æœ‰åŠ¹ã«ã™ã‚‹ã‹ã€<code>--tf32 0</code> ã¾ãŸã¯ <code>--no_tf32</code> ã‚’ä½¿ç”¨ã—ã¦ç„¡åŠ¹ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€PyTorch ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</p>
<p><a id='deepspeed-amp'></a></p>
<h3 id="automatic-mixed-precision">Automatic Mixed Precision</h3>
<h3 id="fp16">fp16</h3>
<p>fp16 (float16) ã‚’è¨­å®šã—ã¦ pytorch AMP ã®ã‚ˆã†ãªãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹ã«ã¯:</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="p">{</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="w">    </span><span class="nt">&quot;fp16&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="w">        </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="w">        </span><span class="nt">&quot;loss_scale&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="w">        </span><span class="nt">&quot;loss_scale_window&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="w">        </span><span class="nt">&quot;initial_scale_power&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="w">        </span><span class="nt">&quot;hysteresis&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="w">        </span><span class="nt">&quot;min_loss_scale&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>[<code>Trainer</code>] ã¯ã€ã®å€¤ã«åŸºã¥ã„ã¦ãã‚Œã‚’è‡ªå‹•çš„ã«æœ‰åŠ¹ã¾ãŸã¯ç„¡åŠ¹ã«ã—ã¾ã™ã€‚
<code>args.fp16_backend</code>ã€‚æ®‹ã‚Šã®è¨­å®šå€¤ã¯ã‚ãªãŸæ¬¡ç¬¬ã§ã™ã€‚</p>
<p>ã“ã®ãƒ¢ãƒ¼ãƒ‰ã¯ã€<code>--fp16 --fp16_backend amp</code>ã¾ãŸã¯<code>--fp16_full_eval</code>ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ãŒæ¸¡ã•ã‚Œã‚‹ã¨æœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚</p>
<p>ã“ã®ãƒ¢ãƒ¼ãƒ‰ã‚’æ˜ç¤ºçš„ã«æœ‰åŠ¹/ç„¡åŠ¹ã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="p">{</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="w">    </span><span class="nt">&quot;fp16&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="w">        </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">        </span><span class="nt">&quot;loss_scale&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">        </span><span class="nt">&quot;loss_scale_window&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="w">        </span><span class="nt">&quot;initial_scale_power&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="w">        </span><span class="nt">&quot;hysteresis&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="w">        </span><span class="nt">&quot;min_loss_scale&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>ãŸã ã—ã€[<code>Trainer</code>] ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã¨ DeepSpeed ã‚’è‡ªåˆ†ã§åŒæœŸã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
æ§‹æˆã€‚</p>
<p>ã“ã‚ŒãŒ<a href="https://www.deepspeed.ai/docs/config-json/#fp16-training-options">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a>ã§ã™ã€‚</p>
<h3 id="bf16">BF16</h3>
<p>fp16 ã®ä»£ã‚ã‚Šã« bf16 (bfloat16) ãŒå¿…è¦ãªå ´åˆã¯ã€æ¬¡ã®æ§‹æˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="p">{</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="w">    </span><span class="nt">&quot;bf16&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="w">        </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>bf16 ã¯ fp32 ã¨åŒã˜ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ ãƒ¬ãƒ³ã‚¸ã‚’å‚™ãˆã¦ã„ã‚‹ãŸã‚ã€æå¤±ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
<p>ã“ã®ãƒ¢ãƒ¼ãƒ‰ã¯ã€<code>--bf16</code> ã¾ãŸã¯ <code>--bf16_full_eval</code> ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ãŒæ¸¡ã•ã‚Œã‚‹ã¨æœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚</p>
<p>ã“ã®ãƒ¢ãƒ¼ãƒ‰ã‚’æ˜ç¤ºçš„ã«æœ‰åŠ¹/ç„¡åŠ¹ã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="p">{</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="w">    </span><span class="nt">&quot;bf16&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="w">        </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="p">}</span>
</span></code></pre></div>
<p><Tip></p>
<p><code>deepspeed==0.6.0</code>ã®æ™‚ç‚¹ã§ã¯ã€bf16 ã‚µãƒãƒ¼ãƒˆã¯æ–°ã—ãå®Ÿé¨“çš„ãªã‚‚ã®ã§ã™ã€‚</p>
<p>bf16 ãŒæœ‰åŠ¹ãªçŠ¶æ…‹ã§ <a href="#gradient-accumulation">å‹¾é…ç´¯ç©</a> ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€bf16 ã§å‹¾é…ãŒç´¯ç©ã•ã‚Œã‚‹ã“ã¨ã«æ³¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®å½¢å¼ã®ç²¾åº¦ãŒä½ã„ãŸã‚ã€ã“ã‚Œã¯å¸Œæœ›ã©ãŠã‚Šã§ã¯ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æå¤±ã®ã‚ã‚‹è“„ç©ã«ã¤ãªãŒã‚Šã¾ã™ã€‚</p>
<p>ã“ã®å•é¡Œã‚’ä¿®æ­£ã—ã€ã‚ˆã‚Šé«˜ç²¾åº¦ã® <code>dtype</code> (fp16 ã¾ãŸã¯ fp32) ã‚’ä½¿ç”¨ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æä¾›ã™ã‚‹ãŸã‚ã®ä½œæ¥­ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚</p>
<p></Tip></p>
<h3 id="nccl-collectives">NCCL Collectives</h3>
<p>è¨“ç·´ä½“åˆ¶ã®<code>dtype</code>ãŒã‚ã‚Šã€ã•ã¾ã–ã¾ãªå‰Šæ¸›ã‚„åé›†/åˆ†æ•£æ“ä½œãªã©ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³é›†åˆä½“ã«ä½¿ç”¨ã•ã‚Œã‚‹åˆ¥ã®<code>dtype</code>ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>ã™ã¹ã¦ã®åé›†/åˆ†æ•£æ“ä½œã¯ã€ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã¨åŒã˜ <code>dtype</code> ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€bf16 ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ä½“åˆ¶ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€ãƒ‡ãƒ¼ã‚¿ã¯ bf16 ã§åé›†ã•ã‚Œã¾ã™ã€‚åé›†ã¯æå¤±ã®ãªã„æ“ä½œã§ã™ã€‚</p>
<p>ã•ã¾ã–ã¾ãªãƒªãƒ‡ãƒ¥ãƒ¼ã‚¹æ“ä½œã¯éå¸¸ã«æå¤±ãŒå¤§ãã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€è¤‡æ•°ã® GPU é–“ã§å‹¾é…ãŒå¹³å‡åŒ–ã•ã‚Œã‚‹å ´åˆã€é€šä¿¡ãŒ fp16 ã¾ãŸã¯ bf16 ã§è¡Œã‚ã‚Œã‚‹å ´åˆã€çµæœã¯æå¤±ãŒå¤šããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚è¤‡æ•°ã®æ•°å€¤ã‚’ä½ç²¾åº¦ã§ã‚¢ãƒ‰ãƒã‚¿ã‚¤ã‚ºã™ã‚‹ã¨çµæœã¯æ­£ç¢ºã§ã¯ãªã„ãŸã‚ã§ã™ã€‚ ã€‚ bf16 ã§ã¯ fp16 ã‚ˆã‚Šã‚‚ç²¾åº¦ãŒä½ã„ãŸã‚ã€ã•ã‚‰ã«ãã†ã§ã™ã€‚é€šå¸¸ã¯éå¸¸ã«å°ã•ã„ grad ã‚’å¹³å‡ã™ã‚‹éš›ã®æå¤±ãŒæœ€å°é™ã«æŠ‘ãˆã‚‰ã‚Œã‚‹ãŸã‚ã€fp16 ã§ååˆ†ã§ã‚ã‚‹ã“ã¨ãŒã‚ˆãã‚ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€åŠç²¾åº¦ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§ã¯ fp16 ãŒãƒªãƒ€ã‚¯ã‚·ãƒ§ãƒ³æ¼”ç®—ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ãŸã ã—ã€ã“ã®æ©Ÿèƒ½ã‚’å®Œå…¨ã«åˆ¶å¾¡ã§ãã€å¿…è¦ã«å¿œã˜ã¦å°ã•ãªã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¦ã€ãƒªãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãŒç´¯ç© dtype ã¨ã—ã¦ fp32 ã‚’ä½¿ç”¨ã—ã€çµæœã®æº–å‚™ãŒã§ããŸå ´åˆã«ã®ã¿åŠç²¾åº¦ <code>dtype</code> ã«ãƒ€ã‚¦ãƒ³ã‚­ãƒ£ã‚¹ãƒˆã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ä¸­ã§ã™ã€‚</p>
<p>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã«ã¯ã€æ–°ã—ã„æ§‹æˆã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="p">{</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="w">    </span><span class="nt">&quot;communication_data_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;fp32&quot;</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>ã“ã®è¨˜äº‹ã®åŸ·ç­†æ™‚ç‚¹ã§ã®æœ‰åŠ¹ãªå€¤ã¯ã€"fp16"ã€"bfp16"ã€"fp32"ã§ã™ã€‚</p>
<p>æ³¨: ã‚¹ãƒ†ãƒ¼ã‚¸ ã‚¼ãƒ­ 3 ã«ã¯ã€bf16 é€šä¿¡ã‚¿ã‚¤ãƒ—ã«é–¢ã™ã‚‹ãƒã‚°ãŒã‚ã‚Šã€<code>deepspeed==0.8.1</code>ã§ä¿®æ­£ã•ã‚Œã¾ã—ãŸã€‚</p>
<h3 id="batch-size">Batch Size</h3>
<p>ãƒãƒƒãƒã‚µã‚¤ã‚ºã‚’è¨­å®šã™ã‚‹ã«ã¯ã€æ¬¡ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="p">{</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="w">    </span><span class="nt">&quot;train_batch_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="w">    </span><span class="nt">&quot;train_micro_batch_size_per_gpu&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="p">}</span>
</span></code></pre></div>
<p>[<code>Trainer</code>] ã¯è‡ªå‹•çš„ã« <code>train_micro_batch_size_per_gpu</code> ã‚’æ¬¡ã®å€¤ã«è¨­å®šã—ã¾ã™ã€‚
<code>args.per_device_train_batch_size</code>ã¨<code>train_batch_size</code>ã‚’<code>args.world_size * args.per_device_train_batch_size * args.gradient_accumulation_steps</code>ã«å¤‰æ›´ã—ã¾ã™ã€‚</p>
<p>å€¤ã‚’æ˜ç¤ºçš„ã«è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="p">{</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="w">    </span><span class="nt">&quot;train_batch_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="w">    </span><span class="nt">&quot;train_micro_batch_size_per_gpu&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="p">}</span>
</span></code></pre></div>
<p>ãŸã ã—ã€[<code>Trainer</code>] ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã¨ DeepSpeed ã‚’è‡ªåˆ†ã§åŒæœŸã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
æ§‹æˆã€‚</p>
<p><a id='deepspeed-grad-acc'></a></p>
<h3 id="gradient-accumulation">Gradient Accumulation</h3>
<p>å‹¾é…ç´¯ç©ã‚»ãƒƒãƒˆã‚’æ§‹æˆã™ã‚‹ã«ã¯:</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="p">{</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="w">    </span><span class="nt">&quot;gradient_accumulation_steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>[<code>Trainer</code>] ã¯è‡ªå‹•çš„ã«ãã‚Œã‚’ <code>args.gradient_accumulation_steps</code> ã®å€¤ã«è¨­å®šã—ã¾ã™ã€‚</p>
<p>å€¤ã‚’æ˜ç¤ºçš„ã«è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="p">{</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="w">    </span><span class="nt">&quot;gradient_accumulation_steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>ãŸã ã—ã€[<code>Trainer</code>] ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã¨ DeepSpeed ã‚’è‡ªåˆ†ã§åŒæœŸã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
æ§‹æˆã€‚</p>
<p><a id='deepspeed-grad-clip'></a></p>
<h3 id="gradient-clipping">Gradient Clipping</h3>
<p>ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ ã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚° ã‚»ãƒƒãƒˆã‚’æ§‹æˆã™ã‚‹ã«ã¯:</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="p">{</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="w">    </span><span class="nt">&quot;gradient_clipping&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>[<code>Trainer</code>] ã¯è‡ªå‹•çš„ã«ãã‚Œã‚’ <code>args.max_grad_norm</code> ã®å€¤ã«è¨­å®šã—ã¾ã™ã€‚</p>
<p>å€¤ã‚’æ˜ç¤ºçš„ã«è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="p">{</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="w">    </span><span class="nt">&quot;gradient_clipping&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>ãŸã ã—ã€[<code>Trainer</code>] ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã¨ DeepSpeed ã‚’è‡ªåˆ†ã§åŒæœŸã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
æ§‹æˆã€‚</p>
<p><a id='deepspeed-weight-extraction'></a></p>
<h3 id="getting-the-model-weights-out">Getting The Model Weights Out</h3>
<p>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ç¶™ç¶šã—ã€DeepSpeed ã®ä½¿ç”¨ã‚’å†é–‹ã™ã‚‹é™ã‚Šã€ä½•ã‚‚å¿ƒé…ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ DeepSpeed ã‚¹ãƒˆã‚¢
fp32 ã®ã‚«ã‚¹ã‚¿ãƒ  ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ãƒã‚¹ã‚¿ãƒ¼ã®é‡ã¿ã€‚ã“ã‚Œã¯ <code>global_step*/*optim_states.pt</code> (ã“ã‚Œã¯ glob
ãƒ‘ã‚¿ãƒ¼ãƒ³)ã€é€šå¸¸ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã®ä¸‹ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
<p><strong>FP16 ã‚¦ã‚§ã‚¤ãƒˆ:</strong></p>
<p>ãƒ¢ãƒ‡ãƒ«ã‚’ ZeRO-2 ã§ä¿å­˜ã™ã‚‹ã¨ã€ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ã‚’å«ã‚€é€šå¸¸ã® <code>pytorch_model.bin</code> ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ãŒã€
ã“ã‚Œã‚‰ã¯é‡ã¿ã® fp16 ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã™ãã¾ã›ã‚“ã€‚</p>
<p>ZeRO-3 ã§ã¯ã€ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ãŒè¤‡æ•°ã® GPU ã«åˆ†å‰²ã•ã‚Œã‚‹ãŸã‚ã€çŠ¶æ³ã¯ã•ã‚‰ã«è¤‡é›‘ã«ãªã‚Šã¾ã™ã€‚
ã—ãŸãŒã£ã¦ã€fp16 ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã® <code>Trainer</code> ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€<code>"stage3_gather_16bit_weights_on_model_save": true</code> ãŒå¿…è¦ã§ã™ã€‚
é‡ã¿ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‚ã“ã®è¨­å®šãŒ<code>False</code>ã®å ´åˆã€<code>pytorch_model.bin</code>ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“ã€‚ã“ã‚Œã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ DeepSpeed ã® <code>state_dict</code> ã«å®Ÿéš›ã®é‡ã¿ã§ã¯ãªããƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒå«ã¾ã‚Œã‚‹ãŸã‚ã§ã™ã€‚ã“ã® <code>state_dict</code> ã‚’ä¿å­˜ã—ãŸå ´åˆã€ãƒ­ãƒ¼ãƒ‰ã—ç›´ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="p">{</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="w">    </span><span class="nt">&quot;zero_optimization&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="w">        </span><span class="nt">&quot;stage3_gather_16bit_weights_on_model_save&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>FP32 é‡é‡:</strong></p>
<p>fp16 ã‚¦ã‚§ã‚¤ãƒˆã¯ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å†é–‹ã™ã‚‹ã®ã«é©ã—ã¦ã„ã¾ã™ãŒã€ãƒ¢ãƒ‡ãƒ«ã®å¾®èª¿æ•´ãŒå®Œäº†ã—ã€ãã‚Œã‚’
<a href="https://huggingface.co/models">ãƒ¢ãƒ‡ãƒ« ãƒãƒ–</a> ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‹ã€fp32 ã‚’å…¥æ‰‹ã—ãŸã„ã¨æ€ã‚ã‚Œã‚‹ä»–ã®äººã«æ¸¡ã—ã¾ã™ã€‚
é‡ã¿ã€‚ã“ã‚Œã¯å¤§é‡ã®ãƒ¡ãƒ¢ãƒªã‚’å¿…è¦ã¨ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã§ã‚ã‚‹ãŸã‚ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ä¸­ã«è¡Œã†ã¹ãã§ã¯ãªã„ã®ãŒç†æƒ³çš„ã§ã™ã€‚
ã—ãŸãŒã£ã¦ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®å®Œäº†å¾Œã«ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§å®Ÿè¡Œã™ã‚‹ã®ãŒæœ€é©ã§ã™ã€‚ãŸã ã—ã€å¿…è¦ã«å¿œã˜ã¦ã€ç©ºã CPU ãŒååˆ†ã«ã‚ã‚‹å ´åˆã¯ã€
åŒã˜ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å®Ÿè¡Œã§ãã‚‹ã“ã¨ã‚’æ€ã„å‡ºã—ã¦ãã ã•ã„ã€‚æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ä¸¡æ–¹ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚</p>
<p><strong>ãƒ©ã‚¤ãƒ– FP32 ã‚¦ã‚§ã‚¤ãƒˆ ãƒªã‚«ãƒãƒª:</strong></p>
<p>ãƒ¢ãƒ‡ãƒ«ãŒå¤§ããã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®çµ‚äº†æ™‚ã«ç©ºã CPU ãƒ¡ãƒ¢ãƒªãŒã»ã¨ã‚“ã©æ®‹ã£ã¦ã„ãªã„å ´åˆã€ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯æ©Ÿèƒ½ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>å°‘ãªãã¨ã‚‚ 1 ã¤ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ä¿å­˜ã—ã¦ã„ã¦ã€æœ€æ–°ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã¯ã€æ¬¡ã®æ‰‹é †ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.trainer_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_last_checkpoint</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">deepspeed.utils.zero_to_fp32</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_state_dict_from_zero_checkpoint</span>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="n">get_last_checkpoint</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="n">fp32_model</span> <span class="o">=</span> <span class="n">load_state_dict_from_zero_checkpoint</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">checkpoint_dir</span><span class="p">)</span>
</span></code></pre></div>
<p><code>--load_best_model_at_end</code> class:<em>~transformers.TrainingArguments</em> å¼•æ•°ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆ (æœ€é©ãªãƒ¢ãƒ‡ãƒ«ã‚’è¿½è·¡ã™ã‚‹ãŸã‚)
ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ)ã€æœ€åˆã«æœ€çµ‚ãƒ¢ãƒ‡ãƒ«ã‚’æ˜ç¤ºçš„ã«ä¿å­˜ã—ã¦ã‹ã‚‰ã€ä¸Šè¨˜ã¨åŒã˜ã“ã¨ã‚’è¡Œã†ã“ã¨ã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’çµ‚äº†ã§ãã¾ã™ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">deepspeed.utils.zero_to_fp32</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_state_dict_from_zero_checkpoint</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;checkpoint-final&quot;</span><span class="p">)</span>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="n">trainer</span><span class="o">.</span><span class="n">deepspeed</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">)</span>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="n">fp32_model</span> <span class="o">=</span> <span class="n">load_state_dict_from_zero_checkpoint</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">checkpoint_dir</span><span class="p">)</span>
</span></code></pre></div>
<p><Tip></p>
<p><code>load_state_dict_from_zero_checkpoint</code> ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨ã€<code>model</code> ã¯ã‚‚ã¯ã‚„ä½¿ç”¨ã§ããªããªã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
åŒã˜ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã® DeepSpeed ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€‚ã¤ã¾ã‚Šã€deepspeed ã‚¨ãƒ³ã‚¸ãƒ³ã‚’å†åˆæœŸåŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
<code>model.load_state_dict(state_dict)</code> ã¯ãã“ã‹ã‚‰ã™ã¹ã¦ã® DeepSpeed ãƒã‚¸ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ã“ã‚Œã¯æœ€å¾Œã«ã®ã¿å®Ÿè¡Œã—ã¦ãã ã•ã„
ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®æ§˜å­ã€‚</p>
<p></Tip></p>
<p>ã‚‚ã¡ã‚ã‚“ã€class:<em>~transformers.Trainer</em> ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ã¯ãªãã€ä¸Šè¨˜ã®ä¾‹ã‚’ç‹¬è‡ªã®ã‚‚ã®ã«èª¿æ•´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã€‚</p>
<p>ä½•ã‚‰ã‹ã®ç†ç”±ã§ã•ã‚‰ã«æ”¹è‰¯ã—ãŸã„å ´åˆã¯ã€é‡ã¿ã® fp32 <code>state_dict</code> ã‚’æŠ½å‡ºã—ã¦é©ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
æ¬¡ã®ä¾‹ã«ç¤ºã™ã‚ˆã†ã«ã€ã“ã‚Œã‚‰ã¯è‡ªåˆ†ã§ä½œæˆã—ã¾ã™ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">deepspeed.utils.zero_to_fp32</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_fp32_state_dict_from_zero_checkpoint</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="n">state_dict</span> <span class="o">=</span> <span class="n">get_fp32_state_dict_from_zero_checkpoint</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">)</span>  <span class="c1"># already on cpu</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ FP32 ã‚¦ã‚§ã‚¤ãƒˆ ãƒªã‚«ãƒãƒª:</strong></p>
<p>DeepSpeed ã¯ç‰¹åˆ¥ãªå¤‰æ›ã‚¹ã‚¯ãƒªãƒ—ãƒˆ<code>zero_to_fp32.py</code>ã‚’ä½œæˆã—ã€ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã®æœ€ä¸Šä½ã«é…ç½®ã—ã¾ã™ã€‚
ãƒ•ã‚©ãƒ«ãƒ€ã€‚ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã„ã¤ã§ã‚‚é‡ã¿ã‚’æŠ½å‡ºã§ãã¾ã™ã€‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãªã®ã§ã€ã‚‚ã†å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚
æŠ½å‡ºã‚’è¡Œã†ãŸã‚ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ <code>Trainer</code> ãŒå¿…è¦ã§ã™ã€‚</p>
<p>ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ãŒæ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã¨ã—ã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a>$<span class="w"> </span>ls<span class="w"> </span>-l<span class="w"> </span>output_dir/checkpoint-1/
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>-rw-rw-r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>stas<span class="w"> </span>stas<span class="w"> </span><span class="m">1</span>.4K<span class="w"> </span>Mar<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">20</span>:42<span class="w"> </span>config.json
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a>drwxrwxr-x<span class="w"> </span><span class="m">2</span><span class="w"> </span>stas<span class="w"> </span>stas<span class="w"> </span><span class="m">4</span>.0K<span class="w"> </span>Mar<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:52<span class="w"> </span>global_step1/
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>-rw-rw-r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>stas<span class="w"> </span>stas<span class="w">   </span><span class="m">12</span><span class="w"> </span>Mar<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">13</span>:16<span class="w"> </span>latest
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a>-rw-rw-r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>stas<span class="w"> </span>stas<span class="w"> </span>827K<span class="w"> </span>Mar<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">20</span>:42<span class="w"> </span>optimizer.pt
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>-rw-rw-r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>stas<span class="w"> </span>stas<span class="w"> </span>231M<span class="w"> </span>Mar<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">20</span>:42<span class="w"> </span>pytorch_model.bin
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a>-rw-rw-r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>stas<span class="w"> </span>stas<span class="w">  </span><span class="m">623</span><span class="w"> </span>Mar<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">20</span>:42<span class="w"> </span>scheduler.pt
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a>-rw-rw-r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>stas<span class="w"> </span>stas<span class="w"> </span><span class="m">1</span>.8K<span class="w"> </span>Mar<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">20</span>:42<span class="w"> </span>special_tokens_map.json
</span><span id="__span-60-9"><a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a>-rw-rw-r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>stas<span class="w"> </span>stas<span class="w"> </span>774K<span class="w"> </span>Mar<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">20</span>:42<span class="w"> </span>spiece.model
</span><span id="__span-60-10"><a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a>-rw-rw-r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>stas<span class="w"> </span>stas<span class="w"> </span><span class="m">1</span>.9K<span class="w"> </span>Mar<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">20</span>:42<span class="w"> </span>tokenizer_config.json
</span><span id="__span-60-11"><a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a>-rw-rw-r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>stas<span class="w"> </span>stas<span class="w">  </span><span class="m">339</span><span class="w"> </span>Mar<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">20</span>:42<span class="w"> </span>trainer_state.json
</span><span id="__span-60-12"><a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a>-rw-rw-r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>stas<span class="w"> </span>stas<span class="w"> </span><span class="m">2</span>.3K<span class="w"> </span>Mar<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">20</span>:42<span class="w"> </span>training_args.bin
</span><span id="__span-60-13"><a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a>-rwxrw-r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>stas<span class="w"> </span>stas<span class="w"> </span><span class="m">5</span>.5K<span class="w"> </span>Mar<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">13</span>:16<span class="w"> </span>zero_to_fp32.py*
</span></code></pre></div>
<p>ã“ã®ä¾‹ã§ã¯ã€DeepSpeed ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ <em>global_step1</em> ãŒ 1 ã¤ã ã‘ã‚ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€FP32ã‚’å†æ§‹ç¯‰ã™ã‚‹ã«ã¯
é‡ã¿ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã§ã™:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a>python<span class="w"> </span>zero_to_fp32.py<span class="w"> </span>.<span class="w"> </span>pytorch_model.bin
</span></code></pre></div>
<p>ã“ã‚Œã ã‚ˆã€‚ <code>pytorch_model.bin</code>ã«ã¯ã€è¤‡æ•°ã® GPU ã‹ã‚‰çµ±åˆã•ã‚ŒãŸå®Œå…¨ãª fp32 ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ãŒå«ã¾ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
<p>ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ZeRO-2 ã¾ãŸã¯ ZeRO-3 ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è‡ªå‹•çš„ã«å‡¦ç†ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
<p><code>python zero_to_fp32.py -h</code> ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä½¿ç”¨æ–¹æ³•ã®è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
<p>ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«<code>latest</code>ã®å†…å®¹ã‚’ä½¿ç”¨ã—ã¦ deepspeed ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’è‡ªå‹•æ¤œå‡ºã—ã¾ã™ã€‚
ä¾‹ã«ã¯<code>global_step1</code>ãŒå«ã¾ã‚Œã¾ã™ã€‚</p>
<p>æ³¨: ç¾åœ¨ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã¯æœ€çµ‚çš„ãª fp32 ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ã® 2 å€ã®ä¸€èˆ¬ RAM ãŒå¿…è¦ã§ã™ã€‚</p>
<h3 id="zero-3-infinity-nuances">ZeRO-3 ã¨ Infinity Nuances</h3>
<p>ZeRO-3 ã¯ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ã‚·ãƒ£ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ã®ç‚¹ã§ ZeRO-2 ã¨ã¯å¤§ããç•°ãªã‚Šã¾ã™ã€‚</p>
<p>ZeRO-Infinity ã¯ ZeRO-3 ã‚’ã•ã‚‰ã«æ‹¡å¼µã—ã€NVMe ãƒ¡ãƒ¢ãƒªã‚„ãã®ä»–ã®è¤‡æ•°ã®é€Ÿåº¦ã¨ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã®å‘ä¸Šã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚</p>
<p>ãƒ¢ãƒ‡ãƒ«ã«ç‰¹åˆ¥ãªå¤‰æ›´ã‚’åŠ ãˆã‚‹å¿…è¦ãŒãªãã¦ã‚‚æ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã‚ã‚‰ã‚†ã‚‹åŠªåŠ›ãŒæ‰•ã‚ã‚Œã¦ãã¾ã—ãŸãŒã€ç‰¹å®šã®ç‚¹ã§ã¯
çŠ¶æ³ã«ã‚ˆã£ã¦ã¯ã€æ¬¡ã®æƒ…å ±ãŒå¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
<h4 id="constructing-massive-models">Constructing Massive Models</h4>
<p>DeepSpeed/ZeRO-3 ã¯ã€æ—¢å­˜ã® RAM ã«åã¾ã‚‰ãªã„å¯èƒ½æ€§ã®ã‚ã‚‹æ•°å…†ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¤ãƒ¢ãƒ‡ãƒ«ã‚’å‡¦ç†ã§ãã¾ã™ã€‚ãã®ã‚ˆã†ãªå ´åˆã€
ã¾ãŸã€åˆæœŸåŒ–ã‚’ã‚ˆã‚Šé«˜é€Ÿã«å®Ÿè¡Œã—ãŸã„å ´åˆã¯ã€<em>deepspeed.zero.Init()</em> ã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ (é–¢æ•°ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã‚‚ã‚ã‚Šã¾ã™)ã€‚æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">T5ForConditionalGeneration</span><span class="p">,</span> <span class="n">T5Config</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">deepspeed</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="k">with</span> <span class="n">deepspeed</span><span class="o">.</span><span class="n">zero</span><span class="o">.</span><span class="n">Init</span><span class="p">():</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">T5Config</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;google-t5/t5-small&quot;</span><span class="p">)</span>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">T5ForConditionalGeneration</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></code></pre></div>
<p>ã”è¦§ã®ã¨ãŠã‚Šã€ã“ã‚Œã«ã‚ˆã‚Šãƒ©ãƒ³ãƒ€ãƒ ã«åˆæœŸåŒ–ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚</p>
<p>äº‹å‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã€<code>model_class.from_pretrained</code> ã¯æ¬¡ã®æ¡ä»¶ã‚’æº€ãŸã™é™ã‚Šã“ã®æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚
<code>is_deepspeed_zero3_enabled()</code> ã¯ <code>True</code> ã‚’è¿”ã—ã¾ã™ã€‚ã“ã‚Œã¯ç¾åœ¨ã€
[<code>TrainingArguments</code>] ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ (æ¸¡ã•ã‚ŒãŸ DeepSpeed æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã« ZeRO-3 æ§‹æˆãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ)
ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€‚ã—ãŸãŒã£ã¦ã€å‘¼ã³å‡ºã—ã®å‰ã«** [<code>TrainingArguments</code>] ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
<code>from_pretrained</code>ã€‚è€ƒãˆã‚‰ã‚Œã‚‹ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã®ä¾‹ã‚’æ¬¡ã«ç¤ºã—ã¾ã™ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoModel</span><span class="p">,</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">TrainingArguments</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">deepspeed</span><span class="o">=</span><span class="n">ds_config</span><span class="p">)</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;google-t5/t5-small&quot;</span><span class="p">)</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</span></code></pre></div>
<p>å…¬å¼ã®ã‚µãƒ³ãƒ—ãƒ« ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦ã„ã¦ã€ã‚³ãƒãƒ³ãƒ‰ ãƒ©ã‚¤ãƒ³å¼•æ•°ã« <code>--deepspeed ds_config.json</code> ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
ZeRO-3 è¨­å®šã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€ã“ã‚ŒãŒã‚µãƒ³ãƒ—ãƒ« ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è¨˜è¿°æ–¹æ³•ã§ã‚ã‚‹ãŸã‚ã€ã™ã¹ã¦ãŒã™ã§ã«å®Œäº†ã—ã¦ã„ã¾ã™ã€‚</p>
<p>æ³¨: ãƒ¢ãƒ‡ãƒ«ã® fp16 é‡ã¿ãŒå˜ä¸€ã® GPU ã®ãƒ¡ãƒ¢ãƒªã«åã¾ã‚‰ãªã„å ´åˆã¯ã€ã“ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>ã“ã®æ–¹æ³•ã¨ãã®ä»–ã®é–¢é€£æ©Ÿèƒ½ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€<a href="https://deepspeed.readthedocs.io/en/latest/zero3.html#constructing-massive-models">å¤§è¦æ¨¡ãƒ¢ãƒ‡ãƒ«ã®æ§‹ç¯‰</a> ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
<p>ã¾ãŸã€fp16 ã§äº‹å‰è¨“ç·´ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ãã¯ã€<code>from_pretrained</code> ã«ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«æŒ‡ç¤ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
<code>dtype=torch.float16</code>ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€<a href="#from_pretrained-torch-dtype">from_pretrained-torch-dtype</a> ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
<h4 id="gathering-parameters">Gathering Parameters</h4>
<p>è¤‡æ•°ã® GPU ä¸Šã® ZeRO-3 ã§ã¯ã€ç¾åœ¨ã® GPU ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ãªã„é™ã‚Šã€å˜ä¸€ã® GPU ãŒã™ã¹ã¦ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¤ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
å®Ÿè¡Œå±¤ã€‚ã—ãŸãŒã£ã¦ã€ã™ã¹ã¦ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã™ã¹ã¦ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã«ä¸€åº¦ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€ãã‚Œã‚’è¡Œã†ãŸã‚ã®ç‰¹å®šã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚
ã»ã¨ã‚“ã©ã®å ´åˆã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ãŒã€å¿…è¦ãªå ´åˆã¯ã€<a href="https://deepspeed.readthedocs.io/en/latest/zero3.html#manual-parameter-coordination">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®åé›†</a> ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
<p>ãŸã ã—ã€ã„ãã¤ã‹ã®å ´æ‰€ã§å†…éƒ¨çš„ã«ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ãã®ä¾‹ã® 1 ã¤ã¯ã€äº‹å‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ãã§ã™ã€‚
<code>from_pretrained</code>ã€‚ä¸€åº¦ã« 1 ã¤ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€å‚åŠ ã—ã¦ã„ã‚‹ã™ã¹ã¦ã® GPU ã«å³åº§ã«åˆ†å‰²ã—ã¾ã™ã€‚
å¤§è¦æ¨¡ãªãƒ¢ãƒ‡ãƒ«ã§ã¯ã€ãƒ¡ãƒ¢ãƒªã®é–¢ä¿‚ã§ã€1 ã¤ã® GPU ã«ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰è¤‡æ•°ã® GPU ã«åˆ†æ•£ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
åˆ¶é™ã€‚</p>
<p>ã¾ãŸã€ZeRO-3 ã§ã¯ã€ç‹¬è‡ªã®ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã€æ¬¡ã®ã‚ˆã†ãªãƒ¢ãƒ‡ãƒ« ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®é‡ã¿ãŒç™ºç”Ÿã™ã‚‹ã¨ã—ã¾ã™ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda:0&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></code></pre></div>
<p><code>tensor([1.])</code> ã«ã‚¹ãƒˆãƒ¬ã‚¹ã‚’æ„Ÿã˜ãŸå ´åˆã€ã¾ãŸã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã‚µã‚¤ã‚ºãŒ <code>1</code> ã§ã‚ã‚‹ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
ã‚ˆã‚Šå¤§ããªå¤šæ¬¡å…ƒå½¢çŠ¶ã€‚ã“ã‚Œã¯ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒåˆ†å‰²ã•ã‚Œã¦ãŠã‚Šã€è¡¨ç¤ºã•ã‚Œã‚‹ã®ã¯ ZeRO-3 ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã§ã‚ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚</p>
<p><a id='deepspeed-zero-inference'></a></p>
<h3 id="zero-inference">ZeRO Inference</h3>
<p>ZeRO Inference ã¯ã€ZeRO-3 Training ã¨åŒã˜æ§‹æˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚ã§
å®Ÿéš›ã€åŒã˜ã‚‚ã®ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨å…±æœ‰ã—ãŸã„å ´åˆã¯ã€ã“ã‚Œã‚‰ã‚’è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«æ®‹ã™ã“ã¨ãŒã§ãã¾ã™ã€‚å½¼ã‚‰ã¯ãŸã ãã†ãªã‚‹ã ã‚ã†
ç„¡è¦–ã•ã‚Œã¾ã—ãŸã€‚</p>
<p>ãã‚Œä»¥å¤–ã®å ´åˆã¯ã€é€šå¸¸ã® [<code>TrainingArguments</code>] å¼•æ•°ã‚’æ¸¡ã™ã ã‘ã§ã™ã€‚ä¾‹ãˆã°ï¼š</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a>deepspeed<span class="w"> </span>--num_gpus<span class="o">=</span><span class="m">2</span><span class="w"> </span>your_program.py<span class="w"> </span>&lt;normal<span class="w"> </span>cl<span class="w"> </span>args&gt;<span class="w"> </span>--do_eval<span class="w"> </span>--deepspeed<span class="w"> </span>ds_config.json
</span></code></pre></div>
<p>å”¯ä¸€é‡è¦ãªã“ã¨ã¯ã€ZeRO-2 ã«ã¯ä½•ã®åˆ©ç‚¹ã‚‚ãªã„ãŸã‚ã€ZeRO-3 æ§‹æˆã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚
ZeRO-3 ã®ã¿ãŒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®ã‚·ãƒ£ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å®Ÿè¡Œã™ã‚‹ã®ã«å¯¾ã—ã€ZeRO-1 ã¯å‹¾é…ã¨ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã®çŠ¶æ…‹ã‚’ã‚·ãƒ£ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹ãŸã‚ã€æ¨è«–ã«å½¹ç«‹ã¡ã¾ã™ã€‚</p>
<p>ä»¥ä¸‹ã¯ã€åˆ©ç”¨å¯èƒ½ãªã™ã¹ã¦ã® GPU ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ DeepSpeed ã§<code>run_translation.py</code>ã‚’å®Ÿè¡Œã™ã‚‹ä¾‹ã§ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>deepspeed<span class="w"> </span>examples/pytorch/translation/run_translation.py<span class="w"> </span><span class="se">\</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>--deepspeed<span class="w"> </span>tests/deepspeed/ds_config_zero3.json<span class="w"> </span><span class="se">\</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>--model_name_or_path<span class="w"> </span>google-t5/t5-small<span class="w"> </span>--output_dir<span class="w"> </span>output_dir<span class="w"> </span><span class="se">\</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>--do_eval<span class="w"> </span>--max_eval_samples<span class="w"> </span><span class="m">50</span><span class="w"> </span>--warmup_steps<span class="w"> </span><span class="m">50</span><span class="w">  </span><span class="se">\</span>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a>--max_source_length<span class="w"> </span><span class="m">128</span><span class="w"> </span>--val_max_target_length<span class="w"> </span><span class="m">128</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a>--per_device_eval_batch_size<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>--predict_with_generate<span class="w"> </span>--dataset_config<span class="w"> </span><span class="s2">&quot;ro-en&quot;</span><span class="w"> </span>--fp16<span class="w"> </span><span class="se">\</span>
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a>--source_lang<span class="w"> </span>en<span class="w"> </span>--target_lang<span class="w"> </span>ro<span class="w"> </span>--dataset_name<span class="w"> </span>wmt16<span class="w"> </span><span class="se">\</span>
</span><span id="__span-66-9"><a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a>--source_prefix<span class="w"> </span><span class="s2">&quot;translate English to Romanian: &quot;</span>
</span></code></pre></div>
<p>æ¨è«–ã®ãŸã‚ã«ã€ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã®çŠ¶æ…‹ã¨å‹¾é…ã«ã‚ˆã£ã¦ä½¿ç”¨ã•ã‚Œã‚‹è¿½åŠ ã®å¤§ããªãƒ¡ãƒ¢ãƒªã¯å¿…è¦ãªã„ãŸã‚ã€
ã¯ã‚‹ã‹ã«å¤§ããªãƒãƒƒãƒã‚„ã‚·ãƒ¼ã‚±ãƒ³ã‚¹é•·ã‚’åŒã˜ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã«é©åˆã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>ã•ã‚‰ã«ã€DeepSpeed ã¯ç¾åœ¨ã€Deepspeed-Inference ã¨å‘¼ã°ã‚Œã‚‹é–¢é€£è£½å“ã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¨ã¯ä½•ã®é–¢ä¿‚ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚
ZeRO ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã«æº–æ‹ ã—ã¦ã„ã¾ã™ãŒã€ä»£ã‚ã‚Šã«ãƒ†ãƒ³ã‚½ãƒ«ä¸¦åˆ—å‡¦ç†ã‚’ä½¿ç”¨ã—ã¦ã€å˜ä¸€ã® GPU ã«åã¾ã‚‰ãªã„ãƒ¢ãƒ‡ãƒ«ã‚’ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚ã“ã‚Œã¯
ç¾åœ¨é–‹ç™ºä¸­ã§ã™ã€‚è£½å“ãŒå®Œæˆã—ãŸã‚‰çµ±åˆã‚’æä¾›ã™ã‚‹äºˆå®šã§ã™ã€‚</p>
<h3 id="memory-requirements">Memory Requirements</h3>
<p>Deepspeed ZeRO ã¯ãƒ¡ãƒ¢ãƒªã‚’ CPU (ãŠã‚ˆã³ NVMe) ã«ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ãŸã‚ã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯ã€ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ GPU ã®æ•°ã«å¿œã˜ã¦å¿…è¦ãª CPU ãŠã‚ˆã³ GPU ãƒ¡ãƒ¢ãƒªã®é‡ã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’æä¾›ã—ã¾ã™ã€‚</p>
<p>å˜ä¸€ã® GPU ã§ <code>bigscience/T0_3B</code>ã‚’å¾®èª¿æ•´ã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒ¡ãƒ¢ãƒªã®é‡ã‚’è¦‹ç©ã‚‚ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>$<span class="w"> </span>python<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;from transformers import AutoModel; \</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="s1">from deepspeed.runtime.zero.stage3 import estimate_zero3_model_states_mem_needs_all_live; \</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="s1">model = AutoModel.from_pretrained(&quot;bigscience/T0_3B&quot;); \</span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="s1">estimate_zero3_model_states_mem_needs_all_live(model, num_gpus_per_node=1, num_nodes=1)&#39;</span>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a><span class="o">[</span>...<span class="o">]</span>
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a>Estimated<span class="w"> </span>memory<span class="w"> </span>needed<span class="w"> </span><span class="k">for</span><span class="w"> </span>params,<span class="w"> </span>optim<span class="w"> </span>states<span class="w"> </span>and<span class="w"> </span>gradients<span class="w"> </span><span class="k">for</span><span class="w"> </span>a:
</span><span id="__span-67-7"><a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a>HW:<span class="w"> </span>Setup<span class="w"> </span>with<span class="w"> </span><span class="m">1</span><span class="w"> </span>node,<span class="w"> </span><span class="m">1</span><span class="w"> </span>GPU<span class="w"> </span>per<span class="w"> </span>node.
</span><span id="__span-67-8"><a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a>SW:<span class="w"> </span>Model<span class="w"> </span>with<span class="w"> </span>2783M<span class="w"> </span>total<span class="w"> </span>params,<span class="w"> </span>65M<span class="w"> </span>largest<span class="w"> </span>layer<span class="w"> </span>params.
</span><span id="__span-67-9"><a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a><span class="w">  </span>per<span class="w"> </span>CPU<span class="w">  </span><span class="p">|</span><span class="w">  </span>per<span class="w"> </span>GPU<span class="w"> </span><span class="p">|</span><span class="w">   </span>Options
</span><span id="__span-67-10"><a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a><span class="w">   </span><span class="m">70</span>.00GB<span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="m">0</span>.25GB<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">offload_param</span><span class="o">=</span>cpu<span class="w"> </span>,<span class="w"> </span><span class="nv">offload_optimizer</span><span class="o">=</span>cpu<span class="w"> </span>,<span class="w"> </span><span class="nv">zero_init</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-67-11"><a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a><span class="w">   </span><span class="m">70</span>.00GB<span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="m">0</span>.25GB<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">offload_param</span><span class="o">=</span>cpu<span class="w"> </span>,<span class="w"> </span><span class="nv">offload_optimizer</span><span class="o">=</span>cpu<span class="w"> </span>,<span class="w"> </span><span class="nv">zero_init</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-67-12"><a id="__codelineno-67-12" name="__codelineno-67-12" href="#__codelineno-67-12"></a><span class="w">   </span><span class="m">62</span>.23GB<span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="m">5</span>.43GB<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">offload_param</span><span class="o">=</span>none,<span class="w"> </span><span class="nv">offload_optimizer</span><span class="o">=</span>cpu<span class="w"> </span>,<span class="w"> </span><span class="nv">zero_init</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-67-13"><a id="__codelineno-67-13" name="__codelineno-67-13" href="#__codelineno-67-13"></a><span class="w">   </span><span class="m">62</span>.23GB<span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="m">5</span>.43GB<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">offload_param</span><span class="o">=</span>none,<span class="w"> </span><span class="nv">offload_optimizer</span><span class="o">=</span>cpu<span class="w"> </span>,<span class="w"> </span><span class="nv">zero_init</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-67-14"><a id="__codelineno-67-14" name="__codelineno-67-14" href="#__codelineno-67-14"></a><span class="w">    </span><span class="m">0</span>.37GB<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">46</span>.91GB<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">offload_param</span><span class="o">=</span>none,<span class="w"> </span><span class="nv">offload_optimizer</span><span class="o">=</span>none,<span class="w"> </span><span class="nv">zero_init</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-67-15"><a id="__codelineno-67-15" name="__codelineno-67-15" href="#__codelineno-67-15"></a><span class="w">   </span><span class="m">15</span>.56GB<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">46</span>.91GB<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">offload_param</span><span class="o">=</span>none,<span class="w"> </span><span class="nv">offload_optimizer</span><span class="o">=</span>none,<span class="w"> </span><span class="nv">zero_init</span><span class="o">=</span><span class="m">0</span>
</span></code></pre></div>
<p>ã—ãŸãŒã£ã¦ã€å˜ä¸€ã® 80 GB GPU ã§ CPU ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ãªã—ã§æ­è¼‰ã™ã‚‹ã“ã¨ã‚‚ã€å°ã•ãª 8 GB GPU ã§ã‚‚æœ€å¤§ 60 GB ã® CPU ãƒ¡ãƒ¢ãƒªãŒå¿…è¦ã«ãªã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚ (ã“ã‚Œã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã®çŠ¶æ…‹ã€ãŠã‚ˆã³å‹¾é…ã®ãŸã‚ã®ãƒ¡ãƒ¢ãƒªã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚cuda ã‚«ãƒ¼ãƒãƒ«ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã€ãŠã‚ˆã³ä¸€æ™‚ãƒ¡ãƒ¢ãƒªã«ã¯ã‚‚ã†å°‘ã—å¤šãã®ãƒ¡ãƒ¢ãƒªãŒå¿…è¦ã§ã™ã€‚)</p>
<p>æ¬¡ã«ã€ã‚³ã‚¹ãƒˆã¨é€Ÿåº¦ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã«ãªã‚Šã¾ã™ã€‚ã‚ˆã‚Šå°ã•ã„ GPU ã‚’è³¼å…¥ã¾ãŸã¯ãƒ¬ãƒ³ã‚¿ãƒ«ã—ãŸæ–¹ãŒå®‰ããªã‚Šã¾ã™ (Deepspeed ZeRO ã§ã¯è¤‡æ•°ã® GPU ã‚’ä½¿ç”¨ã§ãã‚‹ãŸã‚ã€GPU ã®æ•°ã‚’æ¸›ã‚‰ã™ã“ã¨ã‚‚ã§ãã¾ã™)ã€‚ã—ã‹ã—ã€ãã®å ´åˆã¯é…ããªã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€ä½•ã‹ã‚’å®Ÿè¡Œã™ã‚‹é€Ÿåº¦ã‚’æ°—ã«ã—ãªãã¦ã‚‚ã€é€Ÿåº¦ã®ä½ä¸‹ã¯ GPU ã®ä½¿ç”¨æ™‚é–“ã«ç›´æ¥å½±éŸ¿ã—ã€ã‚³ã‚¹ãƒˆãŒå¢—å¤§ã™ã‚‹ãŸã‚ã€ã©ã‚ŒãŒæœ€ã‚‚åŠ¹æœçš„ã‹ã‚’å®Ÿé¨“ã—ã¦æ¯”è¼ƒã—ã¦ãã ã•ã„ã€‚</p>
<p>ååˆ†ãª GPU ãƒ¡ãƒ¢ãƒªãŒã‚ã‚‹å ´åˆã¯ã€ã™ã¹ã¦ãŒé«˜é€Ÿã«ãªã‚‹ãŸã‚ã€CPU/NVMe ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã‚’å¿…ãšç„¡åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚</p>
<p>ãŸã¨ãˆã°ã€2 ã¤ã® GPU ã«å¯¾ã—ã¦åŒã˜ã“ã¨ã‚’ç¹°ã‚Šè¿”ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a>$<span class="w"> </span>python<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;from transformers import AutoModel; \</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="s1">from deepspeed.runtime.zero.stage3 import estimate_zero3_model_states_mem_needs_all_live; \</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a><span class="s1">model = AutoModel.from_pretrained(&quot;bigscience/T0_3B&quot;); \</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="s1">estimate_zero3_model_states_mem_needs_all_live(model, num_gpus_per_node=2, num_nodes=1)&#39;</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="o">[</span>...<span class="o">]</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a>Estimated<span class="w"> </span>memory<span class="w"> </span>needed<span class="w"> </span><span class="k">for</span><span class="w"> </span>params,<span class="w"> </span>optim<span class="w"> </span>states<span class="w"> </span>and<span class="w"> </span>gradients<span class="w"> </span><span class="k">for</span><span class="w"> </span>a:
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a>HW:<span class="w"> </span>Setup<span class="w"> </span>with<span class="w"> </span><span class="m">1</span><span class="w"> </span>node,<span class="w"> </span><span class="m">2</span><span class="w"> </span>GPUs<span class="w"> </span>per<span class="w"> </span>node.
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a>SW:<span class="w"> </span>Model<span class="w"> </span>with<span class="w"> </span>2783M<span class="w"> </span>total<span class="w"> </span>params,<span class="w"> </span>65M<span class="w"> </span>largest<span class="w"> </span>layer<span class="w"> </span>params.
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a><span class="w">  </span>per<span class="w"> </span>CPU<span class="w">  </span><span class="p">|</span><span class="w">  </span>per<span class="w"> </span>GPU<span class="w"> </span><span class="p">|</span><span class="w">   </span>Options
</span><span id="__span-68-10"><a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a><span class="w">   </span><span class="m">70</span>.00GB<span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="m">0</span>.25GB<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">offload_param</span><span class="o">=</span>cpu<span class="w"> </span>,<span class="w"> </span><span class="nv">offload_optimizer</span><span class="o">=</span>cpu<span class="w"> </span>,<span class="w"> </span><span class="nv">zero_init</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-68-11"><a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a><span class="w">   </span><span class="m">70</span>.00GB<span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="m">0</span>.25GB<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">offload_param</span><span class="o">=</span>cpu<span class="w"> </span>,<span class="w"> </span><span class="nv">offload_optimizer</span><span class="o">=</span>cpu<span class="w"> </span>,<span class="w"> </span><span class="nv">zero_init</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-68-12"><a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a><span class="w">   </span><span class="m">62</span>.23GB<span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="m">2</span>.84GB<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">offload_param</span><span class="o">=</span>none,<span class="w"> </span><span class="nv">offload_optimizer</span><span class="o">=</span>cpu<span class="w"> </span>,<span class="w"> </span><span class="nv">zero_init</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-68-13"><a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a><span class="w">   </span><span class="m">62</span>.23GB<span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="m">2</span>.84GB<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">offload_param</span><span class="o">=</span>none,<span class="w"> </span><span class="nv">offload_optimizer</span><span class="o">=</span>cpu<span class="w"> </span>,<span class="w"> </span><span class="nv">zero_init</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-68-14"><a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a><span class="w">    </span><span class="m">0</span>.74GB<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">23</span>.58GB<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">offload_param</span><span class="o">=</span>none,<span class="w"> </span><span class="nv">offload_optimizer</span><span class="o">=</span>none,<span class="w"> </span><span class="nv">zero_init</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-68-15"><a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a><span class="w">   </span><span class="m">31</span>.11GB<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">23</span>.58GB<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">offload_param</span><span class="o">=</span>none,<span class="w"> </span><span class="nv">offload_optimizer</span><span class="o">=</span>none,<span class="w"> </span><span class="nv">zero_init</span><span class="o">=</span><span class="m">0</span>
</span></code></pre></div>
<p>ã—ãŸãŒã£ã¦ã€ã“ã“ã§ã¯ã€CPU ã«ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã›ãšã« 2x 32GB ä»¥ä¸Šã® GPU ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚</p>
<p>è©³ç´°ã«ã¤ã„ã¦ã¯ã€<a href="https://deepspeed.readthedocs.io/en/latest/memory.html">ãƒ¡ãƒ¢ãƒªæ¨å®šãƒ„ãƒ¼ãƒ«</a> ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
<h3 id="filing-issues">Filing Issues</h3>
<p>ã“ã“ã§ã¯ã€å•é¡Œã®çœŸç›¸ã‚’ã™ãã«è§£æ˜ã—ã€ä½œæ¥­ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã§ãã‚‹ã‚ˆã†ã€å•é¡Œã‚’å ±å‘Šã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚</p>
<p>ãƒ¬ãƒãƒ¼ãƒˆã«ã¯å¿…ãšæ¬¡ã®å†…å®¹ã‚’å«ã‚ã¦ãã ã•ã„ã€‚</p>
<ol>
<li>
<p>ãƒ¬ãƒãƒ¼ãƒˆå†…ã®å®Œå…¨ãª Deepspeed æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«</p>
</li>
<li>
<p>[<code>Trainer</code>] ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã€ã¾ãŸã¯
   ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’è‡ªåˆ†ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆã—ã¦ã„ã‚‹å ´åˆã¯ã€[<code>TrainingArguments</code>] å¼•æ•°ã€‚ã—ãªã„ã§ãã ã•ã„
   [<code>TrainingArguments</code>] ã«ã¯ç„¡é–¢ä¿‚ãªã‚¨ãƒ³ãƒˆãƒªãŒå¤šæ•°å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒ€ãƒ³ãƒ—ã—ã¾ã™ã€‚</p>
</li>
<li>
<p>æ¬¡ã®å‡ºåŠ›:</p>
</li>
</ol>
<p><code>bash
    python -c 'import torch; print(f"torch: {torch.__version__}")'
    python -c 'import transformers; print(f"transformers: {transformers.__version__}")'
    python -c 'import deepspeed; print(f"deepspeed: {deepspeed.__version__}")'</code></p>
<ol>
<li>
<p>å¯èƒ½ã§ã‚ã‚Œã°ã€å•é¡Œã‚’å†ç¾ã§ãã‚‹ Google Colab ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¸ã®ãƒªãƒ³ã‚¯ã‚’å«ã‚ã¦ãã ã•ã„ã€‚ã“ã‚Œã‚’ä½¿ãˆã¾ã™
   <a href="https://github.com/stas00/porting/blob/master/transformers/deepspeed/DeepSpeed_on_colab_CLI.ipynb">ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯</a> ã¨ã—ã¦
   å‡ºç™ºç‚¹ã€‚</p>
</li>
<li>
<p>ä¸å¯èƒ½ã§ãªã„é™ã‚Šã€ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ã¯ãªãã€å¸¸ã«ä½¿ç”¨ã§ãã‚‹æ¨™æº–ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚</p>
</li>
<li>
<p>å¯èƒ½ã§ã‚ã‚Œã°ã€æ—¢å­˜ã® <a href="https://github.com/huggingface/transformers/tree/main/examples/pytorch">ã‚µãƒ³ãƒ—ãƒ«</a> ã®ã„ãšã‚Œã‹ã‚’ä½¿ç”¨ã—ã¦å•é¡Œã‚’å†ç¾ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</p>
</li>
<li>
<p>Deepspeed ãŒå•é¡Œã®åŸå› ã§ã¯ãªã„ã“ã¨ãŒã‚ˆãã‚ã‚Šã¾ã™ã€‚</p>
</li>
</ol>
<p>æå‡ºã•ã‚ŒãŸå•é¡Œã®ä¸€éƒ¨ã¯ã€Deepspeed ã¨ã¯ç„¡é–¢ä¿‚ã§ã‚ã‚‹ã“ã¨ãŒåˆ¤æ˜ã—ã¾ã—ãŸã€‚ãã‚Œã¯ã€Deepspeed ãŒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‹ã‚‰å‰Šé™¤ã•ã‚ŒãŸå¾Œã§ã™ã€‚
  å•é¡Œã¯ã¾ã æ®‹ã£ã¦ã„ãŸã€‚</p>
<p>ã—ãŸãŒã£ã¦ã€å®Œå…¨ã«æ˜ç™½ã§ãªã„å ´åˆã¯ã€DeepSpeed é–¢é€£ã®å•é¡Œã§ã™ã€‚
  ä¾‹å¤–ãŒç™ºç”Ÿã—ã€DeepSpeed ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒé–¢ä¿‚ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã¾ãšã€DeepSpeed ã‚’å«ã¾ãªã„ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å†ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚
  å•é¡ŒãŒè§£æ±ºã—ãªã„å ´åˆã«ã®ã¿ã€Deepspeed ã«ã¤ã„ã¦è¨€åŠã—ã€å¿…è¦ãªè©³ç´°ã‚’ã™ã¹ã¦æä¾›ã—ã¦ãã ã•ã„ã€‚</p>
<ul>
<li>å•é¡ŒãŒçµ±åˆéƒ¨åˆ†ã§ã¯ãªã DeepSpeed ã‚³ã‚¢ã«ã‚ã‚‹ã“ã¨ãŒæ˜ã‚‰ã‹ãªå ´åˆã¯ã€å•é¡Œã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚
  <a href="https://github.com/deepspeedai/DeepSpeed/">Deepspeed</a> ã‚’ç›´æ¥ä½¿ç”¨ã—ã¾ã™ã€‚ã‚ˆãã‚ã‹ã‚‰ãªã„å ´åˆã§ã‚‚ã€ã”å®‰å¿ƒãã ã•ã„ã€‚
  ã©ã¡ã‚‰ã®å•é¡Œãƒˆãƒ©ãƒƒã‚«ãƒ¼ã§ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚æŠ•ç¨¿ã•ã‚ŒãŸã‚‰ãã‚Œã‚’åˆ¤æ–­ã—ã€æ¬¡ã®å ´åˆã¯åˆ¥ã®å•é¡Œãƒˆãƒ©ãƒƒã‚«ãƒ¼ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚
  ãã†ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚</li>
</ul>
<h3 id="troubleshooting">Troubleshooting</h3>
<h4 id="the-deepspeed-process-gets-killed-at-startup-without-a-traceback">the <code>deepspeed</code> process gets killed at startup without a traceback</h4>
<p><code>deepspeed</code>ãƒ—ãƒ­ã‚»ã‚¹ãŒèµ·å‹•æ™‚ã«ãƒˆãƒ¬ãƒ¼ã‚¹ãƒãƒƒã‚¯ãªã—ã§å¼·åˆ¶çµ‚äº†ã•ã‚ŒãŸå ´åˆã€ãã‚Œã¯é€šå¸¸ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒè©¦è¡Œã—ãŸã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚
ã‚·ã‚¹ãƒ†ãƒ ãŒæŒã£ã¦ã„ã‚‹ã‚ˆã‚Šã‚‚å¤šãã® CPU ãƒ¡ãƒ¢ãƒªã‚’å‰²ã‚Šå½“ã¦ã‚‹ã‹ã€ãƒ—ãƒ­ã‚»ã‚¹ãŒå‰²ã‚Šå½“ã¦ã‚’è¨±å¯ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€OS ã‚«ãƒ¼ãƒãƒ«ãŒãã‚Œã‚’å¼·åˆ¶çµ‚äº†ã—ã¾ã™ã€‚
ãƒ—ãƒ­ã‚»ã‚¹ã€‚ã“ã‚Œã¯ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã« <code>offload_optimizer</code> ã¾ãŸã¯ <code>offload_param</code> ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ãŸã‚ã§ã™ã€‚
ã©ã¡ã‚‰ã‚‚<code>cpu</code>ã«ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ NVMe ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€æ¬¡ã®ç’°å¢ƒã§å®Ÿè¡Œã—ã¦ã„ã‚‹å ´åˆã¯ NVMe ã¸ã®ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚
ã‚¼ãƒ­-3ã€‚ [ç‰¹å®šã®ãƒ¢ãƒ‡ãƒ«ã«å¿…è¦ãªãƒ¡ãƒ¢ãƒªé‡ã‚’è¦‹ç©ã‚‚ã‚‹]æ–¹æ³•ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™(https://deepspeed.readthedocs.io/en/latest/memory.html)ã€‚</p>
<h4 id="training-andor-evalpredict-loss-is-nan">training and/or eval/predict loss is <code>NaN</code></h4>
<p>ã“ã‚Œã¯ã€bf16 æ··åˆç²¾åº¦ãƒ¢ãƒ¼ãƒ‰ã§äº‹å‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚’å–å¾—ã—ã€ãã‚Œã‚’ fp16 (æ··åˆç²¾åº¦ã®æœ‰ç„¡ã«ã‹ã‹ã‚ã‚‰ãš) ã§ä½¿ç”¨ã—ã‚ˆã†ã¨ã—ãŸå ´åˆã«ã‚ˆãç™ºç”Ÿã—ã¾ã™ã€‚ TPU ã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸã»ã¨ã‚“ã©ã®ãƒ¢ãƒ‡ãƒ«ã€ãŠã‚ˆã³å¤šãã®å ´åˆã€Google ã«ã‚ˆã£ã¦ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã¯ã€ã“ã®ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã•ã‚Œã¾ã™ (ãŸã¨ãˆã°ã€ã»ã¼ã™ã¹ã¦ã® t5 ãƒ™ãƒ¼ã‚¹ã®ãƒ¢ãƒ‡ãƒ«)ã€‚ã“ã“ã§ã®è§£æ±ºç­–ã¯ã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãŒã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹å ´åˆ (TPUã€Ampere GPU ä»¥é™)ã€fp32 ã¾ãŸã¯ bf16 ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="p">{</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="w">    </span><span class="nt">&quot;fp16&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="w">        </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="w">        </span><span class="nt">&quot;loss_scale&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="w">        </span><span class="nt">&quot;loss_scale_window&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a><span class="w">        </span><span class="nt">&quot;initial_scale_power&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span>
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a><span class="w">        </span><span class="nt">&quot;hysteresis&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-69-8"><a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a><span class="w">        </span><span class="nt">&quot;min_loss_scale&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-69-9"><a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-69-10"><a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>ãƒ­ã‚°ã«ã¯ã€Deepspeed ãŒæ¬¡ã®ã‚ˆã†ã«<code>OVERFLOW!</code>ã‚’å ±å‘Šã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="m">0</span>%<span class="p">|</span><span class="w">                                                                                                                             </span><span class="p">|</span><span class="w"> </span><span class="m">0</span>/189<span class="w"> </span><span class="o">[</span><span class="m">00</span>:00&lt;?,<span class="w"> </span>?it/s<span class="o">]</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="w"> </span><span class="o">[</span>deepscale<span class="o">]</span><span class="w"> </span>OVERFLOW!<span class="w"> </span>Rank<span class="w"> </span><span class="m">0</span><span class="w"> </span>Skipping<span class="w"> </span>step.<span class="w"> </span>Attempted<span class="w"> </span>loss<span class="w"> </span>scale:<span class="w"> </span><span class="m">262144</span>,<span class="w"> </span>reducing<span class="w"> </span>to<span class="w"> </span><span class="m">262144</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="w">  </span><span class="m">1</span>%<span class="p">|</span>â–Œ<span class="w">                                                                                                                    </span><span class="p">|</span><span class="w"> </span><span class="m">1</span>/189<span class="w"> </span><span class="o">[</span><span class="m">00</span>:00&lt;<span class="m">01</span>:26,<span class="w">  </span><span class="m">2</span>.17it/s<span class="o">]</span>
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="w"> </span><span class="o">[</span>deepscale<span class="o">]</span><span class="w"> </span>OVERFLOW!<span class="w"> </span>Rank<span class="w"> </span><span class="m">0</span><span class="w"> </span>Skipping<span class="w"> </span>step.<span class="w"> </span>Attempted<span class="w"> </span>loss<span class="w"> </span>scale:<span class="w"> </span><span class="m">262144</span>,<span class="w"> </span>reducing<span class="w"> </span>to<span class="w"> </span><span class="m">131072</span>.0
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a><span class="w">  </span><span class="m">1</span>%<span class="p">|</span>â–ˆâ–
</span><span id="__span-70-6"><a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a><span class="w"> </span><span class="o">[</span>...<span class="o">]</span>
</span><span id="__span-70-7"><a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a><span class="w"> </span><span class="o">[</span>deepscale<span class="o">]</span><span class="w"> </span>OVERFLOW!<span class="w"> </span>Rank<span class="w"> </span><span class="m">0</span><span class="w"> </span>Skipping<span class="w"> </span>step.<span class="w"> </span>Attempted<span class="w"> </span>loss<span class="w"> </span>scale:<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>reducing<span class="w"> </span>to<span class="w"> </span><span class="m">1</span>
</span><span id="__span-70-8"><a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a><span class="w"> </span><span class="m">14</span>%<span class="p">|</span>â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ<span class="w">                                                                                                   </span><span class="p">|</span><span class="w"> </span><span class="m">27</span>/189<span class="w"> </span><span class="o">[</span><span class="m">00</span>:14&lt;<span class="m">01</span>:13,<span class="w">  </span><span class="m">2</span>.21it/s<span class="o">]</span>
</span><span id="__span-70-9"><a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a><span class="w"> </span><span class="o">[</span>deepscale<span class="o">]</span><span class="w"> </span>OVERFLOW!<span class="w"> </span>Rank<span class="w"> </span><span class="m">0</span><span class="w"> </span>Skipping<span class="w"> </span>step.<span class="w"> </span>Attempted<span class="w"> </span>loss<span class="w"> </span>scale:<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>reducing<span class="w"> </span>to<span class="w"> </span><span class="m">1</span>
</span><span id="__span-70-10"><a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a><span class="w"> </span><span class="m">15</span>%<span class="p">|</span>â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–<span class="w">                                                                                                  </span><span class="p">|</span><span class="w"> </span><span class="m">28</span>/189<span class="w"> </span><span class="o">[</span><span class="m">00</span>:14&lt;<span class="m">01</span>:13,<span class="w">  </span><span class="m">2</span>.18it/s<span class="o">]</span>
</span><span id="__span-70-11"><a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a><span class="w"> </span><span class="o">[</span>deepscale<span class="o">]</span><span class="w"> </span>OVERFLOW!<span class="w"> </span>Rank<span class="w"> </span><span class="m">0</span><span class="w"> </span>Skipping<span class="w"> </span>step.<span class="w"> </span>Attempted<span class="w"> </span>loss<span class="w"> </span>scale:<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>reducing<span class="w"> </span>to<span class="w"> </span><span class="m">1</span>
</span><span id="__span-70-12"><a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a><span class="w"> </span><span class="m">15</span>%<span class="p">|</span>â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š<span class="w">                                                                                                  </span><span class="p">|</span><span class="w"> </span><span class="m">29</span>/189<span class="w"> </span><span class="o">[</span><span class="m">00</span>:15&lt;<span class="m">01</span>:13,<span class="w">  </span><span class="m">2</span>.18it/s<span class="o">]</span>
</span><span id="__span-70-13"><a id="__codelineno-70-13" name="__codelineno-70-13" href="#__codelineno-70-13"></a><span class="w"> </span><span class="o">[</span>deepscale<span class="o">]</span><span class="w"> </span>OVERFLOW!<span class="w"> </span>Rank<span class="w"> </span><span class="m">0</span><span class="w"> </span>Skipping<span class="w"> </span>step.<span class="w"> </span>Attempted<span class="w"> </span>loss<span class="w"> </span>scale:<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>reducing<span class="w"> </span>to<span class="w"> </span><span class="m">1</span>
</span><span id="__span-70-14"><a id="__codelineno-70-14" name="__codelineno-70-14" href="#__codelineno-70-14"></a><span class="o">[</span>...<span class="o">]</span>
</span></code></pre></div>
<p>ã“ã‚Œã¯ã€Deepspeed æå¤±ã‚¹ã‚±ãƒ¼ãƒ©ãƒ¼ãŒæå¤±ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’å…‹æœã™ã‚‹ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ä¿‚æ•°ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œãªã„ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚</p>
<p>(ãƒ­ã‚°ã¯ã“ã“ã§èª­ã¿ã‚„ã™ãã™ã‚‹ãŸã‚ã«ãƒãƒƒã‚µãƒ¼ã‚¸ã•ã‚Œã¦ã„ã¾ã™ã€‚)</p>
<p>ã“ã®å ´åˆã€é€šå¸¸ã¯ <code>initial_scale_power</code> ã®å€¤ã‚’ä¸Šã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚é€šå¸¸ã€<code>initial_scale_power: 32</code> ã«è¨­å®šã™ã‚‹ã¨å•é¡ŒãŒè§£æ±ºã—ã¾ã™ã€‚</p>
<h3 id="notes">Notes</h3>
<ul>
<li>DeepSpeed ã«ã¯ pip ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯èƒ½ãª PyPI ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã™ãŒã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã«æœ€ã‚‚é©åˆã™ã‚‹ã‚ˆã†ã«ã€ã¾ãŸæœ‰åŠ¹ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€<a href="https://github.com/deepspeedai/DeepSpeed#installation">ã‚½ãƒ¼ã‚¹</a> ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ã‚’å¼·ããŠå‹§ã‚ã—ã¾ã™ã€‚
  1 ãƒ“ãƒƒãƒˆ Adam ãªã©ã®ç‰¹å®šã®æ©Ÿèƒ½ã¯ã€pypi ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚</li>
<li>ğŸ¤— Transformers ã§ DeepSpeed ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã« [<code>Trainer</code>] ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ - ä»»æ„ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã§ãã¾ã™
  å¾Œè€…ã¯ <a href="https://www.deepspeed.ai/getting-started/#writing-deepspeed-models">DeepSpeed çµ±åˆæ‰‹é †</a> ã«å¾“ã£ã¦èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</li>
</ul>
<h2 id="non-trainer-deepspeed-integration">Non-Trainer Deepspeed Integration</h2>
<p>[<code>~integrations.HfDeepSpeedConfig</code>] ã¯ã€Deepspeed ã‚’ ğŸ¤— Transformers ã‚³ã‚¢ã«çµ±åˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™
[<code>Trainer</code>] ã‚’ä½¿ç”¨ã—ãªã„å ´åˆã®æ©Ÿèƒ½ã€‚å®Ÿè¡Œã™ã‚‹å”¯ä¸€ã®ã“ã¨ã¯ã€Deepspeed ZeRO-3 ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åé›†ã‚’å‡¦ç†ã—ã€<code>from_pretrained</code>å‘¼ã³å‡ºã—ä¸­ã«ãƒ¢ãƒ‡ãƒ«ã‚’è¤‡æ•°ã® GPU ã«è‡ªå‹•çš„ã«åˆ†å‰²ã™ã‚‹ã“ã¨ã§ã™ã€‚ãã‚Œä»¥å¤–ã¯ã™ã¹ã¦è‡ªåˆ†ã§è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>[<code>Trainer</code>] ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã™ã¹ã¦ãŒè‡ªå‹•çš„ã«å‡¦ç†ã•ã‚Œã¾ã™ã€‚</p>
<p>[<code>Trainer</code>] ã‚’ä½¿ç”¨ã—ãªã„å ´åˆã€DeepSpeed ZeRO-3 ã‚’åŠ¹ç‡çš„ã«å°å…¥ã™ã‚‹ã«ã¯ã€
ãƒ¢ãƒ‡ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã™ã‚‹å‰ã« [<code>~integrations.HfDeepSpeedConfig</code>] ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã€ãã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”ŸããŸã¾ã¾ã«ã—ã¾ã™ã€‚</p>
<p>Deepspeed ZeRO-1 ã¾ãŸã¯ ZeRO-2 ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€<code>HfDeepSpeedConfig</code>ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ã¯ã¾ã£ãŸãã‚ã‚Šã¾ã›ã‚“ã€‚</p>
<p>ãŸã¨ãˆã°ã€äº‹å‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã®å ´åˆã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.integrations</span><span class="w"> </span><span class="kn">import</span> <span class="n">HfDeepSpeedConfig</span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoModel</span>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">deepspeed</span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="n">ds_config</span> <span class="o">=</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>  <span class="c1"># deepspeed config object or path to the file</span>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a><span class="c1"># must run before instantiating the model to detect zero 3</span>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="n">dschf</span> <span class="o">=</span> <span class="n">HfDeepSpeedConfig</span><span class="p">(</span><span class="n">ds_config</span><span class="p">)</span>  <span class="c1"># keep this object alive</span>
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;openai-community/gpt2&quot;</span><span class="p">)</span>
</span><span id="__span-71-9"><a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a><span class="n">engine</span> <span class="o">=</span> <span class="n">deepspeed</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">config_params</span><span class="o">=</span><span class="n">ds_config</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</span></code></pre></div>
<p>ã¾ãŸã¯ã€äº‹å‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚Œã¦ã„ãªã„ãƒ¢ãƒ‡ãƒ«ã®å ´åˆ:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.integrations</span><span class="w"> </span><span class="kn">import</span> <span class="n">HfDeepSpeedConfig</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoModel</span><span class="p">,</span> <span class="n">AutoConfig</span>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">deepspeed</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a><span class="n">ds_config</span> <span class="o">=</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>  <span class="c1"># deepspeed config object or path to the file</span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a><span class="c1"># must run before instantiating the model to detect zero 3</span>
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a><span class="n">dschf</span> <span class="o">=</span> <span class="n">HfDeepSpeedConfig</span><span class="p">(</span><span class="n">ds_config</span><span class="p">)</span>  <span class="c1"># keep this object alive</span>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a><span class="n">config</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;openai-community/gpt2&quot;</span><span class="p">)</span>
</span><span id="__span-72-9"><a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModel</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span id="__span-72-10"><a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a><span class="n">engine</span> <span class="o">=</span> <span class="n">deepspeed</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">config_params</span><span class="o">=</span><span class="n">ds_config</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</span></code></pre></div>
<p>[<code>Trainer</code>] çµ±åˆã‚’ä½¿ç”¨ã—ã¦ã„ãªã„å ´åˆã¯ã€å®Œå…¨ã«ç‹¬åŠ›ã§è¡Œã†ã“ã¨ã«ãªã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚åŸºæœ¬çš„ã«ã¯ã€<a href="https://www.deepspeed.ai/">Deepspeed</a> Web ã‚µã‚¤ãƒˆã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å¾“ã£ã¦ãã ã•ã„ã€‚ã¾ãŸã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ˜ç¤ºçš„ã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<code>"auto"</code>å€¤ã¯ä½¿ç”¨ã§ããšã€ä»£ã‚ã‚Šã«å®Ÿéš›ã®å€¤ã‚’å…¥åŠ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<h2 id="hfdeepspeedconfig">HfDeepSpeedConfig</h2>
<p>[[autodoc]] integrations.HfDeepSpeedConfig
    - all</p>
<h3 id="custom-deepspeed-zero-inference">Custom DeepSpeed ZeRO Inference</h3>
<p>ä»¥ä¸‹ã¯ã€å˜ä¸€ã® GPU ã«ãƒ¢ãƒ‡ãƒ«ã‚’é©åˆã§ããªã„å ´åˆã«ã€[<code>Trainer</code>] ã‚’ä½¿ç”¨ã›ãšã« DeepSpeed ZeRO æ¨è«–ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã®ä¾‹ã§ã™ã€‚è§£æ±ºç­–ã«ã¯ã€è¿½åŠ ã® GPU ã®ä½¿ç”¨ã€ã¾ãŸã¯ GPU ãƒ¡ãƒ¢ãƒªã‚’ CPU ãƒ¡ãƒ¢ãƒªã«ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ãŒå«ã¾ã‚Œã¾ã™ã€‚</p>
<p>ã“ã“ã§ç†è§£ã™ã¹ãé‡è¦ãªãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã¯ã€ZeRO ã®è¨­è¨ˆæ–¹æ³•ã«ã‚ˆã‚Šã€ç•°ãªã‚‹ GPU ã§ç•°ãªã‚‹å…¥åŠ›ã‚’ä¸¦è¡Œã—ã¦å‡¦ç†ã§ãã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚</p>
<p>ã“ã®ä¾‹ã«ã¯å¤§é‡ã®ãƒ¡ãƒ¢ãŒã‚ã‚Šã€è‡ªå·±æ–‡æ›¸åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
<p>å¿…ãšæ¬¡ã®ã“ã¨ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚</p>
<ol>
<li>ååˆ†ãª GPU ãƒ¡ãƒ¢ãƒªãŒã‚ã‚‹å ´åˆã¯ã€CPU ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹ã«ã—ã¾ã™ (é€Ÿåº¦ãŒä½ä¸‹ã™ã‚‹ãŸã‚)ã€‚</li>
<li>Ampere ã¾ãŸã¯æ–°ã—ã„ GPU ã‚’æ‰€æœ‰ã—ã¦ã„ã‚‹å ´åˆã¯ã€å‡¦ç†ã‚’é«˜é€ŸåŒ–ã™ã‚‹ãŸã‚ã« bf16 ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚ãã®ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãŒãªã„å ´åˆã¯ã€bf16 æ··åˆç²¾åº¦ã§äº‹å‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ« (ã»ã¨ã‚“ã©ã® t5 ãƒ¢ãƒ‡ãƒ«ãªã©) ã‚’ä½¿ç”¨ã—ãªã„é™ã‚Šã€fp16 ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã‚‰ã¯é€šå¸¸ã€fp16 ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã—ã€å‡ºåŠ›ã¨ã—ã¦ã‚¬ãƒ™ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="ch">#!/usr/bin/env python</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="c1"># This script demonstrates how to use Deepspeed ZeRO in an inference mode when one can&#39;t fit a model</span>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="c1"># into a single GPU</span>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a><span class="c1">#</span>
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a><span class="c1"># 1. Use 1 GPU with CPU offload</span>
</span><span id="__span-73-7"><a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a><span class="c1"># 2. Or use multiple GPUs instead</span>
</span><span id="__span-73-8"><a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a><span class="c1">#</span>
</span><span id="__span-73-9"><a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a><span class="c1"># First you need to install deepspeed: pip install deepspeed</span>
</span><span id="__span-73-10"><a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a><span class="c1">#</span>
</span><span id="__span-73-11"><a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a><span class="c1"># Here we use a 3B &quot;bigscience/T0_3B&quot; model which needs about 15GB GPU RAM - so 1 largish or 2</span>
</span><span id="__span-73-12"><a id="__codelineno-73-12" name="__codelineno-73-12" href="#__codelineno-73-12"></a><span class="c1"># small GPUs can handle it. or 1 small GPU and a lot of CPU memory.</span>
</span><span id="__span-73-13"><a id="__codelineno-73-13" name="__codelineno-73-13" href="#__codelineno-73-13"></a><span class="c1">#</span>
</span><span id="__span-73-14"><a id="__codelineno-73-14" name="__codelineno-73-14" href="#__codelineno-73-14"></a><span class="c1"># To use a larger model like &quot;bigscience/T0&quot; which needs about 50GB, unless you have an 80GB GPU -</span>
</span><span id="__span-73-15"><a id="__codelineno-73-15" name="__codelineno-73-15" href="#__codelineno-73-15"></a><span class="c1"># you will need 2-4 gpus. And then you can adapt the script to handle more gpus if you want to</span>
</span><span id="__span-73-16"><a id="__codelineno-73-16" name="__codelineno-73-16" href="#__codelineno-73-16"></a><span class="c1"># process multiple inputs at once.</span>
</span><span id="__span-73-17"><a id="__codelineno-73-17" name="__codelineno-73-17" href="#__codelineno-73-17"></a><span class="c1">#</span>
</span><span id="__span-73-18"><a id="__codelineno-73-18" name="__codelineno-73-18" href="#__codelineno-73-18"></a><span class="c1"># The provided deepspeed config also activates CPU memory offloading, so chances are that if you</span>
</span><span id="__span-73-19"><a id="__codelineno-73-19" name="__codelineno-73-19" href="#__codelineno-73-19"></a><span class="c1"># have a lot of available CPU memory and you don&#39;t mind a slowdown you should be able to load a</span>
</span><span id="__span-73-20"><a id="__codelineno-73-20" name="__codelineno-73-20" href="#__codelineno-73-20"></a><span class="c1"># model that doesn&#39;t normally fit into a single GPU. If you have enough GPU memory the program will</span>
</span><span id="__span-73-21"><a id="__codelineno-73-21" name="__codelineno-73-21" href="#__codelineno-73-21"></a><span class="c1"># run faster if you don&#39;t want offload to CPU - so disable that section then.</span>
</span><span id="__span-73-22"><a id="__codelineno-73-22" name="__codelineno-73-22" href="#__codelineno-73-22"></a><span class="c1">#</span>
</span><span id="__span-73-23"><a id="__codelineno-73-23" name="__codelineno-73-23" href="#__codelineno-73-23"></a><span class="c1"># To deploy on 1 gpu:</span>
</span><span id="__span-73-24"><a id="__codelineno-73-24" name="__codelineno-73-24" href="#__codelineno-73-24"></a><span class="c1">#</span>
</span><span id="__span-73-25"><a id="__codelineno-73-25" name="__codelineno-73-25" href="#__codelineno-73-25"></a><span class="c1"># deepspeed --num_gpus 1 t0.py</span>
</span><span id="__span-73-26"><a id="__codelineno-73-26" name="__codelineno-73-26" href="#__codelineno-73-26"></a><span class="c1"># or:</span>
</span><span id="__span-73-27"><a id="__codelineno-73-27" name="__codelineno-73-27" href="#__codelineno-73-27"></a><span class="c1"># python -m torch.distributed.run --nproc_per_node=1 t0.py</span>
</span><span id="__span-73-28"><a id="__codelineno-73-28" name="__codelineno-73-28" href="#__codelineno-73-28"></a><span class="c1">#</span>
</span><span id="__span-73-29"><a id="__codelineno-73-29" name="__codelineno-73-29" href="#__codelineno-73-29"></a><span class="c1"># To deploy on 2 gpus:</span>
</span><span id="__span-73-30"><a id="__codelineno-73-30" name="__codelineno-73-30" href="#__codelineno-73-30"></a><span class="c1">#</span>
</span><span id="__span-73-31"><a id="__codelineno-73-31" name="__codelineno-73-31" href="#__codelineno-73-31"></a><span class="c1"># deepspeed --num_gpus 2 t0.py</span>
</span><span id="__span-73-32"><a id="__codelineno-73-32" name="__codelineno-73-32" href="#__codelineno-73-32"></a><span class="c1"># or:</span>
</span><span id="__span-73-33"><a id="__codelineno-73-33" name="__codelineno-73-33" href="#__codelineno-73-33"></a><span class="c1"># python -m torch.distributed.run --nproc_per_node=2 t0.py</span>
</span><span id="__span-73-34"><a id="__codelineno-73-34" name="__codelineno-73-34" href="#__codelineno-73-34"></a>
</span><span id="__span-73-35"><a id="__codelineno-73-35" name="__codelineno-73-35" href="#__codelineno-73-35"></a>
</span><span id="__span-73-36"><a id="__codelineno-73-36" name="__codelineno-73-36" href="#__codelineno-73-36"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoTokenizer</span><span class="p">,</span> <span class="n">AutoConfig</span><span class="p">,</span> <span class="n">AutoModelForSeq2SeqLM</span>
</span><span id="__span-73-37"><a id="__codelineno-73-37" name="__codelineno-73-37" href="#__codelineno-73-37"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.integrations</span><span class="w"> </span><span class="kn">import</span> <span class="n">HfDeepSpeedConfig</span>
</span><span id="__span-73-38"><a id="__codelineno-73-38" name="__codelineno-73-38" href="#__codelineno-73-38"></a><span class="kn">import</span><span class="w"> </span><span class="nn">deepspeed</span>
</span><span id="__span-73-39"><a id="__codelineno-73-39" name="__codelineno-73-39" href="#__codelineno-73-39"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-73-40"><a id="__codelineno-73-40" name="__codelineno-73-40" href="#__codelineno-73-40"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-73-41"><a id="__codelineno-73-41" name="__codelineno-73-41" href="#__codelineno-73-41"></a>
</span><span id="__span-73-42"><a id="__codelineno-73-42" name="__codelineno-73-42" href="#__codelineno-73-42"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TOKENIZERS_PARALLELISM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;false&quot;</span>  <span class="c1"># To avoid warnings about parallelism in tokenizers</span>
</span><span id="__span-73-43"><a id="__codelineno-73-43" name="__codelineno-73-43" href="#__codelineno-73-43"></a>
</span><span id="__span-73-44"><a id="__codelineno-73-44" name="__codelineno-73-44" href="#__codelineno-73-44"></a><span class="c1"># distributed setup</span>
</span><span id="__span-73-45"><a id="__codelineno-73-45" name="__codelineno-73-45" href="#__codelineno-73-45"></a><span class="n">local_rank</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LOCAL_RANK&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span>
</span><span id="__span-73-46"><a id="__codelineno-73-46" name="__codelineno-73-46" href="#__codelineno-73-46"></a><span class="n">world_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;WORLD_SIZE&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span>
</span><span id="__span-73-47"><a id="__codelineno-73-47" name="__codelineno-73-47" href="#__codelineno-73-47"></a><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="n">local_rank</span><span class="p">)</span>
</span><span id="__span-73-48"><a id="__codelineno-73-48" name="__codelineno-73-48" href="#__codelineno-73-48"></a><span class="n">deepspeed</span><span class="o">.</span><span class="n">init_distributed</span><span class="p">()</span>
</span><span id="__span-73-49"><a id="__codelineno-73-49" name="__codelineno-73-49" href="#__codelineno-73-49"></a>
</span><span id="__span-73-50"><a id="__codelineno-73-50" name="__codelineno-73-50" href="#__codelineno-73-50"></a><span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;bigscience/T0_3B&quot;</span>
</span><span id="__span-73-51"><a id="__codelineno-73-51" name="__codelineno-73-51" href="#__codelineno-73-51"></a>
</span><span id="__span-73-52"><a id="__codelineno-73-52" name="__codelineno-73-52" href="#__codelineno-73-52"></a><span class="n">config</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
</span><span id="__span-73-53"><a id="__codelineno-73-53" name="__codelineno-73-53" href="#__codelineno-73-53"></a><span class="n">model_hidden_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">d_model</span>
</span><span id="__span-73-54"><a id="__codelineno-73-54" name="__codelineno-73-54" href="#__codelineno-73-54"></a>
</span><span id="__span-73-55"><a id="__codelineno-73-55" name="__codelineno-73-55" href="#__codelineno-73-55"></a><span class="c1"># batch size has to be divisible by world_size, but can be bigger than world_size</span>
</span><span id="__span-73-56"><a id="__codelineno-73-56" name="__codelineno-73-56" href="#__codelineno-73-56"></a><span class="n">train_batch_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">world_size</span>
</span><span id="__span-73-57"><a id="__codelineno-73-57" name="__codelineno-73-57" href="#__codelineno-73-57"></a>
</span><span id="__span-73-58"><a id="__codelineno-73-58" name="__codelineno-73-58" href="#__codelineno-73-58"></a><span class="c1"># ds_config notes</span>
</span><span id="__span-73-59"><a id="__codelineno-73-59" name="__codelineno-73-59" href="#__codelineno-73-59"></a><span class="c1">#</span>
</span><span id="__span-73-60"><a id="__codelineno-73-60" name="__codelineno-73-60" href="#__codelineno-73-60"></a><span class="c1"># - enable bf16 if you use Ampere or higher GPU - this will run in mixed precision and will be</span>
</span><span id="__span-73-61"><a id="__codelineno-73-61" name="__codelineno-73-61" href="#__codelineno-73-61"></a><span class="c1"># faster.</span>
</span><span id="__span-73-62"><a id="__codelineno-73-62" name="__codelineno-73-62" href="#__codelineno-73-62"></a><span class="c1">#</span>
</span><span id="__span-73-63"><a id="__codelineno-73-63" name="__codelineno-73-63" href="#__codelineno-73-63"></a><span class="c1"># - for older GPUs you can enable fp16, but it&#39;ll only work for non-bf16 pretrained models - e.g.</span>
</span><span id="__span-73-64"><a id="__codelineno-73-64" name="__codelineno-73-64" href="#__codelineno-73-64"></a><span class="c1"># all official t5 models are bf16-pretrained</span>
</span><span id="__span-73-65"><a id="__codelineno-73-65" name="__codelineno-73-65" href="#__codelineno-73-65"></a><span class="c1">#</span>
</span><span id="__span-73-66"><a id="__codelineno-73-66" name="__codelineno-73-66" href="#__codelineno-73-66"></a><span class="c1"># - set offload_param.device to &quot;none&quot; or completely remove the `offload_param` section if you don&#39;t</span>
</span><span id="__span-73-67"><a id="__codelineno-73-67" name="__codelineno-73-67" href="#__codelineno-73-67"></a><span class="c1"># - want CPU offload</span>
</span><span id="__span-73-68"><a id="__codelineno-73-68" name="__codelineno-73-68" href="#__codelineno-73-68"></a><span class="c1">#</span>
</span><span id="__span-73-69"><a id="__codelineno-73-69" name="__codelineno-73-69" href="#__codelineno-73-69"></a><span class="c1"># - if using `offload_param` you can manually finetune stage3_param_persistence_threshold to control</span>
</span><span id="__span-73-70"><a id="__codelineno-73-70" name="__codelineno-73-70" href="#__codelineno-73-70"></a><span class="c1"># - which params should remain on gpus - the larger the value the smaller the offload size</span>
</span><span id="__span-73-71"><a id="__codelineno-73-71" name="__codelineno-73-71" href="#__codelineno-73-71"></a><span class="c1">#</span>
</span><span id="__span-73-72"><a id="__codelineno-73-72" name="__codelineno-73-72" href="#__codelineno-73-72"></a><span class="c1"># For in-depth info on Deepspeed config see</span>
</span><span id="__span-73-73"><a id="__codelineno-73-73" name="__codelineno-73-73" href="#__codelineno-73-73"></a><span class="c1"># https://huggingface.co/docs/transformers/main/main_classes/deepspeed</span>
</span><span id="__span-73-74"><a id="__codelineno-73-74" name="__codelineno-73-74" href="#__codelineno-73-74"></a>
</span><span id="__span-73-75"><a id="__codelineno-73-75" name="__codelineno-73-75" href="#__codelineno-73-75"></a><span class="c1"># keeping the same format as json for consistency, except it uses lower case for true/false</span>
</span><span id="__span-73-76"><a id="__codelineno-73-76" name="__codelineno-73-76" href="#__codelineno-73-76"></a><span class="c1"># fmt: off</span>
</span><span id="__span-73-77"><a id="__codelineno-73-77" name="__codelineno-73-77" href="#__codelineno-73-77"></a><span class="n">ds_config</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-73-78"><a id="__codelineno-73-78" name="__codelineno-73-78" href="#__codelineno-73-78"></a>    <span class="s2">&quot;fp16&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-73-79"><a id="__codelineno-73-79" name="__codelineno-73-79" href="#__codelineno-73-79"></a>        <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">False</span>
</span><span id="__span-73-80"><a id="__codelineno-73-80" name="__codelineno-73-80" href="#__codelineno-73-80"></a>    <span class="p">},</span>
</span><span id="__span-73-81"><a id="__codelineno-73-81" name="__codelineno-73-81" href="#__codelineno-73-81"></a>    <span class="s2">&quot;bf16&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-73-82"><a id="__codelineno-73-82" name="__codelineno-73-82" href="#__codelineno-73-82"></a>        <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">False</span>
</span><span id="__span-73-83"><a id="__codelineno-73-83" name="__codelineno-73-83" href="#__codelineno-73-83"></a>    <span class="p">},</span>
</span><span id="__span-73-84"><a id="__codelineno-73-84" name="__codelineno-73-84" href="#__codelineno-73-84"></a>    <span class="s2">&quot;zero_optimization&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-73-85"><a id="__codelineno-73-85" name="__codelineno-73-85" href="#__codelineno-73-85"></a>        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="__span-73-86"><a id="__codelineno-73-86" name="__codelineno-73-86" href="#__codelineno-73-86"></a>        <span class="s2">&quot;offload_param&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-73-87"><a id="__codelineno-73-87" name="__codelineno-73-87" href="#__codelineno-73-87"></a>            <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span id="__span-73-88"><a id="__codelineno-73-88" name="__codelineno-73-88" href="#__codelineno-73-88"></a>            <span class="s2">&quot;pin_memory&quot;</span><span class="p">:</span> <span class="kc">True</span>
</span><span id="__span-73-89"><a id="__codelineno-73-89" name="__codelineno-73-89" href="#__codelineno-73-89"></a>        <span class="p">},</span>
</span><span id="__span-73-90"><a id="__codelineno-73-90" name="__codelineno-73-90" href="#__codelineno-73-90"></a>        <span class="s2">&quot;overlap_comm&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-73-91"><a id="__codelineno-73-91" name="__codelineno-73-91" href="#__codelineno-73-91"></a>        <span class="s2">&quot;contiguous_gradients&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-73-92"><a id="__codelineno-73-92" name="__codelineno-73-92" href="#__codelineno-73-92"></a>        <span class="s2">&quot;reduce_bucket_size&quot;</span><span class="p">:</span> <span class="n">model_hidden_size</span> <span class="o">*</span> <span class="n">model_hidden_size</span><span class="p">,</span>
</span><span id="__span-73-93"><a id="__codelineno-73-93" name="__codelineno-73-93" href="#__codelineno-73-93"></a>        <span class="s2">&quot;stage3_prefetch_bucket_size&quot;</span><span class="p">:</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">model_hidden_size</span> <span class="o">*</span> <span class="n">model_hidden_size</span><span class="p">,</span>
</span><span id="__span-73-94"><a id="__codelineno-73-94" name="__codelineno-73-94" href="#__codelineno-73-94"></a>        <span class="s2">&quot;stage3_param_persistence_threshold&quot;</span><span class="p">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model_hidden_size</span>
</span><span id="__span-73-95"><a id="__codelineno-73-95" name="__codelineno-73-95" href="#__codelineno-73-95"></a>    <span class="p">},</span>
</span><span id="__span-73-96"><a id="__codelineno-73-96" name="__codelineno-73-96" href="#__codelineno-73-96"></a>    <span class="s2">&quot;steps_per_print&quot;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span>
</span><span id="__span-73-97"><a id="__codelineno-73-97" name="__codelineno-73-97" href="#__codelineno-73-97"></a>    <span class="s2">&quot;train_batch_size&quot;</span><span class="p">:</span> <span class="n">train_batch_size</span><span class="p">,</span>
</span><span id="__span-73-98"><a id="__codelineno-73-98" name="__codelineno-73-98" href="#__codelineno-73-98"></a>    <span class="s2">&quot;train_micro_batch_size_per_gpu&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-73-99"><a id="__codelineno-73-99" name="__codelineno-73-99" href="#__codelineno-73-99"></a>    <span class="s2">&quot;wall_clock_breakdown&quot;</span><span class="p">:</span> <span class="kc">False</span>
</span><span id="__span-73-100"><a id="__codelineno-73-100" name="__codelineno-73-100" href="#__codelineno-73-100"></a><span class="p">}</span>
</span><span id="__span-73-101"><a id="__codelineno-73-101" name="__codelineno-73-101" href="#__codelineno-73-101"></a><span class="c1"># fmt: on</span>
</span><span id="__span-73-102"><a id="__codelineno-73-102" name="__codelineno-73-102" href="#__codelineno-73-102"></a>
</span><span id="__span-73-103"><a id="__codelineno-73-103" name="__codelineno-73-103" href="#__codelineno-73-103"></a><span class="c1"># next line instructs transformers to partition the model directly over multiple gpus using</span>
</span><span id="__span-73-104"><a id="__codelineno-73-104" name="__codelineno-73-104" href="#__codelineno-73-104"></a><span class="c1"># deepspeed.zero.Init when model&#39;s `from_pretrained` method is called.</span>
</span><span id="__span-73-105"><a id="__codelineno-73-105" name="__codelineno-73-105" href="#__codelineno-73-105"></a><span class="c1">#</span>
</span><span id="__span-73-106"><a id="__codelineno-73-106" name="__codelineno-73-106" href="#__codelineno-73-106"></a><span class="c1"># **it has to be run before loading the model AutoModelForSeq2SeqLM.from_pretrained(model_name)**</span>
</span><span id="__span-73-107"><a id="__codelineno-73-107" name="__codelineno-73-107" href="#__codelineno-73-107"></a><span class="c1">#</span>
</span><span id="__span-73-108"><a id="__codelineno-73-108" name="__codelineno-73-108" href="#__codelineno-73-108"></a><span class="c1"># otherwise the model will first be loaded normally and only partitioned at forward time which is</span>
</span><span id="__span-73-109"><a id="__codelineno-73-109" name="__codelineno-73-109" href="#__codelineno-73-109"></a><span class="c1"># less efficient and when there is little CPU RAM may fail</span>
</span><span id="__span-73-110"><a id="__codelineno-73-110" name="__codelineno-73-110" href="#__codelineno-73-110"></a><span class="n">dschf</span> <span class="o">=</span> <span class="n">HfDeepSpeedConfig</span><span class="p">(</span><span class="n">ds_config</span><span class="p">)</span>  <span class="c1"># keep this object alive</span>
</span><span id="__span-73-111"><a id="__codelineno-73-111" name="__codelineno-73-111" href="#__codelineno-73-111"></a>
</span><span id="__span-73-112"><a id="__codelineno-73-112" name="__codelineno-73-112" href="#__codelineno-73-112"></a><span class="c1"># now a model can be loaded.</span>
</span><span id="__span-73-113"><a id="__codelineno-73-113" name="__codelineno-73-113" href="#__codelineno-73-113"></a><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForSeq2SeqLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
</span><span id="__span-73-114"><a id="__codelineno-73-114" name="__codelineno-73-114" href="#__codelineno-73-114"></a>
</span><span id="__span-73-115"><a id="__codelineno-73-115" name="__codelineno-73-115" href="#__codelineno-73-115"></a><span class="c1"># initialise Deepspeed ZeRO and store only the engine object</span>
</span><span id="__span-73-116"><a id="__codelineno-73-116" name="__codelineno-73-116" href="#__codelineno-73-116"></a><span class="n">ds_engine</span> <span class="o">=</span> <span class="n">deepspeed</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">config_params</span><span class="o">=</span><span class="n">ds_config</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-73-117"><a id="__codelineno-73-117" name="__codelineno-73-117" href="#__codelineno-73-117"></a><span class="n">ds_engine</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>  <span class="c1"># inference</span>
</span><span id="__span-73-118"><a id="__codelineno-73-118" name="__codelineno-73-118" href="#__codelineno-73-118"></a>
</span><span id="__span-73-119"><a id="__codelineno-73-119" name="__codelineno-73-119" href="#__codelineno-73-119"></a><span class="c1"># Deepspeed ZeRO can process unrelated inputs on each GPU. So for 2 gpus you process 2 inputs at once.</span>
</span><span id="__span-73-120"><a id="__codelineno-73-120" name="__codelineno-73-120" href="#__codelineno-73-120"></a><span class="c1"># If you use more GPUs adjust for more.</span>
</span><span id="__span-73-121"><a id="__codelineno-73-121" name="__codelineno-73-121" href="#__codelineno-73-121"></a><span class="c1"># And of course if you have just one input to process you then need to pass the same string to both gpus</span>
</span><span id="__span-73-122"><a id="__codelineno-73-122" name="__codelineno-73-122" href="#__codelineno-73-122"></a><span class="c1"># If you use only one GPU, then you will have only rank 0.</span>
</span><span id="__span-73-123"><a id="__codelineno-73-123" name="__codelineno-73-123" href="#__codelineno-73-123"></a><span class="n">rank</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span>
</span><span id="__span-73-124"><a id="__codelineno-73-124" name="__codelineno-73-124" href="#__codelineno-73-124"></a><span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-73-125"><a id="__codelineno-73-125" name="__codelineno-73-125" href="#__codelineno-73-125"></a>    <span class="n">text_in</span> <span class="o">=</span> <span class="s2">&quot;Is this review positive or negative? Review: this is the best cast iron skillet you will ever buy&quot;</span>
</span><span id="__span-73-126"><a id="__codelineno-73-126" name="__codelineno-73-126" href="#__codelineno-73-126"></a><span class="k">elif</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-73-127"><a id="__codelineno-73-127" name="__codelineno-73-127" href="#__codelineno-73-127"></a>    <span class="n">text_in</span> <span class="o">=</span> <span class="s2">&quot;Is this review positive or negative? Review: this is the worst restaurant ever&quot;</span>
</span><span id="__span-73-128"><a id="__codelineno-73-128" name="__codelineno-73-128" href="#__codelineno-73-128"></a>
</span><span id="__span-73-129"><a id="__codelineno-73-129" name="__codelineno-73-129" href="#__codelineno-73-129"></a><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
</span><span id="__span-73-130"><a id="__codelineno-73-130" name="__codelineno-73-130" href="#__codelineno-73-130"></a><span class="n">inputs</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text_in</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">local_rank</span><span class="p">)</span>
</span><span id="__span-73-131"><a id="__codelineno-73-131" name="__codelineno-73-131" href="#__codelineno-73-131"></a><span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-73-132"><a id="__codelineno-73-132" name="__codelineno-73-132" href="#__codelineno-73-132"></a>    <span class="n">outputs</span> <span class="o">=</span> <span class="n">ds_engine</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">synced_gpus</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-73-133"><a id="__codelineno-73-133" name="__codelineno-73-133" href="#__codelineno-73-133"></a><span class="n">text_out</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-73-134"><a id="__codelineno-73-134" name="__codelineno-73-134" href="#__codelineno-73-134"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rank</span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   in=</span><span class="si">{</span><span class="n">text_in</span><span class="si">}</span><span class="se">\n</span><span class="s2">  out=</span><span class="si">{</span><span class="n">text_out</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>ãã‚Œã‚’<code>t0.py</code>ã¨ã—ã¦ä¿å­˜ã—ã¦å®Ÿè¡Œã—ã¾ã—ã‚‡ã†ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a>$<span class="w"> </span>deepspeed<span class="w"> </span>--num_gpus<span class="w"> </span><span class="m">2</span><span class="w"> </span>t0.py
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>rank0:
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="w">   </span><span class="k">in</span><span class="o">=</span>Is<span class="w"> </span>this<span class="w"> </span>review<span class="w"> </span>positive<span class="w"> </span>or<span class="w"> </span>negative?<span class="w"> </span>Review:<span class="w"> </span>this<span class="w"> </span>is<span class="w"> </span>the<span class="w"> </span>best<span class="w"> </span>cast<span class="w"> </span>iron<span class="w"> </span>skillet<span class="w"> </span>you<span class="w"> </span>will<span class="w"> </span>ever<span class="w"> </span>buy
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a><span class="w">  </span><span class="nv">out</span><span class="o">=</span>Positive
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>rank1:
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a><span class="w">   </span><span class="k">in</span><span class="o">=</span>Is<span class="w"> </span>this<span class="w"> </span>review<span class="w"> </span>positive<span class="w"> </span>or<span class="w"> </span>negative?<span class="w"> </span>Review:<span class="w"> </span>this<span class="w"> </span>is<span class="w"> </span>the<span class="w"> </span>worst<span class="w"> </span>restaurant<span class="w"> </span>ever
</span><span id="__span-74-7"><a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a><span class="w">  </span><span class="nv">out</span><span class="o">=</span>negative
</span></code></pre></div>
<p>ã“ã‚Œã¯éå¸¸ã«åŸºæœ¬çš„ãªä¾‹ã§ã‚ã‚Šã€ãƒ‹ãƒ¼ã‚ºã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„ã€‚</p>
<h3 id="generate-nuances"><code>generate</code> nuances</h3>
<p>ZeRO Stage-3 ã§è¤‡æ•°ã® GPU ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€<code>generate(..., synced_gpus=True)</code>ã‚’å‘¼ã³å‡ºã—ã¦ GPU ã‚’åŒæœŸã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚’è¡Œã‚ãªã„ã¨ã€1 ã¤ã® GPU ãŒä»–ã® GPU ã‚ˆã‚Šå…ˆã«ç”Ÿæˆã‚’çµ‚äº†ã—ãŸå ´åˆã€æ®‹ã‚Šã® GPU ãŒç”Ÿæˆã‚’åœæ­¢ã—ãŸ GPU ã‹ã‚‰ã‚¦ã‚§ã‚¤ãƒˆã®ã‚·ãƒ£ãƒ¼ãƒ‰ã‚’å—ä¿¡ã§ããªããªã‚‹ãŸã‚ã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ãŒãƒãƒ³ã‚°ã—ã¾ã™ã€‚</p>
<p><code>transformers&gt;=4.28</code> ä»¥é™ã€<code>synced_gpus</code> ãŒæ˜ç¤ºçš„ã«æŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€ã“ã‚Œã‚‰ã®æ¡ä»¶ãŒæ¤œå‡ºã•ã‚Œã‚‹ã¨è‡ªå‹•çš„ã« <code>True</code> ã«è¨­å®šã•ã‚Œã¾ã™ã€‚ãŸã ã—ã€å¿…è¦ã«å¿œã˜ã¦ <code>synced_gpus</code> ã®å€¤ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
<h2 id="deepspeed">Deepspeed çµ±åˆã®ãƒ†ã‚¹ãƒˆ</h2>
<p>DeepSpeed çµ±åˆã‚’å«ã‚€ PR ã‚’é€ä¿¡ã™ã‚‹å ´åˆã¯ã€CircleCI PR CI ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«ã¯ GPU ãŒãªã„ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ãã®ãŸã‚ã€GPU ã‚’å¿…è¦ã¨ã™ã‚‹ãƒ†ã‚¹ãƒˆã¯åˆ¥ã® CI ã§æ¯æ™©ã®ã¿å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€PR ã§ç·‘è‰²ã® CI ãƒ¬ãƒãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã‚‚ã€DeepSpeed ãƒ†ã‚¹ãƒˆãŒåˆæ ¼ã—ãŸã“ã¨ã‚’æ„å‘³ã™ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
<p>DeepSpeed ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€å°‘ãªãã¨ã‚‚ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="nv">RUN_SLOW</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>pytest<span class="w"> </span>tests/deepspeed/test_deepspeed.py
</span></code></pre></div>
<p>ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã¾ãŸã¯ pytorch ã‚µãƒ³ãƒ—ãƒ« ã‚³ãƒ¼ãƒ‰ã®ã„ãšã‚Œã‹ã‚’å¤‰æ›´ã—ãŸå ´åˆã¯ã€Model Zoo ãƒ†ã‚¹ãƒˆã‚‚å®Ÿè¡Œã—ã¾ã™ã€‚ä»¥ä¸‹ã¯ã™ã¹ã¦ã® DeepSpeed ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="nv">RUN_SLOW</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>pytest<span class="w"> </span>tests/deepspeed
</span></code></pre></div>
<h2 id="main-deepspeed-resources">Main DeepSpeed Resources</h2>
<ul>
<li><a href="https://github.com/deepspeedai/DeepSpeed">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® github</a></li>
<li><a href="https://www.deepspeed.ai/getting-started/">ä½¿ç”¨æ–¹æ³•ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a></li>
<li><a href="https://deepspeed.readthedocs.io/en/latest/index.html">API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a></li>
<li><a href="https://www.microsoft.com/en-us/research/search/?q=deepspeed">ãƒ–ãƒ­ã‚°æŠ•ç¨¿</a></li>
</ul>
<p>è«–æ–‡:</p>
<ul>
<li><a href="https://huggingface.co/papers/1910.02054">ZeRO: å…†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ãƒ¢ãƒ‡ãƒ«ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«å‘ã‘ãŸãƒ¡ãƒ¢ãƒªã®æœ€é©åŒ–</a></li>
<li><a href="https://huggingface.co/papers/2101.06840">ZeRO-Offload: 10 å„„è¦æ¨¡ã®ãƒ¢ãƒ‡ãƒ« ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®æ°‘ä¸»åŒ–</a></li>
<li><a href="https://huggingface.co/papers/2104.07857">ZeRO-Infinity: æ¥µé™ã‚¹ã‚±ãƒ¼ãƒ«ã®æ·±å±¤å­¦ç¿’ã®ãŸã‚ã® GPU ãƒ¡ãƒ¢ãƒªã®å£ã‚’æ‰“ã¡ç ´ã‚‹</a></li>
</ul>
<p>æœ€å¾Œã«ã€HuggingFace [<code>Trainer</code>] ã¯ DeepSpeed ã®ã¿ã‚’çµ±åˆã—ã¦ã„ã‚‹ã“ã¨ã‚’è¦šãˆã¦ãŠã„ã¦ãã ã•ã„ã€‚
DeepSpeed ã®ä½¿ç”¨ã«é–¢ã—ã¦å•é¡Œã‚„è³ªå•ãŒã‚ã‚‹å ´åˆã¯ã€<a href="https://github.com/deepspeedai/DeepSpeed/issues">DeepSpeed GitHub</a> ã«å•é¡Œã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../../../../..", "features": ["navigation.tabs", "navigation.indexes", "navigation.instant", "navigation.sections", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "content.tabs.link", "content.code.copy"], "search": "../../../../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>