
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../../../../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Testing - Ohayou</title>
      
    
    
      <link rel="stylesheet" href="../../../../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../../assets/extra.css">
    
    <script>__md_scope=new URL("../../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#testing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../../.." title="Ohayou" class="md-header__button md-logo" aria-label="Ohayou" data-md-component="logo">
      
  <img src="../../../../../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ohayou
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Testing
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../ohayou/" class="md-tabs__link">
        
  
  
    
  
  Ohayou

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../../vllm/open_ai_vllm_example_a_v_t/" class="md-tabs__link">
          
  
  
    
  
  vLLM

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../../llm/speculative_decoding/" class="md-tabs__link">
          
  
  
    
  
  LLM

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../../vlm/qwen3_vl_4B_object_detection/" class="md-tabs__link">
          
  
  
    
  
  VLM

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../md_format_helpers/" class="md-tabs__link">
        
  
  
    
  
  MD format helpers

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../docker/" class="md-tabs__link">
        
  
  
    
  
  Docker

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../linux/" class="md-tabs__link">
        
  
  
    
  
  Linux

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../moe/" class="md-tabs__link">
        
  
  
    
  
  Mixture of Experts

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../slurm/" class="md-tabs__link">
        
  
  
    
  
  Slurm

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../../japanese-phrases/" class="md-tabs__link">
          
  
  
    
  
  Japanese Phrases

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../hackathon/index.md" class="md-tabs__link">
        
  
  
    
  
  Hack

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../../.." title="Ohayou" class="md-nav__button md-logo" aria-label="Ohayou" data-md-component="logo">
      
  <img src="../../../../../../assets/logo.png" alt="logo">

    </a>
    Ohayou
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../ohayou/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ohayou
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    vLLM
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            vLLM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../vllm/open_ai_vllm_example_a_v_t/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Single Request
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../vllm/bash_vllm_serve/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bash online serve
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../vllm/benchmarks/performance_eval/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Benchmarks
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    LLM
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            LLM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../llm/speculative_decoding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Speculative Decoding
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    VLM
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            VLM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../vlm/qwen3_vl_4B_object_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Qwen3VL
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../md_format_helpers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MD format helpers
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../docker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Docker
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../linux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Linux
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../moe/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mixture of Experts
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../slurm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Slurm
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../../../japanese-phrases/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Japanese Phrases
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_11" id="__nav_11_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Japanese Phrases
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../../../japanese-phrases/daily-life/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Daily Life
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_11_2" id="__nav_11_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_11_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11_2">
            <span class="md-nav__icon md-icon"></span>
            Daily Life
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../japanese-phrases/daily-life/shopping/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shopping
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../../../japanese-phrases/greetings/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Greetings
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_11_3" id="__nav_11_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_11_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11_3">
            <span class="md-nav__icon md-icon"></span>
            Greetings
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../japanese-phrases/greetings/casual/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Casual
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../japanese-phrases/emotions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Emotions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../japanese-phrases/anime-manga/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Anime/Manga
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../hackathon/index.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hack
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-transformers-are-tested" class="md-nav__link">
    <span class="md-ellipsis">
      How transformers are tested
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Running tests
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Running tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#choosing-which-tests-to-run" class="md-nav__link">
    <span class="md-ellipsis">
      Choosing which tests to run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-the-list-of-all-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Getting the list of all tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-a-specific-test-module" class="md-nav__link">
    <span class="md-ellipsis">
      Run a specific test module
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-specific-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Run specific tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-accelerate-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Run accelerate tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-documentation-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Run documentation tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-only-modified-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Run only modified tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automatically-rerun-failed-tests-on-source-modification" class="md-nav__link">
    <span class="md-ellipsis">
      Automatically rerun failed tests on source modification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skip-a-test-module" class="md-nav__link">
    <span class="md-ellipsis">
      Skip a test module
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clearing-state" class="md-nav__link">
    <span class="md-ellipsis">
      Clearing state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-tests-in-parallel" class="md-nav__link">
    <span class="md-ellipsis">
      Running tests in parallel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-order-and-repetition" class="md-nav__link">
    <span class="md-ellipsis">
      Test order and repetition
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test order and repetition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#repeat-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Repeat tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-tests-in-a-random-order" class="md-nav__link">
    <span class="md-ellipsis">
      Run tests in a random order
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#look-and-feel-variations" class="md-nav__link">
    <span class="md-ellipsis">
      Look and feel variations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Look and feel variations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pytest-sugar" class="md-nav__link">
    <span class="md-ellipsis">
      pytest-sugar
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#report-each-sub-test-name-and-its-progress" class="md-nav__link">
    <span class="md-ellipsis">
      Report each sub-test name and its progress
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instantly-shows-failed-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Instantly shows failed tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#to-gpu-or-not-to-gpu" class="md-nav__link">
    <span class="md-ellipsis">
      To GPU or not to GPU
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-with-a-specific-pytorch-backend-or-device" class="md-nav__link">
    <span class="md-ellipsis">
      Testing with a specific PyTorch backend or device
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#distributed-training" class="md-nav__link">
    <span class="md-ellipsis">
      Distributed training
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#output-capture" class="md-nav__link">
    <span class="md-ellipsis">
      Output capture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#color-control" class="md-nav__link">
    <span class="md-ellipsis">
      Color control
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sending-test-report-to-online-pastebin-service" class="md-nav__link">
    <span class="md-ellipsis">
      Sending test report to online pastebin service
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#writing-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Writing tests
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Writing tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parametrization" class="md-nav__link">
    <span class="md-ellipsis">
      Parametrization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#files-and-directories" class="md-nav__link">
    <span class="md-ellipsis">
      Files and directories
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#temporary-files-and-directories" class="md-nav__link">
    <span class="md-ellipsis">
      Temporary files and directories
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#temporary-syspath-override" class="md-nav__link">
    <span class="md-ellipsis">
      Temporary sys.path override
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skipping-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Skipping tests
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Skipping tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-the-stdoutstderr-output" class="md-nav__link">
    <span class="md-ellipsis">
      Testing the stdout/stderr output
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capturing-logger-stream" class="md-nav__link">
    <span class="md-ellipsis">
      Capturing logger stream
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-with-environment-variables" class="md-nav__link">
    <span class="md-ellipsis">
      Testing with environment variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-reproducible-results" class="md-nav__link">
    <span class="md-ellipsis">
      Getting reproducible results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debugging-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Debugging tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#working-with-github-actions-workflows" class="md-nav__link">
    <span class="md-ellipsis">
      Working with github actions workflows
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-experimental-ci-features" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Experimental CI Features
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<!--Copyright 2023 The HuggingFace Team. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with
the License. You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.

âš ï¸ Note that this file is in Markdown but contain specific syntax for our doc-builder (similar to MDX) that may not be
rendered properly in your Markdown viewer.

-->

<h1 id="testing">Testing</h1>
<p>ğŸ¤— Transformersãƒ¢ãƒ‡ãƒ«ãŒã©ã®ã‚ˆã†ã«ãƒ†ã‚¹ãƒˆã•ã‚Œã€æ–°ã—ã„ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆã‚’æ”¹å–„ã§ãã‚‹ã‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<p>ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã¯2ã¤ã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™ï¼š</p>
<ol>
<li><code>tests</code> -- ä¸€èˆ¬çš„ãªAPIç”¨ã®ãƒ†ã‚¹ãƒˆ</li>
<li><code>examples</code> -- APIã®ä¸€éƒ¨ã§ã¯ãªã„ã•ã¾ã–ã¾ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ãƒ†ã‚¹ãƒˆ</li>
</ol>
<h2 id="how-transformers-are-tested">How transformers are tested</h2>
<ol>
<li>PRãŒæå‡ºã•ã‚Œã‚‹ã¨ã€9ã¤ã®CircleCiã‚¸ãƒ§ãƒ–ã§ãƒ†ã‚¹ãƒˆã•ã‚Œã¾ã™ã€‚PRã¸ã®æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆã”ã¨ã«å†ãƒ†ã‚¹ãƒˆã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã‚¸ãƒ§ãƒ–ã¯ã€<a href="https://github.com/huggingface/transformers/tree/main/.circleci/config.yml">ã“ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«</a>ã§å®šç¾©ã•ã‚Œã¦ãŠã‚Šã€å¿…è¦ãªå ´åˆã¯åŒã˜ç’°å¢ƒã‚’è‡ªåˆ†ã®ãƒã‚·ãƒ³ã§å†ç¾ã§ãã¾ã™ã€‚</li>
</ol>
<p>ã“ã‚Œã‚‰ã®CIã‚¸ãƒ§ãƒ–ã¯ <code>@slow</code> ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã›ã‚“ã€‚</p>
<ol>
<li>
<p><a href="https://github.com/huggingface/transformers/actions">GitHub Actions</a>ã«ã‚ˆã£ã¦å®Ÿè¡Œã•ã‚Œã‚‹3ã¤ã®ã‚¸ãƒ§ãƒ–ãŒã‚ã‚Šã¾ã™ï¼š</p>
</li>
<li>
<p><a href="https://github.com/huggingface/transformers/tree/main/.github/workflows/github-torch-hub.yml">torch hub integration</a>: torch hubã®çµ±åˆãŒå‹•ä½œã™ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
</li>
<li>
<p><a href="https://github.com/huggingface/transformers/tree/main/.github/workflows/self-push.yml">self-hosted (push)</a>: <code>main</code> ã«ã‚³ãƒŸãƒƒãƒˆãŒè¡Œã‚ã‚ŒãŸå ´åˆã«ã€GPUã§é«˜é€Ÿãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã®ã‚¸ãƒ§ãƒ–ã¯ã€<code>main</code> ã§ã®ã‚³ãƒŸãƒƒãƒˆãŒä»¥ä¸‹ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ãŸå ´åˆã«ã®ã¿å®Ÿè¡Œã•ã‚Œã¾ã™ï¼š<code>src</code>ã€<code>tests</code>ã€<code>.github</code>ï¼ˆè¿½åŠ ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚«ãƒ¼ãƒ‰ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãªã©ã®å®Ÿè¡Œã‚’é˜²ããŸã‚ï¼‰ã€‚</p>
</li>
<li>
<p><a href="https://github.com/huggingface/transformers/tree/main/.github/workflows/self-scheduled.yml">self-hosted runner</a>: GPUã§ <code>tests</code> ã¨ <code>examples</code> ã®é€šå¸¸ã®ãƒ†ã‚¹ãƒˆã¨é…ã„ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p>
</li>
</ol>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nv">RUN_SLOW</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>pytest<span class="w"> </span>tests/
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nv">RUN_SLOW</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>pytest<span class="w"> </span>examples/
</span></code></pre></div>
    çµæœã¯<a href="https://github.com/huggingface/transformers/actions">here</a>ã§è¦³å¯Ÿã§ãã¾ã™ã€‚</p>
<h2 id="running-tests">Running tests</h2>
<h3 id="choosing-which-tests-to-run">Choosing which tests to run</h3>
<p>ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã®å¤šãã®è©³ç´°ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚ã™ã¹ã¦ã‚’èª­ã‚“ã å¾Œã§ã‚‚ã€ã•ã‚‰ã«è©³ç´°ãŒå¿…è¦ãªå ´åˆã¯ã€<a href="https://docs.pytest.org/en/latest/usage.html">ã“ã¡ã‚‰</a>ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
<p>ä»¥ä¸‹ã¯ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ã„ãã¤ã‹ã®æœ€ã‚‚ä¾¿åˆ©ãªæ–¹æ³•ã§ã™ã€‚</p>
<p>ã™ã¹ã¦å®Ÿè¡Œã—ã¾ã™:
<div class="language-console highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="go">pytest</span>
</span></code></pre></div></p>
<p>ã¾ãŸã¯ï¼š
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>make<span class="w"> </span><span class="nb">test</span>
</span></code></pre></div></p>
<p>å¾Œè€…ã¯æ¬¡ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>-n<span class="w"> </span>auto<span class="w"> </span>--dist<span class="o">=</span>loadfile<span class="w"> </span>-s<span class="w"> </span>-v<span class="w"> </span>./tests/
</span></code></pre></div>
<p>ä»¥ä¸‹ã¯ã€pytestã«æ¸¡ã™è¨­å®šæƒ…å ±ã§ã™ã€‚</p>
<ul>
<li>ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚»ã‚¹ã‚’CPUã‚³ã‚¢ã®æ•°ã¨åŒã˜ã ã‘å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«æŒ‡ç¤ºã—ã¾ã™ã€‚ãŸã ã—ã€RAMãŒååˆ†ã§ãªã„å ´åˆã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚</li>
<li>åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã¯ã€åŒã˜ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚»ã‚¹ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚</li>
<li>å‡ºåŠ›ã®ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’è¡Œã„ã¾ã›ã‚“ã€‚</li>
<li>å†—é•·ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™ã€‚</li>
</ul>
<h3 id="getting-the-list-of-all-tests">Getting the list of all tests</h3>
<p>ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã®ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆï¼š</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>pytest<span class="w"> </span>--collect-only<span class="w"> </span>-q
</span></code></pre></div>
<p>æŒ‡å®šã•ã‚ŒãŸãƒ†ã‚¹ãƒˆ ãƒ•ã‚¡ã‚¤ãƒ«ã®ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆ:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>pytest<span class="w"> </span>tests/test_optimization.py<span class="w"> </span>--collect-only<span class="w"> </span>-q
</span></code></pre></div>
<h3 id="run-a-specific-test-module">Run a specific test module</h3>
<p>å€‹åˆ¥ã®ãƒ†ã‚¹ãƒˆ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>pytest<span class="w"> </span>tests/utils/test_logging.py
</span></code></pre></div>
<h3 id="run-specific-tests">Run specific tests</h3>
<p>ã»ã¨ã‚“ã©ã®ãƒ†ã‚¹ãƒˆã§unittestãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ç‰¹å®šã®ã‚µãƒ–ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ãã‚Œã‚‰ã®ãƒ†ã‚¹ãƒˆã‚’å«ã‚€unittestã‚¯ãƒ©ã‚¹ã®åå‰ã‚’çŸ¥ã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€ãã‚Œã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼š</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>pytest<span class="w"> </span>tests/test_optimization.py::OptimizationTest::test_adam_w
</span></code></pre></div>
<p>ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œæ–¹æ³•:</p>
<p>ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: <code>tests/test_optimization.py</code>
ã‚¯ãƒ©ã‚¹å: <code>OptimizationTest</code>
ãƒ†ã‚¹ãƒˆé–¢æ•°ã®åå‰: <code>test_adam_w</code></p>
<p>ãƒ•ã‚¡ã‚¤ãƒ«ã«è¤‡æ•°ã®ã‚¯ãƒ©ã‚¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ç‰¹å®šã®ã‚¯ãƒ©ã‚¹ã®ãƒ†ã‚¹ãƒˆã®ã¿ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’é¸æŠã§ãã¾ã™ã€‚ä¾‹ãˆã°ï¼š</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>pytest<span class="w"> </span>tests/test_optimization.py::OptimizationTest
</span></code></pre></div>
<p>ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹å†…ã®ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p>
<p>å‰è¿°ã®é€šã‚Šã€<code>OptimizationTest</code> ã‚¯ãƒ©ã‚¹ã«å«ã¾ã‚Œã‚‹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ï¼š</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>pytest<span class="w"> </span>tests/test_optimization.py::OptimizationTest<span class="w"> </span>--collect-only<span class="w"> </span>-q
</span></code></pre></div>
<p>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¼ã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚</p>
<p>åå‰ã« <code>adam</code> ãŒå«ã¾ã‚Œã‚‹ãƒ†ã‚¹ãƒˆã®ã¿ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ï¼š</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>pytest<span class="w"> </span>-k<span class="w"> </span>adam<span class="w"> </span>tests/test_optimization.py
</span></code></pre></div>
<p><code>and</code>ãŠã‚ˆã³<code>or</code>ã¯ã€ã™ã¹ã¦ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã™ã‚‹ã‹ã€ã„ãšã‚Œã‹ã‚’ç¤ºã™ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚<code>not</code>ã¯å¦å®šã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚</p>
<p><code>adam</code>ã¨ã„ã†åå‰ã‚’å«ã‚€ãƒ†ã‚¹ãƒˆã‚’é™¤ã„ã¦ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ï¼š</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>pytest<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;not adam&quot;</span><span class="w"> </span>tests/test_optimization.py
</span></code></pre></div>
<p>ä»¥ä¸‹ã¯ã€æä¾›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã®æ—¥æœ¬èªè¨³ã§ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>pytest<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;ada and not adam&quot;</span><span class="w"> </span>tests/test_optimization.py
</span></code></pre></div>
<p>ãŸã¨ãˆã°ã€<code>test_adafactor</code>ã¨<code>test_adam_w</code>ã®ä¸¡æ–¹ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã§ãã¾ã™:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>pytest<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;test_adam_w or test_adam_w&quot;</span><span class="w"> </span>tests/test_optimization.py
</span></code></pre></div>
<p>æ³¨æ„: ã“ã“ã§ã¯ã€<code>or</code> ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã„ãšã‚Œã‹ä¸€ã¤ãŒä¸€è‡´ã™ã‚Œã°ã€ä¸¡æ–¹ã‚’å«ã‚ã‚‹ãŸã‚ã§ã™ã€‚</p>
<p>ä¸¡æ–¹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å«ã‚€ãƒ†ã‚¹ãƒˆã®ã¿ã‚’å«ã‚ãŸã„å ´åˆã¯ã€<code>and</code> ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>pytest<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;test and ada&quot;</span><span class="w"> </span>tests/test_optimization.py
</span></code></pre></div>
<h3 id="run-accelerate-tests">Run <code>accelerate</code> tests</h3>
<p>æ™‚ã€…ã€ãƒ¢ãƒ‡ãƒ«ã«å¯¾ã—ã¦ <code>accelerate</code> ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€<code>OPT</code> å®Ÿè¡Œã«å¯¾ã—ã¦ã“ã‚Œã‚‰ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ãŸã„å ´åˆã€ã‚³ãƒãƒ³ãƒ‰ã« <code>-m accelerate_tests</code> ã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§æ¸ˆã¿ã¾ã™ï¼š</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="nv">RUN_SLOW</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span>accelerate_tests<span class="w"> </span>tests/models/opt/test_modeling_opt.py
</span></code></pre></div>
<h3 id="run-documentation-tests">Run documentation tests</h3>
<p>ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¾‹ãŒæ­£ã—ã„ã‹ã©ã†ã‹ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ã€<code>doctests</code> ãŒåˆæ ¼ã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä¾‹ã¨ã—ã¦ã€<a href="https://github.com/huggingface/transformers/blob/main/src/transformers/models/whisper/modeling_whisper.py#L1017-L1035"><code>WhisperModel.forward</code> ã®ãƒ‰ãƒƒã‚¯ã‚¹ãƒˆãƒªãƒ³ã‚°</a>ã‚’ä½¿ç”¨ã—ã¾ã—ã‚‡ã†ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="sd">Returns:</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="sd">Example:</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="sd">    ```python</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="sd">    &gt;&gt;&gt; import torch</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="sd">    &gt;&gt;&gt; from transformers import WhisperModel, WhisperFeatureExtractor</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="sd">    &gt;&gt;&gt; from datasets import load_dataset</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="sd">    &gt;&gt;&gt; model = WhisperModel.from_pretrained(&quot;openai/whisper-base&quot;)</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="sd">    &gt;&gt;&gt; feature_extractor = WhisperFeatureExtractor.from_pretrained(&quot;openai/whisper-base&quot;)</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="sd">    &gt;&gt;&gt; ds = load_dataset(&quot;hf-internal-testing/librispeech_asr_dummy&quot;, &quot;clean&quot;, split=&quot;validation&quot;)</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="sd">    &gt;&gt;&gt; inputs = feature_extractor(ds[0][&quot;audio&quot;][&quot;array&quot;], return_tensors=&quot;pt&quot;)</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="sd">    &gt;&gt;&gt; input_features = inputs.input_features</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="sd">    &gt;&gt;&gt; decoder_input_ids = torch.tensor([[1, 1]]) * model.config.decoder_start_token_id</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="sd">    &gt;&gt;&gt; last_hidden_state = model(input_features, decoder_input_ids=decoder_input_ids).last_hidden_state</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="sd">    &gt;&gt;&gt; list(last_hidden_state.shape)</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="sd">    [1, 2, 512]</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="sd">    ```&quot;&quot;&quot;</span>
</span></code></pre></div>
<p>æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ã™ã¹ã¦ã®ãƒ‰ãƒƒã‚¯ã‚¹ãƒˆãƒªãƒ³ã‚°ä¾‹ã‚’è‡ªå‹•çš„ã«ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®è¡Œã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>pytest<span class="w"> </span>--doctest-modules<span class="w"> </span>&lt;path_to_file_or_dir&gt;
</span></code></pre></div>
<p>ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³æ‹¡å¼µå­ãŒã‚ã‚‹å ´åˆã¯ã€<code>--doctest-glob="*.md"</code>å¼•æ•°ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<h3 id="run-only-modified-tests">Run only modified tests</h3>
<p><a href="https://github.com/anapaulagomes/pytest-picked">pytest-picked</a>ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€æœªã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒï¼ˆGitã«å¾“ã£ã¦ï¼‰ã«é–¢é€£ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€å¤‰æ›´å†…å®¹ã«é–¢é€£ã™ã‚‹ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€å¤‰æ›´ãŒä½•ã‚‚å£Šã‚Œã¦ã„ãªã„ã“ã¨ã‚’è¿…é€Ÿã«ç¢ºèªã™ã‚‹ç´ æ™´ã‚‰ã—ã„æ–¹æ³•ã§ã™ã€‚å¤‰æ›´ã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã«é–¢é€£ã™ã‚‹ãƒ†ã‚¹ãƒˆã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>pip<span class="w"> </span>install<span class="w"> </span>pytest-picked
</span></code></pre></div>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>pytest<span class="w"> </span>--picked
</span></code></pre></div>
<p>ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã¯ã€å¤‰æ›´ã•ã‚ŒãŸãŒã¾ã ã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚</p>
<h3 id="automatically-rerun-failed-tests-on-source-modification">Automatically rerun failed tests on source modification</h3>
<p><a href="https://github.com/pytest-dev/pytest-xdist">pytest-xdist</a>ã¯ã€éå¸¸ã«ä¾¿åˆ©ãªæ©Ÿèƒ½ã‚’æä¾›ã—ã¦ãŠã‚Šã€ã™ã¹ã¦ã®å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚’æ¤œå‡ºã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£ã™ã‚‹é–“ã«ãã‚Œã‚‰ã®å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚’é€£ç¶šã—ã¦å†å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã®ãŸã‚ã€ä¿®æ­£ã‚’è¡Œã£ãŸå¾Œã«pytestã‚’å†èµ·å‹•ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒåˆæ ¼ã™ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã•ã‚Œã€ãã®å¾Œå†åº¦ãƒ•ãƒ«ãƒ©ãƒ³ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>pip<span class="w"> </span>install<span class="w"> </span>pytest-xdist
</span></code></pre></div>
<p>ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹ã«ã¯ï¼š <code>pytest -f</code>ã¾ãŸã¯<code>pytest --looponfail</code></p>
<p>ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã¯ã€<code>looponfailroots</code>ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ãã®å†…å®¹å…¨ä½“ï¼ˆå†å¸°çš„ã«ï¼‰ã‚’è¦‹ã¦æ¤œå‡ºã•ã‚Œã¾ã™ã€‚ã“ã®å€¤ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŒæ©Ÿèƒ½ã—ãªã„å ´åˆã€<code>setup.cfg</code>ã§è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å¤‰æ›´ã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã§å¤‰æ›´ã§ãã¾ã™ã€‚</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">[tool:pytest]</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="na">looponfailroots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">transformers tests</span>
</span></code></pre></div>
<p>ã¾ãŸã¯ <code>pytest.ini</code>/<code>tox.ini</code> ãƒ•ã‚¡ã‚¤ãƒ«:</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="k">[pytest]</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="na">looponfailroots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">transformers tests</span>
</span></code></pre></div>
<p>ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¢ã™ã“ã¨ã¯ã€iniãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åŸºæº–ã«ã—ã¦æŒ‡å®šã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§ã®ã¿è¡Œã‚ã‚Œã¾ã™ã€‚</p>
<p><a href="https://github.com/joeyespo/pytest-watch">pytest-watch</a> ã¯ã€ã“ã®æ©Ÿèƒ½ã®ä»£æ›¿å®Ÿè£…ã§ã™ã€‚</p>
<h3 id="skip-a-test-module">Skip a test module</h3>
<p>ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é™¤å¤–ã—ã¦ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®Ÿè¡Œã—ãŸã„å ´åˆã€å®Ÿè¡Œã™ã‚‹ãƒ†ã‚¹ãƒˆã®æ˜ç¤ºçš„ãªãƒªã‚¹ãƒˆã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€<code>test_modeling_*.py</code> ãƒ†ã‚¹ãƒˆã‚’é™¤å¤–ã—ã¦ã™ã¹ã¦ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯æ¬¡ã®ã‚ˆã†ã«ã—ã¾ã™ï¼š</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>pytest<span class="w"> </span>*ls<span class="w"> </span>-1<span class="w"> </span>tests/*py<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span>test_modeling*
</span></code></pre></div>
<h3 id="clearing-state">Clearing state</h3>
<p>CIãƒ“ãƒ«ãƒ‰ãŠã‚ˆã³é€Ÿåº¦ã«å¯¾ã™ã‚‹éš”é›¢ãŒé‡è¦ãªå ´åˆï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«å¯¾ã—ã¦ï¼‰ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>pytest<span class="w"> </span>--cache-clear<span class="w"> </span>tests
</span></code></pre></div>
<h3 id="running-tests-in-parallel">Running tests in parallel</h3>
<p>å‰è¿°ã®ã‚ˆã†ã«ã€<code>make test</code> ã¯ <code>pytest-xdist</code> ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä»‹ã—ã¦ãƒ†ã‚¹ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œã—ã¾ã™ï¼ˆ<code>-n X</code> å¼•æ•°ã€ä¾‹: <code>-n 2</code> ã§2ã¤ã®ä¸¦åˆ—ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œï¼‰ã€‚</p>
<p><code>pytest-xdist</code> ã® <code>--dist=</code> ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒ†ã‚¹ãƒˆãŒã©ã®ã‚ˆã†ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚Œã‚‹ã‹ã‚’åˆ¶å¾¡ã§ãã¾ã™ã€‚<code>--dist=loadfile</code> ã¯åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ã‚‹ãƒ†ã‚¹ãƒˆã‚’åŒã˜ãƒ—ãƒ­ã‚»ã‚¹ã«é…ç½®ã—ã¾ã™ã€‚</p>
<p>ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œé †åºãŒç•°ãªã‚Šäºˆæ¸¬ä¸å¯èƒ½ã§ã‚ã‚‹ãŸã‚ã€<code>pytest-xdist</code> ã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨å¤±æ•—ãŒç™ºç”Ÿã™ã‚‹å ´åˆï¼ˆã¤ã¾ã‚Šã€ã„ãã¤ã‹ã®æœªæ¤œå‡ºã®é€£å‹•ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆï¼‰ã€<a href="https://github.com/ESSS/pytest-replay">pytest-replay</a> ã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚’åŒã˜é †åºã§å†ç”Ÿã—ã€ãã®å¾Œã€å¤±æ•—ã™ã‚‹ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’æœ€å°é™ã«ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚</p>
<h3 id="test-order-and-repetition">Test order and repetition</h3>
<p>æ½œåœ¨çš„ãªç›¸äº’ä¾å­˜æ€§ã‚„çŠ¶æ…‹ã«é–¢é€£ã™ã‚‹ãƒã‚°ï¼ˆãƒ†ã‚£ã‚¢ãƒ€ã‚¦ãƒ³ï¼‰ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã«ã€ãƒ†ã‚¹ãƒˆã‚’è¤‡æ•°å›ã€é€£ç¶šã—ã¦ã€ãƒ©ãƒ³ãƒ€ãƒ ã«ã€ã¾ãŸã¯ã‚»ãƒƒãƒˆã§ç¹°ã‚Šè¿”ã™ã“ã¨ã¯æœ‰ç”¨ã§ã™ã€‚ãã—ã¦ã€å˜ç´”ãªè¤‡æ•°å›ã®ç¹°ã‚Šè¿”ã—ã¯ã€DLã®ãƒ©ãƒ³ãƒ€ãƒ æ€§ã«ã‚ˆã£ã¦æ˜ã‚‰ã‹ã«ãªã‚‹ã„ãã¤ã‹ã®å•é¡Œã‚’æ¤œå‡ºã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚</p>
<h4 id="repeat-tests">Repeat tests</h4>
<ul>
<li><a href="https://github.com/dropbox/pytest-flakefinder">pytest-flakefinder</a>:</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>pip<span class="w"> </span>install<span class="w"> </span>pytest-flakefinder
</span></code></pre></div>
<p>ãã—ã¦ã€ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’è¤‡æ•°å›å®Ÿè¡Œã—ã¾ã™ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ 50 å›)ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>pytest<span class="w"> </span>--flake-finder<span class="w"> </span>--flake-runs<span class="o">=</span><span class="m">5</span><span class="w"> </span>tests/test_failing_test.py
</span></code></pre></div>
<p><Tip></p>
<p>ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã€<code>pytest-xdist</code> ã® <code>-n</code> ãƒ•ãƒ©ã‚°ã§ã¯å‹•ä½œã—ã¾ã›ã‚“ã€‚</p>
<p></Tip></p>
<p><Tip></p>
<p>åˆ¥ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ <code>pytest-repeat</code> ã‚‚ã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã¯ <code>unittest</code> ã§ã¯å‹•ä½œã—ã¾ã›ã‚“ã€‚</p>
<p></Tip></p>
<h4 id="run-tests-in-a-random-order">Run tests in a random order</h4>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>pip<span class="w"> </span>install<span class="w"> </span>pytest-random-order
</span></code></pre></div>
<p>é‡è¦: <code>pytest-random-order</code> ãŒå­˜åœ¨ã™ã‚‹ã¨ã€ãƒ†ã‚¹ãƒˆã¯è‡ªå‹•çš„ã«ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã•ã‚Œã¾ã™ã€‚è¨­å®šã®å¤‰æ›´ã‚„å¤‰æ›´ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚
ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å¿…é ˆã§ã™ã€‚</p>
<p>å‰ã«èª¬æ˜ã—ãŸã‚ˆã†ã«ã€ã“ã‚Œã«ã‚ˆã‚Šã€çµåˆã•ã‚ŒãŸãƒ†ã‚¹ãƒˆ (1 ã¤ã®ãƒ†ã‚¹ãƒˆã®çŠ¶æ…‹ãŒåˆ¥ã®ãƒ†ã‚¹ãƒˆã®çŠ¶æ…‹ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹) ã®æ¤œå‡ºãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ã„ã¤
<code>pytest-random-order</code> ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã¨ã€ãã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä½¿ç”¨ã•ã‚ŒãŸãƒ©ãƒ³ãƒ€ãƒ  ã‚·ãƒ¼ãƒ‰ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚ä¾‹:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>pytest<span class="w"> </span>tests
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="o">[</span>...<span class="o">]</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>Using<span class="w"> </span>--random-order-bucket<span class="o">=</span>module
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>Using<span class="w"> </span>--random-order-seed<span class="o">=</span><span class="m">573663</span>
</span></code></pre></div>
<p>ãã®ãŸã‚ã€æŒ‡å®šã•ã‚ŒãŸç‰¹å®šã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãŒå¤±æ•—ã—ãŸå ´åˆã€ãã®æ­£ç¢ºãªã‚·ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ãã‚Œã‚’å†ç¾ã§ãã¾ã™ã€‚ä¾‹:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>pytest<span class="w"> </span>--random-order-seed<span class="o">=</span><span class="m">573663</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="o">[</span>...<span class="o">]</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>Using<span class="w"> </span>--random-order-bucket<span class="o">=</span>module
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>Using<span class="w"> </span>--random-order-seed<span class="o">=</span><span class="m">573663</span>
</span></code></pre></div>
<p>ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã®ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ã—ãªã„å ´åˆã€ã¾ãŸã¯ã¾ã£ãŸããƒªã‚¹ãƒˆã‚’ä½¿ç”¨ã—ãªã„å ´åˆã€åŒã˜ãƒ†ã‚¹ãƒˆã®æ­£ç¢ºãªé †åºã‚’å†ç¾ã—ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆã®ãƒªã‚¹ãƒˆã‚’æ‰‹å‹•ã§çµã‚Šè¾¼ã¿å§‹ã‚ã‚‹ã¨ã€ã‚·ãƒ¼ãƒ‰ã«ä¾å­˜ã›ãšã€ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸæ­£ç¢ºãªé †åºã§æ‰‹å‹•ã§ãƒªã‚¹ãƒˆã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã¯ã€<code>--random-order-bucket=none</code> ã‚’ä½¿ç”¨ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã‚’ç„¡åŠ¹ã«ã™ã‚‹ã‚ˆã†pytestã«æŒ‡ç¤ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€æ¬¡ã®ã‚ˆã†ã«ã—ã¾ã™ï¼š</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>pytest<span class="w"> </span>--random-order-bucket<span class="o">=</span>none<span class="w"> </span>tests/test_a.py<span class="w"> </span>tests/test_c.py<span class="w"> </span>tests/test_b.py
</span></code></pre></div>
<p>ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã®ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚’ç„¡åŠ¹ã«ã™ã‚‹ã«ã¯:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>pytest<span class="w"> </span>--random-order-bucket<span class="o">=</span>none
</span></code></pre></div>
<p>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€<code>--random-order-bucket=module</code> ãŒæš—é»™çš„ã«é©ç”¨ã•ã‚Œã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã™ã€‚ã¾ãŸã€<code>class</code>ã€<code>package</code>ã€<code>global</code>ã€ãŠã‚ˆã³<code>none</code> ãƒ¬ãƒ™ãƒ«ã§ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€ãã®<a href="https://github.com/jbasko/pytest-random-order">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</a>ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
<p>åˆ¥ã®ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã®ä»£æ›¿æ‰‹æ®µã¯ã€<a href="https://github.com/pytest-dev/pytest-randomly"><code>pytest-randomly</code></a> ã§ã™ã€‚ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯éå¸¸ã«ä¼¼ãŸæ©Ÿèƒ½/ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æŒã£ã¦ã„ã¾ã™ãŒã€<code>pytest-random-order</code> ã§åˆ©ç”¨å¯èƒ½ãªãƒã‚±ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã«è‡ªå‹•çš„ã«æœ‰åŠ¹ã«ãªã‚‹ã¨ã„ã†åŒã˜å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚</p>
<h3 id="look-and-feel-variations">Look and feel variations</h3>
<h4 id="pytest-sugar">pytest-sugar</h4>
<p><a href="https://github.com/Frozenball/pytest-sugar">pytest-sugar</a> ã¯ã€å¤–è¦³ã¨æ“ä½œæ€§ã‚’å‘ä¸Šã•ã›ã€ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’è¿½åŠ ã—ã€å³åº§ã«å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã¨ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã™ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã«è‡ªå‹•çš„ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã•ã‚Œã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>pip<span class="w"> </span>install<span class="w"> </span>pytest-sugar
</span></code></pre></div>
<p>ã“ã‚Œã‚’ä½¿ç”¨ã›ãšã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€æ¬¡ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>pytest<span class="w"> </span>-p<span class="w"> </span>no:sugar
</span></code></pre></div>
<p>ã¾ãŸã¯ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚</p>
<h4 id="report-each-sub-test-name-and-its-progress">Report each sub-test name and its progress</h4>
<p><code>pytest</code> ã«ã‚ˆã‚‹å˜ä¸€ã¾ãŸã¯ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ†ã‚¹ãƒˆã®å ´åˆ (<code>pip install pytest-pspec</code> ã®å¾Œ):</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>pytest<span class="w"> </span>--pspec<span class="w"> </span>tests/test_optimization.py
</span></code></pre></div>
<h4 id="instantly-shows-failed-tests">Instantly shows failed tests</h4>
<p><a href="https://github.com/pytest-dev/pytest-instafail">pytest-instafail</a> ã§ã¯ã€å¤±æ•—ã¨ã‚¨ãƒ©ãƒ¼ãŒå³åº§ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
ãƒ†ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã™ã‚‹ã¾ã§å¾…æ©Ÿã—ã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>pip<span class="w"> </span>install<span class="w"> </span>pytest-instafail
</span></code></pre></div>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>pytest<span class="w"> </span>--instafail
</span></code></pre></div>
<h3 id="to-gpu-or-not-to-gpu">To GPU or not to GPU</h3>
<p>GPU ãŒæœ‰åŠ¹ãªè¨­å®šã§ã€CPU ã®ã¿ãƒ¢ãƒ¼ãƒ‰ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ã€<code>CUDA_VISIBLE_DEVICES=""</code>ã‚’è¿½åŠ ã—ã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="w"> </span>pytest<span class="w"> </span>tests/utils/test_logging.py
</span></code></pre></div>
<p>ã¾ãŸã¯ã€è¤‡æ•°ã® GPU ãŒã‚ã‚‹å ´åˆã¯ã€<code>pytest</code> ã§ã©ã‚Œã‚’ä½¿ç”¨ã™ã‚‹ã‹ã‚’æŒ‡å®šã§ãã¾ã™ã€‚ãŸã¨ãˆã°ã€
2 ç•ªç›®ã® GPU GPU <code>0</code> ã¨ <code>1</code> ãŒã‚ã‚‹å ´åˆã¯ã€æ¬¡ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="w"> </span>pytest<span class="w"> </span>tests/utils/test_logging.py
</span></code></pre></div>
<p>ã“ã‚Œã¯ã€ç•°ãªã‚‹GPUã§ç•°ãªã‚‹ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ãŸã„å ´åˆã«ä¾¿åˆ©ã§ã™ã€‚</p>
<p>ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆã¯CPUã®ã¿ã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ä»–ã®ãƒ†ã‚¹ãƒˆã¯CPUã€GPUã€ã¾ãŸã¯TPUã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã¾ãŸåˆ¥ã®ãƒ†ã‚¹ãƒˆã¯è¤‡æ•°ã®GPUã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æ¬¡ã®ã‚¹ã‚­ãƒƒãƒ—ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã¯ã€ãƒ†ã‚¹ãƒˆã®CPU/GPU/TPUã«é–¢ã™ã‚‹è¦ä»¶ã‚’è¨­å®šã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ï¼š</p>
<ul>
<li><code>require_torch</code> - ã“ã®ãƒ†ã‚¹ãƒˆã¯torchã®ä¸‹ã§ã®ã¿å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚</li>
<li><code>require_torch_gpu</code> - <code>require_torch</code> ã«åŠ ãˆã¦ã€å°‘ãªãã¨ã‚‚1ã¤ã®GPUãŒå¿…è¦ã§ã™ã€‚</li>
<li><code>require_torch_multi_gpu</code> - <code>require_torch</code> ã«åŠ ãˆã¦ã€å°‘ãªãã¨ã‚‚2ã¤ã®GPUãŒå¿…è¦ã§ã™ã€‚</li>
<li><code>require_torch_non_multi_gpu</code> - <code>require_torch</code> ã«åŠ ãˆã¦ã€0ã¾ãŸã¯1ã¤ã®GPUãŒå¿…è¦ã§ã™ã€‚</li>
<li><code>require_torch_up_to_2_gpus</code> - <code>require_torch</code> ã«åŠ ãˆã¦ã€0ã€1ã€ã¾ãŸã¯2ã¤ã®GPUãŒå¿…è¦ã§ã™ã€‚</li>
<li><code>require_torch_xla</code> - <code>require_torch</code> ã«åŠ ãˆã¦ã€å°‘ãªãã¨ã‚‚1ã¤ã®TPUãŒå¿…è¦ã§ã™ã€‚</li>
</ul>
<p>ä»¥ä¸‹ã®è¡¨ã«GPUã®è¦ä»¶ã‚’ç¤ºã—ã¾ã™ï¼š</p>
<p>| n gpus | decorator                      |
|--------+--------------------------------|
| <code>&gt;= 0</code> | <code>@require_torch</code>               |
| <code>&gt;= 1</code> | <code>@require_torch_gpu</code>           |
| <code>&gt;= 2</code> | <code>@require_torch_multi_gpu</code>     |
| <code>&lt; 2</code>  | <code>@require_torch_non_multi_gpu</code> |
| <code>&lt; 3</code>  | <code>@require_torch_up_to_2_gpus</code>  |</p>
<p>ãŸã¨ãˆã°ã€ä½¿ç”¨å¯èƒ½ãª GPU ãŒ 2 ã¤ä»¥ä¸Šã‚ã‚Šã€pytorch ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã®ã¿å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ¬¡ã«ç¤ºã—ã¾ã™ã€‚</p>
<p>```python no-style
@require_torch_multi_gpu
def test_example_with_multi_gpu():
<div class="language-bash highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>ã“ã‚Œã‚‰ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã¯ç©ã¿é‡ã­ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãŸã¨ãˆã°ã€ãƒ†ã‚¹ãƒˆãŒé…ãã€pytorch<span class="w"> </span>ã§å°‘ãªãã¨ã‚‚<span class="w"> </span><span class="m">1</span><span class="w"> </span>ã¤ã®<span class="w"> </span>GPU<span class="w"> </span>ãŒå¿…è¦ãªå ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>è¨­å®šæ–¹æ³•:
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="sb">```</span>python<span class="w"> </span>no-style
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>@require_torch_gpu
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>@slow
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a>def<span class="w"> </span>test_example_slow_on_gpu<span class="o">()</span>:
</span></code></pre></div></p>
<p><code>@parametrized</code> ã®ã‚ˆã†ãªä¸€éƒ¨ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã¯ãƒ†ã‚¹ãƒˆåã‚’æ›¸ãæ›ãˆã‚‹ãŸã‚ã€<code>@require_*</code> ã‚¹ã‚­ãƒƒãƒ— ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ãƒªã‚¹ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
æœ€å¾Œã«ãã‚Œã‚‰ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚æ­£ã—ã„ä½¿ç”¨ä¾‹ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™</p>
<p>```python no-style
@parameterized.expand(...)
@require_torch_multi_gpu
def test_integration_foo():
<div class="language-bash highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>ã“ã®é †åºã®å•é¡Œã¯<span class="w"> </span><span class="sb">`</span>@pytest.mark.parametrize<span class="sb">`</span><span class="w"> </span>ã«ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚æœ€åˆã¾ãŸã¯æœ€å¾Œã«é…ç½®ã—ã¦ã‚‚ã€ãã‚Œã§ã‚‚å•é¡Œã¯è§£æ±ºã•ã‚Œã¾ã™ã€‚
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>ä»•äº‹ã€‚ãŸã ã—ã€ãã‚Œã¯éå˜ä½“ãƒ†ã‚¹ãƒˆã§ã®ã¿æ©Ÿèƒ½ã—ã¾ã™ã€‚
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>å†…éƒ¨ãƒ†ã‚¹ãƒˆ:
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>-<span class="w"> </span>åˆ©ç”¨å¯èƒ½ãª<span class="w"> </span>GPU<span class="w"> </span>ã®æ•°:
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a>
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="sb">```</span>python
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a>from<span class="w"> </span>transformers.testing_utils<span class="w"> </span>import<span class="w"> </span>get_gpu_count
</span><span id="__span-40-10"><a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a>
</span><span id="__span-40-11"><a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a><span class="nv">n_gpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>get_gpu_count<span class="o">()</span><span class="w">  </span><span class="c1"># works with torch and tf</span>
</span></code></pre></div></p>
<h3 id="testing-with-a-specific-pytorch-backend-or-device">Testing with a specific PyTorch backend or device</h3>
<p>ç‰¹å®šã®torchãƒ‡ãƒã‚¤ã‚¹ã§ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€<code>TRANSFORMERS_TEST_DEVICE="$device"</code> ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã“ã“ã§ <code>$device</code> ã¯å¯¾è±¡ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã™ã€‚ä¾‹ãˆã°ã€CPUã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ï¼š</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="nv">TRANSFORMERS_TEST_DEVICE</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="w"> </span>pytest<span class="w"> </span>tests/utils/test_logging.py
</span></code></pre></div>
<p>ã“ã®å¤‰æ•°ã¯ã€<code>mps</code>ãªã©ã®ã‚«ã‚¹ã‚¿ãƒ ã¾ãŸã¯ã‚ã¾ã‚Šä¸€èˆ¬çš„ã§ã¯ãªã„ PyTorch ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚ã¾ãŸã€ç‰¹å®šã® GPU ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã—ãŸã‚Šã€CPU å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã§ãƒ†ã‚¹ãƒˆã—ãŸã‚Šã™ã‚‹ã“ã¨ã§ã€<code>CUDA_VISIBLE_DEVICES</code>ã¨åŒã˜åŠ¹æœã‚’é”æˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
<p>ç‰¹å®šã®ãƒ‡ãƒã‚¤ã‚¹ã§ã¯ã€åˆã‚ã¦ã€Œtorchã€ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸå¾Œã€è¿½åŠ ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€ç’°å¢ƒå¤‰æ•° <code>TRANSFORMERS_TEST_BACKEND</code> ã‚’ä½¿ç”¨ã—ã¦æŒ‡å®šã§ãã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="nv">TRANSFORMERS_TEST_BACKEND</span><span class="o">=</span><span class="s2">&quot;torch_npu&quot;</span><span class="w"> </span>pytest<span class="w"> </span>tests/utils/test_logging.py
</span></code></pre></div>
<h3 id="distributed-training">Distributed training</h3>
<p><code>pytest</code> ã¯ç›´æ¥çš„ã«åˆ†æ•£ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å‡¦ç†ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚è©¦ã¿ã‚‹ã¨ã€ã‚µãƒ–ãƒ—ãƒ­ã‚»ã‚¹ã¯æ­£ã—ã„å‡¦ç†ã‚’è¡Œã‚ãšã€è‡ªåˆ†è‡ªèº«ãŒ <code>pytest</code> ã§ã‚ã‚‹ã¨æ€ã„è¾¼ã‚“ã§ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã‚’ãƒ«ãƒ¼ãƒ—ã§å®Ÿè¡Œã—ç¶šã‘ã¾ã™ã€‚ãŸã ã—ã€é€šå¸¸ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç”Ÿæˆã—ã€ãã‚Œã‹ã‚‰è¤‡æ•°ã®ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’ç”Ÿæˆã—ã€IOãƒ‘ã‚¤ãƒ—ã‚’ç®¡ç†ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç”Ÿæˆã™ã‚Œã°æ©Ÿèƒ½ã—ã¾ã™ã€‚</p>
<p>ã“ã‚Œã‚’ä½¿ç”¨ã™ã‚‹ã„ãã¤ã‹ã®ãƒ†ã‚¹ãƒˆãŒã‚ã‚Šã¾ã™ï¼š</p>
<ul>
<li><a href="https://github.com/huggingface/transformers/tree/main/tests/trainer/test_trainer_distributed.py">test_trainer_distributed.py</a></li>
<li><a href="https://github.com/huggingface/transformers/tree/main/tests/deepspeed/test_deepspeed.py">test_deepspeed.py</a></li>
</ul>
<p>å®Ÿè¡Œãƒã‚¤ãƒ³ãƒˆã«ã™ãã«ç§»å‹•ã™ã‚‹ã«ã¯ã€ã“ã‚Œã‚‰ã®ãƒ†ã‚¹ãƒˆå†…ã§ <code>execute_subprocess_async</code> å‘¼ã³å‡ºã—ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚</p>
<p>ã“ã‚Œã‚‰ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€å°‘ãªãã¨ã‚‚2ã¤ã®GPUãŒå¿…è¦ã§ã™ï¼š</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span>,1<span class="w"> </span><span class="nv">RUN_SLOW</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>pytest<span class="w"> </span>-sv<span class="w"> </span>tests/test_trainer_distributed.py
</span></code></pre></div>
<h3 id="output-capture">Output capture</h3>
<p>ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œä¸­ã«ã€<code>stdout</code> ãŠã‚ˆã³ <code>stderr</code> ã«é€ä¿¡ã•ã‚ŒãŸå‡ºåŠ›ã¯ã‚­ãƒ£ãƒ—ãƒãƒ£ã•ã‚Œã¾ã™ã€‚ãƒ†ã‚¹ãƒˆã¾ãŸã¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ¡ã‚½ãƒƒãƒ‰ãŒå¤±æ•—ã—ãŸå ´åˆã€é€šå¸¸ã€ãã‚Œã«å¯¾å¿œã™ã‚‹ã‚­ãƒ£ãƒ—ãƒãƒ£ã•ã‚ŒãŸå‡ºåŠ›ãŒå¤±æ•—ã®ãƒˆãƒ¬ãƒ¼ã‚¹ãƒãƒƒã‚¯ã¨å…±ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
<p>å‡ºåŠ›ã®ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’ç„¡åŠ¹ã«ã—ã€<code>stdout</code> ã¨ <code>stderr</code> ã‚’é€šå¸¸é€šã‚Šã«å–å¾—ã™ã‚‹ã«ã¯ã€<code>-s</code> ã¾ãŸã¯ <code>--capture=no</code> ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š</p>
<p>ã“ã‚Œã‚‰ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯å°‘ãªãã¨ã‚‚2ã¤ã®GPUãŒå¿…è¦ã§ã™ï¼š</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>pytest<span class="w"> </span>-s<span class="w"> </span>tests/utils/test_logging.py
</span></code></pre></div>
<p>ãƒ†ã‚¹ãƒˆçµæœã‚’ JUnit å½¢å¼ã®å‡ºåŠ›ã«é€ä¿¡ã™ã‚‹ã«ã¯:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>py.test<span class="w"> </span>tests<span class="w"> </span>--junitxml<span class="o">=</span>result.xml
</span></code></pre></div>
<h3 id="color-control">Color control</h3>
<p>è‰²ã‚’æŒãŸãªã„ã‚ˆã†ã«ã™ã‚‹ï¼ˆä¾‹ï¼šé»„è‰²ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ç™½ã„èƒŒæ™¯ã«è¡¨ç¤ºã™ã‚‹ã¨èª­ã¿ã«ãã„ã§ã™ï¼‰ï¼š</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>pytest<span class="w"> </span>--color<span class="o">=</span>no<span class="w"> </span>tests/utils/test_logging.py
</span></code></pre></div>
<h3 id="sending-test-report-to-online-pastebin-service">Sending test report to online pastebin service</h3>
<p>ãƒ†ã‚¹ãƒˆå¤±æ•—ã”ã¨ã« URL ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>pytest<span class="w"> </span>--pastebin<span class="o">=</span>failed<span class="w"> </span>tests/utils/test_logging.py
</span></code></pre></div>
<p>ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæƒ…å ±ãŒãƒªãƒ¢ãƒ¼ãƒˆã®Pasteã‚µãƒ¼ãƒ“ã‚¹ã«é€ä¿¡ã•ã‚Œã€å„ã‚¨ãƒ©ãƒ¼ã«å¯¾ã—ã¦URLãŒæä¾›ã•ã‚Œã¾ã™ã€‚é€šå¸¸é€šã‚Šãƒ†ã‚¹ãƒˆã‚’é¸æŠã™ã‚‹ã‹ã€ãŸã¨ãˆã°ç‰¹å®šã®ã‚¨ãƒ©ãƒ¼ã®ã¿ã‚’é€ä¿¡ã—ãŸã„å ´åˆã¯ <code>-x</code> ã‚’è¿½åŠ ã§æŒ‡å®šã§ãã¾ã™ã€‚</p>
<p>ãƒ†ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³å…¨ä½“ã®ãƒ­ã‚°ã«å¯¾ã™ã‚‹URLã‚’ä½œæˆã™ã‚‹æ–¹æ³•ï¼š</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>pytest<span class="w"> </span>--pastebin<span class="o">=</span>all<span class="w"> </span>tests/utils/test_logging.py
</span></code></pre></div>
<h2 id="writing-tests">Writing tests</h2>
<p>ğŸ¤— transformersã®ãƒ†ã‚¹ãƒˆã¯ <code>unittest</code> ã‚’åŸºã«ã—ã¦ã„ã¾ã™ãŒã€ <code>pytest</code> ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã»ã¨ã‚“ã©ã®å ´åˆã€ä¸¡æ–¹ã®ã‚·ã‚¹ãƒ†ãƒ ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚</p>
<p><a href="https://docs.pytest.org/en/stable/unittest.html">ã“ã¡ã‚‰</a>ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹æ©Ÿèƒ½ã‚’èª­ã‚€ã“ã¨ãŒã§ãã¾ã™ãŒã€é‡è¦ãªã“ã¨ã¯ã€ã»ã¨ã‚“ã©ã® <code>pytest</code> ã®ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ãŒå‹•ä½œã—ãªã„ã“ã¨ã§ã™ã€‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚‚åŒæ§˜ã§ã™ãŒã€ä¼¼ãŸã‚ˆã†ãªæ–¹æ³•ã§å‹•ä½œã™ã‚‹ <code>parameterized</code> ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚</p>
<h3 id="parametrization">Parametrization</h3>
<p>åŒã˜ãƒ†ã‚¹ãƒˆã‚’ç•°ãªã‚‹å¼•æ•°ã§è¤‡æ•°å›å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ãŒã‚ˆãã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆå†…éƒ¨ã‹ã‚‰è¡Œã†ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ãã®å ´åˆã€ãã®ãƒ†ã‚¹ãƒˆã‚’å˜ä¸€ã®å¼•æ•°ã‚»ãƒƒãƒˆã§å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="c1"># test_this1.py</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">unittest</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">parameterized</span><span class="w"> </span><span class="kn">import</span> <span class="n">parameterized</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestMathUnitTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>    <span class="nd">@parameterized</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a>        <span class="p">[</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a>            <span class="p">(</span><span class="s2">&quot;negative&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">),</span>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a>            <span class="p">(</span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a>            <span class="p">(</span><span class="s2">&quot;large fraction&quot;</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a>        <span class="p">]</span>
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a>    <span class="p">)</span>
</span><span id="__span-49-14"><a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_floor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
</span><span id="__span-49-15"><a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a>        <span class="n">assert_equal</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span> <span class="n">expected</span><span class="p">)</span>
</span></code></pre></div>
<p>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ã“ã®ãƒ†ã‚¹ãƒˆã¯3å›å®Ÿè¡Œã•ã‚Œã€ãã‚Œãã‚Œã®å®Ÿè¡Œã§ <code>test_floor</code> ã®æœ€å¾Œã®3ã¤ã®å¼•æ•°ãŒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆã®å¯¾å¿œã™ã‚‹å¼•æ•°ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚</p>
<p>ãã—ã¦ã€<code>negative</code> ã¨ <code>integer</code> ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã‚»ãƒƒãƒˆã®ã¿ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>pytest<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;negative and integer&quot;</span><span class="w"> </span>tests/test_mytest.py
</span></code></pre></div>
<p>ã¾ãŸã¯ã€<code>Negative</code>ã®ã‚µãƒ–ãƒ†ã‚¹ãƒˆã‚’é™¤ãã™ã¹ã¦ã®å ´åˆã€æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>pytest<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;not negative&quot;</span><span class="w"> </span>tests/test_mytest.py
</span></code></pre></div>
<p><code>-k</code> ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«åŠ ãˆã¦ã€å„ã‚µãƒ–ãƒ†ã‚¹ãƒˆã®æ­£ç¢ºãªåå‰ã‚’èª¿ã¹ã€ãã®æ­£ç¢ºãªåå‰ã‚’ä½¿ç”¨ã—ã¦ä»»æ„ã®ã‚µãƒ–ãƒ†ã‚¹ãƒˆã¾ãŸã¯ã™ã¹ã¦ã®ã‚µãƒ–ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>pytest<span class="w"> </span>test_this1.py<span class="w"> </span>--collect-only<span class="w"> </span>-q
</span></code></pre></div>
<p>ã™ã‚‹ã¨æ¬¡ã®ã‚‚ã®ãŒãƒªã‚¹ãƒˆã•ã‚Œã¾ã™:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>test_this1.py::TestMathUnitTest::test_floor_0_negative
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>test_this1.py::TestMathUnitTest::test_floor_1_integer
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>test_this1.py::TestMathUnitTest::test_floor_2_large_fraction
</span></code></pre></div>
<p>ã—ãŸãŒã£ã¦ã€2 ã¤ã®ç‰¹å®šã®ã‚µãƒ–ãƒ†ã‚¹ãƒˆã®ã¿ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a>pytest<span class="w"> </span>test_this1.py::TestMathUnitTest::test_floor_0_negative<span class="w">  </span>test_this1.py::TestMathUnitTest::test_floor_1_integer
</span></code></pre></div>
<p><code>transformers</code>ã®é–‹ç™ºè€…ä¾å­˜é–¢ä¿‚ã«ã™ã§ã«å«ã¾ã‚Œã¦ã„ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«<a href="https://pypi.org/project/parameterized/">parameterized</a> ã¯ã€<code>unittests</code> ã¨ <code>pytest</code> ãƒ†ã‚¹ãƒˆã®ä¸¡æ–¹ã§æ©Ÿèƒ½ã—ã¾ã™ã€‚</p>
<p>ãŸã ã—ã€ãƒ†ã‚¹ãƒˆãŒ <code>unittest</code> ã§ãªã„å ´åˆã€<code>pytest.mark.parametrize</code> ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆã¾ãŸã¯æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆã®ã„ãã¤ã‹ã§ã€ä¸»ã« <code>examples</code> ã®ä¸‹ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã®ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼‰ã€‚</p>
<p>æ¬¡ã«ã€åŒã˜ä¾‹ã‚’ç¤ºã—ã¾ã™ãŒã€ä»Šåº¦ã¯ <code>pytest</code> ã® <code>parametrize</code> ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ï¼š</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="c1"># test_this2.py</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a>    <span class="s2">&quot;name, input, expected&quot;</span><span class="p">,</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a>    <span class="p">[</span>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a>        <span class="p">(</span><span class="s2">&quot;negative&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">),</span>
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a>        <span class="p">(</span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a>        <span class="p">(</span><span class="s2">&quot;large fraction&quot;</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="__span-55-11"><a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a>    <span class="p">],</span>
</span><span id="__span-55-12"><a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a><span class="p">)</span>
</span><span id="__span-55-13"><a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_floor</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
</span><span id="__span-55-14"><a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a>    <span class="n">assert_equal</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span> <span class="n">expected</span><span class="p">)</span>
</span></code></pre></div>
<p><code>parameterized</code> ã¨åŒæ§˜ã«ã€<code>pytest.mark.parametrize</code> ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€<code>-k</code> ãƒ•ã‚£ãƒ«ã‚¿ãŒå½¹ç«‹ãŸãªã„å ´åˆã§ã‚‚ã€ã‚µãƒ–ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã‚’ç´°ã‹ãåˆ¶å¾¡ã§ãã¾ã™ã€‚ãŸã ã—ã€ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–é–¢æ•°ã¯ã‚µãƒ–ãƒ†ã‚¹ãƒˆã®åå‰ã‚’ã‚ãšã‹ã«ç•°ãªã‚‹ã‚‚ã®ã«ã—ã¾ã™ã€‚ä»¥ä¸‹ã«ãã®ä¾‹ã‚’ç¤ºã—ã¾ã™ï¼š</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a>pytest<span class="w"> </span>test_this2.py<span class="w"> </span>--collect-only<span class="w"> </span>-q
</span></code></pre></div>
<p>ã™ã‚‹ã¨æ¬¡ã®ã‚‚ã®ãŒãƒªã‚¹ãƒˆã•ã‚Œã¾ã™:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a>test_this2.py::test_floor<span class="o">[</span>integer-1-1.0<span class="o">]</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>test_this2.py::test_floor<span class="o">[</span>negative--1.5--2.0<span class="o">]</span>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>test_this2.py::test_floor<span class="o">[</span>large<span class="w"> </span>fraction-1.6-1<span class="o">]</span>
</span></code></pre></div>
<p>ã“ã‚Œã§ã€ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã®ã¿ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a>pytest<span class="w"> </span>test_this2.py::test_floor<span class="o">[</span>negative--1.5--2.0<span class="o">]</span><span class="w"> </span>test_this2.py::test_floor<span class="o">[</span>integer-1-1.0<span class="o">]</span>
</span></code></pre></div>
<p>å‰ã®ä¾‹ã¨åŒæ§˜ã«ã€‚</p>
<h3 id="files-and-directories">Files and directories</h3>
<p>ãƒ†ã‚¹ãƒˆã®ä¸­ã§ã€ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®ç›¸å¯¾ä½ç½®ã‚’çŸ¥ã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ãŒã‚ˆãã‚ã‚Šã¾ã™ã€‚ã—ã‹ã—ã€ã“ã‚Œã¯ç°¡å˜ãªã“ã¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãªãœãªã‚‰ã€ãƒ†ã‚¹ãƒˆã¯è¤‡æ•°ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ã‹ã€ç•°ãªã‚‹æ·±ã•ã®ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å­˜åœ¨ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã‹ã‚‰ã§ã™ã€‚<code>transformers.test_utils.TestCasePlus</code> ã¨ã„ã†ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¹ã¯ã€ã™ã¹ã¦ã®åŸºæœ¬ãƒ‘ã‚¹ã‚’æ•´ç†ã—ã€ç°¡å˜ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€ã“ã®å•é¡Œã‚’è§£æ±ºã—ã¾ã™ã€‚</p>
<ul>
<li>
<p><code>pathlib</code> ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆã™ã¹ã¦å®Œå…¨ã«è§£æ±ºã•ã‚ŒãŸã‚‚ã®ï¼‰ï¼š</p>
</li>
<li>
<p><code>test_file_path</code> - ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã€ã¤ã¾ã‚Š <code>__file__</code></p>
</li>
<li><code>test_file_dir</code> - ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª</li>
<li><code>tests_dir</code> - <code>tests</code> ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª</li>
<li><code>examples_dir</code> - <code>examples</code> ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª</li>
<li><code>repo_root_dir</code> - ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª</li>
<li>
<p><code>src_dir</code> - <code>transformers</code> ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹å ´æ‰€</p>
</li>
<li>
<p>ãƒ‘ã‚¹ã®æ–‡å­—åˆ—è¡¨ç¾â€•â€•ä¸Šè¨˜ã¨åŒã˜ã§ã™ãŒã€ã“ã‚Œã‚‰ã¯ <code>pathlib</code> ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãªãæ–‡å­—åˆ—ã¨ã—ã¦ãƒ‘ã‚¹ã‚’è¿”ã—ã¾ã™ï¼š</p>
</li>
<li>
<p><code>test_file_path_str</code></p>
</li>
<li><code>test_file_dir_str</code></li>
<li><code>tests_dir_str</code></li>
<li><code>examples_dir_str</code></li>
<li><code>repo_root_dir_str</code></li>
<li><code>src_dir_str</code></li>
</ul>
<p>ã“ã‚Œã‚‰ã‚’ä½¿ç”¨ã—å§‹ã‚ã‚‹ã«ã¯ã€ãƒ†ã‚¹ãƒˆãŒ <code>transformers.test_utils.TestCasePlus</code> ã®ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã«å­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã ã‘ã§ã™ã€‚ä¾‹ï¼š</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestCasePlus</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">PathExampleTest</span><span class="p">(</span><span class="n">TestCasePlus</span><span class="p">):</span>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_something_involving_local_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a>        <span class="n">data_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests_dir</span> <span class="o">/</span> <span class="s2">&quot;fixtures/tests_samples/wmt_en_ro&quot;</span>
</span></code></pre></div>
<p>ã‚‚ã—ã€<code>pathlib</code> ã‚’ä»‹ã—ã¦ãƒ‘ã‚¹ã‚’æ“ä½œã™ã‚‹å¿…è¦ãŒãªã„å ´åˆã€ã¾ãŸã¯å˜ã«æ–‡å­—åˆ—ã¨ã—ã¦ãƒ‘ã‚¹ãŒå¿…è¦ãªå ´åˆã¯ã€<code>pathlib</code> ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã« <code>str()</code> ã‚’å‘¼ã³å‡ºã™ã‹ã€<code>_str</code> ã§çµ‚ã‚ã‚‹ã‚¢ã‚¯ã‚»ã‚µã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚ä¾‹ï¼š</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestCasePlus</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">PathExampleTest</span><span class="p">(</span><span class="n">TestCasePlus</span><span class="p">):</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_something_involving_stringified_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>        <span class="n">examples_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">examples_dir_str</span>
</span></code></pre></div>
<h3 id="temporary-files-and-directories">Temporary files and directories</h3>
<p>ä¸€æ„ã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½¿ç”¨ã¯ã€ä¸¦åˆ—ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã«ã¯æ¬ ã‹ã›ã¾ã›ã‚“ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ†ã‚¹ãƒˆãŒãŠäº’ã„ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚ã¾ãŸã€ã“ã‚Œã‚‰ã‚’ä½œæˆã—ãŸå„ãƒ†ã‚¹ãƒˆã®çµ‚äº†æ™‚ã«ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå‰Šé™¤ã•ã‚Œã‚‹ã“ã¨ã‚’æœ›ã¿ã¾ã™ã€‚ãã®ãŸã‚ã€ã“ã‚Œã‚‰ã®ãƒ‹ãƒ¼ã‚ºã‚’æº€ãŸã™ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã‚ã‚‹ <code>tempfile</code> ã®ã‚ˆã†ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä½¿ç”¨ã¯é‡è¦ã§ã™ã€‚</p>
<p>ã—ã‹ã—ã€ãƒ†ã‚¹ãƒˆã®ãƒ‡ãƒãƒƒã‚°æ™‚ã«ã¯ã€ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä½•ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã€ãƒ†ã‚¹ãƒˆã‚’å†å®Ÿè¡Œã™ã‚‹ãŸã³ã«ãƒ©ãƒ³ãƒ€ãƒ ã«å¤‰æ›´ã•ã‚Œãªã„ãã®æ­£ç¢ºãªãƒ‘ã‚¹ã‚’çŸ¥ã‚ŠãŸã„ã¨æ€ã„ã¾ã™ã€‚</p>
<p><code>transformers.test_utils.TestCasePlus</code> ã¨ã„ã†ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¹ã¯ã€ã“ã®ã‚ˆã†ãªç›®çš„ã«æœ€é©ã§ã™ã€‚ã“ã‚Œã¯ <code>unittest.TestCase</code> ã®ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã§ã‚ã‚‹ãŸã‚ã€ãƒ†ã‚¹ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ç°¡å˜ã«ç¶™æ‰¿ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
<p>ä»¥ä¸‹ã¯ãã®ä½¿ç”¨ä¾‹ã§ã™ï¼š</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestCasePlus</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">ExamplesTests</span><span class="p">(</span><span class="n">TestCasePlus</span><span class="p">):</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_whatever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>        <span class="n">tmp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_remove_tmp_dir</span><span class="p">()</span>
</span></code></pre></div>
<p>ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€<code>tmp_dir</code> ã‚’ãã®å ´æ‰€ã«è¨­å®šã—ã¾ã™ã€‚</p>
<ul>
<li>ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ï¼š</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_whatever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>    <span class="n">tmp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_remove_tmp_dir</span><span class="p">()</span>
</span></code></pre></div>
<p><code>tmp_dir</code> ã«ã¯ã€ä½œæˆã•ã‚ŒãŸä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ãƒ‘ã‚¹ãŒå«ã¾ã‚Œã¾ã™ã€‚æœŸé–“çµ‚äº†å¾Œã¯è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã™
ãƒ†ã‚¹ãƒˆã€‚</p>
<ul>
<li>ä»»æ„ã®ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ãƒ†ã‚¹ãƒˆã®é–‹å§‹å‰ã«ãã‚ŒãŒç©ºã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã€ãƒ†ã‚¹ãƒˆå¾Œã«ã¯ç©ºã«ã—ãªã„ã§ãã ã•ã„ã€‚</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_whatever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>    <span class="n">tmp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_remove_tmp_dir</span><span class="p">(</span><span class="s2">&quot;./xxx&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>ã“ã‚Œã¯ã€ç‰¹å®šã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç›£è¦–ã—ã€å‰ã®ãƒ†ã‚¹ãƒˆãŒãã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ®‹ã•ãªã„ã“ã¨ã‚’ç¢ºèªã—ãŸã„å ´åˆã«ã€ãƒ‡ãƒãƒƒã‚°ã«å½¹ç«‹ã¡ã¾ã™ã€‚</p>
<ul>
<li>
<p><code>before</code> ã¨ <code>after</code> å¼•æ•°ã‚’ç›´æ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã§ãã¾ã™ã€‚ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®å‹•ä½œã«å°ãã¾ã™ï¼š</p>
</li>
<li>
<p><code>before=True</code>ï¼šãƒ†ã‚¹ãƒˆã®é–‹å§‹æ™‚ã«å¸¸ã«ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™ã€‚</p>
</li>
<li><code>before=False</code>ï¼šä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã€æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãã®ã¾ã¾ã«ãªã‚Šã¾ã™ã€‚</li>
<li><code>after=True</code>ï¼šãƒ†ã‚¹ãƒˆã®çµ‚äº†æ™‚ã«å¸¸ã«ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚</li>
<li><code>after=False</code>ï¼šãƒ†ã‚¹ãƒˆã®çµ‚äº†æ™‚ã«å¸¸ã«ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ãã®ã¾ã¾ã«ãªã‚Šã¾ã™ã€‚</li>
</ul>
<p><Tip></p>
<p><code>rm -r</code>ã®ç›¸å½“ã‚’å®‰å…¨ã«å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã€æ˜ç¤ºçš„ãª <code>tmp_dir</code> ãŒä½¿ç”¨ã•ã‚Œã‚‹å ´åˆã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã®ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã¿ãŒè¨±å¯ã•ã‚Œã¾ã™ã€‚èª¤ã£ã¦ <code>/tmp</code> ãªã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®é‡è¦ãªéƒ¨åˆ†ãŒå‰Šé™¤ã•ã‚Œãªã„ã‚ˆã†ã«ã€å¸¸ã« <code>./</code> ã‹ã‚‰å§‹ã¾ã‚‹ãƒ‘ã‚¹ã‚’æ¸¡ã—ã¦ãã ã•ã„ã€‚</p>
<p></Tip></p>
<p><Tip></p>
<p>å„ãƒ†ã‚¹ãƒˆã¯è¤‡æ•°ã®ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç™»éŒ²ã§ãã€è¦æ±‚ãŒãªã„é™ã‚Šã™ã¹ã¦è‡ªå‹•ã§å‰Šé™¤ã•ã‚Œã¾ã™ã€‚</p>
<p></Tip></p>
<h3 id="temporary-syspath-override">Temporary sys.path override</h3>
<p>åˆ¥ã®ãƒ†ã‚¹ãƒˆã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«ä¸€æ™‚çš„ã« <code>sys.path</code> ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã€<code>ExtendSysPath</code> ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚ä¾‹ï¼š</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExtendSysPath</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="n">bindir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="k">with</span> <span class="n">ExtendSysPath</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bindir</span><span class="si">}</span><span class="s2">/..&quot;</span><span class="p">):</span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">test_trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">TrainerIntegrationCommon</span>  <span class="c1"># noqa</span>
</span></code></pre></div>
<h3 id="skipping-tests">Skipping tests</h3>
<p>ã“ã‚Œã¯ã€ãƒã‚°ãŒè¦‹ã¤ã‹ã‚Šã€æ–°ã—ã„ãƒ†ã‚¹ãƒˆãŒä½œæˆã•ã‚ŒãŸå ´åˆã§ã‚ã£ã¦ã‚‚ã€ãƒã‚°ãŒã¾ã ä¿®æ­£ã•ã‚Œã¦ã„ãªã„å ´åˆã«å½¹ç«‹ã¡ã¾ã™ã€‚ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã«ã¯ã€<code>make test</code> ã®å®Ÿè¡Œä¸­ã«ãã‚Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>ãƒ¡ã‚½ãƒƒãƒ‰ï¼š</p>
<ul>
<li>
<p><strong>skip</strong> ã¯ã€ãƒ†ã‚¹ãƒˆãŒç‰¹å®šã®æ¡ä»¶ãŒæº€ãŸã•ã‚ŒãŸå ´åˆã«ã®ã¿ãƒ‘ã‚¹ã™ã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¦ãŠã‚Šã€ãã‚Œä»¥å¤–ã®å ´åˆã¯ pytest ãŒãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚ä¸€èˆ¬çš„ãªä¾‹ã¯ã€Windowså°‚ç”¨ã®ãƒ†ã‚¹ãƒˆã‚’éWindowsãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å ´åˆã€ã¾ãŸã¯ç¾åœ¨åˆ©ç”¨ã§ããªã„å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã«ä¾å­˜ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å ´åˆã§ã™ï¼ˆä¾‹: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆ©ç”¨ã§ããªã„å ´åˆï¼‰ã€‚</p>
</li>
<li>
<p><strong>xfail</strong> ã¯ã€ä½•ã‚‰ã‹ã®ç†ç”±ã§ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¦ã„ã¾ã™ã€‚ä¸€èˆ¬çš„ãªä¾‹ã¯ã€ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ãªã„æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã‚„ã€ã¾ã ä¿®æ­£ã•ã‚Œã¦ã„ãªã„ãƒã‚°ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚ãƒ†ã‚¹ãƒˆãŒäºˆæƒ³ã•ã‚Œã‚‹å¤±æ•—ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšãƒ‘ã‚¹ã—ãŸå ´åˆï¼ˆpytest.mark.xfailã§ãƒãƒ¼ã‚¯ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆï¼‰ã€ãã‚Œã¯xpassã¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼ã«å ±å‘Šã•ã‚Œã¾ã™ã€‚</p>
</li>
</ul>
<p>ã“ã‚Œã‚‰ã®2ã¤ã®é–“ã®é‡è¦ãªé•ã„ã®1ã¤ã¯ã€<code>skip</code> ã¯ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ãªã„ç‚¹ã§ã‚ã‚Šã€<code>xfail</code> ã¯å®Ÿè¡Œã—ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ãƒã‚°ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ãŒä»–ã®ãƒ†ã‚¹ãƒˆã«å½±éŸ¿ã‚’ä¸ãˆã‚‹å ´åˆã¯ã€<code>xfail</code> ã‚’ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚</p>
<h4 id="implementation">Implementation</h4>
<ul>
<li>ãƒ†ã‚¹ãƒˆå…¨ä½“ã‚’ç„¡æ¡ä»¶ã«ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹æ–¹æ³•ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š</li>
</ul>
<p>```python no-style
@unittest.skip(reason="this bug needs to be fixed")
def test_feature_x():
<div class="language-bash highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a>ã¾ãŸã¯<span class="w"> </span>pytest<span class="w"> </span>çµŒç”±:
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="sb">```</span>python<span class="w"> </span>no-style
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>@pytest.mark.skip<span class="o">(</span><span class="nv">reason</span><span class="o">=</span><span class="s2">&quot;this bug needs to be fixed&quot;</span><span class="o">)</span>
</span></code></pre></div></p>
<p>ã¾ãŸã¯ <code>xfail</code> ã®æ–¹æ³•:</p>
<p>```python no-style
@pytest.mark.xfail
def test_feature_x():
<div class="language-bash highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>-<span class="w"> </span>ãƒ†ã‚¹ãƒˆå†…ã®å†…éƒ¨ãƒã‚§ãƒƒã‚¯ã«åŸºã¥ã„ã¦ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹æ–¹æ³•ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="sb">```</span>python
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>def<span class="w"> </span>test_feature_x<span class="o">()</span>:
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span>not<span class="w"> </span>has_something<span class="o">()</span>:
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a><span class="w">        </span>pytest.skip<span class="o">(</span><span class="s2">&quot;unsupported configuration&quot;</span><span class="o">)</span>
</span></code></pre></div></p>
<p>ã¾ãŸã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å…¨ä½“:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">pytest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;--custom-flag&quot;</span><span class="p">):</span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a>    <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;--custom-flag is missing, skipping tests&quot;</span><span class="p">,</span> <span class="n">allow_module_level</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></code></pre></div>
<p>ã¾ãŸã¯ <code>xfail</code> ã®æ–¹æ³•:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_feature_x</span><span class="p">():</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>    <span class="n">pytest</span><span class="o">.</span><span class="n">xfail</span><span class="p">(</span><span class="s2">&quot;expected to fail until bug XYZ is fixed&quot;</span><span class="p">)</span>
</span></code></pre></div>
<ul>
<li>ä¸€éƒ¨ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒæ¬ è½ã—ã¦ã„ã‚‹å ´åˆã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã®ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹æ–¹æ³•ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="n">docutils</span> <span class="o">=</span> <span class="n">pytest</span><span class="o">.</span><span class="n">importorskip</span><span class="p">(</span><span class="s2">&quot;docutils&quot;</span><span class="p">,</span> <span class="n">minversion</span><span class="o">=</span><span class="s2">&quot;0.3&quot;</span><span class="p">)</span>
</span></code></pre></div>
<ul>
<li>æ¡ä»¶ã«åŸºã¥ã„ã¦ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚</li>
</ul>
<p>```python no-style
@pytest.mark.skipif(sys.version_info &lt; (3,6), reason="requires python3.6 or higher")
def test_feature_x():
<div class="language-bash highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a>ã¾ãŸã¯ï¼š
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="sb">```</span>python<span class="w"> </span>no-style
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>@unittest.skipIf<span class="o">(</span><span class="nv">torch_device</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;cpu&quot;</span>,<span class="w"> </span><span class="s2">&quot;Can&#39;t do half precision&quot;</span><span class="o">)</span>
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>def<span class="w"> </span>test_feature_x<span class="o">()</span>:
</span></code></pre></div></p>
<p>ã¾ãŸã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å…¨ä½“ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚</p>
<p>```python no-style
@pytest.mark.skipif(sys.platform == 'win32', reason="does not run on windows")
class TestClass():
    def test_feature_x(self):
<div class="language-bash highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a>è©³ç´°ã€ä¾‹ã€ãŠã‚ˆã³æ–¹æ³•ã«ã¤ã„ã¦ã®è©³ç´°ã¯<span class="o">[</span>ã“ã¡ã‚‰<span class="o">](</span>https://docs.pytest.org/en/latest/skipping.html<span class="o">)</span>ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="c1">### Slow tests</span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>ãƒ†ã‚¹ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ç€å®Ÿã«æˆé•·ã—ã¦ãŠã‚Šã€ãƒ†ã‚¹ãƒˆã®ä¸€éƒ¨ã¯æ•°åˆ†ã‹ã‹ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€CIã§ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã®å®Œäº†ã‚’å¾…ã¤ã®ã¯1æ™‚é–“å¾…ã¤ä½™è£•ãŒãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ã„ãã¤ã‹ã®ä¾‹å¤–ã‚’é™¤ã„ã¦ã€é…ã„ãƒ†ã‚¹ãƒˆã¯ä»¥ä¸‹ã®ä¾‹ã®ã‚ˆã†ã«ãƒãƒ¼ã‚¯ã™ã¹ãã§ã™ï¼š
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a>
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a><span class="sb">```</span>python<span class="w"> </span>no-style
</span><span id="__span-71-9"><a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a>from<span class="w"> </span>transformers.testing_utils<span class="w"> </span>import<span class="w"> </span>slow
</span><span id="__span-71-10"><a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a>@slow
</span><span id="__span-71-11"><a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a>def<span class="w"> </span>test_integration_foo<span class="o">()</span>:
</span></code></pre></div></p>
<p>ãƒ†ã‚¹ãƒˆãŒ<code>@slow</code>ã¨ã—ã¦ãƒãƒ¼ã‚¯ã•ã‚ŒãŸã‚‰ã€ãã®ã‚ˆã†ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ç’°å¢ƒå¤‰æ•° <code>RUN_SLOW=1</code>ã‚’è¨­å®šã—ã¾ã™ã€‚ä¾‹:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="nv">RUN_SLOW</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>pytest<span class="w"> </span>tests
</span></code></pre></div>
<p><code>@parameterized</code> ã®ã‚ˆã†ãªãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã¯ãƒ†ã‚¹ãƒˆåã‚’æ›¸ãæ›ãˆã‚‹ãŸã‚ã€<code>@slow</code> ãŠã‚ˆã³ä»–ã®ã‚¹ã‚­ãƒƒãƒ—ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ <code>@require_*</code> ã¯æ­£ã—ãå‹•ä½œã™ã‚‹ãŸã‚ã«ã¯ã€æœ€å¾Œã«ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã¯æ­£ã—ã„ä½¿ç”¨ä¾‹ã®ä¸€ä¾‹ã§ã™ï¼š</p>
<p>```python no-style
@parameterized.expand(...)
@slow
def test_integration_foo():
<div class="language-bash highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a>ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†’é ­ã§èª¬æ˜ã—ãŸã‚ˆã†ã«ã€é…ã„ãƒ†ã‚¹ãƒˆã¯å®šæœŸçš„ãªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«å¾“ã£ã¦å®Ÿè¡Œã•ã‚Œã€PRã®CIãƒã‚§ãƒƒã‚¯ã§ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€ä¸€éƒ¨ã®å•é¡ŒãŒPRã®æå‡ºæ™‚ã«è¦‹è½ã¨ã•ã‚Œã€ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãã®ã‚ˆã†ãªå•é¡Œã¯æ¬¡å›ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚ŒãŸCIã‚¸ãƒ§ãƒ–ã§æ¤œå‡ºã•ã‚Œã¾ã™ã€‚ã—ã‹ã—ã€ãã‚Œã¯ã¾ãŸã€PRã‚’æå‡ºã™ã‚‹å‰ã«è‡ªåˆ†ã®ãƒã‚·ãƒ³ã§é…ã„ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹é‡è¦æ€§ã‚’æ„å‘³ã—ã¦ã„ã¾ã™ã€‚
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a>ã©ã®ãƒ†ã‚¹ãƒˆã‚’é…ã„ãƒ†ã‚¹ãƒˆã¨ã—ã¦ãƒãƒ¼ã‚¯ã™ã¹ãã‹ã‚’é¸æŠã™ã‚‹ãŸã‚ã®ã€ãŠãŠã¾ã‹ãªæ„æ€æ±ºå®šãƒ¡ã‚«ãƒ‹ã‚ºãƒ ãŒæ¬¡ã«ç¤ºã•ã‚Œã¦ã„ã¾ã™ï¼š
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a>-<span class="w"> </span>ãƒ†ã‚¹ãƒˆãŒãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å†…éƒ¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®1ã¤ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã‚‹å ´åˆï¼ˆä¾‹:<span class="w"> </span>ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼‰ã€ãã®ãƒ†ã‚¹ãƒˆã¯é…ã„ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã‚ŒãŒãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä»–ã®å´é¢ã€ãŸã¨ãˆã°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ä¾‹ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã‚‹å ´åˆã€ãã‚Œã‚‰ã®ãƒ†ã‚¹ãƒˆã¯é…ã„ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã—ã¦ã€ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ´—ç·´ã•ã›ã‚‹ãŸã‚ã«ä¾‹å¤–ã‚’è¨­ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a>
</span><span id="__span-73-7"><a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a>-<span class="w"> </span>é‡ã„ã‚¦ã‚§ã‚¤ãƒˆã‚»ãƒƒãƒˆã‚„ç´„50MBä»¥ä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆï¼ˆä¾‹:<span class="w"> </span>ãƒ¢ãƒ‡ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆã€ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶çµ±åˆãƒ†ã‚¹ãƒˆã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµ±åˆãƒ†ã‚¹ãƒˆï¼‰ã¯é…ã„ãƒ†ã‚¹ãƒˆã¨ã—ã¦è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æ–°ã—ã„ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã™ã‚‹å ´åˆã€çµ±åˆãƒ†ã‚¹ãƒˆç”¨ã«ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¦ã‚§ã‚¤ãƒˆã‚’æŒã¤å°ã•ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆã—ã€ãƒãƒ–ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®æ®µè½ã§è©³ã—ãèª¬æ˜ã—ã¾ã™ã€‚
</span><span id="__span-73-8"><a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a>
</span><span id="__span-73-9"><a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a>-<span class="w"> </span>ç‰¹ã«é«˜é€ŸåŒ–ã•ã‚Œã¦ã„ãªã„ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚‹ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã¯é…ã„ãƒ†ã‚¹ãƒˆã¨ã—ã¦è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
</span><span id="__span-73-10"><a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a>
</span><span id="__span-73-11"><a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a>-<span class="w"> </span>ä¸€éƒ¨ã®ã€Œé…ã„ã€ã§ã‚ã‚‹ã¹ãã§ãªã„ãƒ†ã‚¹ãƒˆãŒéå¸¸ã«é…ã„å ´åˆã€ãŠã‚ˆã³ãã‚Œã‚‰ã‚’<span class="w"> </span><span class="sb">`</span>@slow<span class="sb">`</span><span class="w"> </span>ã¨ã—ã¦è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã«ã¯ä¾‹å¤–ã‚’å°å…¥ã§ãã¾ã™ã€‚å¤§å®¹é‡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ã‚£ã‚¹ã‚¯ã«ä¿å­˜ãŠã‚ˆã³èª­ã¿è¾¼ã¿ã™ã‚‹è‡ªå‹•ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆã¯ã€<span class="sb">`</span>@slow<span class="sb">`</span><span class="w"> </span>ã¨ã—ã¦ãƒãƒ¼ã‚¯ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã®è‰¯ã„ä¾‹ã§ã™ã€‚
</span><span id="__span-73-12"><a id="__codelineno-73-12" name="__codelineno-73-12" href="#__codelineno-73-12"></a>
</span><span id="__span-73-13"><a id="__codelineno-73-13" name="__codelineno-73-13" href="#__codelineno-73-13"></a>-<span class="w"> </span>CIã§1ç§’æœªæº€ã§ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã™ã‚‹å ´åˆï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’å«ã‚€ï¼‰ã€ãã‚Œã¯é€šå¸¸ã®ãƒ†ã‚¹ãƒˆã§ã‚ã‚‹ã¹ãã§ã™ã€‚
</span><span id="__span-73-14"><a id="__codelineno-73-14" name="__codelineno-73-14" href="#__codelineno-73-14"></a>
</span><span id="__span-73-15"><a id="__codelineno-73-15" name="__codelineno-73-15" href="#__codelineno-73-15"></a>ã™ã¹ã¦ã®éé…ã„ãƒ†ã‚¹ãƒˆã¯ã€ã•ã¾ã–ã¾ãªå†…éƒ¨è¦ç´ ã‚’å®Œå…¨ã«ã‚«ãƒãƒ¼ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€é«˜é€Ÿã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€ç‰¹åˆ¥ã«ä½œæˆã•ã‚ŒãŸå°ã•ãªãƒ¢ãƒ‡ãƒ«ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°ãŒæœ€å°é™ã§ã€èªå½™ã‚µã‚¤ã‚ºãŒå°ã•ã„ãªã©ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã€ã‹ãªã‚Šã®ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚ãã®å¾Œã€<span class="sb">`</span>@slow<span class="sb">`</span><span class="w"> </span>ãƒ†ã‚¹ãƒˆã§ã¯å¤§è¦æ¨¡ãªé…ã„ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦è³ªçš„ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚ã“ã‚Œã‚‰ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«<span class="w"> </span>*tiny*<span class="w"> </span>ãƒ¢ãƒ‡ãƒ«ã‚’æ¢ã—ã¦ãã ã•ã„ï¼š
</span><span id="__span-73-16"><a id="__codelineno-73-16" name="__codelineno-73-16" href="#__codelineno-73-16"></a>
</span><span id="__span-73-17"><a id="__codelineno-73-17" name="__codelineno-73-17" href="#__codelineno-73-17"></a>
</span><span id="__span-73-18"><a id="__codelineno-73-18" name="__codelineno-73-18" href="#__codelineno-73-18"></a><span class="sb">```</span>bash
</span><span id="__span-73-19"><a id="__codelineno-73-19" name="__codelineno-73-19" href="#__codelineno-73-19"></a>grep<span class="w"> </span>tiny<span class="w"> </span>tests<span class="w"> </span>examples
</span></code></pre></div></p>
<p><a href="https://github.com/huggingface/transformers/tree/main/scripts/fsmt/fsmt-make-tiny-model.py">ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä¾‹</a>ãŒã‚ã‚Šã€ã“ã‚Œã«ã‚ˆã‚Š tiny-wmt19-en-de ã®ã‚ˆã†ãªå°ã•ãªãƒ¢ãƒ‡ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚ç‰¹å®šã®ãƒ¢ãƒ‡ãƒ«ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ç°¡å˜ã«èª¿æ•´ã§ãã¾ã™ã€‚</p>
<p>å®Ÿè¡Œæ™‚é–“ã‚’èª¤ã£ã¦æ¸¬å®šã™ã‚‹ã“ã¨ãŒç°¡å˜ã§ã™ã€‚ãŸã¨ãˆã°ã€å·¨å¤§ãªãƒ¢ãƒ‡ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«é–¢ã™ã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒã‚ã‚‹å ´åˆã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚é–“ãŒè¨ˆæ¸¬ã•ã‚Œãªããªã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€CIãƒ­ã‚°ã®å®Ÿè¡Œé€Ÿåº¦ãƒ¬ãƒãƒ¼ãƒˆï¼ˆ<code>pytest --durations=0 tests</code> ã®å‡ºåŠ›ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<p>ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ã€é…ã„ãƒ†ã‚¹ãƒˆã¨ã—ã¦ãƒãƒ¼ã‚¯ã•ã‚Œã¦ã„ãªã„é…ã„å¤–ã‚Œå€¤ã‚„ã€é«˜é€Ÿã«æ›¸ãç›´ã™å¿…è¦ãŒã‚ã‚‹ãƒ†ã‚¹ãƒˆã‚’è¦‹ã¤ã‘ã‚‹ã®ã«ã‚‚å½¹ç«‹ã¡ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆãŒCIã§é…ããªã‚Šå§‹ã‚ãŸå ´åˆã€ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã®ãƒˆãƒƒãƒ—ãƒªã‚¹ãƒˆã«ã¯æœ€ã‚‚é…ã„ãƒ†ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
<h3 id="testing-the-stdoutstderr-output">Testing the stdout/stderr output</h3>
<p><code>stdout</code> ãŠã‚ˆã³/ã¾ãŸã¯ <code>stderr</code> ã«æ›¸ãè¾¼ã‚€é–¢æ•°ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ã€ãƒ†ã‚¹ãƒˆã¯ <code>pytest</code> ã® <a href="https://docs.pytest.org/en/latest/capture.html">capsys ã‚·ã‚¹ãƒ†ãƒ </a> ã‚’ä½¿ç”¨ã—ã¦ã“ã‚Œã‚‰ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ä»¥ä¸‹ã¯ãã®æ–¹æ³•ã§ã™ï¼š</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">print_to_stdout</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a>
</span><span id="__span-74-7"><a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a>
</span><span id="__span-74-8"><a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">print_to_stderr</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="__span-74-9"><a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="__span-74-10"><a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a>
</span><span id="__span-74-11"><a id="__codelineno-74-11" name="__codelineno-74-11" href="#__codelineno-74-11"></a>
</span><span id="__span-74-12"><a id="__codelineno-74-12" name="__codelineno-74-12" href="#__codelineno-74-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_result_and_stdout</span><span class="p">(</span><span class="n">capsys</span><span class="p">):</span>
</span><span id="__span-74-13"><a id="__codelineno-74-13" name="__codelineno-74-13" href="#__codelineno-74-13"></a>    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Hello&quot;</span>
</span><span id="__span-74-14"><a id="__codelineno-74-14" name="__codelineno-74-14" href="#__codelineno-74-14"></a>    <span class="n">print_to_stdout</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="__span-74-15"><a id="__codelineno-74-15" name="__codelineno-74-15" href="#__codelineno-74-15"></a>    <span class="n">print_to_stderr</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="__span-74-16"><a id="__codelineno-74-16" name="__codelineno-74-16" href="#__codelineno-74-16"></a>    <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">capsys</span><span class="o">.</span><span class="n">readouterr</span><span class="p">()</span>  <span class="c1"># consume the captured output streams</span>
</span><span id="__span-74-17"><a id="__codelineno-74-17" name="__codelineno-74-17" href="#__codelineno-74-17"></a>    <span class="c1"># optional: if you want to replay the consumed streams:</span>
</span><span id="__span-74-18"><a id="__codelineno-74-18" name="__codelineno-74-18" href="#__codelineno-74-18"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span><span id="__span-74-19"><a id="__codelineno-74-19" name="__codelineno-74-19" href="#__codelineno-74-19"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span><span id="__span-74-20"><a id="__codelineno-74-20" name="__codelineno-74-20" href="#__codelineno-74-20"></a>    <span class="c1"># test:</span>
</span><span id="__span-74-21"><a id="__codelineno-74-21" name="__codelineno-74-21" href="#__codelineno-74-21"></a>    <span class="k">assert</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">out</span>
</span><span id="__span-74-22"><a id="__codelineno-74-22" name="__codelineno-74-22" href="#__codelineno-74-22"></a>    <span class="k">assert</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">err</span>
</span></code></pre></div>
<p>ãã—ã¦ã‚‚ã¡ã‚ã‚“ã€ã»ã¨ã‚“ã©ã®å ´åˆã€<code>stderr</code>ã¯ä¾‹å¤–ã®ä¸€éƒ¨ã¨ã—ã¦æä¾›ã•ã‚Œã‚‹ãŸã‚ã€ãã®ã‚ˆã†ãªå ´åˆã«ã¯ try/excel ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã‚±ãƒ¼ã‚¹ï¼š</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">raise_exception</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a>    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_something_exception</span><span class="p">():</span>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a>    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Not a good value&quot;</span>
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a>    <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-75-8"><a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-75-9"><a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a>        <span class="n">raise_exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="__span-75-10"><a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-75-11"><a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a>        <span class="n">error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="__span-75-12"><a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a>        <span class="k">assert</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">error</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2"> is in the exception:</span><span class="se">\n</span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></div>
<p>stdout ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ã‚‚ã† 1 ã¤ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã€<code>contextlib.redirect_stdout</code>ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">StringIO</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">redirect_stdout</span>
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>
</span><span id="__span-76-4"><a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>
</span><span id="__span-76-5"><a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">print_to_stdout</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="__span-76-6"><a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="__span-76-7"><a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a>
</span><span id="__span-76-8"><a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a>
</span><span id="__span-76-9"><a id="__codelineno-76-9" name="__codelineno-76-9" href="#__codelineno-76-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_result_and_stdout</span><span class="p">():</span>
</span><span id="__span-76-10"><a id="__codelineno-76-10" name="__codelineno-76-10" href="#__codelineno-76-10"></a>    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Hello&quot;</span>
</span><span id="__span-76-11"><a id="__codelineno-76-11" name="__codelineno-76-11" href="#__codelineno-76-11"></a>    <span class="n">buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
</span><span id="__span-76-12"><a id="__codelineno-76-12" name="__codelineno-76-12" href="#__codelineno-76-12"></a>    <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">buffer</span><span class="p">):</span>
</span><span id="__span-76-13"><a id="__codelineno-76-13" name="__codelineno-76-13" href="#__codelineno-76-13"></a>        <span class="n">print_to_stdout</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="__span-76-14"><a id="__codelineno-76-14" name="__codelineno-76-14" href="#__codelineno-76-14"></a>    <span class="n">out</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</span><span id="__span-76-15"><a id="__codelineno-76-15" name="__codelineno-76-15" href="#__codelineno-76-15"></a>    <span class="c1"># optional: if you want to replay the consumed streams:</span>
</span><span id="__span-76-16"><a id="__codelineno-76-16" name="__codelineno-76-16" href="#__codelineno-76-16"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span><span id="__span-76-17"><a id="__codelineno-76-17" name="__codelineno-76-17" href="#__codelineno-76-17"></a>    <span class="c1"># test:</span>
</span><span id="__span-76-18"><a id="__codelineno-76-18" name="__codelineno-76-18" href="#__codelineno-76-18"></a>    <span class="k">assert</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">out</span>
</span></code></pre></div>
<p>stdout ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹éš›ã®é‡è¦ãªæ½œåœ¨çš„ãªå•é¡Œã¯ã€é€šå¸¸ã® <code>print</code> ã§ã“ã‚Œã¾ã§ã«å‡ºåŠ›ã•ã‚ŒãŸå†…å®¹ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ <code>\r</code> æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ã§ã™ã€‚<code>pytest</code> è‡ªä½“ã«ã¯å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€<code>pytest -s</code> ã§ã¯ã“ã‚Œã‚‰ã®æ–‡å­—ãŒãƒãƒƒãƒ•ã‚¡ã«å«ã¾ã‚Œã‚‹ãŸã‚ã€<code>-s</code> ã‚ã‚Šã¨ãªã—ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã«ã¯ã€<code>re.sub(r'~.*\r', '', buf, 0, re.M)</code> ã‚’ä½¿ç”¨ã—ã¦ã‚­ãƒ£ãƒ—ãƒãƒ£ã•ã‚ŒãŸå‡ºåŠ›ã«å¯¾ã—ã¦è¿½åŠ ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<p>ã—ã‹ã—ã€ãã®å¾Œã€<code>\r</code> ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã«ã‹ã‹ã‚ã‚‰ãšã€ã™ã¹ã¦ã®æ“ä½œã‚’è‡ªå‹•çš„ã«å‡¦ç†ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ©ãƒƒãƒ‘ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€æ¬¡ã®ã‚ˆã†ã«ç°¡å˜ã«è¡Œãˆã¾ã™ï¼š</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">CaptureStdout</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a><span class="k">with</span> <span class="n">CaptureStdout</span><span class="p">()</span> <span class="k">as</span> <span class="n">cs</span><span class="p">:</span>
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>    <span class="n">function_that_writes_to_stdout</span><span class="p">()</span>
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a><span class="nb">print</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">out</span><span class="p">)</span>
</span></code></pre></div>
<p>å®Œå…¨ãªãƒ†ã‚¹ãƒˆä¾‹ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">CaptureStdout</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Secret message</span><span class="se">\r</span><span class="s2">&quot;</span>
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a><span class="n">final</span> <span class="o">=</span> <span class="s2">&quot;Hello World&quot;</span>
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a><span class="k">with</span> <span class="n">CaptureStdout</span><span class="p">()</span> <span class="k">as</span> <span class="n">cs</span><span class="p">:</span>
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="n">final</span><span class="p">)</span>
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a><span class="k">assert</span> <span class="n">cs</span><span class="o">.</span><span class="n">out</span> <span class="o">==</span> <span class="n">final</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;captured: </span><span class="si">{</span><span class="n">cs</span><span class="o">.</span><span class="n">out</span><span class="si">}</span><span class="s2">, expecting </span><span class="si">{</span><span class="n">final</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></div>
<p><code>stderr</code> ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸã„å ´åˆã¯ã€ä»£ã‚ã‚Šã« <code>CaptureStderr</code> ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">CaptureStderr</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="k">with</span> <span class="n">CaptureStderr</span><span class="p">()</span> <span class="k">as</span> <span class="n">cs</span><span class="p">:</span>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a>    <span class="n">function_that_writes_to_stderr</span><span class="p">()</span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="nb">print</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">err</span><span class="p">)</span>
</span></code></pre></div>
<p>ä¸¡æ–¹ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä¸€åº¦ã«ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€è¦ªã® <code>CaptureStd</code> ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">CaptureStd</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="k">with</span> <span class="n">CaptureStd</span><span class="p">()</span> <span class="k">as</span> <span class="n">cs</span><span class="p">:</span>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a>    <span class="n">function_that_writes_to_stdout_and_stderr</span><span class="p">()</span>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a><span class="nb">print</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">cs</span><span class="o">.</span><span class="n">out</span><span class="p">)</span>
</span></code></pre></div>
<p>ã¾ãŸã€ãƒ†ã‚¹ãƒˆã®å•é¡Œã®ãƒ‡ãƒãƒƒã‚°ã‚’æ”¯æ´ã™ã‚‹ãŸã‚ã«ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€ã“ã‚Œã‚‰ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã¯çµ‚äº†æ™‚ã«ã‚­ãƒ£ãƒ—ãƒãƒ£ã•ã‚ŒãŸã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’è‡ªå‹•çš„ã«å†ç”Ÿã—ã¾ã™ã€‚
æ–‡è„ˆã‹ã‚‰ã€‚</p>
<h3 id="capturing-logger-stream">Capturing logger stream</h3>
<p>ãƒ­ã‚¬ãƒ¼ã®å‡ºåŠ›ã‚’æ¤œè¨¼ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€<code>CaptureLogger</code>ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">logging</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">CaptureLogger</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Testing 1, 2, 3&quot;</span>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity_info</span><span class="p">()</span>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;transformers.models.bart.tokenization_bart&quot;</span><span class="p">)</span>
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a><span class="k">with</span> <span class="n">CaptureLogger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span> <span class="k">as</span> <span class="n">cl</span><span class="p">:</span>
</span><span id="__span-81-8"><a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="__span-81-9"><a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a><span class="k">assert</span> <span class="n">cl</span><span class="o">.</span><span class="n">out</span><span class="p">,</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span></code></pre></div>
<h3 id="testing-with-environment-variables">Testing with environment variables</h3>
<p>ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã§ç’°å¢ƒå¤‰æ•°ã®å½±éŸ¿ã‚’ãƒ†ã‚¹ãƒˆã—ãŸã„å ´åˆã¯ã€ãƒ˜ãƒ«ãƒ‘ãƒ¼ ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚
<code>transformers.testing_utils.mockenv</code></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">mockenv</span>
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a>
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a>
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">HfArgumentParserTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a>    <span class="nd">@mockenv</span><span class="p">(</span><span class="n">TRANSFORMERS_VERBOSITY</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_env_override</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a>        <span class="n">env_level_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TRANSFORMERS_VERBOSITY&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></code></pre></div>
<p>å ´åˆã«ã‚ˆã£ã¦ã¯ã€å¤–éƒ¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€<code>os.environ</code> ã«<code>PYTHONPATH</code>ã‚’è¨­å®šã—ã¦ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
è¤‡æ•°ã®ãƒ­ãƒ¼ã‚«ãƒ« ãƒ‘ã‚¹ã€‚ãƒ˜ãƒ«ãƒ‘ãƒ¼ ã‚¯ãƒ©ã‚¹ <code>transformers.test_utils.TestCasePlus</code> ãŒå½¹ã«ç«‹ã¡ã¾ã™ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestCasePlus</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a>
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">EnvExampleTest</span><span class="p">(</span><span class="n">TestCasePlus</span><span class="p">):</span>
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_external_prog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a>        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">()</span>
</span><span id="__span-83-7"><a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a>        <span class="c1"># now call the external program, passing `env` to it</span>
</span></code></pre></div>
<p>ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒ <code>tests</code> ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã¾ãŸã¯ <code>examples</code> ã®ã©ã¡ã‚‰ã«ã‚ã‚‹ã‹ã«å¿œã˜ã¦
<code>env[PYTHONPATH]</code> ã‚’ä½¿ç”¨ã—ã¦ã€ã“ã‚Œã‚‰ 2 ã¤ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã„ãšã‚Œã‹ã‚’å«ã‚ã¾ã™ã€‚ã¾ãŸã€ãƒ†ã‚¹ãƒˆãŒç¢ºå®Ÿã«è¡Œã‚ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã® <code>src</code> ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚‚å«ã‚ã¾ã™ã€‚
ç¾åœ¨ã®ãƒªãƒã‚¸ãƒˆãƒªã«å¯¾ã—ã¦å®Ÿè¡Œã•ã‚Œã€æœ€å¾Œã«ã€ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹å‰ã«ã™ã§ã«è¨­å®šã•ã‚Œã¦ã„ãŸ <code>env[PYTHONPATH]</code> ã‚’ä½¿ç”¨ã—ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
ä½•ã‹ã‚ã‚Œã°å‘¼ã°ã‚Œã¾ã™ã€‚</p>
<p>ã“ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ ãƒ¡ã‚½ãƒƒãƒ‰ã¯ <code>os.environ</code> ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆã™ã‚‹ãŸã‚ã€å…ƒã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ãã®ã¾ã¾æ®‹ã‚Šã¾ã™ã€‚</p>
<h3 id="getting-reproducible-results">Getting reproducible results</h3>
<p>çŠ¶æ³ã«ã‚ˆã£ã¦ã¯ã€ãƒ†ã‚¹ãƒˆã®ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚’å‰Šé™¤ã—ãŸã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚åŒä¸€ã®å†ç¾å¯èƒ½ãªçµæœã‚»ãƒƒãƒˆã‚’å–å¾—ã™ã‚‹ã«ã¯ã€
ã‚·ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="n">seed</span> <span class="o">=</span> <span class="mi">42</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a><span class="c1"># python RNG</span>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a>
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a>
</span><span id="__span-84-8"><a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a><span class="c1"># pytorch RNGs</span>
</span><span id="__span-84-9"><a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-84-10"><a id="__codelineno-84-10" name="__codelineno-84-10" href="#__codelineno-84-10"></a>
</span><span id="__span-84-11"><a id="__codelineno-84-11" name="__codelineno-84-11" href="#__codelineno-84-11"></a><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="__span-84-12"><a id="__codelineno-84-12" name="__codelineno-84-12" href="#__codelineno-84-12"></a><span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-84-13"><a id="__codelineno-84-13" name="__codelineno-84-13" href="#__codelineno-84-13"></a><span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
</span><span id="__span-84-14"><a id="__codelineno-84-14" name="__codelineno-84-14" href="#__codelineno-84-14"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="__span-84-15"><a id="__codelineno-84-15" name="__codelineno-84-15" href="#__codelineno-84-15"></a>
</span><span id="__span-84-16"><a id="__codelineno-84-16" name="__codelineno-84-16" href="#__codelineno-84-16"></a><span class="c1"># numpy RNG</span>
</span><span id="__span-84-17"><a id="__codelineno-84-17" name="__codelineno-84-17" href="#__codelineno-84-17"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-84-18"><a id="__codelineno-84-18" name="__codelineno-84-18" href="#__codelineno-84-18"></a>
</span><span id="__span-84-19"><a id="__codelineno-84-19" name="__codelineno-84-19" href="#__codelineno-84-19"></a><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="debugging-tests">Debugging tests</h3>
<p>è­¦å‘ŠãŒç™ºç”Ÿã—ãŸæ™‚ç‚¹ã§ãƒ‡ãƒãƒƒã‚¬ãƒ¼ã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€æ¬¡ã®æ‰‹é †ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a>pytest<span class="w"> </span>tests/utils/test_logging.py<span class="w"> </span>-W<span class="w"> </span>error::UserWarning<span class="w"> </span>--pdb
</span></code></pre></div>
<h2 id="working-with-github-actions-workflows">Working with github actions workflows</h2>
<p>ã‚»ãƒ«ãƒ•ãƒ—ãƒƒã‚·ãƒ¥ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼CIã‚¸ãƒ§ãƒ–ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š</p>
<ol>
<li><code>transformers</code> ã®ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã§æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã¾ã™ï¼ˆãƒ•ã‚©ãƒ¼ã‚¯ã§ã¯ãªãã€å…ƒã®ãƒªãƒã‚¸ãƒˆãƒªã§è¡Œã„ã¾ã™ï¼‰ã€‚</li>
<li>ãƒ–ãƒ©ãƒ³ãƒã®åå‰ã¯ <code>ci_</code> ã¾ãŸã¯ <code>ci-</code> ã§å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆ<code>main</code> ã‚‚ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã™ãŒã€<code>main</code> ã§ã¯PRã‚’ä½œæˆã§ãã¾ã›ã‚“ï¼‰ã€‚ã¾ãŸã€ç‰¹å®šã®ãƒ‘ã‚¹ã§ã®ã¿ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã™ - ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›¸ã‹ã‚ŒãŸå¾Œã«å¤‰æ›´ã•ã‚ŒãŸå ´åˆã«å‚™ãˆã¦ã€æœ€æ–°ã®å®šç¾©ã¯<a href="https://github.com/huggingface/transformers/blob/main/.github/workflows/self-push.yml">ã“ã¡ã‚‰</a>ã® <em>push:</em> ã«ã‚ã‚Šã¾ã™ã€‚</li>
<li>ã“ã®ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰PRã‚’ä½œæˆã—ã¾ã™ã€‚</li>
<li>ãã®å¾Œã€ã“ã®ã‚¸ãƒ§ãƒ–ãŒ<a href="https://github.com/huggingface/transformers/actions/workflows/self-push.yml">ã“ã“</a>ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã‚¸ãƒ§ãƒ–ã¯ãƒãƒƒã‚¯ãƒ­ã‚°ãŒã‚ã‚‹å ´åˆã€ã™ãã«å®Ÿè¡Œã•ã‚Œãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</li>
</ol>
<h2 id="testing-experimental-ci-features">Testing Experimental CI Features</h2>
<p>CIæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã¯é€šå¸¸ã®CIã®æ­£å¸¸ãªå‹•ä½œã«å¹²æ¸‰ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€æ–°ã—ã„CIæ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹å ´åˆã€ä»¥ä¸‹ã®æ‰‹é †ã«å¾“ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
<ol>
<li>ãƒ†ã‚¹ãƒˆãŒå¿…è¦ãªã‚‚ã®ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®æ–°ã—ã„å°‚ç”¨ã®ã‚¸ãƒ§ãƒ–ã‚’ä½œæˆã—ã¾ã™ã€‚</li>
<li>æ–°ã—ã„ã‚¸ãƒ§ãƒ–ã¯å¸¸ã«æˆåŠŸã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€å¸¸ã«ã‚°ãƒªãƒ¼ãƒ³ âœ“ï¼ˆè©³ç´°ã¯ä»¥ä¸‹å‚ç…§ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</li>
<li>ã•ã¾ã–ã¾ãªç¨®é¡ã®PRï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚©ãƒ¼ã‚¯ãƒ–ãƒ©ãƒ³ãƒã€éãƒ•ã‚©ãƒ¼ã‚¯ãƒ–ãƒ©ãƒ³ãƒã€github.com UIã‹ã‚‰ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒã€ã•ã¾ã–ã¾ãªå¼·åˆ¶ãƒ—ãƒƒã‚·ãƒ¥ãªã©ï¼‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¾ã§ã„ãã¤ã‹ã®æ—¥é–“å®Ÿè¡Œã—ã€å®Ÿé¨“çš„ãªã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã‚’ç›£è¦–ã—ã¾ã™ï¼ˆæ„å›³çš„ã«å¸¸ã«ã‚°ãƒªãƒ¼ãƒ³ã«ãªã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹å…¨ä½“ã®ã‚¸ãƒ§ãƒ–ã®ç·‘ã§ã¯ãªãï¼‰ã€‚</li>
<li>ã™ã¹ã¦ãŒå®‰å®šã—ã¦ã„ã‚‹ã“ã¨ãŒæ˜ç¢ºã«ãªã£ãŸã‚‰ã€æ–°ã—ã„å¤‰æ›´ã‚’æ—¢å­˜ã®ã‚¸ãƒ§ãƒ–ã«çµ±åˆã—ã¾ã™ã€‚</li>
</ol>
<p>ã“ã®ã‚ˆã†ã«ã€CIæ©Ÿèƒ½è‡ªä½“ã®å®Ÿé¨“ãŒé€šå¸¸ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«å¹²æ¸‰ã—ãªã„ã‚ˆã†ã«ã§ãã¾ã™ã€‚</p>
<p>ã§ã¯ã€æ–°ã—ã„CIæ©Ÿèƒ½ãŒé–‹ç™ºä¸­ã§ã‚ã‚‹é–“ã€ã‚¸ãƒ§ãƒ–ã‚’å¸¸ã«æˆåŠŸã•ã›ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°ã„ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ</p>
<p>TravisCIã®ã‚ˆã†ãªä¸€éƒ¨ã®CIã¯ <code>ignore-step-failure</code> ã‚’ã‚µãƒãƒ¼ãƒˆã—ã€å…¨ä½“ã®ã‚¸ãƒ§ãƒ–ã‚’æˆåŠŸã¨ã—ã¦å ±å‘Šã—ã¾ã™ãŒã€ã“ã®æ–‡æ›¸ãŒä½œæˆã•ã‚ŒãŸæ™‚ç‚¹ã§ã¯CircleCIã¨Github Actionsã¯ãã‚Œã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚</p>
<p>ã—ãŸãŒã£ã¦ã€ä»¥ä¸‹ã®ãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ä½¿ç”¨ã§ãã¾ã™ï¼š</p>
<ol>
<li>bashã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§æ½œåœ¨çš„ãªå¤±æ•—ã‚’æŠ‘åˆ¶ã™ã‚‹ãŸã‚ã«å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ã®å†’é ­ã« <code>set +euo pipefail</code> ã‚’è¨˜è¿°ã—ã¾ã™ã€‚</li>
<li>æœ€å¾Œã®ã‚³ãƒãƒ³ãƒ‰ã¯æˆåŠŸã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã° <code>echo "done"</code> ã¾ãŸã¯å˜ã« <code>true</code> ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚</li>
</ol>
<p>ä»¥ä¸‹ã¯ä¾‹ã§ã™ï¼š</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">run CI experiment</span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a><span class="w">        </span><span class="no">set +euo pipefail</span>
</span><span id="__span-86-5"><a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a><span class="w">        </span><span class="no">echo &quot;setting run-all-despite-any-errors-mode&quot;</span>
</span><span id="__span-86-6"><a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a><span class="w">        </span><span class="no">this_command_will_fail</span>
</span><span id="__span-86-7"><a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a><span class="w">        </span><span class="no">echo &quot;but bash continues to run&quot;</span>
</span><span id="__span-86-8"><a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a><span class="w">        </span><span class="no"># emulate another failure</span>
</span><span id="__span-86-9"><a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a><span class="w">        </span><span class="no">false</span>
</span><span id="__span-86-10"><a id="__codelineno-86-10" name="__codelineno-86-10" href="#__codelineno-86-10"></a><span class="w">        </span><span class="no"># but the last command must be a success</span>
</span><span id="__span-86-11"><a id="__codelineno-86-11" name="__codelineno-86-11" href="#__codelineno-86-11"></a><span class="w">        </span><span class="no">echo &quot;during experiment do not remove: reporting success to CI, even if there were failures&quot;</span>
</span></code></pre></div>
<p>å˜ç´”ãªã‚³ãƒãƒ³ãƒ‰ã®å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a>cmd_that_may_fail<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
</span></code></pre></div>
<p>ã‚‚ã¡ã‚ã‚“ã€çµæœã«æº€è¶³ã—ãŸã‚‰ã€å®Ÿé¨“çš„ãªã‚¹ãƒ†ãƒƒãƒ—ã‚„ã‚¸ãƒ§ãƒ–ã‚’é€šå¸¸ã®ã‚¸ãƒ§ãƒ–ã¨çµ±åˆã—ã€<code>set +euo pipefail</code> ãªã©ã®è¿½åŠ ã—ãŸè¦ç´ ã‚’å‰Šé™¤ã—ã¦ã€å®Ÿé¨“çš„ãªã‚¸ãƒ§ãƒ–ãŒé€šå¸¸ã®CIã®å‹•ä½œã«å¹²æ¸‰ã—ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚</p>
<p>ã“ã®ãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ã¯ã€å®Ÿé¨“çš„ãªã‚¹ãƒ†ãƒƒãƒ—ã«å¯¾ã—ã¦ <code>allow-failure</code> ã®ã‚ˆã†ãªã‚‚ã®ã‚’è¨­å®šã—ã€PRã®å…¨ä½“ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å½±éŸ¿ã‚’ä¸ãˆãšã«å¤±æ•—ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚Œã°ã€ã¯ã‚‹ã‹ã«ç°¡å˜ã«ãªã£ãŸã§ã—ã‚‡ã†ã€‚ã—ã‹ã—ã€å‰è¿°ã®é€šã‚Šã€ç¾åœ¨ã¯CircleCIã¨Github Actionsã¯ã“ã®æ©Ÿèƒ½ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚</p>
<p>ã“ã®æ©Ÿèƒ½ã«é–¢ã—ã¦ã®æŠ•ç¥¨ã‚„ã€CIã«ç‰¹æœ‰ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§ãã®é€²æ—çŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™ï¼š</p>
<ul>
<li><a href="https://github.com/actions/toolkit/issues/399">Github Actions:</a></li>
<li><a href="https://ideas.circleci.com/ideas/CCI-I-344">CircleCI:</a></li>
</ul>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../../../..", "features": ["navigation.tabs", "navigation.indexes", "navigation.instant", "navigation.sections", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "content.tabs.link", "content.code.copy"], "search": "../../../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>