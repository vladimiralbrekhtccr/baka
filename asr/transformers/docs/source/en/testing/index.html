
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../../../../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Testing - Ohayou</title>
      
    
    
      <link rel="stylesheet" href="../../../../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../../assets/extra.css">
    
    <script>__md_scope=new URL("../../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#testing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../../.." title="Ohayou" class="md-header__button md-logo" aria-label="Ohayou" data-md-component="logo">
      
  <img src="../../../../../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ohayou
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Testing
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../ohayou/" class="md-tabs__link">
        
  
  
    
  
  Ohayou

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../../vllm/open_ai_vllm_example_a_v_t/" class="md-tabs__link">
          
  
  
    
  
  vLLM

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../../llm/speculative_decoding/" class="md-tabs__link">
          
  
  
    
  
  LLM

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../../vlm/qwen3_vl_4B_object_detection/" class="md-tabs__link">
          
  
  
    
  
  VLM

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../md_format_helpers/" class="md-tabs__link">
        
  
  
    
  
  MD format helpers

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../docker/" class="md-tabs__link">
        
  
  
    
  
  Docker

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../linux/" class="md-tabs__link">
        
  
  
    
  
  Linux

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../moe/" class="md-tabs__link">
        
  
  
    
  
  Mixture of Experts

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../slurm/" class="md-tabs__link">
        
  
  
    
  
  Slurm

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../../japanese-phrases/" class="md-tabs__link">
          
  
  
    
  
  Japanese Phrases

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../../hackathon/index.md" class="md-tabs__link">
        
  
  
    
  
  Hack

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../../.." title="Ohayou" class="md-nav__button md-logo" aria-label="Ohayou" data-md-component="logo">
      
  <img src="../../../../../../assets/logo.png" alt="logo">

    </a>
    Ohayou
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../ohayou/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ohayou
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    vLLM
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            vLLM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../vllm/open_ai_vllm_example_a_v_t/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Single Request
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../vllm/bash_vllm_serve/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bash online serve
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../vllm/benchmarks/performance_eval/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Benchmarks
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    LLM
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            LLM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../llm/speculative_decoding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Speculative Decoding
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    VLM
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            VLM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../vlm/qwen3_vl_4B_object_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Qwen3VL_adema_grounding
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../vlm/qwen3_vla_4B_audio_training_aspandiyar/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Qwen3VLA_aspandiyar_thinking
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../md_format_helpers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MD format helpers
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../docker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Docker
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../linux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Linux
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../moe/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mixture of Experts
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../slurm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Slurm
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../../../japanese-phrases/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Japanese Phrases
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_11" id="__nav_11_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Japanese Phrases
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../../../japanese-phrases/daily-life/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Daily Life
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_11_2" id="__nav_11_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_11_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11_2">
            <span class="md-nav__icon md-icon"></span>
            Daily Life
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../japanese-phrases/daily-life/shopping/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shopping
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../../../japanese-phrases/greetings/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Greetings
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_11_3" id="__nav_11_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_11_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11_3">
            <span class="md-nav__icon md-icon"></span>
            Greetings
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../japanese-phrases/greetings/casual/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Casual
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../japanese-phrases/emotions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Emotions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../japanese-phrases/anime-manga/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Anime/Manga
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../hackathon/index.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hack
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-transformers-are-tested" class="md-nav__link">
    <span class="md-ellipsis">
      How transformers are tested
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Running tests
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Running tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#choosing-which-tests-to-run" class="md-nav__link">
    <span class="md-ellipsis">
      Choosing which tests to run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-the-list-of-all-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Getting the list of all tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-a-specific-test-module" class="md-nav__link">
    <span class="md-ellipsis">
      Run a specific test module
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-specific-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Run specific tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-accelerate-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Run accelerate tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-documentation-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Run documentation tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-only-modified-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Run only modified tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automatically-rerun-failed-tests-on-source-modification" class="md-nav__link">
    <span class="md-ellipsis">
      Automatically rerun failed tests on source modification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skip-a-test-module" class="md-nav__link">
    <span class="md-ellipsis">
      Skip a test module
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clearing-state" class="md-nav__link">
    <span class="md-ellipsis">
      Clearing state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-tests-in-parallel" class="md-nav__link">
    <span class="md-ellipsis">
      Running tests in parallel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-order-and-repetition" class="md-nav__link">
    <span class="md-ellipsis">
      Test order and repetition
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test order and repetition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#repeat-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Repeat tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-tests-in-a-random-order" class="md-nav__link">
    <span class="md-ellipsis">
      Run tests in a random order
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#look-and-feel-variations" class="md-nav__link">
    <span class="md-ellipsis">
      Look and feel variations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Look and feel variations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pytest-sugar" class="md-nav__link">
    <span class="md-ellipsis">
      pytest-sugar
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#report-each-sub-test-name-and-its-progress" class="md-nav__link">
    <span class="md-ellipsis">
      Report each sub-test name and its progress
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instantly-shows-failed-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Instantly shows failed tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#to-gpu-or-not-to-gpu" class="md-nav__link">
    <span class="md-ellipsis">
      To GPU or not to GPU
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-with-a-specific-pytorch-backend-or-device" class="md-nav__link">
    <span class="md-ellipsis">
      Testing with a specific PyTorch backend or device
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#distributed-training" class="md-nav__link">
    <span class="md-ellipsis">
      Distributed training
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#output-capture" class="md-nav__link">
    <span class="md-ellipsis">
      Output capture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#color-control" class="md-nav__link">
    <span class="md-ellipsis">
      Color control
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sending-test-report-to-online-pastebin-service" class="md-nav__link">
    <span class="md-ellipsis">
      Sending test report to online pastebin service
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#writing-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Writing tests
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Writing tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parametrization" class="md-nav__link">
    <span class="md-ellipsis">
      Parametrization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#files-and-directories" class="md-nav__link">
    <span class="md-ellipsis">
      Files and directories
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#temporary-files-and-directories" class="md-nav__link">
    <span class="md-ellipsis">
      Temporary files and directories
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#temporary-syspath-override" class="md-nav__link">
    <span class="md-ellipsis">
      Temporary sys.path override
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skipping-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Skipping tests
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Skipping tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-the-stdoutstderr-output" class="md-nav__link">
    <span class="md-ellipsis">
      Testing the stdout/stderr output
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capturing-logger-stream" class="md-nav__link">
    <span class="md-ellipsis">
      Capturing logger stream
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-with-environment-variables" class="md-nav__link">
    <span class="md-ellipsis">
      Testing with environment variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-reproducible-results" class="md-nav__link">
    <span class="md-ellipsis">
      Getting reproducible results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debugging-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Debugging tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#working-with-github-actions-workflows" class="md-nav__link">
    <span class="md-ellipsis">
      Working with github actions workflows
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-experimental-ci-features" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Experimental CI Features
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deepspeed-integration" class="md-nav__link">
    <span class="md-ellipsis">
      DeepSpeed integration
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<!--Copyright 2020 The HuggingFace Team. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with
the License. You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.

âš ï¸ Note that this file is in Markdown but contain specific syntax for our doc-builder (similar to MDX) that may not be
rendered properly in your Markdown viewer.

-->

<h1 id="testing">Testing</h1>
<p>Let's take a look at how ðŸ¤— Transformers models are tested and how you can write new tests and improve the existing ones.</p>
<p>There are 2 test suites in the repository:</p>
<ol>
<li><code>tests</code> -- tests for the general API</li>
<li><code>examples</code> -- tests primarily for various applications that aren't part of the API</li>
</ol>
<h2 id="how-transformers-are-tested">How transformers are tested</h2>
<ol>
<li>Once a PR is submitted it gets tested with 9 CircleCi jobs. Every new commit to that PR gets retested. These jobs
   are defined in this <a href="https://github.com/huggingface/transformers/tree/main/.circleci/config.yml">config file</a>, so that if needed you can reproduce the same
   environment on your machine.</li>
</ol>
<p>These CI jobs don't run <code>@slow</code> tests.</p>
<ol>
<li>
<p>There are 3 jobs run by <a href="https://github.com/huggingface/transformers/actions">github actions</a>:</p>
</li>
<li>
<p><a href="https://github.com/huggingface/transformers/tree/main/.github/workflows/github-torch-hub.yml">torch hub integration</a>: checks whether torch hub
     integration works.</p>
</li>
<li>
<p><a href="https://github.com/huggingface/transformers/tree/main/.github/workflows/self-push.yml">self-hosted (push)</a>: runs fast tests on GPU only on commits on
     <code>main</code>. It only runs if a commit on <code>main</code> has updated the code in one of the following folders: <code>src</code>,
     <code>tests</code>, <code>.github</code> (to prevent running on added model cards, notebooks, etc.)</p>
</li>
<li>
<p><a href="https://github.com/huggingface/transformers/tree/main/.github/workflows/self-scheduled.yml">self-hosted runner</a>: runs normal and slow tests on GPU in
     <code>tests</code> and <code>examples</code>:</p>
</li>
</ol>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nv">RUN_SLOW</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>pytest<span class="w"> </span>tests/
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nv">RUN_SLOW</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>pytest<span class="w"> </span>examples/
</span></code></pre></div>
<p>The results can be observed <a href="https://github.com/huggingface/transformers/actions">here</a>.</p>
<h2 id="running-tests">Running tests</h2>
<h3 id="choosing-which-tests-to-run">Choosing which tests to run</h3>
<p>This document goes into many details of how tests can be run. If after reading everything, you need even more details
you will find them <a href="https://docs.pytest.org/en/latest/usage.html">here</a>.</p>
<p>Here are some most useful ways of running tests.</p>
<p>Run all:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="go">pytest</span>
</span></code></pre></div>
<p>or:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>make<span class="w"> </span><span class="nb">test</span>
</span></code></pre></div>
<p>Note that the latter is defined as:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>-n<span class="w"> </span>auto<span class="w"> </span>--dist<span class="o">=</span>loadfile<span class="w"> </span>-s<span class="w"> </span>-v<span class="w"> </span>./tests/
</span></code></pre></div>
<p>which tells pytest to:</p>
<ul>
<li>run as many test processes as they are CPU cores (which could be too many if you don't have a ton of RAM!)</li>
<li>ensure that all tests from the same file will be run by the same test process</li>
<li>do not capture output</li>
<li>run in verbose mode</li>
</ul>
<h3 id="getting-the-list-of-all-tests">Getting the list of all tests</h3>
<p>All tests of the test suite:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>pytest<span class="w"> </span>--collect-only<span class="w"> </span>-q
</span></code></pre></div>
<p>All tests of a given test file:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>pytest<span class="w"> </span>tests/test_optimization.py<span class="w"> </span>--collect-only<span class="w"> </span>-q
</span></code></pre></div>
<h3 id="run-a-specific-test-module">Run a specific test module</h3>
<p>To run an individual test module:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>pytest<span class="w"> </span>tests/utils/test_logging.py
</span></code></pre></div>
<h3 id="run-specific-tests">Run specific tests</h3>
<p>Since unittest is used inside most of the tests, to run specific subtests you need to know the name of the unittest
class containing those tests. For example, it could be:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>pytest<span class="w"> </span>tests/test_optimization.py::OptimizationTest::test_adam_w
</span></code></pre></div>
<p>Here:</p>
<ul>
<li><code>tests/test_optimization.py</code> - the file with tests</li>
<li><code>OptimizationTest</code> - the name of the class</li>
<li><code>test_adam_w</code> - the name of the specific test function</li>
</ul>
<p>If the file contains multiple classes, you can choose to run only tests of a given class. For example:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>pytest<span class="w"> </span>tests/test_optimization.py::OptimizationTest
</span></code></pre></div>
<p>will run all the tests inside that class.</p>
<p>As mentioned earlier you can see what tests are contained inside the <code>OptimizationTest</code> class by running:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>pytest<span class="w"> </span>tests/test_optimization.py::OptimizationTest<span class="w"> </span>--collect-only<span class="w"> </span>-q
</span></code></pre></div>
<p>You can run tests by keyword expressions.</p>
<p>To run only tests whose name contains <code>adam</code>:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>pytest<span class="w"> </span>-k<span class="w"> </span>adam<span class="w"> </span>tests/test_optimization.py
</span></code></pre></div>
<p>Logical <code>and</code> and <code>or</code> can be used to indicate whether all keywords should match or either. <code>not</code> can be used to
negate.</p>
<p>To run all tests except those whose name contains <code>adam</code>:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>pytest<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;not adam&quot;</span><span class="w"> </span>tests/test_optimization.py
</span></code></pre></div>
<p>And you can combine the two patterns in one:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>pytest<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;ada and not adam&quot;</span><span class="w"> </span>tests/test_optimization.py
</span></code></pre></div>
<p>For example to run both <code>test_adafactor</code> and <code>test_adam_w</code> you can use:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>pytest<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;test_adafactor or test_adam_w&quot;</span><span class="w"> </span>tests/test_optimization.py
</span></code></pre></div>
<p>Note that we use <code>or</code> here, since we want either of the keywords to match to include both.</p>
<p>If you want to include only tests that include both patterns, <code>and</code> is to be used:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>pytest<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;test and ada&quot;</span><span class="w"> </span>tests/test_optimization.py
</span></code></pre></div>
<h3 id="run-accelerate-tests">Run <code>accelerate</code> tests</h3>
<p>Sometimes you need to run <code>accelerate</code> tests on your models. For that you can just add <code>-m accelerate_tests</code> to your command, if let's say you want to run these tests on <code>OPT</code> run:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="nv">RUN_SLOW</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span>accelerate_tests<span class="w"> </span>tests/models/opt/test_modeling_opt.py
</span></code></pre></div>
<h3 id="run-documentation-tests">Run documentation tests</h3>
<p>In order to test whether the documentation examples are correct, you should check that the <code>doctests</code> are passing.
As an example, let's use <a href="https://github.com/huggingface/transformers/blob/1124d95dbb1a3512d3e80791d73d0f541d1d7e9f/src/transformers/models/whisper/modeling_whisper.py#L1591-L1609"><code>WhisperModel.forward</code>'s docstring</a></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="sd">Returns:</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="sd">Example:</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="sd">    ```python</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="sd">    &gt;&gt;&gt; import torch</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="sd">    &gt;&gt;&gt; from transformers import WhisperModel, WhisperFeatureExtractor</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="sd">    &gt;&gt;&gt; from datasets import load_dataset</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="sd">    &gt;&gt;&gt; model = WhisperModel.from_pretrained(&quot;openai/whisper-base&quot;)</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="sd">    &gt;&gt;&gt; feature_extractor = WhisperFeatureExtractor.from_pretrained(&quot;openai/whisper-base&quot;)</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="sd">    &gt;&gt;&gt; ds = load_dataset(&quot;hf-internal-testing/librispeech_asr_dummy&quot;, &quot;clean&quot;, split=&quot;validation&quot;)</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="sd">    &gt;&gt;&gt; inputs = feature_extractor(ds[0][&quot;audio&quot;][&quot;array&quot;], return_tensors=&quot;pt&quot;)</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="sd">    &gt;&gt;&gt; input_features = inputs.input_features</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="sd">    &gt;&gt;&gt; decoder_input_ids = torch.tensor([[1, 1]]) * model.config.decoder_start_token_id</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="sd">    &gt;&gt;&gt; last_hidden_state = model(input_features, decoder_input_ids=decoder_input_ids).last_hidden_state</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="sd">    &gt;&gt;&gt; list(last_hidden_state.shape)</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="sd">    [1, 2, 512]</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="sd">    ```&quot;&quot;&quot;</span>
</span></code></pre></div>
<p>Just run the following line to automatically test every docstring example in the desired file:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>pytest<span class="w"> </span>--doctest-modules<span class="w"> </span>&lt;path_to_file_or_dir&gt;
</span></code></pre></div>
<p>If the file has a markdown extension, you should add the <code>--doctest-glob="*.md"</code> argument.</p>
<h3 id="run-only-modified-tests">Run only modified tests</h3>
<p>You can run the tests related to the unstaged files or the current branch (according to Git) by using <a href="https://github.com/anapaulagomes/pytest-picked">pytest-picked</a>. This is a great way of quickly testing your changes didn't break
anything, since it won't run the tests related to files you didn't touch.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>pip<span class="w"> </span>install<span class="w"> </span>pytest-picked
</span></code></pre></div>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>pytest<span class="w"> </span>--picked
</span></code></pre></div>
<p>All tests will be run from files and folders which are modified, but not yet committed.</p>
<h3 id="automatically-rerun-failed-tests-on-source-modification">Automatically rerun failed tests on source modification</h3>
<p><a href="https://github.com/pytest-dev/pytest-xdist">pytest-xdist</a> provides a very useful feature of detecting all failed
tests, and then waiting for you to modify files and continuously re-rerun those failing tests until they pass while you
fix them. So that you don't need to re start pytest after you made the fix. This is repeated until all tests pass after
which again a full run is performed.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>pip<span class="w"> </span>install<span class="w"> </span>pytest-xdist
</span></code></pre></div>
<p>To enter the mode: <code>pytest -f</code> or <code>pytest --looponfail</code></p>
<p>File changes are detected by looking at <code>looponfailroots</code> root directories and all of their contents (recursively).
If the default for this value does not work for you, you can change it in your project by setting a configuration
option in <code>setup.cfg</code>:</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">[tool:pytest]</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="na">looponfailroots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">transformers tests</span>
</span></code></pre></div>
<p>or <code>pytest.ini</code>/<code>tox.ini</code> files:</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="k">[pytest]</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="na">looponfailroots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">transformers tests</span>
</span></code></pre></div>
<p>This would lead to only looking for file changes in the respective directories, specified relatively to the ini-file's directory.</p>
<p><a href="https://github.com/joeyespo/pytest-watch">pytest-watch</a> is an alternative implementation of this functionality.</p>
<h3 id="skip-a-test-module">Skip a test module</h3>
<p>If you want to run all test modules, except a few you can exclude them by giving an explicit list of tests to run. For
example, to run all except <code>test_modeling_*.py</code> tests:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>pytest<span class="w"> </span>*ls<span class="w"> </span>-1<span class="w"> </span>tests/*py<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span>test_modeling*
</span></code></pre></div>
<h3 id="clearing-state">Clearing state</h3>
<p>CI builds and when isolation is important (against speed), cache should be cleared:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>pytest<span class="w"> </span>--cache-clear<span class="w"> </span>tests
</span></code></pre></div>
<h3 id="running-tests-in-parallel">Running tests in parallel</h3>
<p>As mentioned earlier <code>make test</code> runs tests in parallel via <code>pytest-xdist</code> plugin (<code>-n X</code> argument, e.g. <code>-n 2</code>
to run 2 parallel jobs).</p>
<p><code>pytest-xdist</code>'s <code>--dist=</code> option allows one to control how the tests are grouped. <code>--dist=loadfile</code> puts the
tests located in one file onto the same process.</p>
<p>Since the order of executed tests is different and unpredictable, if running the test suite with <code>pytest-xdist</code>
produces failures (meaning we have some undetected coupled tests), use <a href="https://github.com/ESSS/pytest-replay">pytest-replay</a> to replay the tests in the same order, which should help with then somehow
reducing that failing sequence to a minimum.</p>
<h3 id="test-order-and-repetition">Test order and repetition</h3>
<p>It's good to repeat the tests several times, in sequence, randomly, or in sets, to detect any potential
inter-dependency and state-related bugs (tear down). And the straightforward multiple repetition is just good to detect
some problems that get uncovered by randomness of DL.</p>
<h4 id="repeat-tests">Repeat tests</h4>
<ul>
<li><a href="https://github.com/dropbox/pytest-flakefinder">pytest-flakefinder</a>:</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>pip<span class="w"> </span>install<span class="w"> </span>pytest-flakefinder
</span></code></pre></div>
<p>And then run every test multiple times (50 by default):</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>pytest<span class="w"> </span>--flake-finder<span class="w"> </span>--flake-runs<span class="o">=</span><span class="m">5</span><span class="w"> </span>tests/test_failing_test.py
</span></code></pre></div>
<p><Tip></p>
<p>This plugin doesn't work with <code>-n</code> flag from <code>pytest-xdist</code>.</p>
<p></Tip></p>
<p><Tip></p>
<p>There is another plugin <code>pytest-repeat</code>, but it doesn't work with <code>unittest</code>.</p>
<p></Tip></p>
<h4 id="run-tests-in-a-random-order">Run tests in a random order</h4>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>pip<span class="w"> </span>install<span class="w"> </span>pytest-random-order
</span></code></pre></div>
<p>Important: the presence of <code>pytest-random-order</code> will automatically randomize tests, no configuration change or
command line options is required.</p>
<p>As explained earlier this allows detection of coupled tests - where one test's state affects the state of another. When
<code>pytest-random-order</code> is installed it will print the random seed it used for that session, e.g:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>pytest<span class="w"> </span>tests
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="o">[</span>...<span class="o">]</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>Using<span class="w"> </span>--random-order-bucket<span class="o">=</span>module
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>Using<span class="w"> </span>--random-order-seed<span class="o">=</span><span class="m">573663</span>
</span></code></pre></div>
<p>So that if the given particular sequence fails, you can reproduce it by adding that exact seed, e.g.:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>pytest<span class="w"> </span>--random-order-seed<span class="o">=</span><span class="m">573663</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="o">[</span>...<span class="o">]</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>Using<span class="w"> </span>--random-order-bucket<span class="o">=</span>module
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>Using<span class="w"> </span>--random-order-seed<span class="o">=</span><span class="m">573663</span>
</span></code></pre></div>
<p>It will only reproduce the exact order if you use the exact same list of tests (or no list at all). Once you start to
manually narrowing down the list you can no longer rely on the seed, but have to list them manually in the exact order
they failed and tell pytest to not randomize them instead using <code>--random-order-bucket=none</code>, e.g.:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>pytest<span class="w"> </span>--random-order-bucket<span class="o">=</span>none<span class="w"> </span>tests/test_a.py<span class="w"> </span>tests/test_c.py<span class="w"> </span>tests/test_b.py
</span></code></pre></div>
<p>To disable the shuffling for all tests:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>pytest<span class="w"> </span>--random-order-bucket<span class="o">=</span>none
</span></code></pre></div>
<p>By default <code>--random-order-bucket=module</code> is implied, which will shuffle the files on the module levels. It can also
shuffle on <code>class</code>, <code>package</code>, <code>global</code> and <code>none</code> levels. For the complete details please see its
<a href="https://github.com/jbasko/pytest-random-order">documentation</a>.</p>
<p>Another randomization alternative is: <a href="https://github.com/pytest-dev/pytest-randomly"><code>pytest-randomly</code></a>. This
module has a very similar functionality/interface, but it doesn't have the bucket modes available in
<code>pytest-random-order</code>. It has the same problem of imposing itself once installed.</p>
<h3 id="look-and-feel-variations">Look and feel variations</h3>
<h4 id="pytest-sugar">pytest-sugar</h4>
<p><a href="https://github.com/Frozenball/pytest-sugar">pytest-sugar</a> is a plugin that improves the look-n-feel, adds a
progressbar, and show tests that fail and the assert instantly. It gets activated automatically upon installation.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>pip<span class="w"> </span>install<span class="w"> </span>pytest-sugar
</span></code></pre></div>
<p>To run tests without it, run:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>pytest<span class="w"> </span>-p<span class="w"> </span>no:sugar
</span></code></pre></div>
<p>or uninstall it.</p>
<h4 id="report-each-sub-test-name-and-its-progress">Report each sub-test name and its progress</h4>
<p>For a single or a group of tests via <code>pytest</code> (after <code>pip install pytest-pspec</code>):</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>pytest<span class="w"> </span>--pspec<span class="w"> </span>tests/test_optimization.py
</span></code></pre></div>
<h4 id="instantly-shows-failed-tests">Instantly shows failed tests</h4>
<p><a href="https://github.com/pytest-dev/pytest-instafail">pytest-instafail</a> shows failures and errors instantly instead of
waiting until the end of test session.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>pip<span class="w"> </span>install<span class="w"> </span>pytest-instafail
</span></code></pre></div>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>pytest<span class="w"> </span>--instafail
</span></code></pre></div>
<h3 id="to-gpu-or-not-to-gpu">To GPU or not to GPU</h3>
<p>On a GPU-enabled setup, to test in CPU-only mode add <code>CUDA_VISIBLE_DEVICES=""</code> for CUDA GPUs:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="w"> </span>pytest<span class="w"> </span>tests/utils/test_logging.py
</span></code></pre></div>
<p>or if you have multiple gpus, you can specify which one is to be used by <code>pytest</code>. For example, to use only the
second gpu if you have gpus <code>0</code> and <code>1</code>, you can run:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="w"> </span>pytest<span class="w"> </span>tests/utils/test_logging.py
</span></code></pre></div>
<p>For Intel GPUs, use <code>ZE_AFFINITY_MASK</code> instead of <code>CUDA_VISIBLE_DEVICES</code> in the above example.</p>
<p>This is handy when you want to run different tasks on different GPUs.</p>
<p>Some tests must be run on CPU-only, others on either CPU or GPU or TPU, yet others on multiple-GPUs. The following skip
decorators are used to set the requirements of tests CPU/GPU/XPU/TPU-wise:</p>
<ul>
<li><code>require_torch</code> - this test will run only under torch</li>
<li><code>require_torch_gpu</code> - as <code>require_torch</code> plus requires at least 1 GPU</li>
<li><code>require_torch_multi_gpu</code> - as <code>require_torch</code> plus requires at least 2 GPUs</li>
<li><code>require_torch_non_multi_gpu</code> - as <code>require_torch</code> plus requires 0 or 1 GPUs</li>
<li><code>require_torch_up_to_2_gpus</code> - as <code>require_torch</code> plus requires 0 or 1 or 2 GPUs</li>
<li><code>require_torch_xla</code> - as <code>require_torch</code> plus requires at least 1 TPU</li>
</ul>
<p>Let's depict the GPU requirements in the following table:</p>
<table>
<thead>
<tr>
<th>n gpus</th>
<th>decorator</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&gt;= 0</code></td>
<td><code>@require_torch</code></td>
</tr>
<tr>
<td><code>&gt;= 1</code></td>
<td><code>@require_torch_gpu</code></td>
</tr>
<tr>
<td><code>&gt;= 2</code></td>
<td><code>@require_torch_multi_gpu</code></td>
</tr>
<tr>
<td><code>&lt; 2</code></td>
<td><code>@require_torch_non_multi_gpu</code></td>
</tr>
<tr>
<td><code>&lt; 3</code></td>
<td><code>@require_torch_up_to_2_gpus</code></td>
</tr>
</tbody>
</table>
<p>For example, here is a test that must be run only when there are 2 or more GPUs available and pytorch is installed:</p>
<p>```python no-style
@require_torch_multi_gpu
def test_example_with_multi_gpu():
<div class="language-bash highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>These<span class="w"> </span>decorators<span class="w"> </span>can<span class="w"> </span>be<span class="w"> </span>stacked.<span class="w"> </span>For<span class="w"> </span>example,<span class="w"> </span><span class="k">if</span><span class="w"> </span>a<span class="w"> </span><span class="nb">test</span><span class="w"> </span>is<span class="w"> </span>slow<span class="w"> </span>and<span class="w"> </span>requires<span class="w"> </span>at<span class="w"> </span>least<span class="w"> </span>one<span class="w"> </span>GPU<span class="w"> </span>under<span class="w"> </span>pytorch,<span class="w"> </span>here<span class="w"> </span>is
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>how<span class="w"> </span>to<span class="w"> </span><span class="nb">set</span><span class="w"> </span>it<span class="w"> </span>up:
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="sb">```</span>python<span class="w"> </span>no-style
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>@require_torch_gpu
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>@slow
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a>def<span class="w"> </span>test_example_slow_on_gpu<span class="o">()</span>:
</span></code></pre></div></p>
<p>Some decorators like <code>@parametrized</code> rewrite test names, therefore <code>@require_*</code> skip decorators have to be listed
last for them to work correctly. Here is an example of the correct usage:</p>
<p>```python no-style
@parameterized.expand(...)
@require_torch_multi_gpu
def test_integration_foo():
<div class="language-bash highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>This<span class="w"> </span>order<span class="w"> </span>problem<span class="w"> </span>doesn<span class="err">&#39;</span>t<span class="w"> </span>exist<span class="w"> </span>with<span class="w"> </span><span class="sb">`</span>@pytest.mark.parametrize<span class="sb">`</span>,<span class="w"> </span>you<span class="w"> </span>can<span class="w"> </span>put<span class="w"> </span>it<span class="w"> </span>first<span class="w"> </span>or<span class="w"> </span>last<span class="w"> </span>and<span class="w"> </span>it<span class="w"> </span>will<span class="w"> </span>still
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>work.<span class="w"> </span>But<span class="w"> </span>it<span class="w"> </span>only<span class="w"> </span>works<span class="w"> </span>with<span class="w"> </span>non-unittests.
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>Inside<span class="w"> </span>tests:
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>-<span class="w"> </span>How<span class="w"> </span>many<span class="w"> </span>GPUs<span class="w"> </span>are<span class="w"> </span>available:
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a>
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="sb">```</span>python
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a>from<span class="w"> </span>transformers.testing_utils<span class="w"> </span>import<span class="w"> </span>get_gpu_count
</span><span id="__span-40-10"><a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a>
</span><span id="__span-40-11"><a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a><span class="nv">n_gpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>get_gpu_count<span class="o">()</span>
</span></code></pre></div></p>
<h3 id="testing-with-a-specific-pytorch-backend-or-device">Testing with a specific PyTorch backend or device</h3>
<p>To run the test suite on a specific torch device add <code>TRANSFORMERS_TEST_DEVICE="$device"</code> where <code>$device</code> is the target backend. For example, to test on CPU only:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="nv">TRANSFORMERS_TEST_DEVICE</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="w"> </span>pytest<span class="w"> </span>tests/utils/test_logging.py
</span></code></pre></div>
<p>This variable is useful for testing custom or less common PyTorch backends such as <code>mps</code>, <code>xpu</code> or <code>npu</code>. It can also be used to achieve the same effect as <code>CUDA_VISIBLE_DEVICES</code> by targeting specific GPUs or testing in CPU-only mode.</p>
<p>Certain devices will require an additional import after importing <code>torch</code> for the first time. This can be specified using the environment variable <code>TRANSFORMERS_TEST_BACKEND</code>:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="nv">TRANSFORMERS_TEST_BACKEND</span><span class="o">=</span><span class="s2">&quot;torch_npu&quot;</span><span class="w"> </span>pytest<span class="w"> </span>tests/utils/test_logging.py
</span></code></pre></div>
<p>Alternative backends may also require the replacement of device-specific functions. For example <code>torch.cuda.manual_seed</code> may need to be replaced with a device-specific seed setter like <code>torch.npu.manual_seed</code> or <code>torch.xpu.manual_seed</code> to correctly set a random seed on the device. To specify a new backend with backend-specific device functions when running the test suite, create a Python device specification file <code>spec.py</code> in the format:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch_npu</span> <span class="c1"># for xpu, replace it with `import intel_extension_for_pytorch`</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="c1"># !! Further additional imports can be added here !!</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="c1"># Specify the device name (eg. &#39;cuda&#39;, &#39;cpu&#39;, &#39;npu&#39;, &#39;xpu&#39;, &#39;mps&#39;)</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="n">DEVICE_NAME</span> <span class="o">=</span> <span class="s1">&#39;npu&#39;</span>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="c1"># Specify device-specific backends to dispatch to.</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="c1"># If not specified, will fallback to &#39;default&#39; in &#39;testing_utils.py`</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="n">MANUAL_SEED_FN</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">npu</span><span class="o">.</span><span class="n">manual_seed</span>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="n">EMPTY_CACHE_FN</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">npu</span><span class="o">.</span><span class="n">empty_cache</span>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="n">DEVICE_COUNT_FN</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">npu</span><span class="o">.</span><span class="n">device_count</span>
</span></code></pre></div>
<p>This format also allows for specification of any additional imports required. To use this file to replace equivalent methods in the test suite, set the environment variable <code>TRANSFORMERS_TEST_DEVICE_SPEC</code> to the path of the spec file, e.g. <code>TRANSFORMERS_TEST_DEVICE_SPEC=spec.py</code>.</p>
<p>Currently, only <code>MANUAL_SEED_FN</code>, <code>EMPTY_CACHE_FN</code> and <code>DEVICE_COUNT_FN</code> are supported for device-specific dispatch.</p>
<h3 id="distributed-training">Distributed training</h3>
<p><code>pytest</code> can't deal with distributed training directly. If this is attempted - the sub-processes don't do the right
thing and end up thinking they are <code>pytest</code> and start running the test suite in loops. It works, however, if one
spawns a normal process that then spawns off multiple workers and manages the IO pipes.</p>
<p>Here are some tests that use it:</p>
<ul>
<li><a href="https://github.com/huggingface/transformers/tree/main/tests/trainer/test_trainer_distributed.py">test_trainer_distributed.py</a></li>
<li><a href="https://github.com/huggingface/transformers/tree/main/tests/deepspeed/test_deepspeed.py">test_deepspeed.py</a></li>
</ul>
<p>To jump right into the execution point, search for the <code>execute_subprocess_async</code> call in those tests.</p>
<p>You will need at least 2 GPUs to see these tests in action:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span>,1<span class="w"> </span><span class="nv">RUN_SLOW</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>pytest<span class="w"> </span>-sv<span class="w"> </span>tests/test_trainer_distributed.py
</span></code></pre></div>
<h3 id="output-capture">Output capture</h3>
<p>During test execution any output sent to <code>stdout</code> and <code>stderr</code> is captured. If a test or a setup method fails, its
according captured output will usually be shown along with the failure traceback.</p>
<p>To disable output capturing and to get the <code>stdout</code> and <code>stderr</code> normally, use <code>-s</code> or <code>--capture=no</code>:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>pytest<span class="w"> </span>-s<span class="w"> </span>tests/utils/test_logging.py
</span></code></pre></div>
<p>To send test results to JUnit format output:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>pytest<span class="w"> </span>tests<span class="w"> </span>--junitxml<span class="o">=</span>result.xml
</span></code></pre></div>
<h3 id="color-control">Color control</h3>
<p>To have no color (e.g., yellow on white background is not readable):</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>pytest<span class="w"> </span>--color<span class="o">=</span>no<span class="w"> </span>tests/utils/test_logging.py
</span></code></pre></div>
<h3 id="sending-test-report-to-online-pastebin-service">Sending test report to online pastebin service</h3>
<p>Creating a URL for each test failure:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>pytest<span class="w"> </span>--pastebin<span class="o">=</span>failed<span class="w"> </span>tests/utils/test_logging.py
</span></code></pre></div>
<p>This will submit test run information to a remote Paste service and provide a URL for each failure. You may select
tests as usual or add for example -x if you only want to send one particular failure.</p>
<p>Creating a URL for a whole test session log:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>pytest<span class="w"> </span>--pastebin<span class="o">=</span>all<span class="w"> </span>tests/utils/test_logging.py
</span></code></pre></div>
<h2 id="writing-tests">Writing tests</h2>
<p>ðŸ¤— transformers tests are based on <code>unittest</code>, but run by <code>pytest</code>, so most of the time features from both systems
can be used.</p>
<p>You can read <a href="https://docs.pytest.org/en/stable/unittest.html">here</a> which features are supported, but the important
thing to remember is that most <code>pytest</code> fixtures don't work. Neither parametrization, but we use the module
<code>parameterized</code> that works in a similar way.</p>
<h3 id="parametrization">Parametrization</h3>
<p>Often, there is a need to run the same test multiple times, but with different arguments. It could be done from within
the test, but then there is no way of running that test for just one set of arguments.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="c1"># test_this1.py</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">unittest</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">parameterized</span><span class="w"> </span><span class="kn">import</span> <span class="n">parameterized</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestMathUnitTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a>    <span class="nd">@parameterized</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a>        <span class="p">[</span>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a>            <span class="p">(</span><span class="s2">&quot;negative&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">),</span>
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a>            <span class="p">(</span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a>            <span class="p">(</span><span class="s2">&quot;large fraction&quot;</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="__span-50-12"><a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a>        <span class="p">]</span>
</span><span id="__span-50-13"><a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a>    <span class="p">)</span>
</span><span id="__span-50-14"><a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_floor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
</span><span id="__span-50-15"><a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a>        <span class="n">assert_equal</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span> <span class="n">expected</span><span class="p">)</span>
</span></code></pre></div>
<p>Now, by default this test will be run 3 times, each time with the last 3 arguments of <code>test_floor</code> being assigned the
corresponding arguments in the parameter list.</p>
<p>and you could run just the <code>negative</code> and <code>integer</code> sets of params with:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>pytest<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;negative and integer&quot;</span><span class="w"> </span>tests/test_mytest.py
</span></code></pre></div>
<p>or all but <code>negative</code> sub-tests, with:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>pytest<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;not negative&quot;</span><span class="w"> </span>tests/test_mytest.py
</span></code></pre></div>
<p>Besides using the <code>-k</code> filter that was just mentioned, you can find out the exact name of each sub-test and run any
or all of them using their exact names.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>pytest<span class="w"> </span>test_this1.py<span class="w"> </span>--collect-only<span class="w"> </span>-q
</span></code></pre></div>
<p>and it will list:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a>test_this1.py::TestMathUnitTest::test_floor_0_negative
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>test_this1.py::TestMathUnitTest::test_floor_1_integer
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a>test_this1.py::TestMathUnitTest::test_floor_2_large_fraction
</span></code></pre></div>
<p>So now you can run just 2 specific sub-tests:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a>pytest<span class="w"> </span>test_this1.py::TestMathUnitTest::test_floor_0_negative<span class="w">  </span>test_this1.py::TestMathUnitTest::test_floor_1_integer
</span></code></pre></div>
<p>The module <a href="https://pypi.org/project/parameterized/">parameterized</a> which is already in the developer dependencies
of <code>transformers</code> works for both: <code>unittests</code> and <code>pytest</code> tests.</p>
<p>If, however, the test is not a <code>unittest</code>, you may use <code>pytest.mark.parametrize</code> (or you may see it being used in
some existing tests, mostly under <code>examples</code>).</p>
<p>Here is the same example, this time using <code>pytest</code>'s <code>parametrize</code> marker:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="c1"># test_this2.py</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a>    <span class="s2">&quot;name, input, expected&quot;</span><span class="p">,</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a>    <span class="p">[</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a>        <span class="p">(</span><span class="s2">&quot;negative&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">),</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a>        <span class="p">(</span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a>        <span class="p">(</span><span class="s2">&quot;large fraction&quot;</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a>    <span class="p">],</span>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a><span class="p">)</span>
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_floor</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a>    <span class="n">assert_equal</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span> <span class="n">expected</span><span class="p">)</span>
</span></code></pre></div>
<p>Same as with <code>parameterized</code>, with <code>pytest.mark.parametrize</code> you can have a fine control over which sub-tests are
run, if the <code>-k</code> filter doesn't do the job. Except, this parametrization function creates a slightly different set of
names for the sub-tests. Here is what they look like:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a>pytest<span class="w"> </span>test_this2.py<span class="w"> </span>--collect-only<span class="w"> </span>-q
</span></code></pre></div>
<p>and it will list:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a>test_this2.py::test_floor<span class="o">[</span>integer-1-1.0<span class="o">]</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>test_this2.py::test_floor<span class="o">[</span>negative--1.5--2.0<span class="o">]</span>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>test_this2.py::test_floor<span class="o">[</span>large<span class="w"> </span>fraction-1.6-1<span class="o">]</span>
</span></code></pre></div>
<p>So now you can run just the specific test:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a>pytest<span class="w"> </span>test_this2.py::test_floor<span class="o">[</span>negative--1.5--2.0<span class="o">]</span><span class="w"> </span>test_this2.py::test_floor<span class="o">[</span>integer-1-1.0<span class="o">]</span>
</span></code></pre></div>
<p>as in the previous example.</p>
<h3 id="files-and-directories">Files and directories</h3>
<p>In tests often we need to know where things are relative to the current test file, and it's not trivial since the test
could be invoked from more than one directory or could reside in sub-directories with different depths. A helper class
<code>transformers.test_utils.TestCasePlus</code> solves this problem by sorting out all the basic paths and provides easy
accessors to them:</p>
<ul>
<li>
<p><code>pathlib</code> objects (all fully resolved):</p>
</li>
<li>
<p><code>test_file_path</code> - the current test file path, i.e. <code>__file__</code></p>
</li>
<li><code>test_file_dir</code> - the directory containing the current test file</li>
<li><code>tests_dir</code> - the directory of the <code>tests</code> test suite</li>
<li><code>examples_dir</code> - the directory of the <code>examples</code> test suite</li>
<li><code>repo_root_dir</code> - the directory of the repository</li>
<li>
<p><code>src_dir</code> - the directory of <code>src</code> (i.e. where the <code>transformers</code> sub-dir resides)</p>
</li>
<li>
<p>stringified paths---same as above but these return paths as strings, rather than <code>pathlib</code> objects:</p>
</li>
<li>
<p><code>test_file_path_str</code></p>
</li>
<li><code>test_file_dir_str</code></li>
<li><code>tests_dir_str</code></li>
<li><code>examples_dir_str</code></li>
<li><code>repo_root_dir_str</code></li>
<li><code>src_dir_str</code></li>
</ul>
<p>To start using those all you need is to make sure that the test resides in a subclass of
<code>transformers.test_utils.TestCasePlus</code>. For example:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestCasePlus</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">PathExampleTest</span><span class="p">(</span><span class="n">TestCasePlus</span><span class="p">):</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_something_involving_local_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>        <span class="n">data_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests_dir</span> <span class="o">/</span> <span class="s2">&quot;fixtures/tests_samples/wmt_en_ro&quot;</span>
</span></code></pre></div>
<p>If you don't need to manipulate paths via <code>pathlib</code> or you just need a path as a string, you can always invoked
<code>str()</code> on the <code>pathlib</code> object or use the accessors ending with <code>_str</code>. For example:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestCasePlus</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">PathExampleTest</span><span class="p">(</span><span class="n">TestCasePlus</span><span class="p">):</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_something_involving_stringified_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>        <span class="n">examples_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">examples_dir_str</span>
</span></code></pre></div>
<h3 id="temporary-files-and-directories">Temporary files and directories</h3>
<p>Using unique temporary files and directories are essential for parallel test running, so that the tests won't overwrite
each other's data. Also we want to get the temporary files and directories removed at the end of each test that created
them. Therefore, using packages like <code>tempfile</code>, which address these needs is essential.</p>
<p>However, when debugging tests, you need to be able to see what goes into the temporary file or directory and you want
to know it's exact path and not having it randomized on every test re-run.</p>
<p>A helper class <code>transformers.test_utils.TestCasePlus</code> is best used for such purposes. It's a sub-class of
<code>unittest.TestCase</code>, so we can easily inherit from it in the test modules.</p>
<p>Here is an example of its usage:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestCasePlus</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">ExamplesTests</span><span class="p">(</span><span class="n">TestCasePlus</span><span class="p">):</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_whatever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>        <span class="n">tmp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_remove_tmp_dir</span><span class="p">()</span>
</span></code></pre></div>
<p>This code creates a unique temporary directory, and sets <code>tmp_dir</code> to its location.</p>
<ul>
<li>Create a unique temporary dir:</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_whatever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>    <span class="n">tmp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_remove_tmp_dir</span><span class="p">()</span>
</span></code></pre></div>
<p><code>tmp_dir</code> will contain the path to the created temporary dir. It will be automatically removed at the end of the
test.</p>
<ul>
<li>Create a temporary dir of my choice, ensure it's empty before the test starts and don't empty it after the test.</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_whatever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>    <span class="n">tmp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_remove_tmp_dir</span><span class="p">(</span><span class="s2">&quot;./xxx&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>This is useful for debug when you want to monitor a specific directory and want to make sure the previous tests didn't
leave any data in there.</p>
<ul>
<li>
<p>You can override the default behavior by directly overriding the <code>before</code> and <code>after</code> args, leading to one of the
  following behaviors:</p>
</li>
<li>
<p><code>before=True</code>: the temporary dir will always be cleared at the beginning of the test.</p>
</li>
<li><code>before=False</code>: if the temporary dir already existed, any existing files will remain there.</li>
<li><code>after=True</code>: the temporary dir will always be deleted at the end of the test.</li>
<li><code>after=False</code>: the temporary dir will always be left intact at the end of the test.</li>
</ul>
<p><Tip></p>
<p>In order to run the equivalent of <code>rm -r</code> safely, only subdirs of the project repository checkout are allowed if
an explicit <code>tmp_dir</code> is used, so that by mistake no <code>/tmp</code> or similar important part of the filesystem will
get nuked. i.e. please always pass paths that start with <code>./</code>.</p>
<p></Tip></p>
<p><Tip></p>
<p>Each test can register multiple temporary directories and they all will get auto-removed, unless requested
otherwise.</p>
<p></Tip></p>
<h3 id="temporary-syspath-override">Temporary sys.path override</h3>
<p>If you need to temporary override <code>sys.path</code> to import from another test for example, you can use the
<code>ExtendSysPath</code> context manager. Example:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExtendSysPath</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="n">bindir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="k">with</span> <span class="n">ExtendSysPath</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bindir</span><span class="si">}</span><span class="s2">/..&quot;</span><span class="p">):</span>
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">test_trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">TrainerIntegrationCommon</span>  <span class="c1"># noqa</span>
</span></code></pre></div>
<h3 id="skipping-tests">Skipping tests</h3>
<p>This is useful when a bug is found and a new test is written, yet the bug is not fixed yet. In order to be able to
commit it to the main repository we need make sure it's skipped during <code>make test</code>.</p>
<p>Methods:</p>
<ul>
<li>
<p>A <strong>skip</strong> means that you expect your test to pass only if some conditions are met, otherwise pytest should skip
  running the test altogether. Common examples are skipping windows-only tests on non-windows platforms, or skipping
  tests that depend on an external resource which is not available at the moment (for example a database).</p>
</li>
<li>
<p>A <strong>xfail</strong> means that you expect a test to fail for some reason. A common example is a test for a feature not yet
  implemented, or a bug not yet fixed. When a test passes despite being expected to fail (marked with
  pytest.mark.xfail), it's an xpass and will be reported in the test summary.</p>
</li>
</ul>
<p>One of the important differences between the two is that <code>skip</code> doesn't run the test, and <code>xfail</code> does. So if the
code that's buggy causes some bad state that will affect other tests, do not use <code>xfail</code>.</p>
<h4 id="implementation">Implementation</h4>
<ul>
<li>Here is how to skip whole test unconditionally:</li>
</ul>
<p>```python no-style
@unittest.skip(reason="this bug needs to be fixed")
def test_feature_x():
<div class="language-bash highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>or<span class="w"> </span>via<span class="w"> </span>pytest:
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="sb">```</span>python<span class="w"> </span>no-style
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>@pytest.mark.skip<span class="o">(</span><span class="nv">reason</span><span class="o">=</span><span class="s2">&quot;this bug needs to be fixed&quot;</span><span class="o">)</span>
</span></code></pre></div></p>
<p>or the <code>xfail</code> way:</p>
<p>```python no-style
@pytest.mark.xfail
def test_feature_x():
<div class="language-bash highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>Here<span class="err">&#39;</span>s<span class="w"> </span>how<span class="w"> </span>to<span class="w"> </span>skip<span class="w"> </span>a<span class="w"> </span><span class="nb">test</span><span class="w"> </span>based<span class="w"> </span>on<span class="w"> </span>internal<span class="w"> </span>checks<span class="w"> </span>within<span class="w"> </span>the<span class="w"> </span>test:
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="sb">```</span>python
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a>def<span class="w"> </span>test_feature_x<span class="o">()</span>:
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span>not<span class="w"> </span>has_something<span class="o">()</span>:
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a><span class="w">        </span>pytest.skip<span class="o">(</span><span class="s2">&quot;unsupported configuration&quot;</span><span class="o">)</span>
</span></code></pre></div></p>
<p>or the whole module:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">pytest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;--custom-flag&quot;</span><span class="p">):</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>    <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;--custom-flag is missing, skipping tests&quot;</span><span class="p">,</span> <span class="n">allow_module_level</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></code></pre></div>
<p>or the <code>xfail</code> way:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_feature_x</span><span class="p">():</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a>    <span class="n">pytest</span><span class="o">.</span><span class="n">xfail</span><span class="p">(</span><span class="s2">&quot;expected to fail until bug XYZ is fixed&quot;</span><span class="p">)</span>
</span></code></pre></div>
<ul>
<li>Here is how to skip all tests in a module if some import is missing:</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="n">docutils</span> <span class="o">=</span> <span class="n">pytest</span><span class="o">.</span><span class="n">importorskip</span><span class="p">(</span><span class="s2">&quot;docutils&quot;</span><span class="p">,</span> <span class="n">minversion</span><span class="o">=</span><span class="s2">&quot;0.3&quot;</span><span class="p">)</span>
</span></code></pre></div>
<ul>
<li>Skip a test based on a condition:</li>
</ul>
<p>```python no-style
@pytest.mark.skipif(sys.version_info &lt; (3,6), reason="requires python3.6 or higher")
def test_feature_x():
<div class="language-bash highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a>or:
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="sb">```</span>python<span class="w"> </span>no-style
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>@unittest.skipIf<span class="o">(</span><span class="nv">torch_device</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;cpu&quot;</span>,<span class="w"> </span><span class="s2">&quot;Can&#39;t do half precision&quot;</span><span class="o">)</span>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>def<span class="w"> </span>test_feature_x<span class="o">()</span>:
</span></code></pre></div></p>
<p>or skip the whole module:</p>
<p>```python no-style
@pytest.mark.skipif(sys.platform == 'win32', reason="does not run on windows")
class TestClass():
    def test_feature_x(self):
<div class="language-bash highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a>More<span class="w"> </span>details,<span class="w"> </span>example<span class="w"> </span>and<span class="w"> </span>ways<span class="w"> </span>are<span class="w"> </span><span class="o">[</span>here<span class="o">](</span>https://docs.pytest.org/en/latest/skipping.html<span class="o">)</span>.
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="c1">### Slow tests</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a>The<span class="w"> </span>library<span class="w"> </span>of<span class="w"> </span>tests<span class="w"> </span>is<span class="w"> </span>ever-growing,<span class="w"> </span>and<span class="w"> </span>some<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>tests<span class="w"> </span>take<span class="w"> </span>minutes<span class="w"> </span>to<span class="w"> </span>run,<span class="w"> </span>therefore<span class="w"> </span>we<span class="w"> </span>can<span class="err">&#39;</span>t<span class="w"> </span>afford<span class="w"> </span>waiting<span class="w"> </span><span class="k">for</span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a>an<span class="w"> </span>hour<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span><span class="nb">test</span><span class="w"> </span>suite<span class="w"> </span>to<span class="w"> </span><span class="nb">complete</span><span class="w"> </span>on<span class="w"> </span>CI.<span class="w"> </span>Therefore,<span class="w"> </span>with<span class="w"> </span>some<span class="w"> </span>exceptions<span class="w"> </span><span class="k">for</span><span class="w"> </span>essential<span class="w"> </span>tests,<span class="w"> </span>slow<span class="w"> </span>tests<span class="w"> </span>should<span class="w"> </span>be
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a>marked<span class="w"> </span>as<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>example<span class="w"> </span>below:
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a>
</span><span id="__span-72-9"><a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a><span class="sb">```</span>python<span class="w"> </span>no-style
</span><span id="__span-72-10"><a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a>from<span class="w"> </span>transformers.testing_utils<span class="w"> </span>import<span class="w"> </span>slow
</span><span id="__span-72-11"><a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a>@slow
</span><span id="__span-72-12"><a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a>def<span class="w"> </span>test_integration_foo<span class="o">()</span>:
</span></code></pre></div></p>
<p>Once a test is marked as <code>@slow</code>, to run such tests set <code>RUN_SLOW=1</code> env var, e.g.:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="nv">RUN_SLOW</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>pytest<span class="w"> </span>tests
</span></code></pre></div>
<p>Some decorators like <code>@parameterized</code> rewrite test names, therefore <code>@slow</code> and the rest of the skip decorators
<code>@require_*</code> have to be listed last for them to work correctly. Here is an example of the correct usage:</p>
<p>```python no-style
@parameterized.expand(...)
@slow
def test_integration_foo():
<div class="language-bash highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a>As<span class="w"> </span>explained<span class="w"> </span>at<span class="w"> </span>the<span class="w"> </span>beginning<span class="w"> </span>of<span class="w"> </span>this<span class="w"> </span>document,<span class="w"> </span>slow<span class="w"> </span>tests<span class="w"> </span>get<span class="w"> </span>to<span class="w"> </span>run<span class="w"> </span>on<span class="w"> </span>a<span class="w"> </span>scheduled<span class="w"> </span>basis,<span class="w"> </span>rather<span class="w"> </span>than<span class="w"> </span><span class="k">in</span><span class="w"> </span>PRs<span class="w"> </span>CI
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>checks.<span class="w"> </span>So<span class="w"> </span>it<span class="s1">&#39;s possible that some problems will be missed during a PR submission and get merged. Such problems will</span>
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="s1">get caught during the next scheduled CI job. But it also means that it&#39;</span>s<span class="w"> </span>important<span class="w"> </span>to<span class="w"> </span>run<span class="w"> </span>the<span class="w"> </span>slow<span class="w"> </span>tests<span class="w"> </span>on<span class="w"> </span>your
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a>machine<span class="w"> </span>before<span class="w"> </span>submitting<span class="w"> </span>the<span class="w"> </span>PR.
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a>Here<span class="w"> </span>is<span class="w"> </span>a<span class="w"> </span>rough<span class="w"> </span>decision<span class="w"> </span>making<span class="w"> </span>mechanism<span class="w"> </span><span class="k">for</span><span class="w"> </span>choosing<span class="w"> </span>which<span class="w"> </span>tests<span class="w"> </span>should<span class="w"> </span>be<span class="w"> </span>marked<span class="w"> </span>as<span class="w"> </span>slow:
</span><span id="__span-74-7"><a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a>
</span><span id="__span-74-8"><a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a>If<span class="w"> </span>the<span class="w"> </span><span class="nb">test</span><span class="w"> </span>is<span class="w"> </span>focused<span class="w"> </span>on<span class="w"> </span>one<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>library<span class="s1">&#39;s internal components (e.g., modeling files, tokenization files,</span>
</span><span id="__span-74-9"><a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a><span class="s1">pipelines), then we should run that test in the non-slow test suite. If it&#39;</span>s<span class="w"> </span>focused<span class="w"> </span>on<span class="w"> </span>an<span class="w"> </span>other<span class="w"> </span>aspect<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>library,
</span><span id="__span-74-10"><a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a>such<span class="w"> </span>as<span class="w"> </span>the<span class="w"> </span>documentation<span class="w"> </span>or<span class="w"> </span>the<span class="w"> </span>examples,<span class="w"> </span><span class="k">then</span><span class="w"> </span>we<span class="w"> </span>should<span class="w"> </span>run<span class="w"> </span>these<span class="w"> </span>tests<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>slow<span class="w"> </span><span class="nb">test</span><span class="w"> </span>suite.<span class="w"> </span>And<span class="w"> </span><span class="k">then</span>,<span class="w"> </span>to<span class="w"> </span>refine
</span><span id="__span-74-11"><a id="__codelineno-74-11" name="__codelineno-74-11" href="#__codelineno-74-11"></a>this<span class="w"> </span>approach<span class="w"> </span>we<span class="w"> </span>should<span class="w"> </span>have<span class="w"> </span>exceptions:
</span><span id="__span-74-12"><a id="__codelineno-74-12" name="__codelineno-74-12" href="#__codelineno-74-12"></a>
</span><span id="__span-74-13"><a id="__codelineno-74-13" name="__codelineno-74-13" href="#__codelineno-74-13"></a>-<span class="w"> </span>All<span class="w"> </span>tests<span class="w"> </span>that<span class="w"> </span>need<span class="w"> </span>to<span class="w"> </span>download<span class="w"> </span>a<span class="w"> </span>heavy<span class="w"> </span><span class="nb">set</span><span class="w"> </span>of<span class="w"> </span>weights<span class="w"> </span>or<span class="w"> </span>a<span class="w"> </span>dataset<span class="w"> </span>that<span class="w"> </span>is<span class="w"> </span>larger<span class="w"> </span>than<span class="w"> </span>~50MB<span class="w"> </span><span class="o">(</span>e.g.,<span class="w"> </span>model<span class="w"> </span>or
</span><span id="__span-74-14"><a id="__codelineno-74-14" name="__codelineno-74-14" href="#__codelineno-74-14"></a><span class="w">  </span>tokenizer<span class="w"> </span>integration<span class="w"> </span>tests,<span class="w"> </span>pipeline<span class="w"> </span>integration<span class="w"> </span>tests<span class="o">)</span><span class="w"> </span>should<span class="w"> </span>be<span class="w"> </span><span class="nb">set</span><span class="w"> </span>to<span class="w"> </span>slow.<span class="w"> </span>If<span class="w"> </span>you<span class="err">&#39;</span>re<span class="w"> </span>adding<span class="w"> </span>a<span class="w"> </span>new<span class="w"> </span>model,<span class="w"> </span>you
</span><span id="__span-74-15"><a id="__codelineno-74-15" name="__codelineno-74-15" href="#__codelineno-74-15"></a><span class="w">  </span>should<span class="w"> </span>create<span class="w"> </span>and<span class="w"> </span>upload<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>hub<span class="w"> </span>a<span class="w"> </span>tiny<span class="w"> </span>version<span class="w"> </span>of<span class="w"> </span>it<span class="w"> </span><span class="o">(</span>with<span class="w"> </span>random<span class="w"> </span>weights<span class="o">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>integration<span class="w"> </span>tests.<span class="w"> </span>This<span class="w"> </span>is
</span><span id="__span-74-16"><a id="__codelineno-74-16" name="__codelineno-74-16" href="#__codelineno-74-16"></a><span class="w">  </span>discussed<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>paragraphs.
</span><span id="__span-74-17"><a id="__codelineno-74-17" name="__codelineno-74-17" href="#__codelineno-74-17"></a>-<span class="w"> </span>All<span class="w"> </span>tests<span class="w"> </span>that<span class="w"> </span>need<span class="w"> </span>to<span class="w"> </span><span class="k">do</span><span class="w"> </span>a<span class="w"> </span>training<span class="w"> </span>not<span class="w"> </span>specifically<span class="w"> </span>optimized<span class="w"> </span>to<span class="w"> </span>be<span class="w"> </span>fast<span class="w"> </span>should<span class="w"> </span>be<span class="w"> </span><span class="nb">set</span><span class="w"> </span>to<span class="w"> </span>slow.
</span><span id="__span-74-18"><a id="__codelineno-74-18" name="__codelineno-74-18" href="#__codelineno-74-18"></a>-<span class="w"> </span>We<span class="w"> </span>can<span class="w"> </span>introduce<span class="w"> </span>exceptions<span class="w"> </span><span class="k">if</span><span class="w"> </span>some<span class="w"> </span>of<span class="w"> </span>these<span class="w"> </span>should-be-non-slow<span class="w"> </span>tests<span class="w"> </span>are<span class="w"> </span>excruciatingly<span class="w"> </span>slow,<span class="w"> </span>and<span class="w"> </span><span class="nb">set</span><span class="w"> </span>them<span class="w"> </span>to
</span><span id="__span-74-19"><a id="__codelineno-74-19" name="__codelineno-74-19" href="#__codelineno-74-19"></a><span class="w">  </span><span class="sb">`</span>@slow<span class="sb">`</span>.<span class="w"> </span>Auto-modeling<span class="w"> </span>tests,<span class="w"> </span>which<span class="w"> </span>save<span class="w"> </span>and<span class="w"> </span>load<span class="w"> </span>large<span class="w"> </span>files<span class="w"> </span>to<span class="w"> </span>disk,<span class="w"> </span>are<span class="w"> </span>a<span class="w"> </span>good<span class="w"> </span>example<span class="w"> </span>of<span class="w"> </span>tests<span class="w"> </span>that<span class="w"> </span>are<span class="w"> </span>marked
</span><span id="__span-74-20"><a id="__codelineno-74-20" name="__codelineno-74-20" href="#__codelineno-74-20"></a><span class="w">  </span>as<span class="w"> </span><span class="sb">`</span>@slow<span class="sb">`</span>.
</span><span id="__span-74-21"><a id="__codelineno-74-21" name="__codelineno-74-21" href="#__codelineno-74-21"></a>-<span class="w"> </span>If<span class="w"> </span>a<span class="w"> </span><span class="nb">test</span><span class="w"> </span>completes<span class="w"> </span>under<span class="w"> </span><span class="m">1</span><span class="w"> </span>second<span class="w"> </span>on<span class="w"> </span>CI<span class="w"> </span><span class="o">(</span>including<span class="w"> </span>downloads<span class="w"> </span><span class="k">if</span><span class="w"> </span>any<span class="o">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span>it<span class="w"> </span>should<span class="w"> </span>be<span class="w"> </span>a<span class="w"> </span>normal<span class="w"> </span><span class="nb">test</span><span class="w"> </span>regardless.
</span><span id="__span-74-22"><a id="__codelineno-74-22" name="__codelineno-74-22" href="#__codelineno-74-22"></a>
</span><span id="__span-74-23"><a id="__codelineno-74-23" name="__codelineno-74-23" href="#__codelineno-74-23"></a>Collectively,<span class="w"> </span>all<span class="w"> </span>the<span class="w"> </span>non-slow<span class="w"> </span>tests<span class="w"> </span>need<span class="w"> </span>to<span class="w"> </span>cover<span class="w"> </span>entirely<span class="w"> </span>the<span class="w"> </span>different<span class="w"> </span>internals,<span class="w"> </span><span class="k">while</span><span class="w"> </span>remaining<span class="w"> </span>fast.<span class="w"> </span>For<span class="w"> </span>example,
</span><span id="__span-74-24"><a id="__codelineno-74-24" name="__codelineno-74-24" href="#__codelineno-74-24"></a>a<span class="w"> </span>significant<span class="w"> </span>coverage<span class="w"> </span>can<span class="w"> </span>be<span class="w"> </span>achieved<span class="w"> </span>by<span class="w"> </span>testing<span class="w"> </span>with<span class="w"> </span>specially<span class="w"> </span>created<span class="w"> </span>tiny<span class="w"> </span>models<span class="w"> </span>with<span class="w"> </span>random<span class="w"> </span>weights.<span class="w"> </span>Such<span class="w"> </span>models
</span><span id="__span-74-25"><a id="__codelineno-74-25" name="__codelineno-74-25" href="#__codelineno-74-25"></a>have<span class="w"> </span>the<span class="w"> </span>very<span class="w"> </span>minimal<span class="w"> </span>number<span class="w"> </span>of<span class="w"> </span>layers<span class="w"> </span><span class="o">(</span>e.g.,<span class="w"> </span><span class="m">2</span><span class="o">)</span>,<span class="w"> </span>vocab<span class="w"> </span>size<span class="w"> </span><span class="o">(</span>e.g.,<span class="w"> </span><span class="m">1000</span><span class="o">)</span>,<span class="w"> </span>etc.<span class="w"> </span>Then<span class="w"> </span>the<span class="w"> </span><span class="sb">`</span>@slow<span class="sb">`</span><span class="w"> </span>tests<span class="w"> </span>can<span class="w"> </span>use<span class="w"> </span>large
</span><span id="__span-74-26"><a id="__codelineno-74-26" name="__codelineno-74-26" href="#__codelineno-74-26"></a>slow<span class="w"> </span>models<span class="w"> </span>to<span class="w"> </span><span class="k">do</span><span class="w"> </span>qualitative<span class="w"> </span>testing.<span class="w"> </span>To<span class="w"> </span>see<span class="w"> </span>the<span class="w"> </span>use<span class="w"> </span>of<span class="w"> </span>these<span class="w"> </span>simply<span class="w"> </span>look<span class="w"> </span><span class="k">for</span><span class="w"> </span>*tiny*<span class="w"> </span>models<span class="w"> </span>with:
</span><span id="__span-74-27"><a id="__codelineno-74-27" name="__codelineno-74-27" href="#__codelineno-74-27"></a>
</span><span id="__span-74-28"><a id="__codelineno-74-28" name="__codelineno-74-28" href="#__codelineno-74-28"></a><span class="sb">```</span>bash
</span><span id="__span-74-29"><a id="__codelineno-74-29" name="__codelineno-74-29" href="#__codelineno-74-29"></a>grep<span class="w"> </span>tiny<span class="w"> </span>tests<span class="w"> </span>examples
</span></code></pre></div></p>
<p>Here is an example of a <a href="https://github.com/huggingface/transformers/tree/main/scripts/fsmt/fsmt-make-tiny-model.py">script</a> that created the tiny model
<a href="https://huggingface.co/stas/tiny-wmt19-en-de">stas/tiny-wmt19-en-de</a>. You can easily adjust it to your specific
model's architecture.</p>
<p>It's easy to measure the run-time incorrectly if for example there is an overheard of downloading a huge model, but if
you test it locally the downloaded files would be cached and thus the download time not measured. Hence check the
execution speed report in CI logs instead (the output of <code>pytest --durations=0 tests</code>).</p>
<p>That report is also useful to find slow outliers that aren't marked as such, or which need to be re-written to be fast.
If you notice that the test suite starts getting slow on CI, the top listing of this report will show the slowest
tests.</p>
<h3 id="testing-the-stdoutstderr-output">Testing the stdout/stderr output</h3>
<p>In order to test functions that write to <code>stdout</code> and/or <code>stderr</code>, the test can access those streams using the
<code>pytest</code>'s <a href="https://docs.pytest.org/en/latest/capture.html">capsys system</a>. Here is how this is accomplished:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">print_to_stdout</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a>
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a>
</span><span id="__span-75-8"><a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">print_to_stderr</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="__span-75-9"><a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="__span-75-10"><a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a>
</span><span id="__span-75-11"><a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a>
</span><span id="__span-75-12"><a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_result_and_stdout</span><span class="p">(</span><span class="n">capsys</span><span class="p">):</span>
</span><span id="__span-75-13"><a id="__codelineno-75-13" name="__codelineno-75-13" href="#__codelineno-75-13"></a>    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Hello&quot;</span>
</span><span id="__span-75-14"><a id="__codelineno-75-14" name="__codelineno-75-14" href="#__codelineno-75-14"></a>    <span class="n">print_to_stdout</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="__span-75-15"><a id="__codelineno-75-15" name="__codelineno-75-15" href="#__codelineno-75-15"></a>    <span class="n">print_to_stderr</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="__span-75-16"><a id="__codelineno-75-16" name="__codelineno-75-16" href="#__codelineno-75-16"></a>    <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">capsys</span><span class="o">.</span><span class="n">readouterr</span><span class="p">()</span>  <span class="c1"># consume the captured output streams</span>
</span><span id="__span-75-17"><a id="__codelineno-75-17" name="__codelineno-75-17" href="#__codelineno-75-17"></a>    <span class="c1"># optional: if you want to replay the consumed streams:</span>
</span><span id="__span-75-18"><a id="__codelineno-75-18" name="__codelineno-75-18" href="#__codelineno-75-18"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span><span id="__span-75-19"><a id="__codelineno-75-19" name="__codelineno-75-19" href="#__codelineno-75-19"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span><span id="__span-75-20"><a id="__codelineno-75-20" name="__codelineno-75-20" href="#__codelineno-75-20"></a>    <span class="c1"># test:</span>
</span><span id="__span-75-21"><a id="__codelineno-75-21" name="__codelineno-75-21" href="#__codelineno-75-21"></a>    <span class="k">assert</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">out</span>
</span><span id="__span-75-22"><a id="__codelineno-75-22" name="__codelineno-75-22" href="#__codelineno-75-22"></a>    <span class="k">assert</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">err</span>
</span></code></pre></div>
<p>And, of course, most of the time, <code>stderr</code> will come as a part of an exception, so try/except has to be used in such
a case:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">raise_exception</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a>    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>
</span><span id="__span-76-4"><a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>
</span><span id="__span-76-5"><a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_something_exception</span><span class="p">():</span>
</span><span id="__span-76-6"><a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a>    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Not a good value&quot;</span>
</span><span id="__span-76-7"><a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a>    <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-76-8"><a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-76-9"><a id="__codelineno-76-9" name="__codelineno-76-9" href="#__codelineno-76-9"></a>        <span class="n">raise_exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="__span-76-10"><a id="__codelineno-76-10" name="__codelineno-76-10" href="#__codelineno-76-10"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-76-11"><a id="__codelineno-76-11" name="__codelineno-76-11" href="#__codelineno-76-11"></a>        <span class="n">error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="__span-76-12"><a id="__codelineno-76-12" name="__codelineno-76-12" href="#__codelineno-76-12"></a>        <span class="k">assert</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">error</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2"> is in the exception:</span><span class="se">\n</span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></div>
<p>Another approach to capturing stdout is via <code>contextlib.redirect_stdout</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">StringIO</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">redirect_stdout</span>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">print_to_stdout</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="__span-77-6"><a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="__span-77-7"><a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a>
</span><span id="__span-77-8"><a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a>
</span><span id="__span-77-9"><a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_result_and_stdout</span><span class="p">():</span>
</span><span id="__span-77-10"><a id="__codelineno-77-10" name="__codelineno-77-10" href="#__codelineno-77-10"></a>    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Hello&quot;</span>
</span><span id="__span-77-11"><a id="__codelineno-77-11" name="__codelineno-77-11" href="#__codelineno-77-11"></a>    <span class="n">buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
</span><span id="__span-77-12"><a id="__codelineno-77-12" name="__codelineno-77-12" href="#__codelineno-77-12"></a>    <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">buffer</span><span class="p">):</span>
</span><span id="__span-77-13"><a id="__codelineno-77-13" name="__codelineno-77-13" href="#__codelineno-77-13"></a>        <span class="n">print_to_stdout</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="__span-77-14"><a id="__codelineno-77-14" name="__codelineno-77-14" href="#__codelineno-77-14"></a>    <span class="n">out</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</span><span id="__span-77-15"><a id="__codelineno-77-15" name="__codelineno-77-15" href="#__codelineno-77-15"></a>    <span class="c1"># optional: if you want to replay the consumed streams:</span>
</span><span id="__span-77-16"><a id="__codelineno-77-16" name="__codelineno-77-16" href="#__codelineno-77-16"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span><span id="__span-77-17"><a id="__codelineno-77-17" name="__codelineno-77-17" href="#__codelineno-77-17"></a>    <span class="c1"># test:</span>
</span><span id="__span-77-18"><a id="__codelineno-77-18" name="__codelineno-77-18" href="#__codelineno-77-18"></a>    <span class="k">assert</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">out</span>
</span></code></pre></div>
<p>An important potential issue with capturing stdout is that it may contain <code>\r</code> characters that in normal <code>print</code>
reset everything that has been printed so far. There is no problem with <code>pytest</code>, but with <code>pytest -s</code> these
characters get included in the buffer, so to be able to have the test run with and without <code>-s</code>, you have to make an
extra cleanup to the captured output, using <code>re.sub(r'~.*\r', '', buf, 0, re.M)</code>.</p>
<p>But, then we have a helper context manager wrapper to automatically take care of it all, regardless of whether it has
some <code>\r</code>'s in it or not, so it's a simple:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">CaptureStdout</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="k">with</span> <span class="n">CaptureStdout</span><span class="p">()</span> <span class="k">as</span> <span class="n">cs</span><span class="p">:</span>
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a>    <span class="n">function_that_writes_to_stdout</span><span class="p">()</span>
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a><span class="nb">print</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">out</span><span class="p">)</span>
</span></code></pre></div>
<p>Here is a full test example:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">CaptureStdout</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Secret message</span><span class="se">\r</span><span class="s2">&quot;</span>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a><span class="n">final</span> <span class="o">=</span> <span class="s2">&quot;Hello World&quot;</span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="k">with</span> <span class="n">CaptureStdout</span><span class="p">()</span> <span class="k">as</span> <span class="n">cs</span><span class="p">:</span>
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="n">final</span><span class="p">)</span>
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a><span class="k">assert</span> <span class="n">cs</span><span class="o">.</span><span class="n">out</span> <span class="o">==</span> <span class="n">final</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;captured: </span><span class="si">{</span><span class="n">cs</span><span class="o">.</span><span class="n">out</span><span class="si">}</span><span class="s2">, expecting </span><span class="si">{</span><span class="n">final</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></div>
<p>If you'd like to capture <code>stderr</code> use the <code>CaptureStderr</code> class instead:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">CaptureStderr</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="k">with</span> <span class="n">CaptureStderr</span><span class="p">()</span> <span class="k">as</span> <span class="n">cs</span><span class="p">:</span>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a>    <span class="n">function_that_writes_to_stderr</span><span class="p">()</span>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a><span class="nb">print</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">err</span><span class="p">)</span>
</span></code></pre></div>
<p>If you need to capture both streams at once, use the parent <code>CaptureStd</code> class:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">CaptureStd</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="k">with</span> <span class="n">CaptureStd</span><span class="p">()</span> <span class="k">as</span> <span class="n">cs</span><span class="p">:</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a>    <span class="n">function_that_writes_to_stdout_and_stderr</span><span class="p">()</span>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a><span class="nb">print</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">cs</span><span class="o">.</span><span class="n">out</span><span class="p">)</span>
</span></code></pre></div>
<p>Also, to aid debugging test issues, by default these context managers automatically replay the captured streams on exit
from the context.</p>
<h3 id="capturing-logger-stream">Capturing logger stream</h3>
<p>If you need to validate the output of a logger, you can use <code>CaptureLogger</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">logging</span>
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">CaptureLogger</span>
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a>
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a><span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Testing 1, 2, 3&quot;</span>
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity_info</span><span class="p">()</span>
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;transformers.models.bart.tokenization_bart&quot;</span><span class="p">)</span>
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a><span class="k">with</span> <span class="n">CaptureLogger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span> <span class="k">as</span> <span class="n">cl</span><span class="p">:</span>
</span><span id="__span-82-8"><a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="__span-82-9"><a id="__codelineno-82-9" name="__codelineno-82-9" href="#__codelineno-82-9"></a><span class="k">assert</span> <span class="n">cl</span><span class="o">.</span><span class="n">out</span><span class="p">,</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span></code></pre></div>
<h3 id="testing-with-environment-variables">Testing with environment variables</h3>
<p>If you want to test the impact of environment variables for a specific test you can use a helper decorator
<code>transformers.testing_utils.mockenv</code></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">mockenv</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a>
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">HfArgumentParserTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>    <span class="nd">@mockenv</span><span class="p">(</span><span class="n">TRANSFORMERS_VERBOSITY</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_env_override</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-83-7"><a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a>        <span class="n">env_level_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TRANSFORMERS_VERBOSITY&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></code></pre></div>
<p>At times an external program needs to be called, which requires setting <code>PYTHONPATH</code> in <code>os.environ</code> to include
multiple local paths. A helper class <code>transformers.test_utils.TestCasePlus</code> comes to help:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.testing_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestCasePlus</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">EnvExampleTest</span><span class="p">(</span><span class="n">TestCasePlus</span><span class="p">):</span>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_external_prog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a>        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">()</span>
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a>        <span class="c1"># now call the external program, passing `env` to it</span>
</span></code></pre></div>
<p>Depending on whether the test file was under the <code>tests</code> test suite or <code>examples</code> it'll correctly set up
<code>env[PYTHONPATH]</code> to include one of these two directories, and also the <code>src</code> directory to ensure the testing is
done against the current repo, and finally with whatever <code>env[PYTHONPATH]</code> was already set to before the test was
called if anything.</p>
<p>This helper method creates a copy of the <code>os.environ</code> object, so the original remains intact.</p>
<h3 id="getting-reproducible-results">Getting reproducible results</h3>
<p>In some situations you may want to remove randomness for your tests. To get identical reproducible results set, you
will need to fix the seed:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="n">seed</span> <span class="o">=</span> <span class="mi">42</span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a><span class="c1"># python RNG</span>
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</span><span id="__span-85-5"><a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a>
</span><span id="__span-85-6"><a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="__span-85-7"><a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a>
</span><span id="__span-85-8"><a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a><span class="c1"># pytorch RNGs</span>
</span><span id="__span-85-9"><a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-85-10"><a id="__codelineno-85-10" name="__codelineno-85-10" href="#__codelineno-85-10"></a>
</span><span id="__span-85-11"><a id="__codelineno-85-11" name="__codelineno-85-11" href="#__codelineno-85-11"></a><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="__span-85-12"><a id="__codelineno-85-12" name="__codelineno-85-12" href="#__codelineno-85-12"></a><span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-85-13"><a id="__codelineno-85-13" name="__codelineno-85-13" href="#__codelineno-85-13"></a><span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
</span><span id="__span-85-14"><a id="__codelineno-85-14" name="__codelineno-85-14" href="#__codelineno-85-14"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="__span-85-15"><a id="__codelineno-85-15" name="__codelineno-85-15" href="#__codelineno-85-15"></a>
</span><span id="__span-85-16"><a id="__codelineno-85-16" name="__codelineno-85-16" href="#__codelineno-85-16"></a><span class="c1"># numpy RNG</span>
</span><span id="__span-85-17"><a id="__codelineno-85-17" name="__codelineno-85-17" href="#__codelineno-85-17"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-85-18"><a id="__codelineno-85-18" name="__codelineno-85-18" href="#__codelineno-85-18"></a>
</span><span id="__span-85-19"><a id="__codelineno-85-19" name="__codelineno-85-19" href="#__codelineno-85-19"></a><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="debugging-tests">Debugging tests</h3>
<p>To start a debugger at the point of the warning, do this:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a>pytest<span class="w"> </span>tests/utils/test_logging.py<span class="w"> </span>-W<span class="w"> </span>error::UserWarning<span class="w"> </span>--pdb
</span></code></pre></div>
<h2 id="working-with-github-actions-workflows">Working with github actions workflows</h2>
<p>To trigger a self-push workflow CI job, you must:</p>
<ol>
<li>Create a new branch on <code>transformers</code> origin (not a fork!).</li>
<li>The branch name has to start with either <code>ci_</code> or <code>ci-</code> (<code>main</code> triggers it too, but we can't do PRs on
   <code>main</code>). It also gets triggered only for specific paths - you can find the up-to-date definition in case it
   changed since this document has been written <a href="https://github.com/huggingface/transformers/blob/main/.github/workflows/self-push.yml">here</a> under <em>push:</em></li>
<li>Create a PR from this branch.</li>
<li>Then you can see the job appear <a href="https://github.com/huggingface/transformers/actions/workflows/self-push.yml">here</a>. It may not run right away if there
   is a backlog.</li>
</ol>
<h2 id="testing-experimental-ci-features">Testing Experimental CI Features</h2>
<p>Testing CI features can be potentially problematic as it can interfere with the normal CI functioning. Therefore if a
new CI feature is to be added, it should be done as following.</p>
<ol>
<li>Create a new dedicated job that tests what needs to be tested</li>
<li>The new job must always succeed so that it gives us a green âœ“ (details below).</li>
<li>Let it run for some days to see that a variety of different PR types get to run on it (user fork branches,
   non-forked branches, branches originating from github.com UI direct file edit, various forced pushes, etc. - there
   are so many) while monitoring the experimental job's logs (not the overall job green as it's purposefully always
   green)</li>
<li>When it's clear that everything is solid, then merge the new changes into existing jobs.</li>
</ol>
<p>That way experiments on CI functionality itself won't interfere with the normal workflow.</p>
<p>Now how can we make the job always succeed while the new CI feature is being developed?</p>
<p>Some CIs, like TravisCI support ignore-step-failure and will report the overall job as successful, but CircleCI and
Github Actions as of this writing don't support that.</p>
<p>So the following workaround can be used:</p>
<ol>
<li><code>set +euo pipefail</code> at the beginning of the run command to suppress most potential failures in the bash script.</li>
<li>the last command must be a success: <code>echo "done"</code> or just <code>true</code> will do</li>
</ol>
<p>Here is an example:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span>
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">run CI experiment</span>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a><span class="w">        </span><span class="no">set +euo pipefail</span>
</span><span id="__span-87-5"><a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a><span class="w">        </span><span class="no">echo &quot;setting run-all-despite-any-errors-mode&quot;</span>
</span><span id="__span-87-6"><a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a><span class="w">        </span><span class="no">this_command_will_fail</span>
</span><span id="__span-87-7"><a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a><span class="w">        </span><span class="no">echo &quot;but bash continues to run&quot;</span>
</span><span id="__span-87-8"><a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a><span class="w">        </span><span class="no"># emulate another failure</span>
</span><span id="__span-87-9"><a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a><span class="w">        </span><span class="no">false</span>
</span><span id="__span-87-10"><a id="__codelineno-87-10" name="__codelineno-87-10" href="#__codelineno-87-10"></a><span class="w">        </span><span class="no"># but the last command must be a success</span>
</span><span id="__span-87-11"><a id="__codelineno-87-11" name="__codelineno-87-11" href="#__codelineno-87-11"></a><span class="w">        </span><span class="no">echo &quot;during experiment do not remove: reporting success to CI, even if there were failures&quot;</span>
</span></code></pre></div>
<p>For simple commands you could also do:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a>cmd_that_may_fail<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
</span></code></pre></div>
<p>Of course, once satisfied with the results, integrate the experimental step or job with the rest of the normal jobs,
while removing <code>set +euo pipefail</code> or any other things you may have added to ensure that the experimental job doesn't
interfere with the normal CI functioning.</p>
<p>This whole process would have been much easier if we only could set something like <code>allow-failure</code> for the
experimental step, and let it fail without impacting the overall status of PRs. But as mentioned earlier CircleCI and
Github Actions don't support it at the moment.</p>
<p>You can vote for this feature and see where it is at these CI-specific threads:</p>
<ul>
<li><a href="https://github.com/actions/toolkit/issues/399">Github Actions:</a></li>
<li><a href="https://ideas.circleci.com/ideas/CCI-I-344">CircleCI:</a></li>
</ul>
<h2 id="deepspeed-integration">DeepSpeed integration</h2>
<p>For a PR that involves the DeepSpeed integration, keep in mind our CircleCI PR CI setup doesn't have GPUs. Tests requiring GPUs are run on a different CI nightly. This means if you get a passing CI report in your PR, it doesn't mean the DeepSpeed tests pass.</p>
<p>To run DeepSpeed tests:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="nv">RUN_SLOW</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>pytest<span class="w"> </span>tests/deepspeed/test_deepspeed.py
</span></code></pre></div>
<p>Any changes to the modeling or PyTorch examples code requires running the model zoo tests as well.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="nv">RUN_SLOW</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>pytest<span class="w"> </span>tests/deepspeed
</span></code></pre></div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../../../..", "features": ["navigation.tabs", "navigation.indexes", "navigation.instant", "navigation.sections", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "content.tabs.link", "content.code.copy"], "search": "../../../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>